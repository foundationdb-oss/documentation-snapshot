{
  "post_stream": {
    "posts": [
      {
        "id": 14925,
        "name": "Dan Meyers",
        "username": "danm",
        "avatar_template": "/user_avatar/forums.foundationdb.org/danm/{size}/1393_2.png",
        "created_at": "2025-05-13T18:56:54.260Z",
        "cooked": "<p>I know FDB restore is pretty slow, even for relatively small DBs. If you\u2019ve done a recent snapshot, it\u2019s not bad. But if there\u2019s a good length of mutation log to read since the last snapshot, it has a massively adverse effect on the restore time.</p>\n<p>For instance we seem to be able to be able to restore an ~350GB K/V size DB from a just-completed (within the last hour or so) snapshot within ~90m, which does cause a good amount of disk I/O on the hosts (doesn\u2019t seem to be hitting any bottlenecks on host performance though). But when there\u2019s a days\u2019 worth of mutation logs (~4.5k individual files, ~4-7GB data), it takes a further 4-5 <em>hours</em> to complete the restore operation, during which the cluster seems to be doing very little in terms of CPU, memory, or disk I/O.</p>\n<p>(Side note: when we were <code>ssd-2</code> on FDB 7.1 on network-attached cloud storage the bottleneck was quite clearly disk I/O as the storage nodes of the restore cluster were square-topping that stat, but since moving to FDB 7.3 and <code>ssd-redwood-1</code> the I/O has been <em>vastly</em> lower both for day-to-day workloads and test restores, and it no longer appears to be the issue)</p>\n<p>My hypothesis (from observation of host performance stats during restore, and from reading <a href=\"https://github.com/apple/foundationdb/blob/main/design/backup.md\" rel=\"noopener nofollow ugc\">this</a>) is that once the latest snapshot data has been restored, the mutation log can only be processed in-order on a single thread, or similar. So I\u2019m wondering what most affects that time, and how we might look to reduce it as much as possible and/or prevent unexpected surprises with it jumping suddenly due to a system design change.</p>\n<p>I can imagine that any or all of</p>\n<ul>\n<li>Number of key updates present in the log files (a lot of updates to small keys/values, vs fewer updates to larger keys/value)</li>\n<li>Number of log files (what actually triggers a new log file? Is it just time/versionstamp progression, or size too?)</li>\n<li>Total size in bytes of the necessary log data (more updates made and/or just larger keys/values)</li>\n<li>Number of individual transactions (or, number of unique versionstamps)</li>\n</ul>\n<p>could affect the speed of a restore. But I don\u2019t know which will affect it <em>most</em> and which are basically non-issues. If anyone can provide me guidance there, it would be most appreciated. I\u2019m going to poke through the codebase, so feel free to link me to bits of it, but I\u2019m not a C++ coder generally so it takes me a while to read/digest/mostly-understand.</p>\n<p>I know data can be pulled from S3 a <em>lot</em> faster than even the snapshot portion of a restore is doing, so would it be faster to pull the S3 backup prefix to a local ephemeral NVMe disk on each node running a backup/restore agent, and then trigger the restore from the local path? Is this even possible, or do too many parts of the backup/restore system reference the original backup path and a lot of unexpected stuff will break?</p>\n<p>I\u2019m aware there\u2019s a partitioned backup/restore process which is marked as experimental and has been since 2019, which from the design doc allows multiple mutation log files to be processed simultaneously. We tried to run the backup side on a test source cluster, and it locked the entire cluster up in such a way that we never managed to recover it. We still don\u2019t understand why, so we\u2019re understandably not comfortable deploying it on our production DB.</p>\n<p>I\u2019m also aware there\u2019s a backup system that involves calling out to an external script simultaneously on all the non-stateless hosts, intended for things like triggering a hypervisor-level disk snapshot. We\u2019d like to investigate that in future (and I\u2019d be interested to know what the DB does to keep everything in sync while that is running. Does it just hold everything in memory and not flush to disk?), but for the time being I want to know what I can squeeze from the existing <code>fdbbackup</code>/<code>fdbrestore</code>.</p>",
        "post_number": 1,
        "post_type": 1,
        "posts_count": 1,
        "updated_at": "2025-05-13T19:05:02.838Z",
        "reply_count": 0,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 14,
        "reads": 11,
        "readers_count": 10,
        "score": 72.2,
        "yours": false,
        "topic_id": 4905,
        "topic_slug": "what-most-affects-the-performance-of-the-streaming-mutation-log-part-of-an-fdb-restore",
        "display_username": "Dan Meyers",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 2,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "link_counts": [
          {
            "url": "https://github.com/apple/foundationdb/blob/main/design/backup.md",
            "internal": false,
            "reflection": false,
            "title": "foundationdb/design/backup.md at main \u00b7 apple/foundationdb \u00b7 GitHub",
            "clicks": 1
          }
        ],
        "read": true,
        "user_title": null,
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 1142,
        "hidden": false,
        "trust_level": 2,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/what-most-affects-the-performance-of-the-streaming-mutation-log-part-of-an-fdb-restore/4905/1",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null,
        "can_vote": false
      }
    ],
    "stream": [
      14925
    ]
  },
  "timeline_lookup": [
    [
      1,
      161
    ]
  ],
  "suggested_topics": [],
  "tags": [
    "performance"
  ],
  "tags_descriptions": {},
  "fancy_title": "What most affects the performance of the &lsquo;streaming mutation log&rsquo; part of an FDB restore?",
  "id": 4905,
  "title": "What most affects the performance of the 'streaming mutation log' part of an FDB restore?",
  "posts_count": 1,
  "created_at": "2025-05-13T18:56:54.184Z",
  "views": 42,
  "reply_count": 0,
  "like_count": 0,
  "last_posted_at": "2025-05-13T18:56:54.260Z",
  "visible": true,
  "closed": false,
  "archived": false,
  "has_summary": false,
  "archetype": "regular",
  "slug": "what-most-affects-the-performance-of-the-streaming-mutation-log-part-of-an-fdb-restore",
  "category_id": 7,
  "word_count": 718,
  "deleted_at": null,
  "user_id": 1142,
  "featured_link": null,
  "pinned_globally": false,
  "pinned_at": null,
  "pinned_until": null,
  "image_url": null,
  "slow_mode_seconds": 0,
  "draft": null,
  "draft_key": "topic_4905",
  "draft_sequence": null,
  "unpinned": null,
  "pinned": false,
  "current_post_number": 1,
  "highest_post_number": 1,
  "deleted_by": null,
  "actions_summary": [
    {
      "id": 4,
      "count": 0,
      "hidden": false,
      "can_act": false
    },
    {
      "id": 8,
      "count": 0,
      "hidden": false,
      "can_act": false
    },
    {
      "id": 10,
      "count": 0,
      "hidden": false,
      "can_act": false
    },
    {
      "id": 7,
      "count": 0,
      "hidden": false,
      "can_act": false
    }
  ],
  "chunk_size": 20,
  "bookmarked": false,
  "topic_timer": null,
  "message_bus_last_id": 0,
  "participant_count": 1,
  "show_read_indicator": false,
  "thumbnails": null,
  "slow_mode_enabled_until": null,
  "tags_disable_ads": false,
  "related_topics": [
    {
      "fancy_title": "Restore is slow and parallel restore doesn&rsquo;t achieve performance boost",
      "id": 2128,
      "title": "Restore is slow and parallel restore doesn't achieve performance boost",
      "slug": "restore-is-slow-and-parallel-restore-doesnt-achieve-performance-boost",
      "posts_count": 11,
      "reply_count": 7,
      "highest_post_number": 11,
      "image_url": null,
      "created_at": "2020-05-20T05:56:49.975Z",
      "last_posted_at": "2020-05-23T04:17:19.585Z",
      "bumped": true,
      "bumped_at": "2020-05-23T04:17:19.585Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 1,
      "views": 1398,
      "category_id": 7,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": "latest",
          "description": "Original Poster, Most Recent Poster",
          "user": {
            "id": 643,
            "username": "lehu",
            "name": "Leo Hu",
            "avatar_template": "/user_avatar/forums.foundationdb.org/lehu/{size}/995_2.png",
            "trust_level": 1
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 337,
            "username": "mengxu",
            "name": "Meng Xu",
            "avatar_template": "/user_avatar/forums.foundationdb.org/mengxu/{size}/893_2.png",
            "trust_level": 2
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 7,
            "username": "SteavedHams",
            "name": "Steve Atherton",
            "avatar_template": "/user_avatar/forums.foundationdb.org/steavedhams/{size}/18_2.png",
            "trust_level": 4
          }
        }
      ]
    },
    {
      "fancy_title": "Design and Implementation of a Performant Restore System in FDB",
      "id": 1277,
      "title": "Design and Implementation of a Performant Restore System in FDB",
      "slug": "design-and-implementation-of-a-performant-restore-system-in-fdb",
      "posts_count": 24,
      "reply_count": 21,
      "highest_post_number": 24,
      "image_url": null,
      "created_at": "2019-04-02T23:35:14.946Z",
      "last_posted_at": "2020-12-08T12:50:31.915Z",
      "bumped": true,
      "bumped_at": "2020-12-08T12:50:31.915Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 4,
      "views": 3171,
      "category_id": 5,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": null,
          "description": "Original Poster",
          "user": {
            "id": 337,
            "username": "mengxu",
            "name": "Meng Xu",
            "avatar_template": "/user_avatar/forums.foundationdb.org/mengxu/{size}/893_2.png",
            "trust_level": 2
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 13,
            "username": "alexmiller",
            "name": "Alex Miller",
            "avatar_template": "/user_avatar/forums.foundationdb.org/alexmiller/{size}/326_2.png",
            "trust_level": 4
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 454,
            "username": "jzhou",
            "name": "Jingyu Zhou",
            "avatar_template": "/user_avatar/forums.foundationdb.org/jzhou/{size}/445_2.png",
            "admin": true,
            "moderator": true,
            "trust_level": 2
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 7,
            "username": "SteavedHams",
            "name": "Steve Atherton",
            "avatar_template": "/user_avatar/forums.foundationdb.org/steavedhams/{size}/18_2.png",
            "trust_level": 4
          }
        },
        {
          "extras": "latest",
          "description": "Most Recent Poster",
          "user": {
            "id": 711,
            "username": "osamarin",
            "name": "Oleg Samarin",
            "avatar_template": "/user_avatar/forums.foundationdb.org/osamarin/{size}/905_2.png",
            "trust_level": 2
          }
        }
      ]
    },
    {
      "fancy_title": "Backup using disk snapshots",
      "id": 1076,
      "title": "Backup using disk snapshots",
      "slug": "backup-using-disk-snapshots",
      "posts_count": 15,
      "reply_count": 9,
      "highest_post_number": 15,
      "image_url": null,
      "created_at": "2019-01-29T12:52:43.232Z",
      "last_posted_at": "2019-02-14T18:12:56.795Z",
      "bumped": true,
      "bumped_at": "2019-02-14T18:12:56.795Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 2,
      "views": 2676,
      "category_id": 7,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": null,
          "description": "Original Poster",
          "user": {
            "id": 360,
            "username": "bjorndv",
            "name": "Bj\u00f6rn",
            "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/b/f05b48/{size}.png",
            "trust_level": 1
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 7,
            "username": "SteavedHams",
            "name": "Steve Atherton",
            "avatar_template": "/user_avatar/forums.foundationdb.org/steavedhams/{size}/18_2.png",
            "trust_level": 4
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 417,
            "username": "lihtnes",
            "name": "Senthil Ramamoorthy",
            "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/l/848f3c/{size}.png",
            "trust_level": 1
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 490,
            "username": "rjenkins",
            "name": "Ray Jenkins",
            "avatar_template": "/user_avatar/forums.foundationdb.org/rjenkins/{size}/487_2.png",
            "trust_level": 2
          }
        },
        {
          "extras": "latest",
          "description": "Most Recent Poster",
          "user": {
            "id": 13,
            "username": "alexmiller",
            "name": "Alex Miller",
            "avatar_template": "/user_avatar/forums.foundationdb.org/alexmiller/{size}/326_2.png",
            "trust_level": 4
          }
        }
      ]
    },
    {
      "fancy_title": "How to speed up the FDB restore process from s3?",
      "id": 2939,
      "title": "How to speed up the FDB restore process from s3?",
      "slug": "how-to-speed-up-the-fdb-restore-process-from-s3",
      "posts_count": 2,
      "reply_count": 0,
      "highest_post_number": 2,
      "image_url": "https://global.discourse-cdn.com/foundationdb/optimized/2X/8/8351c2c0c1ee9fbe49f84aaa62719b8235ab6514_2_1024x985.jpeg",
      "created_at": "2021-10-11T19:15:09.347Z",
      "last_posted_at": "2021-10-14T11:03:02.244Z",
      "bumped": true,
      "bumped_at": "2021-10-14T11:03:02.244Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 0,
      "views": 411,
      "category_id": 7,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": null,
          "description": "Original Poster",
          "user": {
            "id": 1003,
            "username": "nisman",
            "name": "",
            "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/n/7ba0ec/{size}.png",
            "trust_level": 1
          }
        },
        {
          "extras": "latest",
          "description": "Most Recent Poster",
          "user": {
            "id": 711,
            "username": "osamarin",
            "name": "Oleg Samarin",
            "avatar_template": "/user_avatar/forums.foundationdb.org/osamarin/{size}/905_2.png",
            "trust_level": 2
          }
        }
      ]
    },
    {
      "fancy_title": "Backup &amp; restore performance tuning",
      "id": 2078,
      "title": "Backup & restore performance tuning",
      "slug": "backup-restore-performance-tuning",
      "posts_count": 18,
      "reply_count": 16,
      "highest_post_number": 18,
      "image_url": null,
      "created_at": "2020-04-18T06:43:29.997Z",
      "last_posted_at": "2020-05-06T09:01:50.194Z",
      "bumped": true,
      "bumped_at": "2020-05-06T09:01:50.194Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [
        "performance"
      ],
      "tags_descriptions": {},
      "like_count": 1,
      "views": 2929,
      "category_id": 7,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": null,
          "description": "Original Poster",
          "user": {
            "id": 643,
            "username": "lehu",
            "name": "Leo Hu",
            "avatar_template": "/user_avatar/forums.foundationdb.org/lehu/{size}/995_2.png",
            "trust_level": 1
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 13,
            "username": "alexmiller",
            "name": "Alex Miller",
            "avatar_template": "/user_avatar/forums.foundationdb.org/alexmiller/{size}/326_2.png",
            "trust_level": 4
          }
        },
        {
          "extras": "latest",
          "description": "Most Recent Poster",
          "user": {
            "id": 7,
            "username": "SteavedHams",
            "name": "Steve Atherton",
            "avatar_template": "/user_avatar/forums.foundationdb.org/steavedhams/{size}/18_2.png",
            "trust_level": 4
          }
        }
      ]
    }
  ],
  "summarizable": false,
  "can_vote": false,
  "vote_count": 0,
  "user_voted": false,
  "discourse_zendesk_plugin_zendesk_id": null,
  "discourse_zendesk_plugin_zendesk_url": "https://your-url.zendesk.com/agent/tickets/",
  "details": {
    "can_edit": false,
    "notification_level": 1,
    "participants": [
      {
        "id": 1142,
        "username": "danm",
        "name": "Dan Meyers",
        "avatar_template": "/user_avatar/forums.foundationdb.org/danm/{size}/1393_2.png",
        "post_count": 1,
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_color": null,
        "flair_bg_color": null,
        "flair_group_id": null,
        "trust_level": 2
      }
    ],
    "created_by": {
      "id": 1142,
      "username": "danm",
      "name": "Dan Meyers",
      "avatar_template": "/user_avatar/forums.foundationdb.org/danm/{size}/1393_2.png"
    },
    "last_poster": {
      "id": 1142,
      "username": "danm",
      "name": "Dan Meyers",
      "avatar_template": "/user_avatar/forums.foundationdb.org/danm/{size}/1393_2.png"
    },
    "links": [
      {
        "url": "https://github.com/apple/foundationdb/blob/main/design/backup.md",
        "title": "foundationdb/design/backup.md at main \u00b7 apple/foundationdb \u00b7 GitHub",
        "internal": false,
        "attachment": false,
        "reflection": false,
        "clicks": 1,
        "user_id": 1142,
        "domain": "github.com",
        "root_domain": "github.com"
      }
    ]
  },
  "bookmarks": []
}