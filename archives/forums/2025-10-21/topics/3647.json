{
  "post_stream": {
    "posts": [
      {
        "id": 11986,
        "name": "Gytis",
        "username": "gytisgreitai",
        "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/g/7ba0ec/{size}.png",
        "created_at": "2022-11-09T09:22:28.455Z",
        "cooked": "<p>Hi all,</p>\n<p>getting myself familiar with FoundationDB and I have a newbie question. We\u2019re looking at FoundationDB usage for financial operations (general ledger)<br>\nAre there any patterns of implementing something like atomic add but with a certain constraints (e.g. value cannot go below some threshold)?<br>\nTried doing some basic test on single machine, and the atomic add seems to be way more performant than simply reading and writing. We could probably get away with read/write for most of our keys, but the problem is that we\u2019re gonna have some very hot write keys  which would always receive constant stream of updates.</p>\n<p>Thanks!</p>",
        "post_number": 1,
        "post_type": 1,
        "posts_count": 3,
        "updated_at": "2022-11-09T09:22:28.455Z",
        "reply_count": 0,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 219,
        "reads": 36,
        "readers_count": 35,
        "score": 1097.2,
        "yours": false,
        "topic_id": 3647,
        "topic_slug": "hot-write-keys-with-atomic-operations-and-constraints",
        "display_username": "Gytis",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 1184,
        "hidden": false,
        "trust_level": 1,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/hot-write-keys-with-atomic-operations-and-constraints/3647/1",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null,
        "can_vote": false
      },
      {
        "id": 12001,
        "name": "Alec Grieser",
        "username": "alloc",
        "avatar_template": "/user_avatar/forums.foundationdb.org/alloc/{size}/9_2.png",
        "created_at": "2022-11-11T17:31:27.819Z",
        "cooked": "<p>There\u2019s not an atomic operation that would help with that, I don\u2019t think. I\u2019m assuming the semantics you\u2019re looking for are something like: insert some data, and update a counter, BUT if the counter exceeds some value, then fail the transaction.</p>\n<p>The issue here is sort of wrapped up in how FDB atomic operations work. The basic idea is that FDB atomic ops serialize into the transaction a write to a key, but rather than being a normal \u201cset key\u201d write, they contain a \u201cmutation\u201d, like, \u201cadd 3\u201d or \u201cset the key to the max if its current value and 7\u201d. This mutation is considered by the transaction resolver to be a write without a read, and then the actual mutation is executed on the storage server after the transaction has already been committed. That means that the atomic operation can never do anything like \u201capply this operation IF some condition on the value ELSE fail the transaction\u201d because the transaction is committed prior to the value being read. The closest thing we have is probably the <code>COMPARE_AND_CLEAR</code> operation, which takes a key and a value, and clears the key if the key\u2019s current value matches the supplied value (which is usually 0, and can be used to implement counters that disappear when they reach zero).</p>\n<p>I think the only way to get the (proposed) desired semantics with FDB is to read the key during the transaction and validate that the proposed increment doesn\u2019t break your constraint, but that would result in all operations serializing around that one key, which could hurt performance. There are potentially ways you could address this by, doing something like having multiple limits with set maxima, and then randomly assigning each new value to one of those partitions, and then validating that the new value didn\u2019t cause the smaller maximum to exceed its value, though that\u2019s a bit much. Another approach would be to write data to a queue-like data structure, and then have another process go through and process those values. Effectively, this would be a mechanism for making the data durable, and then doing serial updates, but it may be more efficient than locking the counter key.</p>",
        "post_number": 2,
        "post_type": 1,
        "posts_count": 3,
        "updated_at": "2022-11-11T17:31:27.819Z",
        "reply_count": 0,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 4,
        "reads": 33,
        "readers_count": 32,
        "score": 26.6,
        "yours": false,
        "topic_id": 3647,
        "topic_slug": "hot-write-keys-with-atomic-operations-and-constraints",
        "display_username": "Alec Grieser",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 8,
        "hidden": false,
        "trust_level": 4,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/hot-write-keys-with-atomic-operations-and-constraints/3647/2",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 12018,
        "name": "Jon Anderson",
        "username": "janderland",
        "avatar_template": "/user_avatar/forums.foundationdb.org/janderland/{size}/517_2.png",
        "created_at": "2022-11-16T20:24:27.073Z",
        "cooked": "<p>Another solution would be to allow the atomic operation to modify the value below a threshold and correct the value during the read. This may be a good idea because it would allow you to update the value very frequently. Updates can be blindly done using the atomic operation while reads would follow the logic below:</p>\n<pre><code class=\"lang-auto\">db := fdb.MustDefaultDatabase()\nvalue, err := db.Transact(func(tr fdb.Transaction) (any, error) {\n  value := tr.Get(key).MustGet()\n  if value &lt; 0 {\n    value = 0\n    tr.Set(key, value)\n  }\n  return value, nil\n})\n</code></pre>",
        "post_number": 3,
        "post_type": 1,
        "posts_count": 3,
        "updated_at": "2022-11-16T20:25:22.195Z",
        "reply_count": 0,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 1,
        "reads": 30,
        "readers_count": 29,
        "score": 11.0,
        "yours": false,
        "topic_id": 3647,
        "topic_slug": "hot-write-keys-with-atomic-operations-and-constraints",
        "display_username": "Jon Anderson",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 517,
        "hidden": false,
        "trust_level": 2,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/hot-write-keys-with-atomic-operations-and-constraints/3647/3",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      }
    ],
    "stream": [
      11986,
      12001,
      12018
    ]
  },
  "timeline_lookup": [
    [
      1,
      1078
    ],
    [
      2,
      1075
    ],
    [
      3,
      1070
    ]
  ],
  "suggested_topics": [],
  "tags": [],
  "tags_descriptions": {},
  "fancy_title": "Hot write keys with atomic operations and constraints?",
  "id": 3647,
  "title": "Hot write keys with atomic operations and constraints?",
  "posts_count": 3,
  "created_at": "2022-11-09T09:22:28.397Z",
  "views": 513,
  "reply_count": 0,
  "like_count": 0,
  "last_posted_at": "2022-11-16T20:24:27.073Z",
  "visible": true,
  "closed": false,
  "archived": false,
  "has_summary": false,
  "archetype": "regular",
  "slug": "hot-write-keys-with-atomic-operations-and-constraints",
  "category_id": 7,
  "word_count": 565,
  "deleted_at": null,
  "user_id": 1184,
  "featured_link": null,
  "pinned_globally": false,
  "pinned_at": null,
  "pinned_until": null,
  "image_url": null,
  "slow_mode_seconds": 0,
  "draft": null,
  "draft_key": "topic_3647",
  "draft_sequence": null,
  "unpinned": null,
  "pinned": false,
  "current_post_number": 1,
  "highest_post_number": 3,
  "deleted_by": null,
  "actions_summary": [
    {
      "id": 4,
      "count": 0,
      "hidden": false,
      "can_act": false
    },
    {
      "id": 8,
      "count": 0,
      "hidden": false,
      "can_act": false
    },
    {
      "id": 10,
      "count": 0,
      "hidden": false,
      "can_act": false
    },
    {
      "id": 7,
      "count": 0,
      "hidden": false,
      "can_act": false
    }
  ],
  "chunk_size": 20,
  "bookmarked": false,
  "topic_timer": null,
  "message_bus_last_id": 0,
  "participant_count": 3,
  "show_read_indicator": false,
  "thumbnails": null,
  "slow_mode_enabled_until": null,
  "tags_disable_ads": false,
  "related_topics": [
    {
      "fancy_title": "Feature Request: Additional atomic operations",
      "id": 2782,
      "title": "Feature Request: Additional atomic operations",
      "slug": "feature-request-additional-atomic-operations",
      "posts_count": 4,
      "reply_count": 1,
      "highest_post_number": 4,
      "image_url": null,
      "created_at": "2021-07-07T14:19:46.527Z",
      "last_posted_at": "2021-07-26T05:36:50.122Z",
      "bumped": true,
      "bumped_at": "2021-07-26T05:49:01.617Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 1,
      "views": 1038,
      "category_id": 8,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": null,
          "description": "Original Poster",
          "user": {
            "id": 491,
            "username": "iilyak",
            "name": "Iilyak",
            "avatar_template": "/user_avatar/forums.foundationdb.org/iilyak/{size}/1073_2.png",
            "trust_level": 1
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 15,
            "username": "markus.pilman",
            "name": "Markus Pilman",
            "avatar_template": "/user_avatar/forums.foundationdb.org/markus.pilman/{size}/379_2.png",
            "admin": true,
            "trust_level": 4
          }
        },
        {
          "extras": "latest",
          "description": "Most Recent Poster",
          "user": {
            "id": 485,
            "username": "nblintao",
            "name": "Tao Lin",
            "avatar_template": "/user_avatar/forums.foundationdb.org/nblintao/{size}/484_2.png",
            "trust_level": 2
          }
        }
      ]
    },
    {
      "fancy_title": "How to minimize transaction conflicts on atomic operations?",
      "id": 1051,
      "title": "How to minimize transaction conflicts on atomic operations?",
      "slug": "how-to-minimize-transaction-conflicts-on-atomic-operations",
      "posts_count": 8,
      "reply_count": 4,
      "highest_post_number": 8,
      "image_url": null,
      "created_at": "2019-01-24T15:30:28.527Z",
      "last_posted_at": "2019-01-25T16:01:20.698Z",
      "bumped": true,
      "bumped_at": "2019-01-25T16:01:20.698Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 5,
      "views": 2181,
      "category_id": 9,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": null,
          "description": "Original Poster",
          "user": {
            "id": 323,
            "username": "WolfDan",
            "name": "Wolf Dan",
            "avatar_template": "/user_avatar/forums.foundationdb.org/wolfdan/{size}/806_2.png",
            "trust_level": 2
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 53,
            "username": "KrzysFR",
            "name": "Christophe Chevalier",
            "avatar_template": "/user_avatar/forums.foundationdb.org/krzysfr/{size}/43_2.png",
            "trust_level": 2
          }
        },
        {
          "extras": "latest",
          "description": "Most Recent Poster",
          "user": {
            "id": 81,
            "username": "ryanworl",
            "name": "Ryan Worl",
            "avatar_template": "/user_avatar/forums.foundationdb.org/ryanworl/{size}/440_2.png",
            "trust_level": 3
          }
        }
      ]
    },
    {
      "fancy_title": "Atomic_Add(key, -1) can &ldquo;leak&rdquo; keys with value 0 if you are not careful",
      "id": 148,
      "title": "Atomic_Add(key, -1) can \"leak\" keys with value 0 if you are not careful",
      "slug": "atomic-add-key-1-can-leak-keys-with-value-0-if-you-are-not-careful",
      "posts_count": 5,
      "reply_count": 2,
      "highest_post_number": 5,
      "image_url": null,
      "created_at": "2018-04-20T19:00:47.495Z",
      "last_posted_at": "2018-04-21T10:05:05.991Z",
      "bumped": true,
      "bumped_at": "2018-04-21T10:05:05.991Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 2,
      "views": 817,
      "category_id": 7,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": "latest",
          "description": "Original Poster, Most Recent Poster",
          "user": {
            "id": 53,
            "username": "KrzysFR",
            "name": "Christophe Chevalier",
            "avatar_template": "/user_avatar/forums.foundationdb.org/krzysfr/{size}/43_2.png",
            "trust_level": 2
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 111,
            "username": "andoma",
            "name": "Andreas Smas",
            "avatar_template": "/user_avatar/forums.foundationdb.org/andoma/{size}/78_2.png",
            "trust_level": 1
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 54,
            "username": "Evan",
            "name": "Evan Tschannen",
            "avatar_template": "/user_avatar/forums.foundationdb.org/evan/{size}/104_2.png",
            "moderator": true,
            "trust_level": 1
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 22,
            "username": "dave",
            "name": "David Scherer",
            "avatar_template": "/user_avatar/forums.foundationdb.org/dave/{size}/89_2.png",
            "trust_level": 1
          }
        }
      ]
    },
    {
      "fancy_title": "What&rsquo;s the simplest solution to my use case?",
      "id": 3086,
      "title": "What's the simplest solution to my use case?",
      "slug": "whats-the-simplest-solution-to-my-use-case",
      "posts_count": 2,
      "reply_count": 0,
      "highest_post_number": 2,
      "image_url": null,
      "created_at": "2021-12-17T10:31:54.599Z",
      "last_posted_at": "2021-12-20T19:03:38.952Z",
      "bumped": true,
      "bumped_at": "2021-12-20T19:03:38.952Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [
        "bindings"
      ],
      "tags_descriptions": {},
      "like_count": 0,
      "views": 579,
      "category_id": 7,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": null,
          "description": "Original Poster",
          "user": {
            "id": 1053,
            "username": "Djoak",
            "name": "Djoak",
            "avatar_template": "/user_avatar/forums.foundationdb.org/djoak/{size}/1260_2.png",
            "trust_level": 0
          }
        },
        {
          "extras": "latest",
          "description": "Most Recent Poster",
          "user": {
            "id": 173,
            "username": "jkominek",
            "name": "Jay Kominek",
            "avatar_template": "/user_avatar/forums.foundationdb.org/jkominek/{size}/140_2.png",
            "trust_level": 2
          }
        }
      ]
    },
    {
      "fancy_title": "Optimizing a single large transaction ( 10,000 keys)",
      "id": 1961,
      "title": "Optimizing a single large transaction ( 10,000 keys)",
      "slug": "optimizing-a-single-large-transaction-10-000-keys",
      "posts_count": 12,
      "reply_count": 10,
      "highest_post_number": 12,
      "image_url": null,
      "created_at": "2020-02-17T13:36:55.355Z",
      "last_posted_at": "2020-02-24T11:30:42.854Z",
      "bumped": true,
      "bumped_at": "2020-02-24T11:30:42.854Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [
        "performance"
      ],
      "tags_descriptions": {},
      "like_count": 1,
      "views": 2373,
      "category_id": 7,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": null,
          "description": "Original Poster",
          "user": {
            "id": 645,
            "username": "subramaniamr",
            "name": "Subramaniam R",
            "avatar_template": "/user_avatar/forums.foundationdb.org/subramaniamr/{size}/658_2.png",
            "trust_level": 2
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 8,
            "username": "alloc",
            "name": "Alec Grieser",
            "avatar_template": "/user_avatar/forums.foundationdb.org/alloc/{size}/9_2.png",
            "trust_level": 4
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 13,
            "username": "alexmiller",
            "name": "Alex Miller",
            "avatar_template": "/user_avatar/forums.foundationdb.org/alexmiller/{size}/326_2.png",
            "trust_level": 4
          }
        },
        {
          "extras": "latest",
          "description": "Most Recent Poster",
          "user": {
            "id": 166,
            "username": "gaurav",
            "name": "gaurav",
            "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/g/b487fb/{size}.png",
            "trust_level": 3
          }
        }
      ]
    }
  ],
  "summarizable": false,
  "can_vote": false,
  "vote_count": 0,
  "user_voted": false,
  "discourse_zendesk_plugin_zendesk_id": null,
  "discourse_zendesk_plugin_zendesk_url": "https://your-url.zendesk.com/agent/tickets/",
  "details": {
    "can_edit": false,
    "notification_level": 1,
    "participants": [
      {
        "id": 8,
        "username": "alloc",
        "name": "Alec Grieser",
        "avatar_template": "/user_avatar/forums.foundationdb.org/alloc/{size}/9_2.png",
        "post_count": 1,
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_color": null,
        "flair_bg_color": null,
        "flair_group_id": null,
        "trust_level": 4
      },
      {
        "id": 517,
        "username": "janderland",
        "name": "Jon Anderson",
        "avatar_template": "/user_avatar/forums.foundationdb.org/janderland/{size}/517_2.png",
        "post_count": 1,
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_color": null,
        "flair_bg_color": null,
        "flair_group_id": null,
        "trust_level": 2
      },
      {
        "id": 1184,
        "username": "gytisgreitai",
        "name": "Gytis",
        "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/g/7ba0ec/{size}.png",
        "post_count": 1,
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_color": null,
        "flair_bg_color": null,
        "flair_group_id": null,
        "trust_level": 1
      }
    ],
    "created_by": {
      "id": 1184,
      "username": "gytisgreitai",
      "name": "Gytis",
      "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/g/7ba0ec/{size}.png"
    },
    "last_poster": {
      "id": 517,
      "username": "janderland",
      "name": "Jon Anderson",
      "avatar_template": "/user_avatar/forums.foundationdb.org/janderland/{size}/517_2.png"
    }
  },
  "bookmarks": []
}