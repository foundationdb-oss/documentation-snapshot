{
  "post_stream": {
    "posts": [
      {
        "id": 989,
        "name": "Fabian Lindfors",
        "username": "fabianlindfors",
        "avatar_template": "/user_avatar/forums.foundationdb.org/fabianlindfors/{size}/176_2.png",
        "created_at": "2018-05-09T14:16:00.675Z",
        "cooked": "<p>Hi! To become familiar with FoundationDB I recently tried implementing a simple object store on top of it. It was a very pleasant experience that only got me more excited about the concept of stateless layers.</p>\n<p>I wrote a blog post detailing the implementation, check it out if you like: <a href=\"https://fabianlindfors.se/blog/building-an-object-store-with-foundation-db/\" rel=\"nofollow noopener\">https://fabianlindfors.se/blog/building-an-object-store-with-foundation-db/</a></p>",
        "post_number": 1,
        "post_type": 1,
        "posts_count": 10,
        "updated_at": "2018-05-09T14:16:00.675Z",
        "reply_count": 0,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 1464,
        "reads": 162,
        "readers_count": 161,
        "score": 7508.4,
        "yours": false,
        "topic_id": 387,
        "topic_slug": "object-store-on-foundationdb",
        "display_username": "Fabian Lindfors",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "link_counts": [
          {
            "url": "https://fabianlindfors.se/blog/building-an-object-store-with-foundation-db/",
            "internal": false,
            "reflection": false,
            "title": "Building an object store with FoundationDB \u2013 Fabian Lindfors",
            "clicks": 514
          }
        ],
        "read": true,
        "user_title": null,
        "bookmarked": false,
        "actions_summary": [
          {
            "id": 2,
            "count": 9
          }
        ],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 214,
        "hidden": false,
        "trust_level": 1,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/object-store-on-foundationdb/387/1",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null,
        "can_vote": false
      },
      {
        "id": 1002,
        "name": "Ben Collins",
        "username": "bbc",
        "avatar_template": "/user_avatar/forums.foundationdb.org/bbc/{size}/4_2.png",
        "created_at": "2018-05-09T20:08:30.935Z",
        "cooked": "<p>Thanks for sharing, super cool! The post is spot-on with regards to the layer approach, among other things.</p>\n<p>I like that you\u2019re using the tuple layer to store multiple data \u201celements\u201d for each file (the <code>data</code> and <code>content-type</code>). Additionally, you\u2019re splitting the data over multiple keys and then using prefix range reads to get it all back. Seems like a solid approach.</p>\n<p>This seems quite useful for someone who would like something like S3 for small files and with very low latencies. Maybe it would even be more API compatible some day!</p>",
        "post_number": 2,
        "post_type": 1,
        "posts_count": 10,
        "updated_at": "2018-05-09T20:08:30.935Z",
        "reply_count": 1,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 4,
        "reads": 160,
        "readers_count": 159,
        "score": 72.0,
        "yours": false,
        "topic_id": 387,
        "topic_slug": "object-store-on-foundationdb",
        "display_username": "Ben Collins",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "bookmarked": false,
        "actions_summary": [
          {
            "id": 2,
            "count": 1
          }
        ],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 4,
        "hidden": false,
        "trust_level": 2,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/object-store-on-foundationdb/387/2",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 1007,
        "name": "Fabian Lindfors",
        "username": "fabianlindfors",
        "avatar_template": "/user_avatar/forums.foundationdb.org/fabianlindfors/{size}/176_2.png",
        "created_at": "2018-05-09T21:57:49.409Z",
        "cooked": "<p>Glad to hear! FoundationDB made it dead simple to implement what would otherwise be a quite complex service, especially considering how easy it would be to scale the store out.</p>\n<p>If I find the time it would be great to expand on the concept and build an actual usable object store. Leaving the complexity to FoundationDB makes potential features (such as S3 compatibility) super easy to approach and build.</p>",
        "post_number": 3,
        "post_type": 1,
        "posts_count": 10,
        "updated_at": "2018-05-09T21:57:49.409Z",
        "reply_count": 1,
        "reply_to_post_number": 2,
        "quote_count": 0,
        "incoming_link_count": 115,
        "reads": 155,
        "readers_count": 154,
        "score": 611.0,
        "yours": false,
        "topic_id": 387,
        "topic_slug": "object-store-on-foundationdb",
        "display_username": "Fabian Lindfors",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "reply_to_user": {
          "id": 4,
          "username": "bbc",
          "name": "Ben Collins",
          "avatar_template": "/user_avatar/forums.foundationdb.org/bbc/{size}/4_2.png"
        },
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 214,
        "hidden": false,
        "trust_level": 1,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/object-store-on-foundationdb/387/3",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 1010,
        "name": "Cloudspeech",
        "username": "cloudspeech",
        "avatar_template": "/user_avatar/forums.foundationdb.org/cloudspeech/{size}/330_2.png",
        "created_at": "2018-05-10T04:35:10.104Z",
        "cooked": "<p>I really enjoyed your - well-written - blog post too!</p>\n<p>The questions that popped up, though, were:</p>\n<ul>\n<li>Is the single connection from Go client to FDB a bottleneck in some ways?</li>\n<li>What exactly did you have in mind when writing about the \u2018necessary error handling and validation\u2019 that it lacks?</li>\n<li>What would be your preferred approach to lift the 10MB transaction limit in order to allow larger file objects?</li>\n</ul>\n<p>Any thoughts you can share on this would be greatly appreciated!</p>",
        "post_number": 4,
        "post_type": 1,
        "posts_count": 10,
        "updated_at": "2018-05-10T04:35:10.104Z",
        "reply_count": 1,
        "reply_to_post_number": 3,
        "quote_count": 0,
        "incoming_link_count": 4,
        "reads": 139,
        "readers_count": 138,
        "score": 82.8,
        "yours": false,
        "topic_id": 387,
        "topic_slug": "object-store-on-foundationdb",
        "display_username": "Cloudspeech",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "reply_to_user": {
          "id": 214,
          "username": "fabianlindfors",
          "name": "Fabian Lindfors",
          "avatar_template": "/user_avatar/forums.foundationdb.org/fabianlindfors/{size}/176_2.png"
        },
        "bookmarked": false,
        "actions_summary": [
          {
            "id": 2,
            "count": 2
          }
        ],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 208,
        "hidden": false,
        "trust_level": 1,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/object-store-on-foundationdb/387/4",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 1026,
        "name": "Fabian Lindfors",
        "username": "fabianlindfors",
        "avatar_template": "/user_avatar/forums.foundationdb.org/fabianlindfors/{size}/176_2.png",
        "created_at": "2018-05-10T16:32:27.624Z",
        "cooked": "<p>Thank you!</p>\n<ul>\n<li>I haven\u2019t had a chance to test this. Judging by the Go bindings documentation it seems as all parts are safe for usage in Goroutines hence that should be the only limit. Considering the efficiency of Goroutines I would guess they won\u2019t become a bottleneck but I\u2019m not certain at all.</li>\n<li>Currently the program won\u2019t validate the uploaded file size or content type whatsoever meaning the upload will seem to have been successful even though the file might not have been saved. It also won\u2019t handle any errors from the FDB connection (however unlikely).</li>\n<li>I\u2019m not nearly qualified enough to answers this question but I\u2019m guessing the only way would be to split the upload over multiple transactions. Preferably every transaction should be below 1MB according to the documentation. This of course means losing the ACID guarantees that transactions bring. To avoid concurrent write conflicts some kind of object-level lock would probably have to be implemented but I don\u2019t know how that is best achieved.</li>\n</ul>\n<p>If anyone else has something to add/correct, please chime in!</p>",
        "post_number": 5,
        "post_type": 1,
        "posts_count": 10,
        "updated_at": "2018-05-10T21:54:22.386Z",
        "reply_count": 2,
        "reply_to_post_number": 4,
        "quote_count": 0,
        "incoming_link_count": 11,
        "reads": 131,
        "readers_count": 130,
        "score": 91.2,
        "yours": false,
        "topic_id": 387,
        "topic_slug": "object-store-on-foundationdb",
        "display_username": "Fabian Lindfors",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 2,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "reply_to_user": {
          "id": 208,
          "username": "cloudspeech",
          "name": "Cloudspeech",
          "avatar_template": "/user_avatar/forums.foundationdb.org/cloudspeech/{size}/330_2.png"
        },
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 214,
        "hidden": false,
        "trust_level": 1,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/object-store-on-foundationdb/387/5",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 1027,
        "name": "Amirouche",
        "username": "amirouche",
        "avatar_template": "/user_avatar/forums.foundationdb.org/amirouche/{size}/1911_2.png",
        "created_at": "2018-05-10T16:41:08.294Z",
        "cooked": "<aside class=\"quote no-group quote-modified\" data-username=\"fabianlindfors\" data-post=\"5\" data-topic=\"387\">\n<div class=\"title\">\n<div class=\"quote-controls\"></div>\n<img loading=\"lazy\" alt=\"\" width=\"24\" height=\"24\" src=\"https://sea1.discourse-cdn.com/foundationdb/user_avatar/forums.foundationdb.org/fabianlindfors/48/176_2.png\" class=\"avatar\"> fabianlindfors:</div>\n<blockquote>\n<p>I\u2019m guessing the only way would be to split the upload over multiple transactions. Preferably every transaction should be below 1MB according to the documentation. This of course means losing the ACID guarantees that transactions bring. To avoid concurrent write conflicts some kind of object-level lock would probably have to be implemented but that is best achieved.</p>\n</blockquote>\n</aside>\n<p>I don\u2019t know how the Go bindings work, but in Python implementing something like that will be very challenging. Especially if you want, the blob/object layer to cooperate with other layers and keep the ACID semantic. A crappy solution would be to store the file in disk and use background job to push it into the database\u2026</p>\n<p>By the way, I think the name \u201cobject layer\u201d is misleading it reminds me of <a href=\"http://www.zodb.org/en/latest/\" rel=\"noopener nofollow ugc\">ZODB</a>.</p>",
        "post_number": 6,
        "post_type": 1,
        "posts_count": 10,
        "updated_at": "2018-05-10T16:41:24.246Z",
        "reply_count": 1,
        "reply_to_post_number": 5,
        "quote_count": 1,
        "incoming_link_count": 8,
        "reads": 121,
        "readers_count": 120,
        "score": 84.2,
        "yours": false,
        "topic_id": 387,
        "topic_slug": "object-store-on-foundationdb",
        "display_username": "Amirouche",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "link_counts": [
          {
            "url": "http://www.zodb.org/en/latest/",
            "internal": false,
            "reflection": false,
            "title": "ZODB - a native object database for Python \u2014 ZODB documentation",
            "clicks": 25
          }
        ],
        "read": true,
        "user_title": null,
        "bookmarked": false,
        "actions_summary": [
          {
            "id": 2,
            "count": 1
          }
        ],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 41,
        "hidden": false,
        "trust_level": 2,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/object-store-on-foundationdb/387/6",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 1031,
        "name": "Fabian Lindfors",
        "username": "fabianlindfors",
        "avatar_template": "/user_avatar/forums.foundationdb.org/fabianlindfors/{size}/176_2.png",
        "created_at": "2018-05-10T22:16:22.826Z",
        "cooked": "<p>From what I understand there are no differences in capabilities between the Go and Python bindings. If at the beginning of an upload the file hash is added to FDB as a type of lock, it could be checked at the beginning of each sequential transaction to ensure the object hasn\u2019t been overwritten by a different upload. Once all the transactions succeed, the rest of the metadata could be added and not until then is the object/file ready to be read. This way we can ensure an object won\u2019t be read unless it\u2019s fully uploaded. If there are two separate uploads, the earlier one would fail early because it checks the hash for each transaction, ensuring the two uploads won\u2019t overwrite each other. Once again, I\u2019m not qualified to answer this but it might be a resonable solution.</p>\n<p>Regarding the naming, I agree that \u201cobject store\u201d is a way too generic name. It does however seem to be an accepted term at least in the sphere of cloud services, both AWS and Google Cloud uses it for example.</p>",
        "post_number": 7,
        "post_type": 1,
        "posts_count": 10,
        "updated_at": "2018-05-10T22:16:22.826Z",
        "reply_count": 0,
        "reply_to_post_number": 6,
        "quote_count": 0,
        "incoming_link_count": 5,
        "reads": 116,
        "readers_count": 115,
        "score": 48.2,
        "yours": false,
        "topic_id": 387,
        "topic_slug": "object-store-on-foundationdb",
        "display_username": "Fabian Lindfors",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "reply_to_user": {
          "id": 41,
          "username": "amirouche",
          "name": "Amirouche",
          "avatar_template": "/user_avatar/forums.foundationdb.org/amirouche/{size}/1911_2.png"
        },
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 214,
        "hidden": false,
        "trust_level": 1,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/object-store-on-foundationdb/387/7",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 1160,
        "name": "Ben Collins",
        "username": "bbc",
        "avatar_template": "/user_avatar/forums.foundationdb.org/bbc/{size}/4_2.png",
        "created_at": "2018-05-17T16:08:00.265Z",
        "cooked": "<p>I should have noticed and commented earlier\u2026</p>\n<aside class=\"quote no-group quote-modified\" data-username=\"fabianlindfors\" data-post=\"5\" data-topic=\"387\">\n<div class=\"title\">\n<div class=\"quote-controls\"></div>\n<img loading=\"lazy\" alt=\"\" width=\"24\" height=\"24\" src=\"https://sea1.discourse-cdn.com/foundationdb/user_avatar/forums.foundationdb.org/fabianlindfors/48/176_2.png\" class=\"avatar\"> fabianlindfors:</div>\n<blockquote>\n<p>\u2026I\u2019m guessing the only way would be to split the upload over multiple transactions. Preferably every transaction should be below 1MB according to the documentation. This of course means losing the ACID guarantees that transactions bring.</p>\n</blockquote>\n</aside>\n<p>Splitting work across transactions is a common pattern and there\u2019s often a pretty clean way to make this work  while maintaining ACID properties. Generally, the approach is to add a layer of indirection between the data \u201cchunks\u201d and the notion of a completed \u201cfile\u201d. A data model could comprise two types of tuples, one for file paths and one for data chunks:</p>\n<pre><code class=\"lang-auto\">files/file1 = [id1]\nfiles/file2 = [id2]\n...\ndata/id1/chunk1 = [bytes]\ndata/id1/chunk2 = [bytes]\ndata/id1/chunk3 = [bytes]\ndata/id2/chunk1 = [bytes]\n</code></pre>\n<p>A process to make this work could be:</p>\n<ol>\n<li>At the client determine an unique ID for the data contents. Let\u2019s say this <code>42</code> for this example.</li>\n<li>Begin, over the course of multiple transactions, to upload data into the <code>data</code> section of the database.</li>\n<li>When the uploads are all complete, set the <code>files/x</code> key pointing to the correct region of <code>data</code> space.</li>\n</ol>\n<p>A few considerations: this will work most simply for immutable files. Reads for especially large files could take more than 5 seconds and therefore have to span more than one transaction. This is trivial if the files are not changing and, if they are changing, could also be easily be done by simply pointing the <code>file</code> to a new data chuck region (at the risk of reading consistent and complete copies of deleted or modified files).</p>\n<p>Hopefully that something to get you started!</p>",
        "post_number": 8,
        "post_type": 1,
        "posts_count": 10,
        "updated_at": "2018-05-17T16:08:00.265Z",
        "reply_count": 1,
        "reply_to_post_number": 5,
        "quote_count": 1,
        "incoming_link_count": 320,
        "reads": 102,
        "readers_count": 101,
        "score": 1650.4,
        "yours": false,
        "topic_id": 387,
        "topic_slug": "object-store-on-foundationdb",
        "display_username": "Ben Collins",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "link_counts": [
          {
            "url": "https://forums.foundationdb.org/t/looking-for-layer-design-documentation/946/6",
            "internal": true,
            "reflection": true,
            "title": "Looking for layer design documentation",
            "clicks": 3
          }
        ],
        "read": true,
        "user_title": null,
        "bookmarked": false,
        "actions_summary": [
          {
            "id": 2,
            "count": 2
          }
        ],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 4,
        "hidden": false,
        "trust_level": 2,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/object-store-on-foundationdb/387/8",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 1162,
        "name": "Fabian Lindfors",
        "username": "fabianlindfors",
        "avatar_template": "/user_avatar/forums.foundationdb.org/fabianlindfors/{size}/176_2.png",
        "created_at": "2018-05-17T19:40:50.185Z",
        "cooked": "<p>Thanks for laying this out Ben!</p>\n<p>Seems like a good way of handling the transaction limits. Was thinking that one could potentially use a hash of the file contents as the ID. This way duplicate files across the store won\u2019t be stored redundantly and it would enable a stateless way of generating an unique ID. It might cause problems with file deletions but that could easily solved by some kind of atomic reference counter. Thoughts?</p>\n<p>Hope I find the time to extend the code with your suggestions!</p>",
        "post_number": 9,
        "post_type": 1,
        "posts_count": 10,
        "updated_at": "2018-05-17T19:40:50.185Z",
        "reply_count": 1,
        "reply_to_post_number": 8,
        "quote_count": 0,
        "incoming_link_count": 15,
        "reads": 99,
        "readers_count": 98,
        "score": 99.8,
        "yours": false,
        "topic_id": 387,
        "topic_slug": "object-store-on-foundationdb",
        "display_username": "Fabian Lindfors",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "reply_to_user": {
          "id": 4,
          "username": "bbc",
          "name": "Ben Collins",
          "avatar_template": "/user_avatar/forums.foundationdb.org/bbc/{size}/4_2.png"
        },
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 214,
        "hidden": false,
        "trust_level": 1,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/object-store-on-foundationdb/387/9",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 1165,
        "name": "Alec Grieser",
        "username": "alloc",
        "avatar_template": "/user_avatar/forums.foundationdb.org/alloc/{size}/9_2.png",
        "created_at": "2018-05-18T00:29:04.022Z",
        "cooked": "<p>Yeah, that sounds reasonable enough to me (assuming that <a href=\"https://shattered.it\">hash collisions aren\u2019t a problem</a>).</p>\n<p>One problem that you could run into with the atomic reference counter approach is contention on the counter. I can see roughly three approaches:</p>\n<ol>\n<li>You add a read conflict and a write conflict to the reference counter each transaction. This is the simplest and is probably fine if you don\u2019t expect multiple objects with the same hash all that often (which <em>should</em> be the case for most files\u2013maybe not the empty file, but perhaps that should be handled differently anyways\u2026).</li>\n<li>You can use <a href=\"https://apple.github.io/foundationdb/developer-guide.html#atomic-operations\">atomic ops</a> to increment the reference counter on insertions, but add the read-conflict key on deletes anyway. This lets you have conflict free inserts, but your deletions might conflict if two people decrement a reference counter at the same time. (You will also need to add a read conflict range to the data themselves or you might increment the counter while concurrently deleting\u2013oops.) Then the delete logic is (1) do a read (with a conflict range), (2) decrement, and (3) if it hits zero, delete the object itself. Two things might end up doing (1) and (2) at the same time, but the resolver will fail one of them, and when it retries, it will re-do (1) and (2) before (maybe) doing (3).</li>\n<li>Garbage collection! Then all of your updates to the reference counter are conflict free, but you need to periodically sweep all of the reference counting things (using a conflict-free range read), then for all that are zero, add read a read conflict key on that key and delete the data. (You will still need to add a read conflict key on the data on insertions as in the second option.) This allows everything to be conflict free at the expense of keeping deleted objects around a little longer than necessary. (But it also means that if you have some weird pattern where a specific document keeps getting uploaded and deleted and uploaded again, then because you are lazily deleting things, each upload (after the first one) is essentially free.) The downside is that now you need a sweep job, and you also need to sweep over <em>all</em> counters.*</li>\n</ol>\n<p>My guess is that the second option is probably good enough and probably what you\u2019d want to do, but it really will depend on the rate of deletes to your store, how hot your system is (because (3) might create hot keys), and how often people upload the same document twice (as either (2) or (3) might be pre-mature optimization if (1) will do just fine.</p>\n<hr>\n<p>* Or <em>do</em> you? If you get really spiffy, you can do something like keep a hierarchical data structure where for each range of reference counters, you can keep another key that you increment (or maybe max with 1 or use as a bit mask if you want to be really fancy) whenever you do a delete. Then, you only need to sweep over (1) the range of those secondary keys and (2) any range of reference counters that have had any deletes. On a sweep, you can zero out that secondary entry (you will need to add a read conflict key before you zero it out in case there is a concurrent delete in that range) after removing all of the things that have been deleted forever. If that still is too many keys, you can add another layer of the same on top of that key and so on.</p>",
        "post_number": 10,
        "post_type": 1,
        "posts_count": 10,
        "updated_at": "2018-05-18T00:29:04.022Z",
        "reply_count": 0,
        "reply_to_post_number": 9,
        "quote_count": 0,
        "incoming_link_count": 17,
        "reads": 96,
        "readers_count": 95,
        "score": 171.2,
        "yours": false,
        "topic_id": 387,
        "topic_slug": "object-store-on-foundationdb",
        "display_username": "Alec Grieser",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "link_counts": [
          {
            "url": "https://shattered.it",
            "internal": false,
            "reflection": false,
            "title": "SHAttered",
            "clicks": 28
          },
          {
            "url": "https://apple.github.io/foundationdb/developer-guide.html#atomic-operations",
            "internal": false,
            "reflection": false,
            "title": "Developer Guide \u2014 FoundationDB 5.1",
            "clicks": 14
          }
        ],
        "read": true,
        "user_title": null,
        "reply_to_user": {
          "id": 214,
          "username": "fabianlindfors",
          "name": "Fabian Lindfors",
          "avatar_template": "/user_avatar/forums.foundationdb.org/fabianlindfors/{size}/176_2.png"
        },
        "bookmarked": false,
        "actions_summary": [
          {
            "id": 2,
            "count": 4
          }
        ],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 8,
        "hidden": false,
        "trust_level": 4,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/object-store-on-foundationdb/387/10",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      }
    ],
    "stream": [
      989,
      1002,
      1007,
      1010,
      1026,
      1027,
      1031,
      1160,
      1162,
      1165
    ]
  },
  "timeline_lookup": [
    [
      1,
      2722
    ],
    [
      5,
      2721
    ],
    [
      8,
      2714
    ]
  ],
  "suggested_topics": [],
  "tags": [],
  "tags_descriptions": {},
  "fancy_title": "Object store on FoundationDB",
  "id": 387,
  "title": "Object store on FoundationDB",
  "posts_count": 10,
  "created_at": "2018-05-09T14:16:00.544Z",
  "views": 5055,
  "reply_count": 8,
  "like_count": 19,
  "last_posted_at": "2018-05-18T00:29:04.022Z",
  "visible": true,
  "closed": false,
  "archived": false,
  "has_summary": false,
  "archetype": "regular",
  "slug": "object-store-on-foundationdb",
  "category_id": 9,
  "word_count": 1816,
  "deleted_at": null,
  "user_id": 214,
  "featured_link": null,
  "pinned_globally": false,
  "pinned_at": null,
  "pinned_until": null,
  "image_url": null,
  "slow_mode_seconds": 0,
  "draft": null,
  "draft_key": "topic_387",
  "draft_sequence": null,
  "unpinned": null,
  "pinned": false,
  "current_post_number": 1,
  "highest_post_number": 10,
  "deleted_by": null,
  "actions_summary": [
    {
      "id": 4,
      "count": 0,
      "hidden": false,
      "can_act": false
    },
    {
      "id": 8,
      "count": 0,
      "hidden": false,
      "can_act": false
    },
    {
      "id": 10,
      "count": 0,
      "hidden": false,
      "can_act": false
    },
    {
      "id": 7,
      "count": 0,
      "hidden": false,
      "can_act": false
    }
  ],
  "chunk_size": 20,
  "bookmarked": false,
  "topic_timer": null,
  "message_bus_last_id": 0,
  "participant_count": 5,
  "show_read_indicator": false,
  "thumbnails": null,
  "slow_mode_enabled_until": null,
  "tags_disable_ads": false,
  "related_topics": [
    {
      "fancy_title": "A few design-pattern + check-my-understanding questions",
      "id": 1153,
      "title": "A few design-pattern + check-my-understanding questions",
      "slug": "a-few-design-pattern-check-my-understanding-questions",
      "posts_count": 10,
      "reply_count": 6,
      "highest_post_number": 10,
      "image_url": null,
      "created_at": "2019-02-19T15:18:58.329Z",
      "last_posted_at": "2019-02-21T19:51:53.686Z",
      "bumped": true,
      "bumped_at": "2019-02-21T19:51:53.686Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 1,
      "views": 2273,
      "category_id": 7,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": null,
          "description": "Original Poster",
          "user": {
            "id": 519,
            "username": "JamesThompson",
            "name": "James Thompson",
            "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/j/c67d28/{size}.png",
            "trust_level": 1
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 173,
            "username": "jkominek",
            "name": "Jay Kominek",
            "avatar_template": "/user_avatar/forums.foundationdb.org/jkominek/{size}/140_2.png",
            "trust_level": 2
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 12,
            "username": "ajbeamon",
            "name": "A.J. Beamon",
            "avatar_template": "/user_avatar/forums.foundationdb.org/ajbeamon/{size}/13_2.png",
            "admin": true,
            "trust_level": 4
          }
        },
        {
          "extras": "latest",
          "description": "Most Recent Poster",
          "user": {
            "id": 53,
            "username": "KrzysFR",
            "name": "Christophe Chevalier",
            "avatar_template": "/user_avatar/forums.foundationdb.org/krzysfr/{size}/43_2.png",
            "trust_level": 2
          }
        }
      ]
    },
    {
      "fancy_title": "FDB over other databases for small to large sites",
      "id": 247,
      "title": "FDB over other databases for small to large sites",
      "slug": "fdb-over-other-databases-for-small-to-large-sites",
      "posts_count": 3,
      "reply_count": 0,
      "highest_post_number": 3,
      "image_url": null,
      "created_at": "2018-04-24T17:01:49.234Z",
      "last_posted_at": "2018-04-25T09:37:04.247Z",
      "bumped": true,
      "bumped_at": "2018-04-25T09:37:04.247Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 3,
      "views": 2882,
      "category_id": 7,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": null,
          "description": "Original Poster",
          "user": {
            "id": 131,
            "username": "proyb",
            "name": "",
            "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/p/76d3ee/{size}.png",
            "trust_level": 1
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 9,
            "username": "mbhaskar",
            "name": "Bhaskar Muppana",
            "avatar_template": "/user_avatar/forums.foundationdb.org/mbhaskar/{size}/277_2.png",
            "trust_level": 4
          }
        },
        {
          "extras": "latest",
          "description": "Most Recent Poster",
          "user": {
            "id": 41,
            "username": "amirouche",
            "name": "Amirouche",
            "avatar_template": "/user_avatar/forums.foundationdb.org/amirouche/{size}/1911_2.png",
            "trust_level": 2
          }
        }
      ]
    },
    {
      "fancy_title": "Intent/roadmap to handle larger value sizes?",
      "id": 126,
      "title": "Intent/roadmap to handle larger value sizes?",
      "slug": "intent-roadmap-to-handle-larger-value-sizes",
      "posts_count": 6,
      "reply_count": 3,
      "highest_post_number": 6,
      "image_url": null,
      "created_at": "2018-04-20T13:08:00.621Z",
      "last_posted_at": "2018-04-20T19:19:17.886Z",
      "bumped": true,
      "bumped_at": "2018-04-20T19:19:17.886Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 3,
      "views": 2197,
      "category_id": 8,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": null,
          "description": "Original Poster",
          "user": {
            "id": 87,
            "username": "ringods",
            "name": "Ringo De Smet",
            "avatar_template": "/user_avatar/forums.foundationdb.org/ringods/{size}/61_2.png",
            "trust_level": 0
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 78,
            "username": "pineapple",
            "name": "Brian Haslet",
            "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/p/7993a0/{size}.png",
            "trust_level": 1
          }
        },
        {
          "extras": "latest",
          "description": "Most Recent Poster",
          "user": {
            "id": 53,
            "username": "KrzysFR",
            "name": "Christophe Chevalier",
            "avatar_template": "/user_avatar/forums.foundationdb.org/krzysfr/{size}/43_2.png",
            "trust_level": 2
          }
        }
      ]
    },
    {
      "fancy_title": "Looking for feedback on a Go FoundationDB blob store",
      "id": 3855,
      "title": "Looking for feedback on a Go FoundationDB blob store",
      "slug": "looking-for-feedback-on-a-go-foundationdb-blob-store",
      "posts_count": 3,
      "reply_count": 0,
      "highest_post_number": 3,
      "image_url": null,
      "created_at": "2023-03-15T07:38:50.003Z",
      "last_posted_at": "2023-03-29T06:46:10.838Z",
      "bumped": true,
      "bumped_at": "2023-03-29T06:46:10.838Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 0,
      "views": 578,
      "category_id": 9,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": "latest",
          "description": "Original Poster, Most Recent Poster",
          "user": {
            "id": 1226,
            "username": "sunesimonsen",
            "name": "Sune Simonsen",
            "avatar_template": "/user_avatar/forums.foundationdb.org/sunesimonsen/{size}/1539_2.png",
            "trust_level": 0
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 41,
            "username": "amirouche",
            "name": "Amirouche",
            "avatar_template": "/user_avatar/forums.foundationdb.org/amirouche/{size}/1911_2.png",
            "trust_level": 2
          }
        }
      ]
    },
    {
      "fancy_title": "Optimizing a single large transaction ( 10,000 keys)",
      "id": 1961,
      "title": "Optimizing a single large transaction ( 10,000 keys)",
      "slug": "optimizing-a-single-large-transaction-10-000-keys",
      "posts_count": 12,
      "reply_count": 10,
      "highest_post_number": 12,
      "image_url": null,
      "created_at": "2020-02-17T13:36:55.355Z",
      "last_posted_at": "2020-02-24T11:30:42.854Z",
      "bumped": true,
      "bumped_at": "2020-02-24T11:30:42.854Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [
        "performance"
      ],
      "tags_descriptions": {},
      "like_count": 1,
      "views": 2373,
      "category_id": 7,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": null,
          "description": "Original Poster",
          "user": {
            "id": 645,
            "username": "subramaniamr",
            "name": "Subramaniam R",
            "avatar_template": "/user_avatar/forums.foundationdb.org/subramaniamr/{size}/658_2.png",
            "trust_level": 2
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 8,
            "username": "alloc",
            "name": "Alec Grieser",
            "avatar_template": "/user_avatar/forums.foundationdb.org/alloc/{size}/9_2.png",
            "trust_level": 4
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 13,
            "username": "alexmiller",
            "name": "Alex Miller",
            "avatar_template": "/user_avatar/forums.foundationdb.org/alexmiller/{size}/326_2.png",
            "trust_level": 4
          }
        },
        {
          "extras": "latest",
          "description": "Most Recent Poster",
          "user": {
            "id": 166,
            "username": "gaurav",
            "name": "gaurav",
            "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/g/b487fb/{size}.png",
            "trust_level": 3
          }
        }
      ]
    }
  ],
  "summarizable": false,
  "can_vote": false,
  "vote_count": 0,
  "user_voted": false,
  "discourse_zendesk_plugin_zendesk_id": null,
  "discourse_zendesk_plugin_zendesk_url": "https://your-url.zendesk.com/agent/tickets/",
  "details": {
    "can_edit": false,
    "notification_level": 1,
    "participants": [
      {
        "id": 214,
        "username": "fabianlindfors",
        "name": "Fabian Lindfors",
        "avatar_template": "/user_avatar/forums.foundationdb.org/fabianlindfors/{size}/176_2.png",
        "post_count": 5,
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_color": null,
        "flair_bg_color": null,
        "flair_group_id": null,
        "trust_level": 1
      },
      {
        "id": 4,
        "username": "bbc",
        "name": "Ben Collins",
        "avatar_template": "/user_avatar/forums.foundationdb.org/bbc/{size}/4_2.png",
        "post_count": 2,
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_color": null,
        "flair_bg_color": null,
        "flair_group_id": null,
        "trust_level": 2
      },
      {
        "id": 8,
        "username": "alloc",
        "name": "Alec Grieser",
        "avatar_template": "/user_avatar/forums.foundationdb.org/alloc/{size}/9_2.png",
        "post_count": 1,
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_color": null,
        "flair_bg_color": null,
        "flair_group_id": null,
        "trust_level": 4
      },
      {
        "id": 41,
        "username": "amirouche",
        "name": "Amirouche",
        "avatar_template": "/user_avatar/forums.foundationdb.org/amirouche/{size}/1911_2.png",
        "post_count": 1,
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_color": null,
        "flair_bg_color": null,
        "flair_group_id": null,
        "trust_level": 2
      },
      {
        "id": 208,
        "username": "cloudspeech",
        "name": "Cloudspeech",
        "avatar_template": "/user_avatar/forums.foundationdb.org/cloudspeech/{size}/330_2.png",
        "post_count": 1,
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_color": null,
        "flair_bg_color": null,
        "flair_group_id": null,
        "trust_level": 1
      }
    ],
    "created_by": {
      "id": 214,
      "username": "fabianlindfors",
      "name": "Fabian Lindfors",
      "avatar_template": "/user_avatar/forums.foundationdb.org/fabianlindfors/{size}/176_2.png"
    },
    "last_poster": {
      "id": 8,
      "username": "alloc",
      "name": "Alec Grieser",
      "avatar_template": "/user_avatar/forums.foundationdb.org/alloc/{size}/9_2.png"
    },
    "links": [
      {
        "url": "https://fabianlindfors.se/blog/building-an-object-store-with-foundation-db/",
        "title": "Building an object store with FoundationDB \u2013 Fabian Lindfors",
        "internal": false,
        "attachment": false,
        "reflection": false,
        "clicks": 514,
        "user_id": 214,
        "domain": "fabianlindfors.se",
        "root_domain": "fabianlindfors.se"
      },
      {
        "url": "https://shattered.it",
        "title": "SHAttered",
        "internal": false,
        "attachment": false,
        "reflection": false,
        "clicks": 28,
        "user_id": 8,
        "domain": "shattered.it",
        "root_domain": "shattered.it"
      },
      {
        "url": "http://www.zodb.org/en/latest/",
        "title": "ZODB - a native object database for Python \u2014 ZODB documentation",
        "internal": false,
        "attachment": false,
        "reflection": false,
        "clicks": 25,
        "user_id": 41,
        "domain": "www.zodb.org",
        "root_domain": "zodb.org"
      },
      {
        "url": "https://apple.github.io/foundationdb/developer-guide.html#atomic-operations",
        "title": "Developer Guide \u2014 FoundationDB 5.1",
        "internal": false,
        "attachment": false,
        "reflection": false,
        "clicks": 14,
        "user_id": 8,
        "domain": "apple.github.io",
        "root_domain": "apple.github.io"
      },
      {
        "url": "https://forums.foundationdb.org/t/looking-for-layer-design-documentation/946/6",
        "title": "Looking for layer design documentation",
        "internal": true,
        "attachment": false,
        "reflection": true,
        "clicks": 3,
        "user_id": 41,
        "domain": "forums.foundationdb.org",
        "root_domain": "foundationdb.org"
      }
    ]
  },
  "bookmarks": []
}