{
  "post_stream": {
    "posts": [
      {
        "id": 7356,
        "name": null,
        "username": "imtdk",
        "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/i/22d042/{size}.png",
        "created_at": "2020-06-15T15:45:43.732Z",
        "cooked": "<p>We are running a foundationdb cluster with the following configuration -</p>\n<pre><code>Configuration:\n  Redundancy mode        - triple\n  Storage engine         - ssd-2\n  Coordinators           - 8\n\nCluster:\n  FoundationDB processes - 37\n  Zones                  - 8\n  Machines               - 8\n  Memory availability    - 7.2 GB per process on machine with least available\n  Retransmissions rate   - 1 Hz\n  Fault Tolerance        - 2 machines\n</code></pre>\n<p>The process class configuration is -<br>\n4 storage + 1 proxy on 3 nodes<br>\n4 storage + 1 stateless on 2 nodes<br>\n1 log + 3 stateless on 3 nodes<br>\nEvery machine has a single ssd.</p>\n<p>We observe periods with spikes in disk I/O (75-80% on some processes) where the transaction processing latency spikes up quite a bit, high disk I/O doesn\u2019t always lead to high latency but there are sustained periods (~2hr) where processing of transactions is very slow (and disk I/O is high). Very often this coincides with a decrease in the total disk space used (or happens around this time) but there doesn\u2019t seem to be a correlation with the number of clear key transactions with the latency spikes. Sometimes a large number of these types<br>\nof transactions are processed with minimal latency. Also it is not the case that the write rate is low during these periods.<br>\nWe want to figure out if there\u2019s something that we are missing that might be happening in the cluster leading to these periods of sustained high latency.</p>",
        "post_number": 1,
        "post_type": 1,
        "posts_count": 22,
        "updated_at": "2020-06-15T15:45:43.732Z",
        "reply_count": 0,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 480,
        "reads": 90,
        "readers_count": 89,
        "score": 2418.0,
        "yours": false,
        "topic_id": 2184,
        "topic_slug": "foundationdb-cluster-performance-issue-periods-of-high-disk-i-o-and-sustained-high-latency",
        "display_username": null,
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "link_counts": [
          {
            "url": "https://forums.foundationdb.org/t/unexpected-repartitioning-of-the-database/2225",
            "internal": true,
            "reflection": true,
            "title": "Unexpected repartitioning of the database",
            "clicks": 1
          }
        ],
        "read": true,
        "user_title": null,
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 779,
        "hidden": false,
        "trust_level": 1,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/foundationdb-cluster-performance-issue-periods-of-high-disk-i-o-and-sustained-high-latency/2184/1",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null,
        "can_vote": false
      },
      {
        "id": 7360,
        "name": "Steve Atherton",
        "username": "SteavedHams",
        "avatar_template": "/user_avatar/forums.foundationdb.org/steavedhams/{size}/18_2.png",
        "created_at": "2020-06-16T03:25:21.950Z",
        "cooked": "<p>Are you cleaning keys or ranges?  The number of clears does not so much matter, but the scope of the clears does.  The <code>ssd-2</code> engine has to do a lot of deferred cleanup over time after a large clear.</p>\n<p>Also, 4 storage processes on a single SSD is probably too many.  For <code>ssd-2</code>, two storage processes per disk is likely better than one because it will make better use of the disk\u2019s IOPS budget for writes and deferred cleanup work because the storage engine has low parallelism for those things, but three storage processes per disk is likely too many.</p>",
        "post_number": 2,
        "post_type": 1,
        "posts_count": 22,
        "updated_at": "2020-06-16T03:25:21.950Z",
        "reply_count": 1,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 11,
        "reads": 83,
        "readers_count": 82,
        "score": 91.6,
        "yours": false,
        "topic_id": 2184,
        "topic_slug": "foundationdb-cluster-performance-issue-periods-of-high-disk-i-o-and-sustained-high-latency",
        "display_username": "Steve Atherton",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": "",
        "bookmarked": false,
        "actions_summary": [
          {
            "id": 2,
            "count": 1
          }
        ],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 7,
        "hidden": false,
        "trust_level": 4,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/foundationdb-cluster-performance-issue-periods-of-high-disk-i-o-and-sustained-high-latency/2184/2",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 7361,
        "name": "Subramaniam R",
        "username": "subramaniamr",
        "avatar_template": "/user_avatar/forums.foundationdb.org/subramaniamr/{size}/658_2.png",
        "created_at": "2020-06-16T06:52:08.475Z",
        "cooked": "<aside class=\"quote no-group\" data-username=\"SteavedHams\" data-post=\"2\" data-topic=\"2184\">\n<div class=\"title\">\n<div class=\"quote-controls\"></div>\n<img loading=\"lazy\" alt=\"\" width=\"24\" height=\"24\" src=\"https://sea1.discourse-cdn.com/foundationdb/user_avatar/forums.foundationdb.org/steavedhams/48/18_2.png\" class=\"avatar\"> SteavedHams:</div>\n<blockquote>\n<p>Are you cleaning keys or ranges? The number of clears does not so much matter, but the scope of the clears does.</p>\n</blockquote>\n</aside>\n<p>We clean individual keys but quite a bit of them - clearing 1 million keys over a period of few minutes is common. this will spread across tens of thousands of txns.</p>\n<aside class=\"quote no-group\" data-username=\"SteavedHams\" data-post=\"2\" data-topic=\"2184\">\n<div class=\"title\">\n<div class=\"quote-controls\"></div>\n<img loading=\"lazy\" alt=\"\" width=\"24\" height=\"24\" src=\"https://sea1.discourse-cdn.com/foundationdb/user_avatar/forums.foundationdb.org/steavedhams/48/18_2.png\" class=\"avatar\"> SteavedHams:</div>\n<blockquote>\n<p>The <code>ssd-2</code> engine has to do a lot of deferred cleanup over time after a large clear.</p>\n</blockquote>\n</aside>\n<p>The biggest issue here is we have no visibility on whether there is some actions going on the background ( moving or purging data) that will spike up the disk usage.</p>\n<p>Based on what I see after certain number of deletes some switch gets flipped (which we have no visibility) and disk goes crazy.</p>\n<p>Even if the no.of.storage servers are a problem based on what parameters we can determine that is actually the problem ? I cant make much out of status.json details.</p>",
        "post_number": 3,
        "post_type": 1,
        "posts_count": 22,
        "updated_at": "2020-06-16T06:52:08.475Z",
        "reply_count": 1,
        "reply_to_post_number": null,
        "quote_count": 1,
        "incoming_link_count": 4,
        "reads": 79,
        "readers_count": 78,
        "score": 40.8,
        "yours": false,
        "topic_id": 2184,
        "topic_slug": "foundationdb-cluster-performance-issue-periods-of-high-disk-i-o-and-sustained-high-latency",
        "display_username": "Subramaniam R",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 645,
        "hidden": false,
        "trust_level": 2,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/foundationdb-cluster-performance-issue-periods-of-high-disk-i-o-and-sustained-high-latency/2184/3",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 7362,
        "name": "Steve Atherton",
        "username": "SteavedHams",
        "avatar_template": "/user_avatar/forums.foundationdb.org/steavedhams/{size}/18_2.png",
        "created_at": "2020-06-16T07:24:58.831Z",
        "cooked": "<p>How large are your keys and values?</p>\n<p>You can look in the trace log for <code>DiskMetrics</code> and <code>SpringCleaningMetrics</code> events for some details about what I/O operations the <code>ssd-2</code> engine is doing.</p>\n<p>You also might want to try the upcoming Redwood storage engine.  The first performant version of it will be in FDB 6.3, which should be officially released in the near future, but if you want to try it now and don\u2019t mind building FDB yourself it is available in the <code>release-6.3</code> branch and called <code>ssd-redwood-experimental</code>.</p>\n<p>I suspect that Redwood\u2019s performance will be more consistent over time.  It also might be higher, depending on your workload.  In any case, its metrics events (<code>RedwoodMetrics</code>) give a lot of insight into what the storage engine is doing and about your workload.</p>",
        "post_number": 4,
        "post_type": 1,
        "posts_count": 22,
        "updated_at": "2020-06-16T07:24:58.831Z",
        "reply_count": 1,
        "reply_to_post_number": 3,
        "quote_count": 0,
        "incoming_link_count": 4,
        "reads": 76,
        "readers_count": 75,
        "score": 40.2,
        "yours": false,
        "topic_id": 2184,
        "topic_slug": "foundationdb-cluster-performance-issue-periods-of-high-disk-i-o-and-sustained-high-latency",
        "display_username": "Steve Atherton",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": "",
        "reply_to_user": {
          "id": 645,
          "username": "subramaniamr",
          "name": "Subramaniam R",
          "avatar_template": "/user_avatar/forums.foundationdb.org/subramaniamr/{size}/658_2.png"
        },
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 7,
        "hidden": false,
        "trust_level": 4,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/foundationdb-cluster-performance-issue-periods-of-high-disk-i-o-and-sustained-high-latency/2184/4",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 7363,
        "name": "Subramaniam R",
        "username": "subramaniamr",
        "avatar_template": "/user_avatar/forums.foundationdb.org/subramaniamr/{size}/658_2.png",
        "created_at": "2020-06-16T07:53:46.320Z",
        "cooked": "<p>Thanks a lot for quick reply.</p>\n<aside class=\"quote no-group\" data-username=\"SteavedHams\" data-post=\"4\" data-topic=\"2184\">\n<div class=\"title\">\n<div class=\"quote-controls\"></div>\n<img loading=\"lazy\" alt=\"\" width=\"24\" height=\"24\" src=\"https://sea1.discourse-cdn.com/foundationdb/user_avatar/forums.foundationdb.org/steavedhams/48/18_2.png\" class=\"avatar\"> SteavedHams:</div>\n<blockquote>\n<p>How large are your keys and values?</p>\n</blockquote>\n</aside>\n<p>Keys - less than 64 bytes.<br>\nValues - Varies, mostly about 32kb but there can be few that exceeds 1mb.</p>\n<p>I will look into tracelogs and come back on anything suspicious.</p>",
        "post_number": 5,
        "post_type": 1,
        "posts_count": 22,
        "updated_at": "2020-06-16T07:53:46.320Z",
        "reply_count": 1,
        "reply_to_post_number": 4,
        "quote_count": 1,
        "incoming_link_count": 2,
        "reads": 70,
        "readers_count": 69,
        "score": 44.0,
        "yours": false,
        "topic_id": 2184,
        "topic_slug": "foundationdb-cluster-performance-issue-periods-of-high-disk-i-o-and-sustained-high-latency",
        "display_username": "Subramaniam R",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "bookmarked": false,
        "actions_summary": [
          {
            "id": 2,
            "count": 1
          }
        ],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 645,
        "hidden": false,
        "trust_level": 2,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/foundationdb-cluster-performance-issue-periods-of-high-disk-i-o-and-sustained-high-latency/2184/5",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 7364,
        "name": "Steve Atherton",
        "username": "SteavedHams",
        "avatar_template": "/user_avatar/forums.foundationdb.org/steavedhams/{size}/18_2.png",
        "created_at": "2020-06-16T09:22:06.018Z",
        "cooked": "<p>Are you splitting the 1MB values into chunks, or did you override the value size limit knob?  Normally values are limited to 100kb.</p>\n<p>In any case, these value sizes cause a terrible I/O pattern on the <code>ssd-2</code> engine.  Every 32kb value is made of a linked list of 8 pages, 4kb each, and due to the serial nature of a linked list in order to clear one of the keys each of those value pages must be read, serially, to find the next page in the sequence and free it for reuse.  Over time, the pages that comprise one of these large values could randomly become more spread throughout the data file, and this further increases the write operations required for a set or clear because when whole pages are added to or removed from a large value there are metadata pages that must be updated.  The more random the value page set is, the larger the covering metadata page set will be.</p>\n<p>I suspect you will see better performance with the <code>ssd-redwood-experimental</code> storage engine, if not now then in the future (it is still being improved), though be aware that it will not leave the <code>experimental</code> stage for a while.</p>",
        "post_number": 6,
        "post_type": 1,
        "posts_count": 22,
        "updated_at": "2020-06-16T09:22:06.018Z",
        "reply_count": 1,
        "reply_to_post_number": 5,
        "quote_count": 0,
        "incoming_link_count": 3,
        "reads": 69,
        "readers_count": 68,
        "score": 33.8,
        "yours": false,
        "topic_id": 2184,
        "topic_slug": "foundationdb-cluster-performance-issue-periods-of-high-disk-i-o-and-sustained-high-latency",
        "display_username": "Steve Atherton",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": "",
        "reply_to_user": {
          "id": 645,
          "username": "subramaniamr",
          "name": "Subramaniam R",
          "avatar_template": "/user_avatar/forums.foundationdb.org/subramaniamr/{size}/658_2.png"
        },
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 7,
        "hidden": false,
        "trust_level": 4,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/foundationdb-cluster-performance-issue-periods-of-high-disk-i-o-and-sustained-high-latency/2184/6",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 7365,
        "name": "Subramaniam R",
        "username": "subramaniamr",
        "avatar_template": "/user_avatar/forums.foundationdb.org/subramaniamr/{size}/658_2.png",
        "created_at": "2020-06-16T09:44:10.295Z",
        "cooked": "<aside class=\"quote no-group\" data-username=\"SteavedHams\" data-post=\"6\" data-topic=\"2184\">\n<div class=\"title\">\n<div class=\"quote-controls\"></div>\n<img loading=\"lazy\" alt=\"\" width=\"24\" height=\"24\" src=\"https://sea1.discourse-cdn.com/foundationdb/user_avatar/forums.foundationdb.org/steavedhams/48/18_2.png\" class=\"avatar\"> SteavedHams:</div>\n<blockquote>\n<p>Are you splitting the 1MB values into chunks, or did you override the value size limit knob? Normally values are limited to 100kb</p>\n</blockquote>\n</aside>\n<p>At the moment we are overriding the knob. But splitting them up should be straightforward. But I am sure more than 99% of our values are less than 32kb.</p>\n<p>I picked up on your pointer about \u201cdeferred cleanup\u201d and did some analysis. This is what I found</p>\n<p>At 6.40AM the purge job starts - Disk usage is normal.<br>\n6.40 - 7.10 - Disk usage is normal and better tps. Purge job is runnign but I dont see a drop in k/v size of disk space.<br>\nAt 7.10AM the purge job is still running and cleared about 5 million keys - Disk usage spikes ( 40% usage)<br>\nAt 7.25AM - purge job completes with slow tps between 7.10 - 7.25am - Disk usage still around 40%<br>\nAt 7.40AM - Disk usage back to normal ( 1-2%) and tps improves. Overall k/z size and disk size sees a drop and stabilizes.</p>\n<ol>\n<li>I dont have an exact count but we have cleared about 10 million keys and k/v size reduced by about 1GB.</li>\n<li>Total DB has about 500 million keys spread across 40 subspaces approximately.</li>\n<li>Disk metrics show an increase in writeops ( about 5K) without any significant increase in application load.</li>\n<li>fdb version - 6.2.19</li>\n</ol>\n<p>Is there any kind of b-tree rebalancing going on that will impact the performance ?</p>\n<p>Redwood engine - This requires bit more effort, i will find sometime to experiment it. This for highlighting.</p>",
        "post_number": 7,
        "post_type": 1,
        "posts_count": 22,
        "updated_at": "2020-06-16T09:45:57.013Z",
        "reply_count": 2,
        "reply_to_post_number": null,
        "quote_count": 1,
        "incoming_link_count": 2,
        "reads": 70,
        "readers_count": 69,
        "score": 34.0,
        "yours": false,
        "topic_id": 2184,
        "topic_slug": "foundationdb-cluster-performance-issue-periods-of-high-disk-i-o-and-sustained-high-latency",
        "display_username": "Subramaniam R",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 2,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 645,
        "hidden": false,
        "trust_level": 2,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/foundationdb-cluster-performance-issue-periods-of-high-disk-i-o-and-sustained-high-latency/2184/7",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 7367,
        "name": "A.J. Beamon",
        "username": "ajbeamon",
        "avatar_template": "/user_avatar/forums.foundationdb.org/ajbeamon/{size}/13_2.png",
        "created_at": "2020-06-16T10:15:50.630Z",
        "cooked": "<p>Have you changed any other knobs?</p>",
        "post_number": 8,
        "post_type": 1,
        "posts_count": 22,
        "updated_at": "2020-06-16T10:15:50.630Z",
        "reply_count": 1,
        "reply_to_post_number": 7,
        "quote_count": 0,
        "incoming_link_count": 0,
        "reads": 66,
        "readers_count": 65,
        "score": 18.2,
        "yours": false,
        "topic_id": 2184,
        "topic_slug": "foundationdb-cluster-performance-issue-periods-of-high-disk-i-o-and-sustained-high-latency",
        "display_username": "A.J. Beamon",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "reply_to_user": {
          "id": 645,
          "username": "subramaniamr",
          "name": "Subramaniam R",
          "avatar_template": "/user_avatar/forums.foundationdb.org/subramaniamr/{size}/658_2.png"
        },
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": true,
        "staff": true,
        "user_id": 12,
        "hidden": false,
        "trust_level": 4,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/foundationdb-cluster-performance-issue-periods-of-high-disk-i-o-and-sustained-high-latency/2184/8",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 7368,
        "name": "Subramaniam R",
        "username": "subramaniamr",
        "avatar_template": "/user_avatar/forums.foundationdb.org/subramaniamr/{size}/658_2.png",
        "created_at": "2020-06-16T10:18:06.081Z",
        "cooked": "<p>Txn size is bumped up to 20MB. But I can guarantee nothing exceeded 10MB. I can reproduce this with 10MB limit too. Actual txn size for purge jobs are tiny. It will be few KB max.</p>",
        "post_number": 9,
        "post_type": 1,
        "posts_count": 22,
        "updated_at": "2020-06-16T10:18:06.232Z",
        "reply_count": 1,
        "reply_to_post_number": 8,
        "quote_count": 0,
        "incoming_link_count": 2,
        "reads": 64,
        "readers_count": 63,
        "score": 27.8,
        "yours": false,
        "topic_id": 2184,
        "topic_slug": "foundationdb-cluster-performance-issue-periods-of-high-disk-i-o-and-sustained-high-latency",
        "display_username": "Subramaniam R",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 2,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "reply_to_user": {
          "id": 12,
          "username": "ajbeamon",
          "name": "A.J. Beamon",
          "avatar_template": "/user_avatar/forums.foundationdb.org/ajbeamon/{size}/13_2.png"
        },
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 645,
        "hidden": false,
        "trust_level": 2,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": "Automatically removed quote of whole previous post.",
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/foundationdb-cluster-performance-issue-periods-of-high-disk-i-o-and-sustained-high-latency/2184/9",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 7370,
        "name": "Steve Atherton",
        "username": "SteavedHams",
        "avatar_template": "/user_avatar/forums.foundationdb.org/steavedhams/{size}/18_2.png",
        "created_at": "2020-06-16T10:33:34.448Z",
        "cooked": "<p>I would not use the term \u201crebalancing\u201d to describe any of the deferred cleanup processes that happen <em>within</em> the BTree, but yes there are background tasks that are performed over time in response to mutations to the data that can impact performance.  One is the execution of large range clears, which requires reading all of the data in the cleared range but it happens slowly over time.  The other is shrinking the data file, which can be IO intensive per unit of space yielded, depending on the data pattern and also other mutations happening while vacuuming is happening.  This process does not change the BTree\u2019s structure (fanout / node contents, etc, which is why I say it\u2019s not really rebalancing anything) but rather it consolidates free space to the end of the data file so it can be truncated off of the file.  This is probably at least part of what is happening in your (3) above since your data file is shrinking.</p>\n<p>Note that if all of your clears are of single keys and not ranges, the clear work is NOT deferred and it happens when the mutation is applied.  Writing new large values (to new keys) will be faster than clearing existing large values due to the IO patterns involved.</p>\n<p>Stepping back a bit, however, at the cluster level <em>outside</em> of the BTree (storage engine) the cluster does rebalance data cross its Storage Server processes as you write and delete keys.  This happens for several reasons, including when the write pattern causes some Storage Servers to hold significantly more data than others or if a single shard (a contiguous range of the key space) is taking too many writes or has become too large or small compared to the rest of the shards.  So it is possible your database is doing some rebalancing when you see high IO.  The amount of data rebalancing happening at any given moment is reported in status in the cli and the json document.</p>\n<p>Something else that could be happening here is when your dataset mostly fits in the page cache of the Storage Server processes everything runs a lot faster, and your load and purge cycles might be pushing you back and forth across this threshold.</p>",
        "post_number": 10,
        "post_type": 1,
        "posts_count": 22,
        "updated_at": "2020-06-16T10:35:40.132Z",
        "reply_count": 2,
        "reply_to_post_number": 7,
        "quote_count": 0,
        "incoming_link_count": 0,
        "reads": 64,
        "readers_count": 63,
        "score": 22.8,
        "yours": false,
        "topic_id": 2184,
        "topic_slug": "foundationdb-cluster-performance-issue-periods-of-high-disk-i-o-and-sustained-high-latency",
        "display_username": "Steve Atherton",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": "",
        "reply_to_user": {
          "id": 645,
          "username": "subramaniamr",
          "name": "Subramaniam R",
          "avatar_template": "/user_avatar/forums.foundationdb.org/subramaniamr/{size}/658_2.png"
        },
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 7,
        "hidden": false,
        "trust_level": 4,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/foundationdb-cluster-performance-issue-periods-of-high-disk-i-o-and-sustained-high-latency/2184/10",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 7372,
        "name": "Subramaniam R",
        "username": "subramaniamr",
        "avatar_template": "/user_avatar/forums.foundationdb.org/subramaniamr/{size}/658_2.png",
        "created_at": "2020-06-16T12:46:55.008Z",
        "cooked": "<aside class=\"quote no-group\" data-username=\"SteavedHams\" data-post=\"10\" data-topic=\"2184\">\n<div class=\"title\">\n<div class=\"quote-controls\"></div>\n<img loading=\"lazy\" alt=\"\" width=\"24\" height=\"24\" src=\"https://sea1.discourse-cdn.com/foundationdb/user_avatar/forums.foundationdb.org/steavedhams/48/18_2.png\" class=\"avatar\"> SteavedHams:</div>\n<blockquote>\n<p>but rather it consolidates free space to the end of the data file so it can be truncated off of the file. This is probably at least part of what is happening in your (3) above since your data file is shrinking.</p>\n</blockquote>\n</aside>\n<p>I am pretty sure this is happening as I see a clear correlation between disk space usage and disk busy %. When the data files stop shrinking the throughput significantly increases.</p>\n<p>Just did some calc on how much we clear,</p>\n<p>KV size - 150GB<br>\nData cleared - 10GB (diff in k/v size pre and post delete),<br>\nKeys cleared - 8-10 million keys (individual clear commands).</p>\n<p>I am a bit stuck here, is there any option to make the data files clearing process deferred or take linear time ?</p>",
        "post_number": 11,
        "post_type": 1,
        "posts_count": 22,
        "updated_at": "2020-06-16T12:46:55.008Z",
        "reply_count": 0,
        "reply_to_post_number": 10,
        "quote_count": 1,
        "incoming_link_count": 0,
        "reads": 61,
        "readers_count": 60,
        "score": 12.2,
        "yours": false,
        "topic_id": 2184,
        "topic_slug": "foundationdb-cluster-performance-issue-periods-of-high-disk-i-o-and-sustained-high-latency",
        "display_username": "Subramaniam R",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 645,
        "hidden": false,
        "trust_level": 2,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/foundationdb-cluster-performance-issue-periods-of-high-disk-i-o-and-sustained-high-latency/2184/11",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 7381,
        "name": "Ashish Gupta",
        "username": "ashishgupta",
        "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/a/c67d28/{size}.png",
        "created_at": "2020-06-17T08:30:51.163Z",
        "cooked": "<blockquote>\n<p>Note that if all of your clears are of single keys and not ranges, the clear work is NOT deferred and it happens when the mutation is applied.</p>\n</blockquote>\n<p>We have objects such that each is stored across two k/v pairs, with a common key prefix. We do a clear range on that common prefix, when we delete them. Do you think the deferred work for even these smaller ranges could be impacting performance, as they pile up?</p>",
        "post_number": 12,
        "post_type": 1,
        "posts_count": 22,
        "updated_at": "2020-06-17T08:30:51.163Z",
        "reply_count": 1,
        "reply_to_post_number": 10,
        "quote_count": 0,
        "incoming_link_count": 4,
        "reads": 60,
        "readers_count": 59,
        "score": 37.0,
        "yours": false,
        "topic_id": 2184,
        "topic_slug": "foundationdb-cluster-performance-issue-periods-of-high-disk-i-o-and-sustained-high-latency",
        "display_username": "Ashish Gupta",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "reply_to_user": {
          "id": 7,
          "username": "SteavedHams",
          "name": "Steve Atherton",
          "avatar_template": "/user_avatar/forums.foundationdb.org/steavedhams/{size}/18_2.png"
        },
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 747,
        "hidden": false,
        "trust_level": 1,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/foundationdb-cluster-performance-issue-periods-of-high-disk-i-o-and-sustained-high-latency/2184/12",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 7382,
        "name": "Steve Atherton",
        "username": "SteavedHams",
        "avatar_template": "/user_avatar/forums.foundationdb.org/steavedhams/{size}/18_2.png",
        "created_at": "2020-06-17T09:15:16.949Z",
        "cooked": "<p>The file shrinking deferred work might be having an effect on performance.  There are some limits on how much of this \u201cvacuuming\u201d work is done per spring cleaning cycle in an attempt to limit its affect on performance, but it can still be an issue in certain workloads I think.</p>\n<p>You can actually just disable it and see what happens, it just means your files will not shrink on disk but the free space inside them will still be reused.  The option, which you must pass to your <code>fdbserver</code> processes (or at least the storage process ones) is</p>\n<p><code>--knob_spring_cleaning_max_vacuum_pages=0</code></p>\n<p>and if that improves things you can try to find an acceptable non-zero value that doesn\u2019t harm performance.  I think a value of 100 will limit file shrinking to something around 400kb/s.</p>\n<p>The other type of deferred work, the deferred range clear, would <em>not</em> be happening when you clear just two keys.  Deferred range clears are done when the range cleared completely covers one or more BTree subtrees, each with a single root node.   The pages which link to those subtrees are modified to remove those links, and then the subtree roots themselves are queued for incremental recursion later.  Clearing only 2 keys in an operation would not constitute a subtree so there would be no queuing of work for later.</p>\n<p>Something else that causes overhead (though again not deferred) is that with your large values it is likely that many of the 4k nodes in your BTree have only 4 entries in them, with each entry then linking to a linked list of overflow pages that hold the large value bytes, as I described earlier.  It is possible that your 2-key clears are triggering page underflows, where the page has too much unused space in it so an attempt is made to merge it with a sibling.  Unfortunately, there are not currently any metrics that can confirm whether or not this is happening.</p>",
        "post_number": 13,
        "post_type": 1,
        "posts_count": 22,
        "updated_at": "2020-06-17T09:16:06.953Z",
        "reply_count": 0,
        "reply_to_post_number": 12,
        "quote_count": 0,
        "incoming_link_count": 1,
        "reads": 63,
        "readers_count": 62,
        "score": 17.6,
        "yours": false,
        "topic_id": 2184,
        "topic_slug": "foundationdb-cluster-performance-issue-periods-of-high-disk-i-o-and-sustained-high-latency",
        "display_username": "Steve Atherton",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": "",
        "reply_to_user": {
          "id": 747,
          "username": "ashishgupta",
          "name": "Ashish Gupta",
          "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/a/c67d28/{size}.png"
        },
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 7,
        "hidden": false,
        "trust_level": 4,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/foundationdb-cluster-performance-issue-periods-of-high-disk-i-o-and-sustained-high-latency/2184/13",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 7383,
        "name": "gaurav",
        "username": "gaurav",
        "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/g/b487fb/{size}.png",
        "created_at": "2020-06-17T12:23:36.428Z",
        "cooked": "<p>How many individual keys are you clearing in each transaction? In past we have experienced that keeping the number of cleared keys operations per transaction to a small number  (&lt;~10) was helpful. But we did not have anything concrete to explain this behavior.</p>",
        "post_number": 14,
        "post_type": 1,
        "posts_count": 22,
        "updated_at": "2020-06-17T12:23:36.428Z",
        "reply_count": 1,
        "reply_to_post_number": 9,
        "quote_count": 0,
        "incoming_link_count": 2,
        "reads": 57,
        "readers_count": 56,
        "score": 26.4,
        "yours": false,
        "topic_id": 2184,
        "topic_slug": "foundationdb-cluster-performance-issue-periods-of-high-disk-i-o-and-sustained-high-latency",
        "display_username": "gaurav",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "reply_to_user": {
          "id": 645,
          "username": "subramaniamr",
          "name": "Subramaniam R",
          "avatar_template": "/user_avatar/forums.foundationdb.org/subramaniamr/{size}/658_2.png"
        },
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 166,
        "hidden": false,
        "trust_level": 3,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/foundationdb-cluster-performance-issue-periods-of-high-disk-i-o-and-sustained-high-latency/2184/14",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 7384,
        "name": "Subramaniam R",
        "username": "subramaniamr",
        "avatar_template": "/user_avatar/forums.foundationdb.org/subramaniamr/{size}/658_2.png",
        "created_at": "2020-06-17T12:25:50.166Z",
        "cooked": "<p>I dont have an exact answer, a batch process clears them. So its most likely few thousand keys in each txn. We are testing with the option which Steve suggested.</p>\n<p>Next up will be to measure number of keys per txn.</p>",
        "post_number": 15,
        "post_type": 1,
        "posts_count": 22,
        "updated_at": "2020-06-17T12:25:50.166Z",
        "reply_count": 1,
        "reply_to_post_number": 14,
        "quote_count": 0,
        "incoming_link_count": 0,
        "reads": 55,
        "readers_count": 54,
        "score": 16.0,
        "yours": false,
        "topic_id": 2184,
        "topic_slug": "foundationdb-cluster-performance-issue-periods-of-high-disk-i-o-and-sustained-high-latency",
        "display_username": "Subramaniam R",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "reply_to_user": {
          "id": 166,
          "username": "gaurav",
          "name": "gaurav",
          "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/g/b487fb/{size}.png"
        },
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 645,
        "hidden": false,
        "trust_level": 2,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/foundationdb-cluster-performance-issue-periods-of-high-disk-i-o-and-sustained-high-latency/2184/15",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 7385,
        "name": "gaurav",
        "username": "gaurav",
        "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/g/b487fb/{size}.png",
        "created_at": "2020-06-17T12:27:18.746Z",
        "cooked": "<p>I would suggest to experiment with splitting the clear ops across more transactions. Try 10 clears per tx. It might be of help.</p>\n<p>See this thread where we faced some issues with clear <a href=\"https://forums.foundationdb.org/t/troubleshooting-queue-build-up/1493\" class=\"inline-onebox\">Troubleshooting queue build up</a></p>",
        "post_number": 16,
        "post_type": 1,
        "posts_count": 22,
        "updated_at": "2020-06-17T12:27:18.746Z",
        "reply_count": 0,
        "reply_to_post_number": 15,
        "quote_count": 0,
        "incoming_link_count": 0,
        "reads": 58,
        "readers_count": 57,
        "score": 11.6,
        "yours": false,
        "topic_id": 2184,
        "topic_slug": "foundationdb-cluster-performance-issue-periods-of-high-disk-i-o-and-sustained-high-latency",
        "display_username": "gaurav",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "link_counts": [
          {
            "url": "https://forums.foundationdb.org/t/troubleshooting-queue-build-up/1493",
            "internal": true,
            "reflection": false,
            "title": "Troubleshooting queue build up",
            "clicks": 8
          }
        ],
        "read": true,
        "user_title": null,
        "reply_to_user": {
          "id": 645,
          "username": "subramaniamr",
          "name": "Subramaniam R",
          "avatar_template": "/user_avatar/forums.foundationdb.org/subramaniamr/{size}/658_2.png"
        },
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 166,
        "hidden": false,
        "trust_level": 3,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/foundationdb-cluster-performance-issue-periods-of-high-disk-i-o-and-sustained-high-latency/2184/16",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 7507,
        "name": "Subramaniam R",
        "username": "subramaniamr",
        "avatar_template": "/user_avatar/forums.foundationdb.org/subramaniamr/{size}/658_2.png",
        "created_at": "2020-07-04T18:50:20.817Z",
        "cooked": "<p>Update on this thread - It turns out we have a very complex delete logic. For every logical delete op we do 20 - 30 reads and another 20 - 30 actual delete ops in fdb.  By definition these are old keys and they are never in the cache.</p>\n<p>We got the clue from Cache stats in storage server as there was a significant cache miss during this period. An optimization around the \u201cread ops\u201d made the actual delete transaction many times faster.</p>\n<p>We now have a new problem with an insane amount repartitioning that gets triggered during the deletes but I will start a separate thread for that.</p>\n<p>Thanks everyone.</p>",
        "post_number": 17,
        "post_type": 1,
        "posts_count": 22,
        "updated_at": "2020-07-04T18:50:20.817Z",
        "reply_count": 1,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 0,
        "reads": 49,
        "readers_count": 48,
        "score": 14.8,
        "yours": false,
        "topic_id": 2184,
        "topic_slug": "foundationdb-cluster-performance-issue-periods-of-high-disk-i-o-and-sustained-high-latency",
        "display_username": "Subramaniam R",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 645,
        "hidden": false,
        "trust_level": 2,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/foundationdb-cluster-performance-issue-periods-of-high-disk-i-o-and-sustained-high-latency/2184/17",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 7510,
        "name": "gaurav",
        "username": "gaurav",
        "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/g/b487fb/{size}.png",
        "created_at": "2020-07-05T12:36:31.112Z",
        "cooked": "<aside class=\"quote no-group\" data-username=\"subramaniamr\" data-post=\"17\" data-topic=\"2184\">\n<div class=\"title\">\n<div class=\"quote-controls\"></div>\n<img loading=\"lazy\" alt=\"\" width=\"24\" height=\"24\" src=\"https://sea1.discourse-cdn.com/foundationdb/user_avatar/forums.foundationdb.org/subramaniamr/48/658_2.png\" class=\"avatar\"> subramaniamr:</div>\n<blockquote>\n<p>An optimization around the \u201cread ops\u201d made the actual delete transaction many times faster.</p>\n</blockquote>\n</aside>\n<p>Could you elaborate on what did this involve? It might be helpful for others.</p>",
        "post_number": 18,
        "post_type": 1,
        "posts_count": 22,
        "updated_at": "2020-07-05T12:36:31.112Z",
        "reply_count": 1,
        "reply_to_post_number": 17,
        "quote_count": 1,
        "incoming_link_count": 0,
        "reads": 48,
        "readers_count": 47,
        "score": 14.6,
        "yours": false,
        "topic_id": 2184,
        "topic_slug": "foundationdb-cluster-performance-issue-periods-of-high-disk-i-o-and-sustained-high-latency",
        "display_username": "gaurav",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 166,
        "hidden": false,
        "trust_level": 3,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/foundationdb-cluster-performance-issue-periods-of-high-disk-i-o-and-sustained-high-latency/2184/18",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 7513,
        "name": "Subramaniam R",
        "username": "subramaniamr",
        "avatar_template": "/user_avatar/forums.foundationdb.org/subramaniamr/{size}/658_2.png",
        "created_at": "2020-07-06T04:54:47.167Z",
        "cooked": "<p>We have a complex index-like record storing where a single record is broken into 20 - 30 individual k/v pairs in different subspaces.  During delete we were doing a \u201cread\u201d in each subspace for validation before deleting.</p>\n<p>The fix was simple, we retrieve the original record with a single read and apply the same algorithm that is used during \u201cinsert\u201d to generate the keys, apply validations and delete them. This means reads are reduced significantly.</p>",
        "post_number": 19,
        "post_type": 1,
        "posts_count": 22,
        "updated_at": "2020-07-06T04:54:47.167Z",
        "reply_count": 1,
        "reply_to_post_number": 18,
        "quote_count": 0,
        "incoming_link_count": 1,
        "reads": 47,
        "readers_count": 46,
        "score": 19.4,
        "yours": false,
        "topic_id": 2184,
        "topic_slug": "foundationdb-cluster-performance-issue-periods-of-high-disk-i-o-and-sustained-high-latency",
        "display_username": "Subramaniam R",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "reply_to_user": {
          "id": 166,
          "username": "gaurav",
          "name": "gaurav",
          "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/g/b487fb/{size}.png"
        },
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 645,
        "hidden": false,
        "trust_level": 2,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/foundationdb-cluster-performance-issue-periods-of-high-disk-i-o-and-sustained-high-latency/2184/19",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 7516,
        "name": "gaurav",
        "username": "gaurav",
        "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/g/b487fb/{size}.png",
        "created_at": "2020-07-06T05:32:45.086Z",
        "cooked": "<aside class=\"quote no-group\" data-username=\"subramaniamr\" data-post=\"19\" data-topic=\"2184\">\n<div class=\"title\">\n<div class=\"quote-controls\"></div>\n<img loading=\"lazy\" alt=\"\" width=\"24\" height=\"24\" src=\"https://sea1.discourse-cdn.com/foundationdb/user_avatar/forums.foundationdb.org/subramaniamr/48/658_2.png\" class=\"avatar\"> subramaniamr:</div>\n<blockquote>\n<p>The fix was simple, we retrieve the original record with a single read and apply the same algorithm that is used during \u201cinsert\u201d to generate the keys, apply validations and delete them. This means reads are reduced significantly.</p>\n</blockquote>\n</aside>\n<p>Thanks. But wouldn\u2019t a blind delete of the 20-30 keys result in implicit reading of the btree disk blocks (read, update, write)?</p>\n<p>Curious to know how would an explicit read of keys followed by delete be any worse than blind deletes of the same keys, from the cache-friendliness and IO-activity perspective?</p>\n<p>In fact, from what I\u2019ve understood, <code>gets</code> of keys are done by SS in parallel (higher queue depth), vs the implicit reads (for write/delete) being done serially (with queue depth of one).</p>",
        "post_number": 20,
        "post_type": 1,
        "posts_count": 22,
        "updated_at": "2020-07-06T06:43:19.397Z",
        "reply_count": 1,
        "reply_to_post_number": 19,
        "quote_count": 1,
        "incoming_link_count": 0,
        "reads": 47,
        "readers_count": 46,
        "score": 14.4,
        "yours": false,
        "topic_id": 2184,
        "topic_slug": "foundationdb-cluster-performance-issue-periods-of-high-disk-i-o-and-sustained-high-latency",
        "display_username": "gaurav",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 2,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 166,
        "hidden": false,
        "trust_level": 3,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/foundationdb-cluster-performance-issue-periods-of-high-disk-i-o-and-sustained-high-latency/2184/20",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      }
    ],
    "stream": [
      7356,
      7360,
      7361,
      7362,
      7363,
      7364,
      7365,
      7367,
      7368,
      7370,
      7372,
      7381,
      7382,
      7383,
      7384,
      7385,
      7507,
      7510,
      7513,
      7516,
      7518,
      7519
    ]
  },
  "timeline_lookup": [
    [
      1,
      1954
    ],
    [
      11,
      1953
    ],
    [
      14,
      1952
    ],
    [
      17,
      1935
    ],
    [
      18,
      1934
    ]
  ],
  "tags": [
    "performance"
  ],
  "tags_descriptions": {},
  "fancy_title": "FoundationDB cluster performance issue - Periods of high disk I/O and sustained high latency",
  "id": 2184,
  "title": "FoundationDB cluster performance issue - Periods of high disk I/O and sustained high latency",
  "posts_count": 22,
  "created_at": "2020-06-15T15:45:43.650Z",
  "views": 2571,
  "reply_count": 17,
  "like_count": 2,
  "last_posted_at": "2020-07-06T06:50:56.594Z",
  "visible": true,
  "closed": false,
  "archived": false,
  "has_summary": false,
  "archetype": "regular",
  "slug": "foundationdb-cluster-performance-issue-periods-of-high-disk-i-o-and-sustained-high-latency",
  "category_id": 7,
  "word_count": 3017,
  "deleted_at": null,
  "user_id": 779,
  "featured_link": null,
  "pinned_globally": false,
  "pinned_at": null,
  "pinned_until": null,
  "image_url": null,
  "slow_mode_seconds": 0,
  "draft": null,
  "draft_key": "topic_2184",
  "draft_sequence": null,
  "unpinned": null,
  "pinned": false,
  "current_post_number": 1,
  "highest_post_number": 22,
  "deleted_by": null,
  "actions_summary": [
    {
      "id": 4,
      "count": 0,
      "hidden": false,
      "can_act": false
    },
    {
      "id": 8,
      "count": 0,
      "hidden": false,
      "can_act": false
    },
    {
      "id": 10,
      "count": 0,
      "hidden": false,
      "can_act": false
    },
    {
      "id": 7,
      "count": 0,
      "hidden": false,
      "can_act": false
    }
  ],
  "chunk_size": 20,
  "bookmarked": false,
  "topic_timer": null,
  "message_bus_last_id": 0,
  "participant_count": 6,
  "show_read_indicator": false,
  "thumbnails": null,
  "slow_mode_enabled_until": null,
  "tags_disable_ads": false,
  "related_topics": null,
  "summarizable": false,
  "can_vote": false,
  "vote_count": 0,
  "user_voted": false,
  "discourse_zendesk_plugin_zendesk_id": null,
  "discourse_zendesk_plugin_zendesk_url": "https://your-url.zendesk.com/agent/tickets/",
  "details": {
    "can_edit": false,
    "notification_level": 1,
    "participants": [
      {
        "id": 645,
        "username": "subramaniamr",
        "name": "Subramaniam R",
        "avatar_template": "/user_avatar/forums.foundationdb.org/subramaniamr/{size}/658_2.png",
        "post_count": 9,
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_color": null,
        "flair_bg_color": null,
        "flair_group_id": null,
        "trust_level": 2
      },
      {
        "id": 7,
        "username": "SteavedHams",
        "name": "Steve Atherton",
        "avatar_template": "/user_avatar/forums.foundationdb.org/steavedhams/{size}/18_2.png",
        "post_count": 5,
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_color": null,
        "flair_bg_color": null,
        "flair_group_id": null,
        "trust_level": 4
      },
      {
        "id": 166,
        "username": "gaurav",
        "name": "gaurav",
        "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/g/b487fb/{size}.png",
        "post_count": 5,
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_color": null,
        "flair_bg_color": null,
        "flair_group_id": null,
        "trust_level": 3
      },
      {
        "id": 747,
        "username": "ashishgupta",
        "name": "Ashish Gupta",
        "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/a/c67d28/{size}.png",
        "post_count": 1,
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_color": null,
        "flair_bg_color": null,
        "flair_group_id": null,
        "trust_level": 1
      },
      {
        "id": 779,
        "username": "imtdk",
        "name": null,
        "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/i/22d042/{size}.png",
        "post_count": 1,
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_color": null,
        "flair_bg_color": null,
        "flair_group_id": null,
        "trust_level": 1
      },
      {
        "id": 12,
        "username": "ajbeamon",
        "name": "A.J. Beamon",
        "avatar_template": "/user_avatar/forums.foundationdb.org/ajbeamon/{size}/13_2.png",
        "post_count": 1,
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_color": null,
        "flair_bg_color": null,
        "flair_group_id": null,
        "admin": true,
        "trust_level": 4
      }
    ],
    "created_by": {
      "id": 779,
      "username": "imtdk",
      "name": null,
      "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/i/22d042/{size}.png"
    },
    "last_poster": {
      "id": 166,
      "username": "gaurav",
      "name": "gaurav",
      "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/g/b487fb/{size}.png"
    },
    "links": [
      {
        "url": "https://forums.foundationdb.org/t/troubleshooting-queue-build-up/1493",
        "title": "Troubleshooting queue build up",
        "internal": true,
        "attachment": false,
        "reflection": false,
        "clicks": 8,
        "user_id": 166,
        "domain": "forums.foundationdb.org",
        "root_domain": "foundationdb.org"
      },
      {
        "url": "https://forums.foundationdb.org/t/unexpected-repartitioning-of-the-database/2225",
        "title": "Unexpected repartitioning of the database",
        "internal": true,
        "attachment": false,
        "reflection": true,
        "clicks": 1,
        "user_id": 645,
        "domain": "forums.foundationdb.org",
        "root_domain": "foundationdb.org"
      }
    ]
  },
  "bookmarks": []
}