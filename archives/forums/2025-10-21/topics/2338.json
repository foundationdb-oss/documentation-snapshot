{
  "post_stream": {
    "posts": [
      {
        "id": 7922,
        "name": "",
        "username": "legilimen",
        "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/l/a6a055/{size}.png",
        "created_at": "2020-09-15T07:41:31.448Z",
        "cooked": "<p>Record am storing looks like this [CATEGORY, TYPE, VALUE, ID]\u2026 Primary key is on first three fields [CATEGORY, TYPE, VALUE]\u2026 I also have an index on ID field. I have a business use case where an ID can have only one VALUE for some TPYE\u2019s. For ex, lets say an ID can have only one VALUE for type T1 then this is invalid [C1,T1,V1,ID1] , [C1,T1,V2,ID1] since ID1 will have two values [V1,V2] for type T1.</p>\n<p>How can i ensure when concurrent writes happen only one of them gets stored and other is rejected. What i am doing today is, after inserting the row as part of transaction TX1, in a new transaction TX2 i do a read with causal read risky option to see if something else got inserted. If so i rollback the current transaction TX1 else i commit it. Will this work? If two instances are performing this concurrently is it possible for each tx to not know about the other tx\u2019s commit and end up with both the records in DB?</p>",
        "post_number": 1,
        "post_type": 1,
        "posts_count": 2,
        "updated_at": "2020-09-15T07:41:31.448Z",
        "reply_count": 0,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 15,
        "reads": 23,
        "readers_count": 22,
        "score": 79.6,
        "yours": false,
        "topic_id": 2338,
        "topic_slug": "maintaining-data-integrity",
        "display_username": "",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 764,
        "hidden": false,
        "trust_level": 0,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/maintaining-data-integrity/2338/1",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null,
        "can_vote": false
      },
      {
        "id": 7924,
        "name": "Alec Grieser",
        "username": "alloc",
        "avatar_template": "/user_avatar/forums.foundationdb.org/alloc/{size}/9_2.png",
        "created_at": "2020-09-15T18:36:30.377Z",
        "cooked": "<p>Hm, I\u2019m a little unclear here on what the exact desired constraint here is, but it seems like the right unique index here might work. In particular, the semantics of a unique index are that if you have one defined, it will reject any updates that result in multiple entries with the same values being saved. (You can also specify whether multiple entries with the \u201cnull\u201d value for a field should be allowed by specifying the \u201cnull unique option\u201d.)</p>\n<p>Would a unique index on <code>(type, id)</code> be sufficient? That would reject any updates that would result in two records having the same ID if they already have the same type. (It may instead need to be <code>(category, type, id)</code> instead of <code>(type, id)</code> if a type is \u201creally\u201d specified by <code>(category, type)</code>.)</p>\n<p>In general, though, I would not suggest trying to maintain constraints with multiple transactions as then you\u2019d have to handle things like what if the second transaction fails (and your constraint may temporarily be violated). The general way to ensure that these kinds of things are maintained is to check the constraint during the first transaction, and then the transaction processor will reject the commit (with a conflict) if the things read during that transaction are modified. So, in this case, the idea would be to check in TX1 if there are any other records with a different <code>value</code> for that <code>id</code> and <code>type</code>. If there aren\u2019t, then you issue the commit, and then let the FDB transaction resolver fail the update if a concurrent write comes in that violates the constraint.</p>\n<p>It\u2019s possible I\u2019m misunderstanding your proposed algorithm, though.</p>",
        "post_number": 2,
        "post_type": 1,
        "posts_count": 2,
        "updated_at": "2020-09-15T18:36:30.377Z",
        "reply_count": 0,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 0,
        "reads": 22,
        "readers_count": 21,
        "score": 4.4,
        "yours": false,
        "topic_id": 2338,
        "topic_slug": "maintaining-data-integrity",
        "display_username": "Alec Grieser",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 8,
        "hidden": false,
        "trust_level": 4,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/maintaining-data-integrity/2338/2",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      }
    ],
    "stream": [
      7922,
      7924
    ]
  },
  "timeline_lookup": [
    [
      1,
      1863
    ],
    [
      2,
      1862
    ]
  ],
  "suggested_topics": [],
  "tags": [],
  "tags_descriptions": {},
  "fancy_title": "Maintaining Data Integrity",
  "id": 2338,
  "title": "Maintaining Data Integrity",
  "posts_count": 2,
  "created_at": "2020-09-15T07:41:31.379Z",
  "views": 656,
  "reply_count": 0,
  "like_count": 0,
  "last_posted_at": "2020-09-15T18:36:30.377Z",
  "visible": true,
  "closed": false,
  "archived": false,
  "has_summary": false,
  "archetype": "regular",
  "slug": "maintaining-data-integrity",
  "category_id": 12,
  "word_count": 460,
  "deleted_at": null,
  "user_id": 764,
  "featured_link": null,
  "pinned_globally": false,
  "pinned_at": null,
  "pinned_until": null,
  "image_url": null,
  "slow_mode_seconds": 0,
  "draft": null,
  "draft_key": "topic_2338",
  "draft_sequence": null,
  "unpinned": null,
  "pinned": false,
  "current_post_number": 1,
  "highest_post_number": 2,
  "deleted_by": null,
  "actions_summary": [
    {
      "id": 4,
      "count": 0,
      "hidden": false,
      "can_act": false
    },
    {
      "id": 8,
      "count": 0,
      "hidden": false,
      "can_act": false
    },
    {
      "id": 10,
      "count": 0,
      "hidden": false,
      "can_act": false
    },
    {
      "id": 7,
      "count": 0,
      "hidden": false,
      "can_act": false
    }
  ],
  "chunk_size": 20,
  "bookmarked": false,
  "topic_timer": null,
  "message_bus_last_id": 0,
  "participant_count": 2,
  "show_read_indicator": false,
  "thumbnails": null,
  "slow_mode_enabled_until": null,
  "tags_disable_ads": false,
  "related_topics": [
    {
      "fancy_title": "Wrong rank index when concurrently adding records",
      "id": 2185,
      "title": "Wrong rank index when concurrently adding records",
      "slug": "wrong-rank-index-when-concurrently-adding-records",
      "posts_count": 2,
      "reply_count": 0,
      "highest_post_number": 2,
      "image_url": null,
      "created_at": "2020-06-16T09:47:05.381Z",
      "last_posted_at": "2020-06-16T17:48:31.509Z",
      "bumped": true,
      "bumped_at": "2020-06-16T17:48:31.509Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 3,
      "views": 623,
      "category_id": 12,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": null,
          "description": "Original Poster",
          "user": {
            "id": 775,
            "username": "iamquang95",
            "name": "Quang Le Hong",
            "avatar_template": "/user_avatar/forums.foundationdb.org/iamquang95/{size}/889_2.png",
            "trust_level": 1
          }
        },
        {
          "extras": "latest",
          "description": "Most Recent Poster",
          "user": {
            "id": 8,
            "username": "alloc",
            "name": "Alec Grieser",
            "avatar_template": "/user_avatar/forums.foundationdb.org/alloc/{size}/9_2.png",
            "trust_level": 4
          }
        }
      ]
    },
    {
      "fancy_title": "Best way to add an index on already-existing data?",
      "id": 97,
      "title": "Best way to add an index on already-existing data?",
      "slug": "best-way-to-add-an-index-on-already-existing-data",
      "posts_count": 3,
      "reply_count": 0,
      "highest_post_number": 3,
      "image_url": null,
      "created_at": "2018-04-20T04:59:04.978Z",
      "last_posted_at": "2018-04-21T14:52:02.378Z",
      "bumped": true,
      "bumped_at": "2018-04-21T14:52:02.378Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 1,
      "views": 3525,
      "category_id": 7,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": null,
          "description": "Original Poster",
          "user": {
            "id": 67,
            "username": "bpartridge",
            "name": "Brenton Partridge",
            "avatar_template": "/user_avatar/forums.foundationdb.org/bpartridge/{size}/50_2.png",
            "trust_level": 1
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 8,
            "username": "alloc",
            "name": "Alec Grieser",
            "avatar_template": "/user_avatar/forums.foundationdb.org/alloc/{size}/9_2.png",
            "trust_level": 4
          }
        },
        {
          "extras": "latest",
          "description": "Most Recent Poster",
          "user": {
            "id": 30,
            "username": "wwilson",
            "name": "Will Wilson",
            "avatar_template": "/user_avatar/forums.foundationdb.org/wwilson/{size}/88_2.png",
            "trust_level": 2
          }
        }
      ]
    },
    {
      "fancy_title": "ReadConflict vs WriteConflict for locking a range?",
      "id": 1070,
      "title": "ReadConflict vs WriteConflict for locking a range?",
      "slug": "readconflict-vs-writeconflict-for-locking-a-range",
      "posts_count": 7,
      "reply_count": 3,
      "highest_post_number": 7,
      "image_url": null,
      "created_at": "2019-01-26T13:26:56.674Z",
      "last_posted_at": "2019-02-02T05:07:53.900Z",
      "bumped": true,
      "bumped_at": "2019-02-02T05:07:53.900Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 0,
      "views": 1354,
      "category_id": 7,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": "latest",
          "description": "Original Poster, Most Recent Poster",
          "user": {
            "id": 166,
            "username": "gaurav",
            "name": "gaurav",
            "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/g/b487fb/{size}.png",
            "trust_level": 3
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 308,
            "username": "ananthakumaran",
            "name": "Anantha Kumaran",
            "avatar_template": "/user_avatar/forums.foundationdb.org/ananthakumaran/{size}/526_2.png",
            "trust_level": 2
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 173,
            "username": "jkominek",
            "name": "Jay Kominek",
            "avatar_template": "/user_avatar/forums.foundationdb.org/jkominek/{size}/140_2.png",
            "trust_level": 2
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 8,
            "username": "alloc",
            "name": "Alec Grieser",
            "avatar_template": "/user_avatar/forums.foundationdb.org/alloc/{size}/9_2.png",
            "trust_level": 4
          }
        }
      ]
    },
    {
      "fancy_title": "Go lang AddReadConflictKey AddWriteConflictKey",
      "id": 1842,
      "title": "Go lang AddReadConflictKey AddWriteConflictKey",
      "slug": "go-lang-addreadconflictkey-addwriteconflictkey",
      "posts_count": 4,
      "reply_count": 0,
      "highest_post_number": 4,
      "image_url": null,
      "created_at": "2019-12-16T07:17:17.187Z",
      "last_posted_at": "2019-12-16T21:07:59.763Z",
      "bumped": true,
      "bumped_at": "2019-12-16T21:07:59.763Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [
        "bindings"
      ],
      "tags_descriptions": {},
      "like_count": 0,
      "views": 851,
      "category_id": 5,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": "latest",
          "description": "Original Poster, Most Recent Poster",
          "user": {
            "id": 538,
            "username": "ravilution",
            "name": "Ravilution",
            "avatar_template": "/user_avatar/forums.foundationdb.org/ravilution/{size}/728_2.png",
            "trust_level": 2
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 166,
            "username": "gaurav",
            "name": "gaurav",
            "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/g/b487fb/{size}.png",
            "trust_level": 3
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 8,
            "username": "alloc",
            "name": "Alec Grieser",
            "avatar_template": "/user_avatar/forums.foundationdb.org/alloc/{size}/9_2.png",
            "trust_level": 4
          }
        }
      ]
    },
    {
      "fancy_title": "Layer for read-write transactions lasting longer than 5 seconds",
      "id": 1318,
      "title": "Layer for read-write transactions lasting longer than 5 seconds",
      "slug": "layer-for-read-write-transactions-lasting-longer-than-5-seconds",
      "posts_count": 10,
      "reply_count": 6,
      "highest_post_number": 10,
      "image_url": null,
      "created_at": "2019-04-18T17:25:43.958Z",
      "last_posted_at": "2019-11-12T22:43:02.952Z",
      "bumped": true,
      "bumped_at": "2019-11-12T22:43:02.952Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 1,
      "views": 2043,
      "category_id": 5,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": null,
          "description": "Original Poster",
          "user": {
            "id": 14,
            "username": "andrew.noyes",
            "name": "",
            "avatar_template": "/user_avatar/forums.foundationdb.org/andrew.noyes/{size}/443_2.png",
            "trust_level": 2
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 8,
            "username": "alloc",
            "name": "Alec Grieser",
            "avatar_template": "/user_avatar/forums.foundationdb.org/alloc/{size}/9_2.png",
            "trust_level": 4
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 15,
            "username": "markus.pilman",
            "name": "Markus Pilman",
            "avatar_template": "/user_avatar/forums.foundationdb.org/markus.pilman/{size}/379_2.png",
            "admin": true,
            "trust_level": 4
          }
        },
        {
          "extras": "latest",
          "description": "Most Recent Poster",
          "user": {
            "id": 13,
            "username": "alexmiller",
            "name": "Alex Miller",
            "avatar_template": "/user_avatar/forums.foundationdb.org/alexmiller/{size}/326_2.png",
            "trust_level": 4
          }
        }
      ]
    }
  ],
  "summarizable": false,
  "can_vote": false,
  "vote_count": 0,
  "user_voted": false,
  "discourse_zendesk_plugin_zendesk_id": null,
  "discourse_zendesk_plugin_zendesk_url": "https://your-url.zendesk.com/agent/tickets/",
  "details": {
    "can_edit": false,
    "notification_level": 1,
    "participants": [
      {
        "id": 8,
        "username": "alloc",
        "name": "Alec Grieser",
        "avatar_template": "/user_avatar/forums.foundationdb.org/alloc/{size}/9_2.png",
        "post_count": 1,
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_color": null,
        "flair_bg_color": null,
        "flair_group_id": null,
        "trust_level": 4
      },
      {
        "id": 764,
        "username": "legilimen",
        "name": "",
        "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/l/a6a055/{size}.png",
        "post_count": 1,
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_color": null,
        "flair_bg_color": null,
        "flair_group_id": null,
        "trust_level": 0
      }
    ],
    "created_by": {
      "id": 764,
      "username": "legilimen",
      "name": "",
      "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/l/a6a055/{size}.png"
    },
    "last_poster": {
      "id": 8,
      "username": "alloc",
      "name": "Alec Grieser",
      "avatar_template": "/user_avatar/forums.foundationdb.org/alloc/{size}/9_2.png"
    }
  },
  "bookmarks": []
}