{
  "post_stream": {
    "posts": [
      {
        "id": 10905,
        "name": "",
        "username": "Skwiwel",
        "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/s/5f8ce5/{size}.png",
        "created_at": "2022-04-04T13:59:14.419Z",
        "cooked": "<p>Hi,</p>\n<p>We have run into a performance barrier while trying to minimize the latency of read transactions in our applications. Our service currently handles around 20,000 read-only requests/s, being split into around 40 instances (processes). Each request is small, a few 100 bytes each. The service uses the Go bindings of fdb.</p>\n<p>We note that the usual p95 time of each such transaction takes around 9ms. That is the time it takes the fdb Go library to return from a call. This kind of latency is acceptable to us. We also note, though, that the times of p99 go up significantly into ~16ms, and p995, p999 are consistently way up in the order of ~40ms and ~70ms, respectively. This extremely high tail latency is what we are trying to improve.</p>\n<p>The requests are very standard read transactions, written mirroring the usage in the Go bindings documentation. GetRange transactions consisting of ~100 keys are consistently just ~1ms slower (on all percentiles) than simple Get reads, so raw throughput per-transaction is not a problem.</p>\n<p>Some info:</p>\n<ul>\n<li>used fdb client/server version: 6.2.30</li>\n<li>API: 600</li>\n<li>go version: 1.17, same results on other versions</li>\n</ul>\n<p>Since we are using fdb 6.2.30, the db could be updated. Having read the changelog, I have not noticed much promising new fixes or features, though.</p>\n<p>We don\u2019t recognize any significant slowdowns, or other worrying metrics, on the database side and thus have ruled the database server side out. We believe that the reason for the high latencies comes from the client-side network I/O or thread utilization, which may be related to the way Go handles the cgo of the underlying fdb client library.</p>\n<p>I have already tinkered with adjusting the number of processes running the service to optimize throughput of the fdb network thread. I have noticed significant improvements to the p95 times with doubling the number of instances from 20 to 40, but more instances do not yield better results.</p>\n<p>We have observed a high correlation between increased latency and higher CPU usage on the machine. While normally it would not be a surprise that a machine struggling with CPU power would produce bad latencies, the machines employed here are never pushed above ~90% CPU. We use the standard Docker/Kubernetes way of separating the CPU usage of applications, so the service is generally receiving enough CPU time to operate. Nonetheless, the latency of the service instances running on machines with 60% CPU utilization is much smaller than on machines running at 85%.</p>\n<p>Using the Golang\u2019s pprof tool we note that the <code>cgocall</code> of the Go fdb client binding is taking almost half of the CPU time of the app. I\u2019m unsure, though, how that should be interpreted. If the cgocall blocks, waiting on I/O, it should not, to my understanding, register CPU time in pprof. 95% of that is started from the <code>fdb.StartNetwork</code> func.</p>\n<p>I understand that all of this is, obviously, not enough information to definitively pinpoint the problem. Nonetheless, I would like to ask if there is anyone here that has experienced similar problems or would know of a good approach for debugging the latency issue. Any help would be greatly appreciated <img src=\"https://emoji.discourse-cdn.com/twitter/slight_smile.png?v=12\" title=\":slight_smile:\" class=\"emoji\" alt=\":slight_smile:\" loading=\"lazy\" width=\"20\" height=\"20\"></p>",
        "post_number": 1,
        "post_type": 1,
        "posts_count": 3,
        "updated_at": "2022-04-04T13:59:14.419Z",
        "reply_count": 0,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 173,
        "reads": 23,
        "readers_count": 22,
        "score": 864.6,
        "yours": false,
        "topic_id": 3245,
        "topic_slug": "high-client-tail-latency-with-go-bindings-increasing-with-cpu-usage",
        "display_username": "",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 1087,
        "hidden": false,
        "trust_level": 0,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/high-client-tail-latency-with-go-bindings-increasing-with-cpu-usage/3245/1",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null,
        "can_vote": false
      },
      {
        "id": 10911,
        "name": "Sam Pullara",
        "username": "spullara",
        "avatar_template": "/user_avatar/forums.foundationdb.org/spullara/{size}/125_2.png",
        "created_at": "2022-04-05T18:00:04.042Z",
        "cooked": "<p>Have you rules out GC?</p>",
        "post_number": 2,
        "post_type": 1,
        "posts_count": 3,
        "updated_at": "2022-04-05T18:00:04.042Z",
        "reply_count": 0,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 1,
        "reads": 20,
        "readers_count": 19,
        "score": 9.0,
        "yours": false,
        "topic_id": 3245,
        "topic_slug": "high-client-tail-latency-with-go-bindings-increasing-with-cpu-usage",
        "display_username": "Sam Pullara",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 156,
        "hidden": false,
        "trust_level": 2,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/high-client-tail-latency-with-go-bindings-increasing-with-cpu-usage/3245/2",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 10913,
        "name": "",
        "username": "Skwiwel",
        "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/s/5f8ce5/{size}.png",
        "created_at": "2022-04-06T06:31:53.348Z",
        "cooked": "<p>Hi, thanks for the reply. I have not ruled out GC. It seems quite unlikely to me that this is the source of the problem, but I\u2019ll investigate deeper in this direction.<br>\nThanks for the input!</p>",
        "post_number": 3,
        "post_type": 1,
        "posts_count": 3,
        "updated_at": "2022-04-06T06:31:53.348Z",
        "reply_count": 0,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 1,
        "reads": 18,
        "readers_count": 17,
        "score": 8.6,
        "yours": false,
        "topic_id": 3245,
        "topic_slug": "high-client-tail-latency-with-go-bindings-increasing-with-cpu-usage",
        "display_username": "",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 1087,
        "hidden": false,
        "trust_level": 0,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/high-client-tail-latency-with-go-bindings-increasing-with-cpu-usage/3245/3",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      }
    ],
    "stream": [
      10905,
      10911,
      10913
    ]
  },
  "timeline_lookup": [
    [
      1,
      1296
    ],
    [
      2,
      1295
    ]
  ],
  "suggested_topics": [],
  "tags": [
    "bindings",
    "performance"
  ],
  "tags_descriptions": {},
  "fancy_title": "High client tail latency with Go bindings, increasing with CPU usage",
  "id": 3245,
  "title": "High client tail latency with Go bindings, increasing with CPU usage",
  "posts_count": 3,
  "created_at": "2022-04-04T13:59:14.346Z",
  "views": 646,
  "reply_count": 0,
  "like_count": 0,
  "last_posted_at": "2022-04-06T06:31:53.348Z",
  "visible": true,
  "closed": false,
  "archived": false,
  "has_summary": false,
  "archetype": "regular",
  "slug": "high-client-tail-latency-with-go-bindings-increasing-with-cpu-usage",
  "category_id": 7,
  "word_count": 585,
  "deleted_at": null,
  "user_id": 1087,
  "featured_link": null,
  "pinned_globally": false,
  "pinned_at": null,
  "pinned_until": null,
  "image_url": null,
  "slow_mode_seconds": 0,
  "draft": null,
  "draft_key": "topic_3245",
  "draft_sequence": null,
  "unpinned": null,
  "pinned": false,
  "current_post_number": 1,
  "highest_post_number": 3,
  "deleted_by": null,
  "actions_summary": [
    {
      "id": 4,
      "count": 0,
      "hidden": false,
      "can_act": false
    },
    {
      "id": 8,
      "count": 0,
      "hidden": false,
      "can_act": false
    },
    {
      "id": 10,
      "count": 0,
      "hidden": false,
      "can_act": false
    },
    {
      "id": 7,
      "count": 0,
      "hidden": false,
      "can_act": false
    }
  ],
  "chunk_size": 20,
  "bookmarked": false,
  "topic_timer": null,
  "message_bus_last_id": 0,
  "participant_count": 2,
  "show_read_indicator": false,
  "thumbnails": null,
  "slow_mode_enabled_until": null,
  "tags_disable_ads": false,
  "related_topics": [
    {
      "fancy_title": "How to improve connections count from client to server in go sdk or in c sdk",
      "id": 223,
      "title": "How to improve connections count from client to server in go sdk or in c sdk",
      "slug": "how-to-improve-connections-count-from-client-to-server-in-go-sdk-or-in-c-sdk",
      "posts_count": 9,
      "reply_count": 7,
      "highest_post_number": 9,
      "image_url": null,
      "created_at": "2018-04-23T15:43:18.969Z",
      "last_posted_at": "2018-04-24T05:23:56.703Z",
      "bumped": true,
      "bumped_at": "2018-04-24T05:23:56.703Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 2,
      "views": 1718,
      "category_id": 7,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": null,
          "description": "Original Poster",
          "user": {
            "id": 152,
            "username": "shgxwxl",
            "name": "Shgxwxl",
            "avatar_template": "/user_avatar/forums.foundationdb.org/shgxwxl/{size}/127_2.png",
            "trust_level": 1
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 22,
            "username": "dave",
            "name": "David Scherer",
            "avatar_template": "/user_avatar/forums.foundationdb.org/dave/{size}/89_2.png",
            "trust_level": 1
          }
        },
        {
          "extras": "latest",
          "description": "Most Recent Poster",
          "user": {
            "id": 13,
            "username": "alexmiller",
            "name": "Alex Miller",
            "avatar_template": "/user_avatar/forums.foundationdb.org/alexmiller/{size}/326_2.png",
            "trust_level": 4
          }
        }
      ]
    },
    {
      "fancy_title": "How to scale foundation db reads",
      "id": 1108,
      "title": "How to scale foundation db reads",
      "slug": "how-to-scale-foundation-db-reads",
      "posts_count": 21,
      "reply_count": 13,
      "highest_post_number": 21,
      "image_url": null,
      "created_at": "2019-02-02T12:39:23.370Z",
      "last_posted_at": "2019-03-18T16:32:32.430Z",
      "bumped": true,
      "bumped_at": "2019-03-18T16:32:32.430Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 7,
      "views": 6504,
      "category_id": 7,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": null,
          "description": "Original Poster",
          "user": {
            "id": 504,
            "username": "preslavle",
            "name": "Preslav Le",
            "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/p/9de0a6/{size}.png",
            "trust_level": 1
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 53,
            "username": "KrzysFR",
            "name": "Christophe Chevalier",
            "avatar_template": "/user_avatar/forums.foundationdb.org/krzysfr/{size}/43_2.png",
            "trust_level": 2
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 12,
            "username": "ajbeamon",
            "name": "A.J. Beamon",
            "avatar_template": "/user_avatar/forums.foundationdb.org/ajbeamon/{size}/13_2.png",
            "admin": true,
            "trust_level": 4
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 13,
            "username": "alexmiller",
            "name": "Alex Miller",
            "avatar_template": "/user_avatar/forums.foundationdb.org/alexmiller/{size}/326_2.png",
            "trust_level": 4
          }
        },
        {
          "extras": "latest",
          "description": "Most Recent Poster",
          "user": {
            "id": 337,
            "username": "mengxu",
            "name": "Meng Xu",
            "avatar_template": "/user_avatar/forums.foundationdb.org/mengxu/{size}/893_2.png",
            "trust_level": 2
          }
        }
      ]
    },
    {
      "fancy_title": "Benchmarking FoundationDB on AWS",
      "id": 410,
      "title": "Benchmarking FoundationDB on AWS",
      "slug": "benchmarking-foundationdb-on-aws",
      "posts_count": 19,
      "reply_count": 12,
      "highest_post_number": 19,
      "image_url": null,
      "created_at": "2018-05-14T09:55:57.604Z",
      "last_posted_at": "2018-10-30T16:01:15.283Z",
      "bumped": true,
      "bumped_at": "2018-10-30T16:01:15.283Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 2,
      "views": 9035,
      "category_id": 7,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": null,
          "description": "Original Poster",
          "user": {
            "id": 118,
            "username": "abdullin",
            "name": "Rinat Abdullin",
            "avatar_template": "/user_avatar/forums.foundationdb.org/abdullin/{size}/83_2.png",
            "trust_level": 2
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 257,
            "username": "cih.y2k",
            "name": "cih.y2k",
            "avatar_template": "/user_avatar/forums.foundationdb.org/cih.y2k/{size}/423_2.png",
            "trust_level": 2
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 12,
            "username": "ajbeamon",
            "name": "A.J. Beamon",
            "avatar_template": "/user_avatar/forums.foundationdb.org/ajbeamon/{size}/13_2.png",
            "admin": true,
            "trust_level": 4
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 13,
            "username": "alexmiller",
            "name": "Alex Miller",
            "avatar_template": "/user_avatar/forums.foundationdb.org/alexmiller/{size}/326_2.png",
            "trust_level": 4
          }
        },
        {
          "extras": "latest",
          "description": "Most Recent Poster",
          "user": {
            "id": 369,
            "username": "ricky.saltzer",
            "name": "Ricky Saltzer",
            "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/r/f17d59/{size}.png",
            "trust_level": 2
          }
        }
      ]
    },
    {
      "fancy_title": "Experience of combining FoundationDB with a MPP data warehouse",
      "id": 438,
      "title": "Experience of combining FoundationDB with a MPP data warehouse",
      "slug": "experience-of-combining-foundationdb-with-a-mpp-data-warehouse",
      "posts_count": 6,
      "reply_count": 4,
      "highest_post_number": 6,
      "image_url": null,
      "created_at": "2018-05-19T15:37:27.305Z",
      "last_posted_at": "2018-05-24T00:32:08.763Z",
      "bumped": true,
      "bumped_at": "2018-05-24T00:32:08.763Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 2,
      "views": 1234,
      "category_id": 10,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": "latest",
          "description": "Original Poster, Most Recent Poster",
          "user": {
            "id": 270,
            "username": "ftian",
            "name": "",
            "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/f/aca169/{size}.png",
            "trust_level": 1
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 13,
            "username": "alexmiller",
            "name": "Alex Miller",
            "avatar_template": "/user_avatar/forums.foundationdb.org/alexmiller/{size}/326_2.png",
            "trust_level": 4
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 8,
            "username": "alloc",
            "name": "Alec Grieser",
            "avatar_template": "/user_avatar/forums.foundationdb.org/alloc/{size}/9_2.png",
            "trust_level": 4
          }
        }
      ]
    },
    {
      "fancy_title": "Are spikes of 500ms+ MaxRowReadLatency normal?",
      "id": 1508,
      "title": "Are spikes of 500ms+ MaxRowReadLatency normal?",
      "slug": "are-spikes-of-500ms-maxrowreadlatency-normal",
      "posts_count": 8,
      "reply_count": 3,
      "highest_post_number": 8,
      "image_url": null,
      "created_at": "2019-07-05T04:45:03.599Z",
      "last_posted_at": "2019-07-11T00:15:09.522Z",
      "bumped": true,
      "bumped_at": "2019-07-11T00:15:09.522Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 0,
      "views": 1216,
      "category_id": 7,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": null,
          "description": "Original Poster",
          "user": {
            "id": 619,
            "username": "eastern-grey",
            "name": "",
            "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/e/c67d28/{size}.png",
            "trust_level": 1
          }
        },
        {
          "extras": "latest",
          "description": "Most Recent Poster",
          "user": {
            "id": 13,
            "username": "alexmiller",
            "name": "Alex Miller",
            "avatar_template": "/user_avatar/forums.foundationdb.org/alexmiller/{size}/326_2.png",
            "trust_level": 4
          }
        }
      ]
    }
  ],
  "summarizable": false,
  "can_vote": false,
  "vote_count": 0,
  "user_voted": false,
  "discourse_zendesk_plugin_zendesk_id": null,
  "discourse_zendesk_plugin_zendesk_url": "https://your-url.zendesk.com/agent/tickets/",
  "details": {
    "can_edit": false,
    "notification_level": 1,
    "participants": [
      {
        "id": 1087,
        "username": "Skwiwel",
        "name": "",
        "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/s/5f8ce5/{size}.png",
        "post_count": 2,
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_color": null,
        "flair_bg_color": null,
        "flair_group_id": null,
        "trust_level": 0
      },
      {
        "id": 156,
        "username": "spullara",
        "name": "Sam Pullara",
        "avatar_template": "/user_avatar/forums.foundationdb.org/spullara/{size}/125_2.png",
        "post_count": 1,
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_color": null,
        "flair_bg_color": null,
        "flair_group_id": null,
        "trust_level": 2
      }
    ],
    "created_by": {
      "id": 1087,
      "username": "Skwiwel",
      "name": "",
      "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/s/5f8ce5/{size}.png"
    },
    "last_poster": {
      "id": 1087,
      "username": "Skwiwel",
      "name": "",
      "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/s/5f8ce5/{size}.png"
    }
  },
  "bookmarks": []
}