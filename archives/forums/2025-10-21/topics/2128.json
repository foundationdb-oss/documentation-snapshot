{
  "post_stream": {
    "posts": [
      {
        "id": 7019,
        "name": "Leo Hu",
        "username": "lehu",
        "avatar_template": "/user_avatar/forums.foundationdb.org/lehu/{size}/995_2.png",
        "created_at": "2020-05-20T05:56:50.044Z",
        "cooked": "<p>We set up a set of backup nodes/pods separate from regular data nodes. We are very happy that backup with multiple backup nodes have sped up significantly. For example, with a cluster of <strong>50GB</strong> data in test env, with a single backup node with multiple agents, the backup takes <strong>9min</strong>. With 2 backup nodes, it\u2019s <strong>5 mins</strong>; with 4 nodes, it\u2019s <strong>3min</strong>. With a large prod db of 3TB data in prod, we are able to reduce the backup time from <strong>13.5 hours to 2.5 hours</strong> with six backup nodes.</p>\n<p>On the other hand, I cannot achieve any performance boost for RESTORE with N nodes. Restores are all very slow. For the 50GB db in <strong>triple</strong> replication mode, I tested 4 times. It took 2 to 3 hours to restore. The durations were similar whether it\u2019s one backup node or N backup nodes. It seems there has been NO parallelism for restore.</p>\n<p>I haven\u2019t tested restoring for the large db in prod with N backup nodes yet. In the past, I did restore with 1 backup node, and it took <strong>27 hours for 1.5TB.</strong></p>\n<p>The restore seems to be quite slow. Is this normal with the numbers above?</p>\n<p>Why are the backup time and the restore time so different (3 mins vs 2.5 hours)?</p>\n<p>Do I miss something with parallel restore? How do I troubleshoot it?</p>\n<p>Thank you.<br>\nLeo</p>",
        "post_number": 1,
        "post_type": 1,
        "posts_count": 11,
        "updated_at": "2020-05-20T16:52:24.035Z",
        "reply_count": 0,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 302,
        "reads": 58,
        "readers_count": 57,
        "score": 1521.6,
        "yours": false,
        "topic_id": 2128,
        "topic_slug": "restore-is-slow-and-parallel-restore-doesnt-achieve-performance-boost",
        "display_username": "Leo Hu",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 2,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 643,
        "hidden": false,
        "trust_level": 1,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/restore-is-slow-and-parallel-restore-doesnt-achieve-performance-boost/2128/1",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null,
        "can_vote": false
      },
      {
        "id": 7025,
        "name": "Meng Xu",
        "username": "mengxu",
        "avatar_template": "/user_avatar/forums.foundationdb.org/mengxu/{size}/893_2.png",
        "created_at": "2020-05-20T17:35:26.272Z",
        "cooked": "<p>I assume you are running 6.2 version, which still uses the old restore.<br>\nThe old (current-released) restore can first restore the key-value range files in parallel, but has to sequentially apply the mutation in log files.<br>\nThe new restore (which will be released hopefully in 6.3 as an experimental feature) is a customized Spark-like system that can process all backup files in parallel and asynchronously, and preapplies the mutations in memory so that the mutations applied to FDB is much smaller.</p>\n<p>As to the speed, your experiment shows less than 10MB/s speed of processing the backup data, which is super slow compared to what we know. The old restore should be able to process at least 50MB/s (sometimes 100MB/s) backup data with many hosts (<a class=\"mention\" href=\"/u/steavedhams\">@SteavedHams</a> do you know how many hosts are used for the existing restore?). The new fast restore, in a very premature experiment, shows 70MB/s with only 13 processes and 4-host FDB cluster. We are still experimenting the new fast restore. The target speedup or the new fast restore is 5X faster than the current restore. (I\u2019m trying to make it faster than that.)</p>\n<p><a class=\"mention\" href=\"/u/steavedhams\">@SteavedHams</a> may want to chim in about the old (current) restore.</p>",
        "post_number": 2,
        "post_type": 1,
        "posts_count": 11,
        "updated_at": "2020-05-20T17:38:49.721Z",
        "reply_count": 1,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 3,
        "reads": 55,
        "readers_count": 54,
        "score": 31.0,
        "yours": false,
        "topic_id": 2128,
        "topic_slug": "restore-is-slow-and-parallel-restore-doesnt-achieve-performance-boost",
        "display_username": "Meng Xu",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 337,
        "hidden": false,
        "trust_level": 2,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/restore-is-slow-and-parallel-restore-doesnt-achieve-performance-boost/2128/2",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 7029,
        "name": "Leo Hu",
        "username": "lehu",
        "avatar_template": "/user_avatar/forums.foundationdb.org/lehu/{size}/995_2.png",
        "created_at": "2020-05-20T18:03:57.453Z",
        "cooked": "<p>Yes, we are using v6.2.<br>\nAre the \u201ckey-value range files\u201d the ones generated by the key-range options on the fdbbackup cmd?<br>\nWe backup the whole db, and do not use key-range backups. So the restore won\u2019t perform in parallel in our case. <strong>Is that right?</strong></p>\n<p>I just have a new restore finished. It\u2019s 15GB backup data and restored in 15min. It\u2019s about 16MB/sec. For the large restore I mentioned, it\u2019s1.5TB in key-value size. The backup size was bigger, like 1.7TB. The restore speed for that one is about 17MB/sec. Still well below 50MB/sec.</p>\n<p>Can the performance of our remote storage be a limiting factor in restore? Will giving larger RAM to backup agent help? Does replication factor affect restore speed? (Is the single replication faster than triple for restore?)</p>\n<p>Thanks.</p>",
        "post_number": 3,
        "post_type": 1,
        "posts_count": 11,
        "updated_at": "2020-05-20T18:16:47.231Z",
        "reply_count": 1,
        "reply_to_post_number": 2,
        "quote_count": 0,
        "incoming_link_count": 2,
        "reads": 53,
        "readers_count": 52,
        "score": 25.6,
        "yours": false,
        "topic_id": 2128,
        "topic_slug": "restore-is-slow-and-parallel-restore-doesnt-achieve-performance-boost",
        "display_username": "Leo Hu",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 3,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "reply_to_user": {
          "id": 337,
          "username": "mengxu",
          "name": "Meng Xu",
          "avatar_template": "/user_avatar/forums.foundationdb.org/mengxu/{size}/893_2.png"
        },
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 643,
        "hidden": false,
        "trust_level": 1,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/restore-is-slow-and-parallel-restore-doesnt-achieve-performance-boost/2128/3",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 7031,
        "name": "Steve Atherton",
        "username": "SteavedHams",
        "avatar_template": "/user_avatar/forums.foundationdb.org/steavedhams/{size}/18_2.png",
        "created_at": "2020-05-20T18:47:45.377Z",
        "cooked": "<aside class=\"quote no-group\" data-username=\"lehu\" data-post=\"3\" data-topic=\"2128\">\n<div class=\"title\">\n<div class=\"quote-controls\"></div>\n<img loading=\"lazy\" alt=\"\" width=\"24\" height=\"24\" src=\"https://sea1.discourse-cdn.com/foundationdb/user_avatar/forums.foundationdb.org/lehu/48/995_2.png\" class=\"avatar\"> lehu:</div>\n<blockquote>\n<p>Are the \u201ckey-value range files\u201d the ones generated by the key-range options on the fdbbackup cmd?<br>\nWe backup the whole db, and do not use key-range backups. So the restore won\u2019t perform in parallel in our case. <strong>Is that right?</strong></p>\n</blockquote>\n</aside>\n<p>No.<br>\nRegardless of what range is being backed up, the backup process generates many small key range files representing small slices of the key range, and they are generated in a random order over time to spread the read workload over the storage servers in the cluster.</p>\n<p>Restore loads, in parallel, all of the key range files within the restored range (in your case all of the database) but restricted to some range of <em>versions</em>, and after that a serial process applies mutations that your cluster executed during that version window.  While that serial process is happening, the key range files for the next version range are being loaded.</p>\n<p>This means that restore is speed depends largely on how much your cluster was being mutated during the backup, as applying those mutations is serial.</p>\n<p>The speed of the backup also affects restore speed because it affects how parallel the key range file load can be and how much mutation data needs to be applied.</p>\n<p>Did you try restoring the backup on your 50GB db that only took 3 minutes to create?   And what is the your cluster configuration?  Adding more logs during a restore can speed up performance, as the parallel loading of key range data could easily be log limited with too few logs.  This is also true of the new restore process available in v6.3.</p>",
        "post_number": 4,
        "post_type": 1,
        "posts_count": 11,
        "updated_at": "2020-05-20T18:47:45.377Z",
        "reply_count": 1,
        "reply_to_post_number": null,
        "quote_count": 1,
        "incoming_link_count": 0,
        "reads": 55,
        "readers_count": 54,
        "score": 31.0,
        "yours": false,
        "topic_id": 2128,
        "topic_slug": "restore-is-slow-and-parallel-restore-doesnt-achieve-performance-boost",
        "display_username": "Steve Atherton",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": "",
        "bookmarked": false,
        "actions_summary": [
          {
            "id": 2,
            "count": 1
          }
        ],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 7,
        "hidden": false,
        "trust_level": 4,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/restore-is-slow-and-parallel-restore-doesnt-achieve-performance-boost/2128/4",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 7032,
        "name": "Meng Xu",
        "username": "mengxu",
        "avatar_template": "/user_avatar/forums.foundationdb.org/mengxu/{size}/893_2.png",
        "created_at": "2020-05-20T18:58:36.288Z",
        "cooked": "<p><a class=\"mention\" href=\"/u/lehu\">@lehu</a> BTW, if you are running on AWS, did you try the snapshot based backup and restore, which can be much easier and faster.<br>\nThe only drawback is that it does not support point-in-time restore.</p>",
        "post_number": 5,
        "post_type": 1,
        "posts_count": 11,
        "updated_at": "2020-05-20T18:58:36.288Z",
        "reply_count": 1,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 0,
        "reads": 54,
        "readers_count": 53,
        "score": 15.8,
        "yours": false,
        "topic_id": 2128,
        "topic_slug": "restore-is-slow-and-parallel-restore-doesnt-achieve-performance-boost",
        "display_username": "Meng Xu",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 337,
        "hidden": false,
        "trust_level": 2,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/restore-is-slow-and-parallel-restore-doesnt-achieve-performance-boost/2128/5",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 7051,
        "name": "Leo Hu",
        "username": "lehu",
        "avatar_template": "/user_avatar/forums.foundationdb.org/lehu/{size}/995_2.png",
        "created_at": "2020-05-21T17:16:57.755Z",
        "cooked": "<p>Steve, quite interesting.</p>\n<p>For the test dbs, I made backups <strong>after</strong> the data loading finished. No changes to the db when backups were taking place. I assume that means there were no mutations during the backup window.</p>\n<p>I first loaded 50GB of data, and tested backups and restores. Since the restores took 2+ hours, I shrank the db to 15GB by clearing ranges of keys. After that, I tested again.</p>\n<p>Here is the process count report of my cluster config:</p>\n<blockquote>\n<pre><code> CNT Role\n---- -------------\n   1 cluster_controller\n   3 coordinator\n   1 data_distributor\n   5 log\n   1 master\n   3 proxy\n   1 ratekeeper\n   1 resolver\n  30 storage\n</code></pre>\n</blockquote>\n<p>I have <strong>5 Tx log processes on 5 different pods.</strong>  Are they enough?</p>\n<p>I created 6 backup pods with 6 agents on each pod, with a total of 36 agents. I checked the status json output. The 36 agents are connected to the db. From the status json output:</p>\n<blockquote>\n<pre><code>\"cluster\" : {\n    \"clients\" : {\n        \"count\" : 1,\n        \"supported_versions\" : [\n            {\n                \"client_version\" : \"Unknown\",\n                \"connected_clients\" : [\n                    {\n                        \"address\" : \"10.69.196.45:54386:tls\",\n                        \"log_group\" : \"default\"\n                    },\n                    ...... (35 more similar entries)\n                ],\n                \"count\" : 36,\n                \"protocol_version\" : \"Unknown\",\n                \"source_version\" : \"Unknown\"\n            },\n</code></pre>\n<p>\u2026</p>\n</blockquote>\n<p>Anything I should change?<br>\nThanks.</p>",
        "post_number": 6,
        "post_type": 1,
        "posts_count": 11,
        "updated_at": "2020-05-21T17:16:57.755Z",
        "reply_count": 1,
        "reply_to_post_number": 4,
        "quote_count": 0,
        "incoming_link_count": 4,
        "reads": 49,
        "readers_count": 48,
        "score": 34.8,
        "yours": false,
        "topic_id": 2128,
        "topic_slug": "restore-is-slow-and-parallel-restore-doesnt-achieve-performance-boost",
        "display_username": "Leo Hu",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "reply_to_user": {
          "id": 7,
          "username": "SteavedHams",
          "name": "Steve Atherton",
          "avatar_template": "/user_avatar/forums.foundationdb.org/steavedhams/{size}/18_2.png"
        },
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 643,
        "hidden": false,
        "trust_level": 1,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/restore-is-slow-and-parallel-restore-doesnt-achieve-performance-boost/2128/6",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 7052,
        "name": "Leo Hu",
        "username": "lehu",
        "avatar_template": "/user_avatar/forums.foundationdb.org/lehu/{size}/995_2.png",
        "created_at": "2020-05-21T17:26:03.308Z",
        "cooked": "<p>Meng, we are not using AWS, because eBay doesn\u2019t like them. <img src=\"https://emoji.discourse-cdn.com/twitter/slight_smile.png?v=9\" title=\":slight_smile:\" class=\"emoji\" alt=\":slight_smile:\"></p>\n<p>Currently we deploy fdb to eBay\u2019s customized Kubernetes clusters. Have local-ssd PVC as data storage. Not sure if the local-ssd supports snapshots.</p>\n<p>In general, what are prerequisites to have snapshot based backup and restore, in terms of FS, local vs remote storage, etc?</p>\n<p>Question about fdb\u2019s point-in-time restore: what\u2019s the time window of \u201cpoint in time\u201d? Is it the same as the backup window, or larger? For example, if I started my backup at 1am today, and it finished at 3am. Is the time window from <strong>1am to 3pm today</strong>, from which I can choose a time point like 2am to restore?  Or can I choose a time point before the backup started, like <strong>9pm yesterday</strong>?</p>\n<p>Thank you.</p>",
        "post_number": 7,
        "post_type": 1,
        "posts_count": 11,
        "updated_at": "2020-05-21T17:39:31.992Z",
        "reply_count": 1,
        "reply_to_post_number": 5,
        "quote_count": 0,
        "incoming_link_count": 2,
        "reads": 46,
        "readers_count": 45,
        "score": 24.2,
        "yours": false,
        "topic_id": 2128,
        "topic_slug": "restore-is-slow-and-parallel-restore-doesnt-achieve-performance-boost",
        "display_username": "Leo Hu",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 2,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "reply_to_user": {
          "id": 337,
          "username": "mengxu",
          "name": "Meng Xu",
          "avatar_template": "/user_avatar/forums.foundationdb.org/mengxu/{size}/893_2.png"
        },
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 643,
        "hidden": false,
        "trust_level": 1,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/restore-is-slow-and-parallel-restore-doesnt-achieve-performance-boost/2128/7",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 7053,
        "name": "Meng Xu",
        "username": "mengxu",
        "avatar_template": "/user_avatar/forums.foundationdb.org/mengxu/{size}/893_2.png",
        "created_at": "2020-05-21T17:50:44.690Z",
        "cooked": "<p>Haha, I see.</p>\n<p>The snapshot based backup and restore requires a filesystem that supports snapshot. It basically snapshots the storage and tLog files on each disk for backup and restore those files later for restore.</p>\n<p>About point-in-time restore, its contract is: when you get a restorable point (which is represented as a version number), you can restore to any version number equal or higher than the restorable point, assuming you don\u2019t delete backup files that has data after the restorable point.</p>\n<p>It takes a while (hours) to get the restorable point. The backup agents have to use transactions to take snapshot over the entire key space. Because a transaction has size limit, each transaction can only take snapshot on a sub-keyspace. The time depends on how large your DB is and how many backup agents you have: The more backup agents you have, the more snapshots you can take in parallel, the faster you can snapshot the entire keyspace.</p>\n<p>Note that the snapshot on each subspace is taken at different versions. So simply concatenating them together does not produce a consistent view of the entire keyspace. That\u2019s why we also need to capture all mutations once the backup starts.</p>",
        "post_number": 8,
        "post_type": 1,
        "posts_count": 11,
        "updated_at": "2020-05-21T17:50:44.690Z",
        "reply_count": 1,
        "reply_to_post_number": 7,
        "quote_count": 0,
        "incoming_link_count": 6,
        "reads": 46,
        "readers_count": 45,
        "score": 44.2,
        "yours": false,
        "topic_id": 2128,
        "topic_slug": "restore-is-slow-and-parallel-restore-doesnt-achieve-performance-boost",
        "display_username": "Meng Xu",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "reply_to_user": {
          "id": 643,
          "username": "lehu",
          "name": "Leo Hu",
          "avatar_template": "/user_avatar/forums.foundationdb.org/lehu/{size}/995_2.png"
        },
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 337,
        "hidden": false,
        "trust_level": 2,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/restore-is-slow-and-parallel-restore-doesnt-achieve-performance-boost/2128/8",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 7055,
        "name": "Steve Atherton",
        "username": "SteavedHams",
        "avatar_template": "/user_avatar/forums.foundationdb.org/steavedhams/{size}/18_2.png",
        "created_at": "2020-05-21T19:08:27.890Z",
        "cooked": "<aside class=\"quote no-group\" data-username=\"mengxu\" data-post=\"8\" data-topic=\"2128\">\n<div class=\"title\">\n<div class=\"quote-controls\"></div>\n<img loading=\"lazy\" alt=\"\" width=\"24\" height=\"24\" src=\"https://sea1.discourse-cdn.com/foundationdb/user_avatar/forums.foundationdb.org/mengxu/48/893_2.png\" class=\"avatar\"> mengxu:</div>\n<blockquote>\n<p>Because a transaction has size limit</p>\n</blockquote>\n</aside>\n<p>Just to clarify, for reading key range snapshots it\u2019s the transaction <em>time</em> limit that matters.  Which I guess is sort of a size, just in seconds <img src=\"https://emoji.discourse-cdn.com/twitter/slight_smile.png?v=12\" title=\":slight_smile:\" class=\"emoji\" alt=\":slight_smile:\" loading=\"lazy\" width=\"20\" height=\"20\"></p>",
        "post_number": 9,
        "post_type": 1,
        "posts_count": 11,
        "updated_at": "2020-05-21T19:08:27.890Z",
        "reply_count": 0,
        "reply_to_post_number": 8,
        "quote_count": 1,
        "incoming_link_count": 4,
        "reads": 47,
        "readers_count": 46,
        "score": 29.4,
        "yours": false,
        "topic_id": 2128,
        "topic_slug": "restore-is-slow-and-parallel-restore-doesnt-achieve-performance-boost",
        "display_username": "Steve Atherton",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": "",
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 7,
        "hidden": false,
        "trust_level": 4,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/restore-is-slow-and-parallel-restore-doesnt-achieve-performance-boost/2128/9",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 7056,
        "name": "Steve Atherton",
        "username": "SteavedHams",
        "avatar_template": "/user_avatar/forums.foundationdb.org/steavedhams/{size}/18_2.png",
        "created_at": "2020-05-21T19:19:43.298Z",
        "cooked": "<aside class=\"quote no-group\" data-username=\"lehu\" data-post=\"6\" data-topic=\"2128\">\n<div class=\"title\">\n<div class=\"quote-controls\"></div>\n<img loading=\"lazy\" alt=\"\" width=\"24\" height=\"24\" src=\"https://sea1.discourse-cdn.com/foundationdb/user_avatar/forums.foundationdb.org/lehu/48/995_2.png\" class=\"avatar\"> lehu:</div>\n<blockquote>\n<p>For the test dbs, I made backups <strong>after</strong> the data loading finished. No changes to the db when backups were taking place. I assume that means there were no mutations during the backup window.</p>\n</blockquote>\n</aside>\n<p>Correct, your mutation log would be nearly empty, and your restore speed should go as fast as your cluster can write.</p>\n<p>Based on 50GB and 2 hours, and a negligible amount of mutations, you are getting around 7 MB/s.  This is far too slow, I\u2019m not sure what the issue is.  A few things to check/try:</p>\n<ul>\n<li>Look at cluster status during restore, are any processes CPU bound?</li>\n<li>Check your hosts during the restore, are any of the over-utilized?  For example if you have 10 processes on a 4 core system, no single process will show high CPU but only because there isn\u2019t enough to go around.</li>\n<li>Check that your processes are successfully using unbuffered linux async IO.  You can tell this by looking for TraceEvents called <code>AsyncFileKAIOOpen</code> and <code>AsyncFileKAIOOpenFailed</code>.  You should have many of the former and none of the latter.</li>\n<li>Switch to single or double replication during the restore</li>\n<li>Try more proxies and more logs, perhaps 5 proxies and 8 logs.</li>\n</ul>",
        "post_number": 10,
        "post_type": 1,
        "posts_count": 11,
        "updated_at": "2020-05-21T19:19:43.298Z",
        "reply_count": 1,
        "reply_to_post_number": 6,
        "quote_count": 1,
        "incoming_link_count": 4,
        "reads": 46,
        "readers_count": 45,
        "score": 34.2,
        "yours": false,
        "topic_id": 2128,
        "topic_slug": "restore-is-slow-and-parallel-restore-doesnt-achieve-performance-boost",
        "display_username": "Steve Atherton",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": "",
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 7,
        "hidden": false,
        "trust_level": 4,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/restore-is-slow-and-parallel-restore-doesnt-achieve-performance-boost/2128/10",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 7095,
        "name": "Leo Hu",
        "username": "lehu",
        "avatar_template": "/user_avatar/forums.foundationdb.org/lehu/{size}/995_2.png",
        "created_at": "2020-05-23T04:17:19.585Z",
        "cooked": "<p>Hi Steve, I went after all the items in your list one by one. We are fine with the first 4 items, but I expanded provies and Tx logs. I\u2019ve made some progress with restores. For the 50GB db,</p>\n<ul>\n<li>It used to be 2+ hours a few days ago.</li>\n<li>yesterday\u2019s restore was 1hr 10min. I didn\u2019t do much with this restore itself, but we happened to upgrade the Kubernetes cluster by 3 minor versions 2 days ago. The upgrade could have enhanced the speed.</li>\n<li>Today it\u2019s 55min after adding more Tx and proxies to the fdb cluster following your advice.</li>\n</ul>\n<p>I found something interesting from our Tess internal Wiki page on K8s volumes:  <code>local-dynamic is 3-time slower</code>  in IO performance  <code>than local-ssd</code>  (one-third).  <code>The IOPS are 10K for local-dynamic VS. 30K for local-ssd.</code>  In the test K8s cluster, I have used local-dynamic. In the big prod db, we use local-ssd.  <strong>Therefore the test db has slower SSDs than the prod db.</strong></p>\n<p>What a coincidence! Can the 3-time SLOWER performance of local-dynamic in test env be (at least partially) responsible for the 3-time slower restore performance we have than Apple\u2019s 50MB/sec?</p>\n<p>I\u2019ll find it out when doing restore testing with prod db. Currently we have planned the K8s upgrade on that prod K8s cluster as well. Will test after the upgrade.</p>\n<p>Thank you.</p>\n<p>Leo</p>",
        "post_number": 11,
        "post_type": 1,
        "posts_count": 11,
        "updated_at": "2020-05-23T04:17:19.585Z",
        "reply_count": 0,
        "reply_to_post_number": 10,
        "quote_count": 0,
        "incoming_link_count": 0,
        "reads": 41,
        "readers_count": 40,
        "score": 8.2,
        "yours": false,
        "topic_id": 2128,
        "topic_slug": "restore-is-slow-and-parallel-restore-doesnt-achieve-performance-boost",
        "display_username": "Leo Hu",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "reply_to_user": {
          "id": 7,
          "username": "SteavedHams",
          "name": "Steve Atherton",
          "avatar_template": "/user_avatar/forums.foundationdb.org/steavedhams/{size}/18_2.png"
        },
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 643,
        "hidden": false,
        "trust_level": 1,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/restore-is-slow-and-parallel-restore-doesnt-achieve-performance-boost/2128/11",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      }
    ],
    "stream": [
      7019,
      7025,
      7029,
      7031,
      7032,
      7051,
      7052,
      7053,
      7055,
      7056,
      7095
    ]
  },
  "timeline_lookup": [
    [
      1,
      1981
    ],
    [
      2,
      1980
    ],
    [
      6,
      1979
    ],
    [
      11,
      1978
    ]
  ],
  "suggested_topics": [],
  "tags": [],
  "tags_descriptions": {},
  "fancy_title": "Restore is slow and parallel restore doesn&rsquo;t achieve performance boost",
  "id": 2128,
  "title": "Restore is slow and parallel restore doesn't achieve performance boost",
  "posts_count": 11,
  "created_at": "2020-05-20T05:56:49.975Z",
  "views": 1398,
  "reply_count": 7,
  "like_count": 1,
  "last_posted_at": "2020-05-23T04:17:19.585Z",
  "visible": true,
  "closed": false,
  "archived": false,
  "has_summary": false,
  "archetype": "regular",
  "slug": "restore-is-slow-and-parallel-restore-doesnt-achieve-performance-boost",
  "category_id": 7,
  "word_count": 1919,
  "deleted_at": null,
  "user_id": 643,
  "featured_link": null,
  "pinned_globally": false,
  "pinned_at": null,
  "pinned_until": null,
  "image_url": null,
  "slow_mode_seconds": 0,
  "draft": null,
  "draft_key": "topic_2128",
  "draft_sequence": null,
  "unpinned": null,
  "pinned": false,
  "current_post_number": 1,
  "highest_post_number": 11,
  "deleted_by": null,
  "actions_summary": [
    {
      "id": 4,
      "count": 0,
      "hidden": false,
      "can_act": false
    },
    {
      "id": 8,
      "count": 0,
      "hidden": false,
      "can_act": false
    },
    {
      "id": 10,
      "count": 0,
      "hidden": false,
      "can_act": false
    },
    {
      "id": 7,
      "count": 0,
      "hidden": false,
      "can_act": false
    }
  ],
  "chunk_size": 20,
  "bookmarked": false,
  "topic_timer": null,
  "message_bus_last_id": 0,
  "participant_count": 3,
  "show_read_indicator": false,
  "thumbnails": null,
  "slow_mode_enabled_until": null,
  "tags_disable_ads": false,
  "related_topics": [
    {
      "fancy_title": "Backup &amp; restore performance tuning",
      "id": 2078,
      "title": "Backup & restore performance tuning",
      "slug": "backup-restore-performance-tuning",
      "posts_count": 18,
      "reply_count": 16,
      "highest_post_number": 18,
      "image_url": null,
      "created_at": "2020-04-18T06:43:29.997Z",
      "last_posted_at": "2020-05-06T09:01:50.194Z",
      "bumped": true,
      "bumped_at": "2020-05-06T09:01:50.194Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [
        "performance"
      ],
      "tags_descriptions": {},
      "like_count": 1,
      "views": 2929,
      "category_id": 7,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": null,
          "description": "Original Poster",
          "user": {
            "id": 643,
            "username": "lehu",
            "name": "Leo Hu",
            "avatar_template": "/user_avatar/forums.foundationdb.org/lehu/{size}/995_2.png",
            "trust_level": 1
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 13,
            "username": "alexmiller",
            "name": "Alex Miller",
            "avatar_template": "/user_avatar/forums.foundationdb.org/alexmiller/{size}/326_2.png",
            "trust_level": 4
          }
        },
        {
          "extras": "latest",
          "description": "Most Recent Poster",
          "user": {
            "id": 7,
            "username": "SteavedHams",
            "name": "Steve Atherton",
            "avatar_template": "/user_avatar/forums.foundationdb.org/steavedhams/{size}/18_2.png",
            "trust_level": 4
          }
        }
      ]
    },
    {
      "fancy_title": "FDB 6.3 performant restore",
      "id": 2137,
      "title": "FDB 6.3 performant restore",
      "slug": "fdb-6-3-performant-restore",
      "posts_count": 17,
      "reply_count": 8,
      "highest_post_number": 17,
      "image_url": null,
      "created_at": "2020-05-27T06:16:38.330Z",
      "last_posted_at": "2022-10-05T00:25:32.840Z",
      "bumped": true,
      "bumped_at": "2022-10-05T00:25:32.840Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [
        "performance"
      ],
      "tags_descriptions": {},
      "like_count": 3,
      "views": 2583,
      "category_id": 7,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": null,
          "description": "Original Poster",
          "user": {
            "id": 645,
            "username": "subramaniamr",
            "name": "Subramaniam R",
            "avatar_template": "/user_avatar/forums.foundationdb.org/subramaniamr/{size}/658_2.png",
            "trust_level": 2
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 7,
            "username": "SteavedHams",
            "name": "Steve Atherton",
            "avatar_template": "/user_avatar/forums.foundationdb.org/steavedhams/{size}/18_2.png",
            "trust_level": 4
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 746,
            "username": "matiasholte",
            "name": "Matias Holte",
            "avatar_template": "/user_avatar/forums.foundationdb.org/matiasholte/{size}/1124_2.png",
            "trust_level": 1
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 711,
            "username": "osamarin",
            "name": "Oleg Samarin",
            "avatar_template": "/user_avatar/forums.foundationdb.org/osamarin/{size}/905_2.png",
            "trust_level": 2
          }
        },
        {
          "extras": "latest",
          "description": "Most Recent Poster",
          "user": {
            "id": 337,
            "username": "mengxu",
            "name": "Meng Xu",
            "avatar_template": "/user_avatar/forums.foundationdb.org/mengxu/{size}/893_2.png",
            "trust_level": 2
          }
        }
      ]
    },
    {
      "fancy_title": "Design and Implementation of a Performant Restore System in FDB",
      "id": 1277,
      "title": "Design and Implementation of a Performant Restore System in FDB",
      "slug": "design-and-implementation-of-a-performant-restore-system-in-fdb",
      "posts_count": 24,
      "reply_count": 21,
      "highest_post_number": 24,
      "image_url": null,
      "created_at": "2019-04-02T23:35:14.946Z",
      "last_posted_at": "2020-12-08T12:50:31.915Z",
      "bumped": true,
      "bumped_at": "2020-12-08T12:50:31.915Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 4,
      "views": 3171,
      "category_id": 5,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": null,
          "description": "Original Poster",
          "user": {
            "id": 337,
            "username": "mengxu",
            "name": "Meng Xu",
            "avatar_template": "/user_avatar/forums.foundationdb.org/mengxu/{size}/893_2.png",
            "trust_level": 2
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 13,
            "username": "alexmiller",
            "name": "Alex Miller",
            "avatar_template": "/user_avatar/forums.foundationdb.org/alexmiller/{size}/326_2.png",
            "trust_level": 4
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 454,
            "username": "jzhou",
            "name": "Jingyu Zhou",
            "avatar_template": "/user_avatar/forums.foundationdb.org/jzhou/{size}/445_2.png",
            "admin": true,
            "moderator": true,
            "trust_level": 2
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 7,
            "username": "SteavedHams",
            "name": "Steve Atherton",
            "avatar_template": "/user_avatar/forums.foundationdb.org/steavedhams/{size}/18_2.png",
            "trust_level": 4
          }
        },
        {
          "extras": "latest",
          "description": "Most Recent Poster",
          "user": {
            "id": 711,
            "username": "osamarin",
            "name": "Oleg Samarin",
            "avatar_template": "/user_avatar/forums.foundationdb.org/osamarin/{size}/905_2.png",
            "trust_level": 2
          }
        }
      ]
    },
    {
      "fancy_title": "Backup using disk snapshots",
      "id": 1076,
      "title": "Backup using disk snapshots",
      "slug": "backup-using-disk-snapshots",
      "posts_count": 15,
      "reply_count": 9,
      "highest_post_number": 15,
      "image_url": null,
      "created_at": "2019-01-29T12:52:43.232Z",
      "last_posted_at": "2019-02-14T18:12:56.795Z",
      "bumped": true,
      "bumped_at": "2019-02-14T18:12:56.795Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 2,
      "views": 2676,
      "category_id": 7,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": null,
          "description": "Original Poster",
          "user": {
            "id": 360,
            "username": "bjorndv",
            "name": "Bj\u00f6rn",
            "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/b/f05b48/{size}.png",
            "trust_level": 1
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 7,
            "username": "SteavedHams",
            "name": "Steve Atherton",
            "avatar_template": "/user_avatar/forums.foundationdb.org/steavedhams/{size}/18_2.png",
            "trust_level": 4
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 417,
            "username": "lihtnes",
            "name": "Senthil Ramamoorthy",
            "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/l/848f3c/{size}.png",
            "trust_level": 1
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 490,
            "username": "rjenkins",
            "name": "Ray Jenkins",
            "avatar_template": "/user_avatar/forums.foundationdb.org/rjenkins/{size}/487_2.png",
            "trust_level": 2
          }
        },
        {
          "extras": "latest",
          "description": "Most Recent Poster",
          "user": {
            "id": 13,
            "username": "alexmiller",
            "name": "Alex Miller",
            "avatar_template": "/user_avatar/forums.foundationdb.org/alexmiller/{size}/326_2.png",
            "trust_level": 4
          }
        }
      ]
    },
    {
      "fancy_title": "Backup /restore fdb",
      "id": 1637,
      "title": "Backup /restore fdb",
      "slug": "backup-restore-fdb",
      "posts_count": 22,
      "reply_count": 17,
      "highest_post_number": 22,
      "image_url": null,
      "created_at": "2019-09-19T17:04:18.878Z",
      "last_posted_at": "2019-10-05T04:45:51.663Z",
      "bumped": true,
      "bumped_at": "2019-10-05T04:45:51.663Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 0,
      "views": 2729,
      "category_id": 7,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": null,
          "description": "Original Poster",
          "user": {
            "id": 604,
            "username": "Minaxi",
            "name": "meenakshi subramanyam",
            "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/m/2bfe46/{size}.png",
            "trust_level": 1
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 337,
            "username": "mengxu",
            "name": "Meng Xu",
            "avatar_template": "/user_avatar/forums.foundationdb.org/mengxu/{size}/893_2.png",
            "trust_level": 2
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 7,
            "username": "SteavedHams",
            "name": "Steve Atherton",
            "avatar_template": "/user_avatar/forums.foundationdb.org/steavedhams/{size}/18_2.png",
            "trust_level": 4
          }
        },
        {
          "extras": "latest",
          "description": "Most Recent Poster",
          "user": {
            "id": 13,
            "username": "alexmiller",
            "name": "Alex Miller",
            "avatar_template": "/user_avatar/forums.foundationdb.org/alexmiller/{size}/326_2.png",
            "trust_level": 4
          }
        }
      ]
    }
  ],
  "summarizable": false,
  "can_vote": false,
  "vote_count": 0,
  "user_voted": false,
  "discourse_zendesk_plugin_zendesk_id": null,
  "discourse_zendesk_plugin_zendesk_url": "https://your-url.zendesk.com/agent/tickets/",
  "details": {
    "can_edit": false,
    "notification_level": 1,
    "participants": [
      {
        "id": 643,
        "username": "lehu",
        "name": "Leo Hu",
        "avatar_template": "/user_avatar/forums.foundationdb.org/lehu/{size}/995_2.png",
        "post_count": 5,
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_color": null,
        "flair_bg_color": null,
        "flair_group_id": null,
        "trust_level": 1
      },
      {
        "id": 7,
        "username": "SteavedHams",
        "name": "Steve Atherton",
        "avatar_template": "/user_avatar/forums.foundationdb.org/steavedhams/{size}/18_2.png",
        "post_count": 3,
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_color": null,
        "flair_bg_color": null,
        "flair_group_id": null,
        "trust_level": 4
      },
      {
        "id": 337,
        "username": "mengxu",
        "name": "Meng Xu",
        "avatar_template": "/user_avatar/forums.foundationdb.org/mengxu/{size}/893_2.png",
        "post_count": 3,
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_color": null,
        "flair_bg_color": null,
        "flair_group_id": null,
        "trust_level": 2
      }
    ],
    "created_by": {
      "id": 643,
      "username": "lehu",
      "name": "Leo Hu",
      "avatar_template": "/user_avatar/forums.foundationdb.org/lehu/{size}/995_2.png"
    },
    "last_poster": {
      "id": 643,
      "username": "lehu",
      "name": "Leo Hu",
      "avatar_template": "/user_avatar/forums.foundationdb.org/lehu/{size}/995_2.png"
    }
  },
  "bookmarks": []
}