{
  "post_stream": {
    "posts": [
      {
        "id": 14340,
        "name": "Dan Meyers",
        "username": "danm",
        "avatar_template": "/user_avatar/forums.foundationdb.org/danm/{size}/1393_2.png",
        "created_at": "2024-09-09T09:12:45.174Z",
        "cooked": "<p>Very weird one here, looking for any insight into how it might have happened.</p>\n<p>We\u2019ve got 2 FDB clusters in our development environment, in 2 regions. The primary is normally set to replicate to the secondary. I manually rolled out a change I was testing which had worked in a new test cluster to our primary dev cluster, the result of which was to utterly destroy the primary cluster (I mistakenly triggered a format of the volumes on which the FDB data directory was held). No worries, this is why we have a dev env and DR.</p>\n<ul>\n<li>On the secondary cluster, I ran <code>fdbdr abort --dstonly --source &lt;primary_cluster_file&gt; --destination &lt;secondary_cluster_file&gt;</code></li>\n<li>I (re)created a new DB on the original primary cluster, then on the secondary I ran <code>fdbdr start --source &lt;secondary_cluster_file&gt; --destination &lt;primary_cluster_file&gt;</code></li>\n<li>I verified that the DR was running, and that the sum of key/value storage on the new DB was increasing. <code>fdbdr status ...</code> was reporting that the DR was <em>not</em> a complete copy (as expected).</li>\n<li>After some time, <code>fdbdr status ...</code> was reporting that DR <em>was</em> a complete copy, and that the destination was ~1.5s behind. Checking the key/value sizes on both clusters gave expected and very close amounts too (our application was running from the secondary region at this point, so it was constantly having data written to it to sync across).</li>\n<li>I ran <code>fdbdr switch --source &lt;secondary_cluster_file&gt; --destination &lt;primary_cluster_file&gt;</code></li>\n<li>I got a fatal error from <code>fdbdr</code>\u2026</li>\n</ul>\n<p>Running with trace logging enabled on the <code>fdbdr</code> command, it would seem the actual error is:</p>\n<pre><code class=\"lang-auto\">{  \"Severity\": \"20\", \"Time\": \"1725793370.194168\", \"DateTime\": \"2024-09-08T11:02:50Z\", \"Type\": \"DBA_TagNotPresentInStatus\", \"ID\": \"0000000000000000\", \"Tag\": \"default\", \"Context\": \"dr_backup_dest\", \"ThreadID\": \"114316097773912472\", \"Machine\": \"10.129.244.16:49211\", \"LogGroup\": \"default\", \"ClientDescription\": \"primary-7.1.49-114316097773912472\" }\n</code></pre>\n<p>I\u2019ve since verified this. The new DB seems to have no knowledge that it is a destination for DR replication (<code>fdbcli --exec 'status details'</code>, and also combing through the output of <code>status json</code>). But <code>fdbdr status ...</code> still says that the destination is a complete copy of the DB ~1.5s behind the source, and the destination <em>does</em> seem to be getting new keys from the source written to it.</p>\n<p>At this point I\u2019m assuming (but haven\u2019t yet tried) I should be able to <code>fdbdr abort ...</code> on the secondary cluster, switch our application back to the primary region (there might be a small amount of data loss, but I don\u2019t care overmuch because it\u2019s dev), and then wipe the secondary and re-setup the DR sync in the intended direction.</p>\n<p>But am I kinda confused as to how it got into this state in the first place. I unfortunately wiped my terminal history for that tab to make following output from something else easier, so I can\u2019t look back and confirm if the new DB <em>ever</em> recognised that it was a DR destination.</p>",
        "post_number": 1,
        "post_type": 1,
        "posts_count": 4,
        "updated_at": "2024-09-09T12:01:36.441Z",
        "reply_count": 0,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 15,
        "reads": 18,
        "readers_count": 17,
        "score": 78.6,
        "yours": false,
        "topic_id": 4606,
        "topic_slug": "fdbdr-destination-cluster-doesnt-recognise-dr-is-running",
        "display_username": "Dan Meyers",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 2,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 1142,
        "hidden": false,
        "trust_level": 2,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/fdbdr-destination-cluster-doesnt-recognise-dr-is-running/4606/1",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null,
        "can_vote": false
      },
      {
        "id": 14341,
        "name": "Dan Meyers",
        "username": "danm",
        "avatar_template": "/user_avatar/forums.foundationdb.org/danm/{size}/1393_2.png",
        "created_at": "2024-09-09T12:10:07.364Z",
        "cooked": "<p>More information from subsequent testing. I can replicate this reliably.</p>\n<ul>\n<li><code>status json</code> on the secondary cluster shows both a <code>dr_backup</code> (the current DR process) and <code>dr_backup_dest</code> (the old, aborted, process) block.</li>\n<li>The same on the primary cluster only shows <code>dr_backup</code>, which has a <code>mutation_stream_id</code> matching that of <code>dr_backup_dest</code> from the secondary. There is no <code>dr_backup_dest</code>.</li>\n<li>The primary cluster <em>does</em> have a DB lock applied, which was presumably done as a result of the new fdbdr process being started.</li>\n</ul>\n<p>I am confused how the primary cluster still has a record of being a source for the old DR process, given that all the volumes were formatted and then the instances terminated and new ones created. All data was lost.</p>\n<p>I have a theory. The <code>fdb.cluster</code> file contains data which looks like <code>seed:&lt;ID&gt;@IP1:port,IP2:port...</code>. I\u2019ve done a quick test, and given that we are statically assigning an ENI for the coordinator instances, the IP:port values are identical between the old and new clusters. This has resulted in the <code>&lt;ID&gt;</code> <em>also</em> being identical, even though I completely wiped the state data and recreated the DB.</p>\n<p>Is the DR state in some way tied to that cluster ID? And there\u2019s some bug related to stopping then recreating a DR setup with the same (but inverted) source and destination IDs?</p>\n<p>I could potentially completely destroy all resources for the primary cluster and recreate them. That would result in a different set of static coordinator IPs being created, and presumably then a different cluster ID.</p>",
        "post_number": 2,
        "post_type": 1,
        "posts_count": 4,
        "updated_at": "2024-09-09T15:03:26.995Z",
        "reply_count": 0,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 0,
        "reads": 18,
        "readers_count": 17,
        "score": 3.6,
        "yours": false,
        "topic_id": 4606,
        "topic_slug": "fdbdr-destination-cluster-doesnt-recognise-dr-is-running",
        "display_username": "Dan Meyers",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 2,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 1142,
        "hidden": false,
        "trust_level": 2,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/fdbdr-destination-cluster-doesnt-recognise-dr-is-running/4606/2",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 14342,
        "name": "Dan Meyers",
        "username": "danm",
        "avatar_template": "/user_avatar/forums.foundationdb.org/danm/{size}/1393_2.png",
        "created_at": "2024-09-09T13:33:20.630Z",
        "cooked": "<p>OK, no, that didn\u2019t work. I got a completely new set of coordinator IPs and somehow the DB <em>still</em> knew it was originally a source for a now-aborted DR process, before I\u2019d restarted.</p>\n<p>Both the new primary and old secondary clusters are already running <code>dr_agent</code>, pointed at each other, so I guess the DR agent process is getting that information from the destination cluster (which <em>hasn\u2019t</em> changed coordinator IPs)? How is it associating the old, aborted, process with itself?</p>",
        "post_number": 3,
        "post_type": 1,
        "posts_count": 4,
        "updated_at": "2024-09-09T13:33:20.630Z",
        "reply_count": 0,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 0,
        "reads": 18,
        "readers_count": 17,
        "score": 3.6,
        "yours": false,
        "topic_id": 4606,
        "topic_slug": "fdbdr-destination-cluster-doesnt-recognise-dr-is-running",
        "display_username": "Dan Meyers",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 1142,
        "hidden": false,
        "trust_level": 2,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/fdbdr-destination-cluster-doesnt-recognise-dr-is-running/4606/3",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 14344,
        "name": "Dan Meyers",
        "username": "danm",
        "avatar_template": "/user_avatar/forums.foundationdb.org/danm/{size}/1393_2.png",
        "created_at": "2024-09-09T17:34:18.303Z",
        "cooked": "<p>More weirdness.</p>\n<p><code>fdbcli --exec 'status details'</code> and <code>fdbcli --exec 'status json'</code> (plus some searching through the resulting doc) both show the destination cluster fluctuating on whether it\u2019s a DR replica or not. Sometimes it reports that it is, sometimes not. These are ephemeral instances configured by script, so all the instances should have identical configuration and setup, but it <em>feels</em> like it\u2019s dependent on which agent most recently updated the magic keys in the DB, and some agents are correctly connected but others are not\u2026</p>",
        "post_number": 4,
        "post_type": 1,
        "posts_count": 4,
        "updated_at": "2024-09-09T17:34:18.303Z",
        "reply_count": 0,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 0,
        "reads": 16,
        "readers_count": 15,
        "score": 3.2,
        "yours": false,
        "topic_id": 4606,
        "topic_slug": "fdbdr-destination-cluster-doesnt-recognise-dr-is-running",
        "display_username": "Dan Meyers",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 1142,
        "hidden": false,
        "trust_level": 2,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/fdbdr-destination-cluster-doesnt-recognise-dr-is-running/4606/4",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      }
    ],
    "stream": [
      14340,
      14341,
      14342,
      14344
    ]
  },
  "timeline_lookup": [
    [
      1,
      408
    ],
    [
      2,
      407
    ]
  ],
  "suggested_topics": [],
  "tags": [],
  "tags_descriptions": {},
  "fancy_title": "Fdbdr destination cluster doesn&rsquo;t recognise DR is running?",
  "id": 4606,
  "title": "Fdbdr destination cluster doesn't recognise DR is running?",
  "posts_count": 4,
  "created_at": "2024-09-09T09:12:45.115Z",
  "views": 54,
  "reply_count": 0,
  "like_count": 0,
  "last_posted_at": "2024-09-09T17:34:18.303Z",
  "visible": true,
  "closed": false,
  "archived": false,
  "has_summary": false,
  "archetype": "regular",
  "slug": "fdbdr-destination-cluster-doesnt-recognise-dr-is-running",
  "category_id": 7,
  "word_count": 909,
  "deleted_at": null,
  "user_id": 1142,
  "featured_link": null,
  "pinned_globally": false,
  "pinned_at": null,
  "pinned_until": null,
  "image_url": null,
  "slow_mode_seconds": 0,
  "draft": null,
  "draft_key": "topic_4606",
  "draft_sequence": null,
  "unpinned": null,
  "pinned": false,
  "current_post_number": 1,
  "highest_post_number": 4,
  "deleted_by": null,
  "actions_summary": [
    {
      "id": 4,
      "count": 0,
      "hidden": false,
      "can_act": false
    },
    {
      "id": 8,
      "count": 0,
      "hidden": false,
      "can_act": false
    },
    {
      "id": 10,
      "count": 0,
      "hidden": false,
      "can_act": false
    },
    {
      "id": 7,
      "count": 0,
      "hidden": false,
      "can_act": false
    }
  ],
  "chunk_size": 20,
  "bookmarked": false,
  "topic_timer": null,
  "message_bus_last_id": 0,
  "participant_count": 1,
  "show_read_indicator": false,
  "thumbnails": null,
  "slow_mode_enabled_until": null,
  "tags_disable_ads": false,
  "related_topics": [
    {
      "fancy_title": "FoundationDB fdbdr",
      "id": 1449,
      "title": "FoundationDB fdbdr",
      "slug": "foundationdb-fdbdr",
      "posts_count": 8,
      "reply_count": 5,
      "highest_post_number": 8,
      "image_url": null,
      "created_at": "2019-06-13T06:33:40.394Z",
      "last_posted_at": "2019-06-13T22:26:26.460Z",
      "bumped": true,
      "bumped_at": "2019-06-13T22:52:52.665Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 2,
      "views": 1383,
      "category_id": 7,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": "latest",
          "description": "Original Poster, Most Recent Poster",
          "user": {
            "id": 579,
            "username": "approachcp",
            "name": "",
            "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/a/f04885/{size}.png",
            "trust_level": 1
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 13,
            "username": "alexmiller",
            "name": "Alex Miller",
            "avatar_template": "/user_avatar/forums.foundationdb.org/alexmiller/{size}/326_2.png",
            "trust_level": 4
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 12,
            "username": "ajbeamon",
            "name": "A.J. Beamon",
            "avatar_template": "/user_avatar/forums.foundationdb.org/ajbeamon/{size}/13_2.png",
            "admin": true,
            "trust_level": 4
          }
        }
      ]
    },
    {
      "fancy_title": "DR configuration",
      "id": 1306,
      "title": "DR configuration",
      "slug": "dr-configuration",
      "posts_count": 4,
      "reply_count": 2,
      "highest_post_number": 4,
      "image_url": null,
      "created_at": "2019-04-15T10:04:02.904Z",
      "last_posted_at": "2019-04-16T16:20:03.634Z",
      "bumped": true,
      "bumped_at": "2019-04-16T16:20:03.634Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 1,
      "views": 1028,
      "category_id": 7,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": null,
          "description": "Original Poster",
          "user": {
            "id": 419,
            "username": "doublemax",
            "name": "",
            "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/d/8e7dd6/{size}.png",
            "trust_level": 2
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 13,
            "username": "alexmiller",
            "name": "Alex Miller",
            "avatar_template": "/user_avatar/forums.foundationdb.org/alexmiller/{size}/326_2.png",
            "trust_level": 4
          }
        },
        {
          "extras": "latest",
          "description": "Most Recent Poster",
          "user": {
            "id": 12,
            "username": "ajbeamon",
            "name": "A.J. Beamon",
            "avatar_template": "/user_avatar/forums.foundationdb.org/ajbeamon/{size}/13_2.png",
            "admin": true,
            "trust_level": 4
          }
        }
      ]
    },
    {
      "fancy_title": "Pre-switch check",
      "id": 1045,
      "title": "Pre-switch check",
      "slug": "pre-switch-check",
      "posts_count": 3,
      "reply_count": 1,
      "highest_post_number": 3,
      "image_url": null,
      "created_at": "2019-01-23T01:22:02.875Z",
      "last_posted_at": "2019-01-24T19:34:55.115Z",
      "bumped": true,
      "bumped_at": "2019-01-24T19:34:55.115Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 1,
      "views": 436,
      "category_id": 7,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": "latest",
          "description": "Original Poster, Most Recent Poster",
          "user": {
            "id": 489,
            "username": "cdonati",
            "name": "Chris Donati",
            "avatar_template": "/user_avatar/forums.foundationdb.org/cdonati/{size}/515_2.png",
            "trust_level": 1
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 337,
            "username": "mengxu",
            "name": "Meng Xu",
            "avatar_template": "/user_avatar/forums.foundationdb.org/mengxu/{size}/893_2.png",
            "trust_level": 2
          }
        }
      ]
    },
    {
      "fancy_title": "How to create a DR site?",
      "id": 1903,
      "title": "How to create a DR site?",
      "slug": "how-to-create-a-dr-site",
      "posts_count": 7,
      "reply_count": 5,
      "highest_post_number": 7,
      "image_url": null,
      "created_at": "2020-01-23T15:42:22.124Z",
      "last_posted_at": "2022-04-19T22:19:14.375Z",
      "bumped": true,
      "bumped_at": "2022-04-19T22:19:14.375Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 0,
      "views": 1176,
      "category_id": 7,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": null,
          "description": "Original Poster",
          "user": {
            "id": 711,
            "username": "osamarin",
            "name": "Oleg Samarin",
            "avatar_template": "/user_avatar/forums.foundationdb.org/osamarin/{size}/905_2.png",
            "trust_level": 2
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 3,
            "username": "john_brownlee",
            "name": "John Brownlee",
            "avatar_template": "/user_avatar/forums.foundationdb.org/john_brownlee/{size}/22_2.png",
            "admin": true,
            "trust_level": 4
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 1046,
            "username": "hamakh12",
            "name": "Muhammad Khalil",
            "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/h/258eb7/{size}.png",
            "trust_level": 1
          }
        },
        {
          "extras": "latest",
          "description": "Most Recent Poster",
          "user": {
            "id": 890,
            "username": "tangerine",
            "name": "",
            "avatar_template": "/user_avatar/forums.foundationdb.org/tangerine/{size}/1084_2.png",
            "trust_level": 1
          }
        }
      ]
    },
    {
      "fancy_title": "DR Explanations/Help",
      "id": 3749,
      "title": "DR Explanations/Help",
      "slug": "dr-explanations-help",
      "posts_count": 2,
      "reply_count": 0,
      "highest_post_number": 2,
      "image_url": null,
      "created_at": "2023-01-19T16:08:17.672Z",
      "last_posted_at": "2023-01-20T13:43:18.297Z",
      "bumped": true,
      "bumped_at": "2023-01-20T13:43:18.297Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 0,
      "views": 355,
      "category_id": 7,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": "latest single",
          "description": "Original Poster, Most Recent Poster",
          "user": {
            "id": 1203,
            "username": "leonardb",
            "name": "Leonardb",
            "avatar_template": "/user_avatar/forums.foundationdb.org/leonardb/{size}/1498_2.png",
            "trust_level": 1
          }
        }
      ]
    }
  ],
  "summarizable": false,
  "can_vote": false,
  "vote_count": 0,
  "user_voted": false,
  "discourse_zendesk_plugin_zendesk_id": null,
  "discourse_zendesk_plugin_zendesk_url": "https://your-url.zendesk.com/agent/tickets/",
  "details": {
    "can_edit": false,
    "notification_level": 1,
    "participants": [
      {
        "id": 1142,
        "username": "danm",
        "name": "Dan Meyers",
        "avatar_template": "/user_avatar/forums.foundationdb.org/danm/{size}/1393_2.png",
        "post_count": 4,
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_color": null,
        "flair_bg_color": null,
        "flair_group_id": null,
        "trust_level": 2
      }
    ],
    "created_by": {
      "id": 1142,
      "username": "danm",
      "name": "Dan Meyers",
      "avatar_template": "/user_avatar/forums.foundationdb.org/danm/{size}/1393_2.png"
    },
    "last_poster": {
      "id": 1142,
      "username": "danm",
      "name": "Dan Meyers",
      "avatar_template": "/user_avatar/forums.foundationdb.org/danm/{size}/1393_2.png"
    }
  },
  "bookmarks": []
}