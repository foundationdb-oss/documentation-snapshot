{
  "post_stream": {
    "posts": [
      {
        "id": 9458,
        "name": "Steve Korshakov",
        "username": "ex3ndr",
        "avatar_template": "/user_avatar/forums.foundationdb.org/ex3ndr/{size}/389_2.png",
        "created_at": "2021-05-20T15:53:49.103Z",
        "cooked": "<p>I have the next case: Let\u2019s say I have ~5k users that want to join a voice chat and with first join, we must spin up the media stack and with last one left close everything down.</p>\n<p>Users came and leave in huge bursts, let\u2019s say they come all within one second and leave the same way.</p>\n<p>To detect the start/end of a call I have two keys: one for the total number (<code>counter</code>) of users and one is a flag if the voice has been <code>started</code>.</p>\n<p>Starting a call is very easy - just check if <code>started</code> is false and then schedule work to the media server. If 100 users jump on call it would \u2018only\u2019 cost 199 transaction iterations. But when leaving we have to have read conflict with total counter meaning that we need to wait for each other to leave chat and execute every transaction sequently until the counter reaches zero. In my simple tests, it takes ~578 retries for 100 users to leave the chat.</p>\n<p>I am wrapping my head for a long time with this issue. Is there any simple solution to avoid this conflicts?</p>",
        "post_number": 1,
        "post_type": 1,
        "posts_count": 4,
        "updated_at": "2021-05-20T15:53:49.103Z",
        "reply_count": 0,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 27,
        "reads": 21,
        "readers_count": 20,
        "score": 139.2,
        "yours": false,
        "topic_id": 2710,
        "topic_slug": "reduce-number-of-conflicts-for-detecting-when-counter-reaches-zero",
        "display_username": "Steve Korshakov",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 393,
        "hidden": false,
        "trust_level": 2,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/reduce-number-of-conflicts-for-detecting-when-counter-reaches-zero/2710/1",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null,
        "can_vote": false
      },
      {
        "id": 9459,
        "name": "",
        "username": "andrew.noyes",
        "avatar_template": "/user_avatar/forums.foundationdb.org/andrew.noyes/{size}/443_2.png",
        "created_at": "2021-05-20T17:04:20.986Z",
        "cooked": "<p>It sounds like you\u2019re already using atomic add for the counter, which makes sense. One option is to have a \u201cbackground\u201d worker watching/polling the counter. Once it reaches zero, then that worker can update <code>started</code> to false (or whatever else needs to happen).</p>\n<p>To make sure that the transactions that change counter are idempotent I would recommend additionally writing some kind of user_id to a keyspace with the invariant that counter == number of user_id\u2019s. Otherwise retrying on e.g. commit_unknown_result could cause the count to go negative or other weirdness.</p>\n<p>Something like this in python-ish pseudocode:</p>\n<p>Add user to voice chat:</p>\n<pre><code class=\"lang-auto\">if subspace[\"started\"] is true or not present and subspace[\"users\"][user_id] is not present:\n    subspace[\"users\"][user_id] = ''\n    subspace[\"count\"].atomic_add(1)\n    subspace[\"started\"] = true\n</code></pre>\n<p>Remove user from voice chat:</p>\n<pre><code class=\"lang-auto\">if subspace[\"users\"][user_id] is present:\n    delete subspace[\"users\"][user_id]\n    subspace[\"count\"].atomic_add(-1)\n</code></pre>\n<p>Background worker</p>\n<pre><code class=\"lang-auto\">loop:\n    wait(subspace[\"count\"].onChange)\n    if subspace[\"started\"] == true and subspace[\"count\"] == 0:\n        subspace[\"started\"] = false # voice chat is over. Tear down and don't let users join anymore\n</code></pre>",
        "post_number": 2,
        "post_type": 1,
        "posts_count": 4,
        "updated_at": "2021-05-20T17:04:20.986Z",
        "reply_count": 0,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 0,
        "reads": 21,
        "readers_count": 20,
        "score": 34.2,
        "yours": false,
        "topic_id": 2710,
        "topic_slug": "reduce-number-of-conflicts-for-detecting-when-counter-reaches-zero",
        "display_username": "",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": "",
        "bookmarked": false,
        "actions_summary": [
          {
            "id": 2,
            "count": 2
          }
        ],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 14,
        "hidden": false,
        "trust_level": 2,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/reduce-number-of-conflicts-for-detecting-when-counter-reaches-zero/2710/2",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 9461,
        "name": "gaurav",
        "username": "gaurav",
        "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/g/b487fb/{size}.png",
        "created_at": "2021-05-21T03:52:17.539Z",
        "cooked": "<p>It is an interesting problem. One way could be to shard the counter k ways. Each user would increment and decrement a pre-determined shard. Once all shards reach 0, cleanup can be done. This suggestion is based on assumption that given n users, <span class=\"hashtag\">#conflicts</span> are O(n^2); splitting n should reduce the conflicts.</p>",
        "post_number": 3,
        "post_type": 1,
        "posts_count": 4,
        "updated_at": "2021-05-21T03:55:25.089Z",
        "reply_count": 1,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 0,
        "reads": 15,
        "readers_count": 14,
        "score": 8.0,
        "yours": false,
        "topic_id": 2710,
        "topic_slug": "reduce-number-of-conflicts-for-detecting-when-counter-reaches-zero",
        "display_username": "gaurav",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 166,
        "hidden": false,
        "trust_level": 3,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/reduce-number-of-conflicts-for-detecting-when-counter-reaches-zero/2710/3",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 9469,
        "name": "gaurav",
        "username": "gaurav",
        "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/g/b487fb/{size}.png",
        "created_at": "2021-05-21T05:31:15.594Z",
        "cooked": "<p>Another way could be that users can just decrement counter without a read conflict. And then issue a fresh read transaction to see if value is 0; if the value is 0, then they can set another boolean as false (with proper read write conflict), similar to \u2018started\u2019, and whichever client successfully does that can clean things up.</p>\n<p>This is very rough skeletal idea, with need of careful idempotent operations and handling of failures in between two transactions.</p>",
        "post_number": 4,
        "post_type": 1,
        "posts_count": 4,
        "updated_at": "2021-05-21T05:31:15.594Z",
        "reply_count": 0,
        "reply_to_post_number": 3,
        "quote_count": 0,
        "incoming_link_count": 0,
        "reads": 14,
        "readers_count": 13,
        "score": 2.8,
        "yours": false,
        "topic_id": 2710,
        "topic_slug": "reduce-number-of-conflicts-for-detecting-when-counter-reaches-zero",
        "display_username": "gaurav",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "reply_to_user": {
          "id": 166,
          "username": "gaurav",
          "name": "gaurav",
          "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/g/b487fb/{size}.png"
        },
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 166,
        "hidden": false,
        "trust_level": 3,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/reduce-number-of-conflicts-for-detecting-when-counter-reaches-zero/2710/4",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      }
    ],
    "stream": [
      9458,
      9459,
      9461,
      9469
    ]
  },
  "timeline_lookup": [
    [
      1,
      1615
    ]
  ],
  "suggested_topics": [],
  "tags": [],
  "tags_descriptions": {},
  "fancy_title": "Reduce number of conflicts for detecting when counter reaches zero",
  "id": 2710,
  "title": "Reduce number of conflicts for detecting when counter reaches zero",
  "posts_count": 4,
  "created_at": "2021-05-20T15:53:49.023Z",
  "views": 600,
  "reply_count": 1,
  "like_count": 2,
  "last_posted_at": "2021-05-21T05:31:15.594Z",
  "visible": true,
  "closed": false,
  "archived": false,
  "has_summary": false,
  "archetype": "regular",
  "slug": "reduce-number-of-conflicts-for-detecting-when-counter-reaches-zero",
  "category_id": 9,
  "word_count": 506,
  "deleted_at": null,
  "user_id": 393,
  "featured_link": null,
  "pinned_globally": false,
  "pinned_at": null,
  "pinned_until": null,
  "image_url": null,
  "slow_mode_seconds": 0,
  "draft": null,
  "draft_key": "topic_2710",
  "draft_sequence": null,
  "unpinned": null,
  "pinned": false,
  "current_post_number": 1,
  "highest_post_number": 4,
  "deleted_by": null,
  "actions_summary": [
    {
      "id": 4,
      "count": 0,
      "hidden": false,
      "can_act": false
    },
    {
      "id": 8,
      "count": 0,
      "hidden": false,
      "can_act": false
    },
    {
      "id": 10,
      "count": 0,
      "hidden": false,
      "can_act": false
    },
    {
      "id": 7,
      "count": 0,
      "hidden": false,
      "can_act": false
    }
  ],
  "chunk_size": 20,
  "bookmarked": false,
  "topic_timer": null,
  "message_bus_last_id": 0,
  "participant_count": 3,
  "show_read_indicator": false,
  "thumbnails": null,
  "slow_mode_enabled_until": null,
  "tags_disable_ads": false,
  "related_topics": [
    {
      "fancy_title": "How to minimize transaction conflicts on atomic operations?",
      "id": 1051,
      "title": "How to minimize transaction conflicts on atomic operations?",
      "slug": "how-to-minimize-transaction-conflicts-on-atomic-operations",
      "posts_count": 8,
      "reply_count": 4,
      "highest_post_number": 8,
      "image_url": null,
      "created_at": "2019-01-24T15:30:28.527Z",
      "last_posted_at": "2019-01-25T16:01:20.698Z",
      "bumped": true,
      "bumped_at": "2019-01-25T16:01:20.698Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 5,
      "views": 2181,
      "category_id": 9,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": null,
          "description": "Original Poster",
          "user": {
            "id": 323,
            "username": "WolfDan",
            "name": "Wolf Dan",
            "avatar_template": "/user_avatar/forums.foundationdb.org/wolfdan/{size}/806_2.png",
            "trust_level": 2
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 53,
            "username": "KrzysFR",
            "name": "Christophe Chevalier",
            "avatar_template": "/user_avatar/forums.foundationdb.org/krzysfr/{size}/43_2.png",
            "trust_level": 2
          }
        },
        {
          "extras": "latest",
          "description": "Most Recent Poster",
          "user": {
            "id": 81,
            "username": "ryanworl",
            "name": "Ryan Worl",
            "avatar_template": "/user_avatar/forums.foundationdb.org/ryanworl/{size}/440_2.png",
            "trust_level": 3
          }
        }
      ]
    },
    {
      "fancy_title": "Atomic_Add(key, -1) can &ldquo;leak&rdquo; keys with value 0 if you are not careful",
      "id": 148,
      "title": "Atomic_Add(key, -1) can \"leak\" keys with value 0 if you are not careful",
      "slug": "atomic-add-key-1-can-leak-keys-with-value-0-if-you-are-not-careful",
      "posts_count": 5,
      "reply_count": 2,
      "highest_post_number": 5,
      "image_url": null,
      "created_at": "2018-04-20T19:00:47.495Z",
      "last_posted_at": "2018-04-21T10:05:05.991Z",
      "bumped": true,
      "bumped_at": "2018-04-21T10:05:05.991Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 2,
      "views": 817,
      "category_id": 7,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": "latest",
          "description": "Original Poster, Most Recent Poster",
          "user": {
            "id": 53,
            "username": "KrzysFR",
            "name": "Christophe Chevalier",
            "avatar_template": "/user_avatar/forums.foundationdb.org/krzysfr/{size}/43_2.png",
            "trust_level": 2
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 111,
            "username": "andoma",
            "name": "Andreas Smas",
            "avatar_template": "/user_avatar/forums.foundationdb.org/andoma/{size}/78_2.png",
            "trust_level": 1
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 54,
            "username": "Evan",
            "name": "Evan Tschannen",
            "avatar_template": "/user_avatar/forums.foundationdb.org/evan/{size}/104_2.png",
            "moderator": true,
            "trust_level": 1
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 22,
            "username": "dave",
            "name": "David Scherer",
            "avatar_template": "/user_avatar/forums.foundationdb.org/dave/{size}/89_2.png",
            "trust_level": 1
          }
        }
      ]
    },
    {
      "fancy_title": "Go lang AddReadConflictKey AddWriteConflictKey",
      "id": 1842,
      "title": "Go lang AddReadConflictKey AddWriteConflictKey",
      "slug": "go-lang-addreadconflictkey-addwriteconflictkey",
      "posts_count": 4,
      "reply_count": 0,
      "highest_post_number": 4,
      "image_url": null,
      "created_at": "2019-12-16T07:17:17.187Z",
      "last_posted_at": "2019-12-16T21:07:59.763Z",
      "bumped": true,
      "bumped_at": "2019-12-16T21:07:59.763Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [
        "bindings"
      ],
      "tags_descriptions": {},
      "like_count": 0,
      "views": 851,
      "category_id": 5,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": "latest",
          "description": "Original Poster, Most Recent Poster",
          "user": {
            "id": 538,
            "username": "ravilution",
            "name": "Ravilution",
            "avatar_template": "/user_avatar/forums.foundationdb.org/ravilution/{size}/728_2.png",
            "trust_level": 2
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 166,
            "username": "gaurav",
            "name": "gaurav",
            "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/g/b487fb/{size}.png",
            "trust_level": 3
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 8,
            "username": "alloc",
            "name": "Alec Grieser",
            "avatar_template": "/user_avatar/forums.foundationdb.org/alloc/{size}/9_2.png",
            "trust_level": 4
          }
        }
      ]
    },
    {
      "fancy_title": "What&rsquo;s the simplest solution to my use case?",
      "id": 3086,
      "title": "What's the simplest solution to my use case?",
      "slug": "whats-the-simplest-solution-to-my-use-case",
      "posts_count": 2,
      "reply_count": 0,
      "highest_post_number": 2,
      "image_url": null,
      "created_at": "2021-12-17T10:31:54.599Z",
      "last_posted_at": "2021-12-20T19:03:38.952Z",
      "bumped": true,
      "bumped_at": "2021-12-20T19:03:38.952Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [
        "bindings"
      ],
      "tags_descriptions": {},
      "like_count": 0,
      "views": 579,
      "category_id": 7,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": null,
          "description": "Original Poster",
          "user": {
            "id": 1053,
            "username": "Djoak",
            "name": "Djoak",
            "avatar_template": "/user_avatar/forums.foundationdb.org/djoak/{size}/1260_2.png",
            "trust_level": 0
          }
        },
        {
          "extras": "latest",
          "description": "Most Recent Poster",
          "user": {
            "id": 173,
            "username": "jkominek",
            "name": "Jay Kominek",
            "avatar_template": "/user_avatar/forums.foundationdb.org/jkominek/{size}/140_2.png",
            "trust_level": 2
          }
        }
      ]
    },
    {
      "fancy_title": "Optimizing a single large transaction ( 10,000 keys)",
      "id": 1961,
      "title": "Optimizing a single large transaction ( 10,000 keys)",
      "slug": "optimizing-a-single-large-transaction-10-000-keys",
      "posts_count": 12,
      "reply_count": 10,
      "highest_post_number": 12,
      "image_url": null,
      "created_at": "2020-02-17T13:36:55.355Z",
      "last_posted_at": "2020-02-24T11:30:42.854Z",
      "bumped": true,
      "bumped_at": "2020-02-24T11:30:42.854Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [
        "performance"
      ],
      "tags_descriptions": {},
      "like_count": 1,
      "views": 2373,
      "category_id": 7,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": null,
          "description": "Original Poster",
          "user": {
            "id": 645,
            "username": "subramaniamr",
            "name": "Subramaniam R",
            "avatar_template": "/user_avatar/forums.foundationdb.org/subramaniamr/{size}/658_2.png",
            "trust_level": 2
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 8,
            "username": "alloc",
            "name": "Alec Grieser",
            "avatar_template": "/user_avatar/forums.foundationdb.org/alloc/{size}/9_2.png",
            "trust_level": 4
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 13,
            "username": "alexmiller",
            "name": "Alex Miller",
            "avatar_template": "/user_avatar/forums.foundationdb.org/alexmiller/{size}/326_2.png",
            "trust_level": 4
          }
        },
        {
          "extras": "latest",
          "description": "Most Recent Poster",
          "user": {
            "id": 166,
            "username": "gaurav",
            "name": "gaurav",
            "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/g/b487fb/{size}.png",
            "trust_level": 3
          }
        }
      ]
    }
  ],
  "summarizable": false,
  "can_vote": false,
  "vote_count": 0,
  "user_voted": false,
  "discourse_zendesk_plugin_zendesk_id": null,
  "discourse_zendesk_plugin_zendesk_url": "https://your-url.zendesk.com/agent/tickets/",
  "details": {
    "can_edit": false,
    "notification_level": 1,
    "participants": [
      {
        "id": 166,
        "username": "gaurav",
        "name": "gaurav",
        "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/g/b487fb/{size}.png",
        "post_count": 2,
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_color": null,
        "flair_bg_color": null,
        "flair_group_id": null,
        "trust_level": 3
      },
      {
        "id": 14,
        "username": "andrew.noyes",
        "name": "",
        "avatar_template": "/user_avatar/forums.foundationdb.org/andrew.noyes/{size}/443_2.png",
        "post_count": 1,
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_color": null,
        "flair_bg_color": null,
        "flair_group_id": null,
        "trust_level": 2
      },
      {
        "id": 393,
        "username": "ex3ndr",
        "name": "Steve Korshakov",
        "avatar_template": "/user_avatar/forums.foundationdb.org/ex3ndr/{size}/389_2.png",
        "post_count": 1,
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_color": null,
        "flair_bg_color": null,
        "flair_group_id": null,
        "trust_level": 2
      }
    ],
    "created_by": {
      "id": 393,
      "username": "ex3ndr",
      "name": "Steve Korshakov",
      "avatar_template": "/user_avatar/forums.foundationdb.org/ex3ndr/{size}/389_2.png"
    },
    "last_poster": {
      "id": 166,
      "username": "gaurav",
      "name": "gaurav",
      "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/g/b487fb/{size}.png"
    }
  },
  "bookmarks": []
}