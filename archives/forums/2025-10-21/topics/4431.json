{
  "post_stream": {
    "posts": [
      {
        "id": 13943,
        "name": "Dave Rolle",
        "username": "miridius",
        "avatar_template": "/user_avatar/forums.foundationdb.org/miridius/{size}/1500_2.png",
        "created_at": "2024-04-15T08:23:03.683Z",
        "cooked": "<p>I noticed while testing the <code>Transaction.getApproximateSize()</code> API in the Java bindings, that getting the same key N times in the same transaction adds N times the cost of a single get to the size approximation. This seems wrong to me, since the tx size for gets comes from the read conflict ranges, but subsequent gets of the same key shouldn\u2019t affect those ranges right?</p>\n<p>Likewise, setting the same key N times (even to the same value) adds N times the cost of a write to the tx size. Which also seems wrong since I assume the FDB client would optimise those to a single write at commit time - or does it actually send all of them to the server?</p>",
        "post_number": 1,
        "post_type": 1,
        "posts_count": 2,
        "updated_at": "2024-04-15T08:23:03.683Z",
        "reply_count": 0,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 16,
        "reads": 13,
        "readers_count": 12,
        "score": 82.6,
        "yours": false,
        "topic_id": 4431,
        "topic_slug": "get-approximate-size-counts-sets-and-gets-of-the-same-key-multiple-times",
        "display_username": "Dave Rolle",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 1205,
        "hidden": false,
        "trust_level": 1,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/get-approximate-size-counts-sets-and-gets-of-the-same-key-multiple-times/4431/1",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null,
        "can_vote": false
      },
      {
        "id": 13959,
        "name": "Alec Grieser",
        "username": "alloc",
        "avatar_template": "/user_avatar/forums.foundationdb.org/alloc/{size}/9_2.png",
        "created_at": "2024-04-17T09:28:13.832Z",
        "cooked": "<p>That\u2019s right, that (with the default transaction options), multiple sets to the same key will be coalesced, as will overlapping read or write conflict ranges. In particular, the \u201cwrite cache\u201d will combine multiple writes to the same key and turn them into a single mutation. (I say with default transaction options because I believe if you set the <a href=\"https://apple.github.io/foundationdb/javadoc/com/apple/foundationdb/TransactionOptions.html#setReadYourWritesDisable()\"><code>setReadYourWritesDisable</code></a> transaction option, this will no longer be the case.)</p>\n<p>With the <code>getApproximateSize</code> method, the choice was made to deliberately over count those mutations and conflict ranges so that the method is as cheap as possible. In essence, the underlying transaction option just maintains a single integer, which it increments with every read and mutation based solely on the argument parameters, whereas if it needed to correctly account for coalesced ranges, it would need to do more book keeping. The main goal of the method is to give a mechanism for adopters to determine if they\u2019ve hit the <a href=\"https://apple.github.io/foundationdb/known-limitations.html#large-transactions\">10 MB transaction size limit</a> before they try and commit. So, we anticipate use cases that look something like:</p>\n<pre data-code-wrap=\"java\"><code class=\"lang-java\">// Save items from data list while the transaction's approximate commit size\n// is below some threshold. Return the number of saved elements\n&lt;T&gt; int saveData(Transaction tr, List&lt;T&gt; dataList) {\n     if (dataList.isEmpty()) {\n        return 0;\n     }\n     int saved = 0;\n     do {\n        T datum = dataList.get(saved);\n        saveDatum(tr, datum);\n        saved++;\n     } while (saved &lt; dataList.size() &amp;&amp; tr.getApproximateSize() &lt; THRESHOLD);\n     return saved;\n}\n</code></pre>\n<p>So, because it can be called in relatively tight loops like that, we don\u2019t want the method to be too expensive. It\u2019s somewhat important that it doesn\u2019t <em>under count</em>, because that could lead to us thinking that commits that we think are going to be smaller than the transaction size limit failing when we go to <code>commit()</code>, but if <em>over counts</em>, that just means we end up paging less work into each transaction. Which certainly isn\u2019t ideal, but a trade off we can probaby live with.</p>",
        "post_number": 2,
        "post_type": 1,
        "posts_count": 2,
        "updated_at": "2024-04-17T09:28:13.832Z",
        "reply_count": 0,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 1,
        "reads": 8,
        "readers_count": 7,
        "score": 21.6,
        "yours": false,
        "topic_id": 4431,
        "topic_slug": "get-approximate-size-counts-sets-and-gets-of-the-same-key-multiple-times",
        "display_username": "Alec Grieser",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "link_counts": [
          {
            "url": "https://apple.github.io/foundationdb/javadoc/com/apple/foundationdb/TransactionOptions.html#setReadYourWritesDisable()",
            "internal": false,
            "reflection": false,
            "title": "TransactionOptions (FoundationDB Java Client API)",
            "clicks": 1
          },
          {
            "url": "https://apple.github.io/foundationdb/known-limitations.html#large-transactions",
            "internal": false,
            "reflection": false,
            "title": "Known Limitations \u2014 FoundationDB 7.1",
            "clicks": 1
          }
        ],
        "read": true,
        "user_title": null,
        "bookmarked": false,
        "actions_summary": [
          {
            "id": 2,
            "count": 1
          }
        ],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 8,
        "hidden": false,
        "trust_level": 4,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/get-approximate-size-counts-sets-and-gets-of-the-same-key-multiple-times/4431/2",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      }
    ],
    "stream": [
      13943,
      13959
    ]
  },
  "timeline_lookup": [
    [
      1,
      555
    ],
    [
      2,
      553
    ]
  ],
  "suggested_topics": [],
  "tags": [],
  "tags_descriptions": {},
  "fancy_title": "Get_approximate_size counts sets and gets of the same key multiple times",
  "id": 4431,
  "title": "Get_approximate_size counts sets and gets of the same key multiple times",
  "posts_count": 2,
  "created_at": "2024-04-15T08:23:03.626Z",
  "views": 121,
  "reply_count": 0,
  "like_count": 1,
  "last_posted_at": "2024-04-17T09:28:13.832Z",
  "visible": true,
  "closed": false,
  "archived": false,
  "has_summary": false,
  "archetype": "regular",
  "slug": "get-approximate-size-counts-sets-and-gets-of-the-same-key-multiple-times",
  "category_id": 5,
  "word_count": 468,
  "deleted_at": null,
  "user_id": 1205,
  "featured_link": null,
  "pinned_globally": false,
  "pinned_at": null,
  "pinned_until": null,
  "image_url": null,
  "slow_mode_seconds": 0,
  "draft": null,
  "draft_key": "topic_4431",
  "draft_sequence": null,
  "unpinned": null,
  "pinned": false,
  "current_post_number": 1,
  "highest_post_number": 2,
  "deleted_by": null,
  "actions_summary": [
    {
      "id": 4,
      "count": 0,
      "hidden": false,
      "can_act": false
    },
    {
      "id": 8,
      "count": 0,
      "hidden": false,
      "can_act": false
    },
    {
      "id": 10,
      "count": 0,
      "hidden": false,
      "can_act": false
    },
    {
      "id": 7,
      "count": 0,
      "hidden": false,
      "can_act": false
    }
  ],
  "chunk_size": 20,
  "bookmarked": false,
  "topic_timer": null,
  "message_bus_last_id": 0,
  "participant_count": 2,
  "show_read_indicator": false,
  "thumbnails": null,
  "slow_mode_enabled_until": null,
  "tags_disable_ads": false,
  "related_topics": [
    {
      "fancy_title": "Transaction size limit calculation",
      "id": 811,
      "title": "Transaction size limit calculation",
      "slug": "transaction-size-limit-calculation",
      "posts_count": 6,
      "reply_count": 3,
      "highest_post_number": 6,
      "image_url": null,
      "created_at": "2018-10-27T23:31:00.061Z",
      "last_posted_at": "2019-01-26T01:12:16.191Z",
      "bumped": true,
      "bumped_at": "2019-01-26T01:12:16.191Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 2,
      "views": 2323,
      "category_id": 7,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": null,
          "description": "Original Poster",
          "user": {
            "id": 81,
            "username": "ryanworl",
            "name": "Ryan Worl",
            "avatar_template": "/user_avatar/forums.foundationdb.org/ryanworl/{size}/440_2.png",
            "trust_level": 3
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 12,
            "username": "ajbeamon",
            "name": "A.J. Beamon",
            "avatar_template": "/user_avatar/forums.foundationdb.org/ajbeamon/{size}/13_2.png",
            "admin": true,
            "trust_level": 4
          }
        },
        {
          "extras": "latest",
          "description": "Most Recent Poster",
          "user": {
            "id": 38,
            "username": "panghy",
            "name": "Clement Pang",
            "avatar_template": "/user_avatar/forums.foundationdb.org/panghy/{size}/19_2.png",
            "trust_level": 2
          }
        }
      ]
    },
    {
      "fancy_title": "API for Transaction Size",
      "id": 1367,
      "title": "API for Transaction Size",
      "slug": "api-for-transaction-size",
      "posts_count": 7,
      "reply_count": 3,
      "highest_post_number": 7,
      "image_url": null,
      "created_at": "2019-05-16T21:43:18.094Z",
      "last_posted_at": "2019-08-10T13:52:19.492Z",
      "bumped": true,
      "bumped_at": "2019-08-10T20:23:10.757Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 0,
      "views": 939,
      "category_id": 5,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": null,
          "description": "Original Poster",
          "user": {
            "id": 8,
            "username": "alloc",
            "name": "Alec Grieser",
            "avatar_template": "/user_avatar/forums.foundationdb.org/alloc/{size}/9_2.png",
            "trust_level": 4
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 337,
            "username": "mengxu",
            "name": "Meng Xu",
            "avatar_template": "/user_avatar/forums.foundationdb.org/mengxu/{size}/893_2.png",
            "trust_level": 2
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 53,
            "username": "KrzysFR",
            "name": "Christophe Chevalier",
            "avatar_template": "/user_avatar/forums.foundationdb.org/krzysfr/{size}/43_2.png",
            "trust_level": 2
          }
        },
        {
          "extras": "latest",
          "description": "Most Recent Poster",
          "user": {
            "id": 12,
            "username": "ajbeamon",
            "name": "A.J. Beamon",
            "avatar_template": "/user_avatar/forums.foundationdb.org/ajbeamon/{size}/13_2.png",
            "admin": true,
            "trust_level": 4
          }
        }
      ]
    },
    {
      "fancy_title": "Optimizing a single large transaction ( 10,000 keys)",
      "id": 1961,
      "title": "Optimizing a single large transaction ( 10,000 keys)",
      "slug": "optimizing-a-single-large-transaction-10-000-keys",
      "posts_count": 12,
      "reply_count": 10,
      "highest_post_number": 12,
      "image_url": null,
      "created_at": "2020-02-17T13:36:55.355Z",
      "last_posted_at": "2020-02-24T11:30:42.854Z",
      "bumped": true,
      "bumped_at": "2020-02-24T11:30:42.854Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [
        "performance"
      ],
      "tags_descriptions": {},
      "like_count": 1,
      "views": 2373,
      "category_id": 7,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": null,
          "description": "Original Poster",
          "user": {
            "id": 645,
            "username": "subramaniamr",
            "name": "Subramaniam R",
            "avatar_template": "/user_avatar/forums.foundationdb.org/subramaniamr/{size}/658_2.png",
            "trust_level": 2
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 8,
            "username": "alloc",
            "name": "Alec Grieser",
            "avatar_template": "/user_avatar/forums.foundationdb.org/alloc/{size}/9_2.png",
            "trust_level": 4
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 13,
            "username": "alexmiller",
            "name": "Alex Miller",
            "avatar_template": "/user_avatar/forums.foundationdb.org/alexmiller/{size}/326_2.png",
            "trust_level": 4
          }
        },
        {
          "extras": "latest",
          "description": "Most Recent Poster",
          "user": {
            "id": 166,
            "username": "gaurav",
            "name": "gaurav",
            "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/g/b487fb/{size}.png",
            "trust_level": 3
          }
        }
      ]
    },
    {
      "fancy_title": "Limiting the cardinality of a key range",
      "id": 665,
      "title": "Limiting the cardinality of a key range",
      "slug": "limiting-the-cardinality-of-a-key-range",
      "posts_count": 2,
      "reply_count": 0,
      "highest_post_number": 3,
      "image_url": null,
      "created_at": "2018-08-26T18:47:07.288Z",
      "last_posted_at": "2018-08-27T17:05:16.467Z",
      "bumped": true,
      "bumped_at": "2018-08-27T17:05:16.467Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 0,
      "views": 1248,
      "category_id": 7,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": null,
          "description": "Original Poster",
          "user": {
            "id": 251,
            "username": "George",
            "name": "",
            "avatar_template": "/user_avatar/forums.foundationdb.org/george/{size}/620_2.png",
            "trust_level": 1
          }
        },
        {
          "extras": "latest",
          "description": "Most Recent Poster",
          "user": {
            "id": 12,
            "username": "ajbeamon",
            "name": "A.J. Beamon",
            "avatar_template": "/user_avatar/forums.foundationdb.org/ajbeamon/{size}/13_2.png",
            "admin": true,
            "trust_level": 4
          }
        }
      ]
    },
    {
      "fancy_title": "Key-val sizes in the Record Layer",
      "id": 1481,
      "title": "Key-val sizes in the Record Layer",
      "slug": "key-val-sizes-in-the-record-layer",
      "posts_count": 5,
      "reply_count": 1,
      "highest_post_number": 5,
      "image_url": null,
      "created_at": "2019-06-23T09:20:30.497Z",
      "last_posted_at": "2020-07-15T12:46:20.435Z",
      "bumped": true,
      "bumped_at": "2020-07-15T12:46:20.435Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 0,
      "views": 2204,
      "category_id": 12,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": null,
          "description": "Original Poster",
          "user": {
            "id": 388,
            "username": "amarjeet000",
            "name": "Amarjeet",
            "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/a/e19adc/{size}.png",
            "trust_level": 1
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 8,
            "username": "alloc",
            "name": "Alec Grieser",
            "avatar_template": "/user_avatar/forums.foundationdb.org/alloc/{size}/9_2.png",
            "trust_level": 4
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 790,
            "username": "shubham4060",
            "name": "Shubham",
            "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/s/0ea827/{size}.png",
            "trust_level": 1
          }
        },
        {
          "extras": "latest",
          "description": "Most Recent Poster",
          "user": {
            "id": 34,
            "username": "scgray",
            "name": "Scott Gray",
            "avatar_template": "/user_avatar/forums.foundationdb.org/scgray/{size}/30_2.png",
            "trust_level": 1
          }
        }
      ]
    }
  ],
  "summarizable": false,
  "can_vote": false,
  "vote_count": 0,
  "user_voted": false,
  "discourse_zendesk_plugin_zendesk_id": null,
  "discourse_zendesk_plugin_zendesk_url": "https://your-url.zendesk.com/agent/tickets/",
  "details": {
    "can_edit": false,
    "notification_level": 1,
    "participants": [
      {
        "id": 8,
        "username": "alloc",
        "name": "Alec Grieser",
        "avatar_template": "/user_avatar/forums.foundationdb.org/alloc/{size}/9_2.png",
        "post_count": 1,
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_color": null,
        "flair_bg_color": null,
        "flair_group_id": null,
        "trust_level": 4
      },
      {
        "id": 1205,
        "username": "miridius",
        "name": "Dave Rolle",
        "avatar_template": "/user_avatar/forums.foundationdb.org/miridius/{size}/1500_2.png",
        "post_count": 1,
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_color": null,
        "flair_bg_color": null,
        "flair_group_id": null,
        "trust_level": 1
      }
    ],
    "created_by": {
      "id": 1205,
      "username": "miridius",
      "name": "Dave Rolle",
      "avatar_template": "/user_avatar/forums.foundationdb.org/miridius/{size}/1500_2.png"
    },
    "last_poster": {
      "id": 8,
      "username": "alloc",
      "name": "Alec Grieser",
      "avatar_template": "/user_avatar/forums.foundationdb.org/alloc/{size}/9_2.png"
    },
    "links": [
      {
        "url": "https://apple.github.io/foundationdb/javadoc/com/apple/foundationdb/TransactionOptions.html#setReadYourWritesDisable()",
        "title": "TransactionOptions (FoundationDB Java Client API)",
        "internal": false,
        "attachment": false,
        "reflection": false,
        "clicks": 1,
        "user_id": 8,
        "domain": "apple.github.io",
        "root_domain": "apple.github.io"
      },
      {
        "url": "https://apple.github.io/foundationdb/known-limitations.html#large-transactions",
        "title": "Known Limitations \u2014 FoundationDB 7.1",
        "internal": false,
        "attachment": false,
        "reflection": false,
        "clicks": 1,
        "user_id": 8,
        "domain": "apple.github.io",
        "root_domain": "apple.github.io"
      }
    ]
  },
  "bookmarks": []
}