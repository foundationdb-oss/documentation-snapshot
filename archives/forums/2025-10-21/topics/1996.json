{
  "post_stream": {
    "posts": [
      {
        "id": 6388,
        "name": "Aayushi Malik",
        "username": "aymalik",
        "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/a/aca169/{size}.png",
        "created_at": "2020-03-02T12:25:09.735Z",
        "cooked": "<p>Hi,</p>\n<p>For records of type Order as defined below, I want to be able to truncate the total sorted range of records scanned by passing a filter on the primary key but record layer doesn\u2019t seem to allow that when an additional Or component is present in the query as it converts the filter to a disjunctive normal form.</p>\n<pre><code>message Order {\n    int64 order_id = 1;\n    int32 price = 2;\n}\n</code></pre>\n<p>The following are the query passed and plan generated for the case when there is no Or component within the And component.</p>\n<pre><code>RecordQuery.newBuilder()\n    .setRecordType(\"Order\")\n    .setFilter(Query.and(\n        Query.field(\"order_id\").greaterThanOrEquals(101L),\n        Query.field(\"order_id\").lessThanOrEquals(102L)))\n    .setSort(Key.Expressions.field(\"order_id\"),false)\n    .build();\n\nQuery Plan: Scan([[101],&gt;) | [Order] | order_id LESS_THAN_OR_EQUALS 102\n</code></pre>\n<p>The following are the query passed and plan generated for the case when there is an additional Or component within the And component.</p>\n<pre><code>RecordQuery query = RecordQuery.newBuilder()\n    .setRecordType(\"Order\")\n    .setFilter(Query.and(\n        Query.field(\"order_id\").greaterThanOrEquals(101L),\n        Query.field(\"order_id\").lessThanOrEquals(102L),           \n        Query.or(Query.field(\"price\").equalsValue(2), \n                 Query.field(\"price\").equalsValue(2))))\n        .setSort(Key.Expressions.field(\"order_id\"),true)\n        .build();\n\nQuery Plan: Scan(&lt;,&gt;) | [Order] | Or([And([order_id LESS_THAN_OR_EQUALS 102, order_id GREATER_THAN_OR_EQUALS 101, price EQUALS 2]), And([order_id LESS_THAN_OR_EQUALS 102, order_id GREATER_THAN_OR_EQUALS 101, price EQUALS 2])])\n</code></pre>\n<p>Note that in the first query only the greaterThanOrEquals filter on order_id is used to truncate the scan (when the order of filters is switched and lessThanOrEquals filter on order_id is specified before then the lessThanOrEquals filter is used).<br>\nFurther, in the second query, none of the filters on order_id are used to truncate the scan range. This makes the query slow.<br>\nAny thoughts/suggestions on how I can counter this?</p>",
        "post_number": 1,
        "post_type": 1,
        "posts_count": 3,
        "updated_at": "2020-03-02T12:25:09.735Z",
        "reply_count": 1,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 20,
        "reads": 18,
        "readers_count": 17,
        "score": 108.6,
        "yours": false,
        "topic_id": 1996,
        "topic_slug": "range-scan-not-being-truncated-by-primary-key-filter-when-an-additional-or-component-present-in-and-component",
        "display_username": "Aayushi Malik",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 737,
        "hidden": false,
        "trust_level": 1,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/range-scan-not-being-truncated-by-primary-key-filter-when-an-additional-or-component-present-in-and-component/1996/1",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null,
        "can_vote": false
      },
      {
        "id": 6393,
        "name": "Alec Grieser",
        "username": "alloc",
        "avatar_template": "/user_avatar/forums.foundationdb.org/alloc/{size}/9_2.png",
        "created_at": "2020-03-02T17:39:25.319Z",
        "cooked": "<aside class=\"quote no-group\" data-username=\"aymalik\" data-post=\"1\" data-topic=\"1996\">\n<div class=\"title\">\n<div class=\"quote-controls\"></div>\n<img loading=\"lazy\" alt=\"\" width=\"24\" height=\"24\" src=\"https://avatars.discourse-cdn.com/v4/letter/a/aca169/48.png\" class=\"avatar\"> aymalik:</div>\n<blockquote>\n<p>Note that in the first query only the greaterThanOrEquals filter on order_id is used to truncate the scan (when the order of filters is switched and lessThanOrEquals filter on order_id is specified before then the lessThanOrEquals filter is used).</p>\n</blockquote>\n</aside>\n<p>That does sound like a bug. In general, it <em>should</em> be able to collapse filters like that, but sometimes it has trouble. See: <a href=\"https://github.com/FoundationDB/fdb-record-layer/issues/1\" class=\"inline-onebox\">Planner does not currently coalesce overlapping filters \u00b7 Issue #1 \u00b7 FoundationDB/fdb-record-layer \u00b7 GitHub</a></p>\n<aside class=\"quote no-group\" data-username=\"aymalik\" data-post=\"1\" data-topic=\"1996\">\n<div class=\"title\">\n<div class=\"quote-controls\"></div>\n<img loading=\"lazy\" alt=\"\" width=\"24\" height=\"24\" src=\"https://avatars.discourse-cdn.com/v4/letter/a/aca169/48.png\" class=\"avatar\"> aymalik:</div>\n<blockquote>\n<p>Further, in the second query, none of the filters on order_id are used to truncate the scan range. This makes the query slow.</p>\n</blockquote>\n</aside>\n<p>You are correct that we convert to DNF, and that does have some implications in the kind of plans we\u2019d produce. In particular, I think a slightly more sophisticated version of the planner would be likely to produce something that is:</p>\n<pre><code class=\"lang-auto\">(Scan([[101],[102]]) | price EQUALS_VALUE 2) \u22c3 (Scan([[101],[102]]) | price EQUALS_VALUE 2)\n</code></pre>\n<p>and not notice that both sides of the union are the same. Or likewise, if the <code>or</code> were something like <code>Query.or(Query.field(\"price\").equalsValue(0), Query.field(\"price\").equalsValue(2))</code>, it might plan it as:</p>\n<pre><code class=\"lang-auto\">(Scan([[101],[102]]) | price EQUALS_VALUE 0) \u22c3 (Scan([[101],[102]]) | price EQUALS_VALUE 2)\n</code></pre>\n<p>Instead of the more efficient:</p>\n<pre><code class=\"lang-auto\">Scan([[101],[102]]) | OR(price EQUALS_VALUE 0, price EQUALS_VALUE 2)\n</code></pre>\n<p>I think our approach (with the new planner) would be to continue doing DNF normalization, and then optimizing the resulting structure, e.g., noticing that the left side of the union is common and that the first can be turned into the second. I could be wrong though.</p>\n<p>But putting DNF aside, I think our or handling in general isn\u2019t perfect. This isn\u2019t the most user friendly approach, but it might be easier to execute the query more directly. Something like:</p>\n<pre data-code-wrap=\"java\"><code class=\"lang-java\">recordStore.scanRecords(Tuple.from(101), Tuple.from(102), TupleRange.RANGE_INCLUSIVE,  TupleRange.RANGE_INCLUSIVE, null /* for continuation not right if resuming from previous execution */, ScanProperties.REVERSE_SCAN)\n    .filter(rec -&gt; Query.or(Query.field(\"price\").equalsValue(2), Query.field(\"price\").equalsValue(2)).eval(recordStore, EvaluationContext.EMPTY, rec))\n</code></pre>\n<p>Or something like that. You could also, if you\u2019re extra brave, construct the optimal <code>RecordQueryPlan</code> from plan elements, though therein lies dragons.</p>",
        "post_number": 2,
        "post_type": 1,
        "posts_count": 3,
        "updated_at": "2020-03-02T17:39:25.319Z",
        "reply_count": 1,
        "reply_to_post_number": null,
        "quote_count": 1,
        "incoming_link_count": 1,
        "reads": 18,
        "readers_count": 17,
        "score": 13.6,
        "yours": false,
        "topic_id": 1996,
        "topic_slug": "range-scan-not-being-truncated-by-primary-key-filter-when-an-additional-or-component-present-in-and-component",
        "display_username": "Alec Grieser",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "link_counts": [
          {
            "url": "https://github.com/FoundationDB/fdb-record-layer/issues/1",
            "internal": false,
            "reflection": false,
            "title": "Planner does not currently coalesce overlapping filters \u00b7 Issue #1 \u00b7 FoundationDB/fdb-record-layer \u00b7 GitHub",
            "clicks": 1
          }
        ],
        "read": true,
        "user_title": null,
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 8,
        "hidden": false,
        "trust_level": 4,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/range-scan-not-being-truncated-by-primary-key-filter-when-an-additional-or-component-present-in-and-component/1996/2",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 6401,
        "name": "Aayushi Malik",
        "username": "aymalik",
        "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/a/aca169/{size}.png",
        "created_at": "2020-03-03T10:11:33.746Z",
        "cooked": "<p>Thanks <a class=\"mention\" href=\"/u/alloc\">@alloc</a> for the insight.</p>\n<p>I think I\u2019ll go forward with the scanRecords implementation for now.</p>",
        "post_number": 3,
        "post_type": 1,
        "posts_count": 3,
        "updated_at": "2020-03-03T10:11:33.746Z",
        "reply_count": 0,
        "reply_to_post_number": 2,
        "quote_count": 0,
        "incoming_link_count": 0,
        "reads": 15,
        "readers_count": 14,
        "score": 3.0,
        "yours": false,
        "topic_id": 1996,
        "topic_slug": "range-scan-not-being-truncated-by-primary-key-filter-when-an-additional-or-component-present-in-and-component",
        "display_username": "Aayushi Malik",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "reply_to_user": {
          "id": 8,
          "username": "alloc",
          "name": "Alec Grieser",
          "avatar_template": "/user_avatar/forums.foundationdb.org/alloc/{size}/9_2.png"
        },
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 737,
        "hidden": false,
        "trust_level": 1,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/range-scan-not-being-truncated-by-primary-key-filter-when-an-additional-or-component-present-in-and-component/1996/3",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      }
    ],
    "stream": [
      6388,
      6393,
      6401
    ]
  },
  "timeline_lookup": [
    [
      1,
      2059
    ]
  ],
  "suggested_topics": [],
  "tags": [],
  "tags_descriptions": {},
  "fancy_title": "Range scan not being truncated by primary key filter when an additional Or component present in And component",
  "id": 1996,
  "title": "Range scan not being truncated by primary key filter when an additional Or component present in And component",
  "posts_count": 3,
  "created_at": "2020-03-02T12:25:09.669Z",
  "views": 640,
  "reply_count": 1,
  "like_count": 0,
  "last_posted_at": "2020-03-03T10:11:33.746Z",
  "visible": true,
  "closed": false,
  "archived": false,
  "has_summary": false,
  "archetype": "regular",
  "slug": "range-scan-not-being-truncated-by-primary-key-filter-when-an-additional-or-component-present-in-and-component",
  "category_id": 12,
  "word_count": 672,
  "deleted_at": null,
  "user_id": 737,
  "featured_link": null,
  "pinned_globally": false,
  "pinned_at": null,
  "pinned_until": null,
  "image_url": null,
  "slow_mode_seconds": 0,
  "draft": null,
  "draft_key": "topic_1996",
  "draft_sequence": null,
  "unpinned": null,
  "pinned": false,
  "current_post_number": 1,
  "highest_post_number": 3,
  "deleted_by": null,
  "actions_summary": [
    {
      "id": 4,
      "count": 0,
      "hidden": false,
      "can_act": false
    },
    {
      "id": 8,
      "count": 0,
      "hidden": false,
      "can_act": false
    },
    {
      "id": 10,
      "count": 0,
      "hidden": false,
      "can_act": false
    },
    {
      "id": 7,
      "count": 0,
      "hidden": false,
      "can_act": false
    }
  ],
  "chunk_size": 20,
  "bookmarked": false,
  "topic_timer": null,
  "message_bus_last_id": 0,
  "participant_count": 2,
  "show_read_indicator": false,
  "thumbnails": null,
  "slow_mode_enabled_until": null,
  "tags_disable_ads": false,
  "related_topics": [
    {
      "fancy_title": "Full range scan performed in sort when not required",
      "id": 1995,
      "title": "Full range scan performed in sort when not required",
      "slug": "full-range-scan-performed-in-sort-when-not-required",
      "posts_count": 4,
      "reply_count": 2,
      "highest_post_number": 4,
      "image_url": null,
      "created_at": "2020-03-02T10:49:06.926Z",
      "last_posted_at": "2020-03-03T10:16:53.281Z",
      "bumped": true,
      "bumped_at": "2020-03-03T10:16:53.281Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 1,
      "views": 987,
      "category_id": 12,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": "latest",
          "description": "Original Poster, Most Recent Poster",
          "user": {
            "id": 737,
            "username": "aymalik",
            "name": "Aayushi Malik",
            "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/a/aca169/{size}.png",
            "trust_level": 1
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 8,
            "username": "alloc",
            "name": "Alec Grieser",
            "avatar_template": "/user_avatar/forums.foundationdb.org/alloc/{size}/9_2.png",
            "trust_level": 4
          }
        }
      ]
    },
    {
      "fancy_title": "Number types in Tuples may not be null | Reverse scan",
      "id": 1912,
      "title": "Number types in Tuples may not be null | Reverse scan",
      "slug": "number-types-in-tuples-may-not-be-null-reverse-scan",
      "posts_count": 4,
      "reply_count": 2,
      "highest_post_number": 4,
      "image_url": null,
      "created_at": "2020-01-27T13:38:56.010Z",
      "last_posted_at": "2020-02-20T14:50:37.088Z",
      "bumped": true,
      "bumped_at": "2020-02-20T14:50:37.088Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 0,
      "views": 992,
      "category_id": 12,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": null,
          "description": "Original Poster",
          "user": {
            "id": 653,
            "username": "VibhutiD",
            "name": "Vibhuti Dembi",
            "avatar_template": "/user_avatar/forums.foundationdb.org/vibhutid/{size}/668_2.png",
            "trust_level": 1
          }
        },
        {
          "extras": "latest",
          "description": "Most Recent Poster",
          "user": {
            "id": 8,
            "username": "alloc",
            "name": "Alec Grieser",
            "avatar_template": "/user_avatar/forums.foundationdb.org/alloc/{size}/9_2.png",
            "trust_level": 4
          }
        }
      ]
    },
    {
      "fancy_title": "A filter similar in sql to `where (a,b,c) &gt; (1,2,3)`",
      "id": 4464,
      "title": "A filter similar in sql to `where (a,b,c) > (1,2,3)`",
      "slug": "a-filter-similar-in-sql-to-where-a-b-c-1-2-3",
      "posts_count": 3,
      "reply_count": 1,
      "highest_post_number": 3,
      "image_url": null,
      "created_at": "2024-05-09T06:35:42.842Z",
      "last_posted_at": "2024-05-10T19:59:07.397Z",
      "bumped": true,
      "bumped_at": "2024-05-10T19:59:07.397Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 2,
      "views": 195,
      "category_id": 14,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": "latest",
          "description": "Original Poster, Most Recent Poster",
          "user": {
            "id": 1200,
            "username": "dispalt",
            "name": "Dan Di Spaltro",
            "avatar_template": "/user_avatar/forums.foundationdb.org/dispalt/{size}/1492_2.png",
            "trust_level": 1
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 8,
            "username": "alloc",
            "name": "Alec Grieser",
            "avatar_template": "/user_avatar/forums.foundationdb.org/alloc/{size}/9_2.png",
            "trust_level": 4
          }
        }
      ]
    },
    {
      "fancy_title": "Last less than or last less or equal with limit added to keyselector returns different values",
      "id": 392,
      "title": "Last less than or last less or equal with limit added to keyselector returns different values",
      "slug": "last-less-than-or-last-less-or-equal-with-limit-added-to-keyselector-returns-different-values",
      "posts_count": 3,
      "reply_count": 1,
      "highest_post_number": 3,
      "image_url": null,
      "created_at": "2018-05-10T05:13:03.437Z",
      "last_posted_at": "2018-05-10T06:40:07.295Z",
      "bumped": true,
      "bumped_at": "2018-05-10T06:40:07.295Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 2,
      "views": 1008,
      "category_id": 7,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": "latest",
          "description": "Original Poster, Most Recent Poster",
          "user": {
            "id": 231,
            "username": "xtreak",
            "name": "",
            "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/x/ad7895/{size}.png",
            "trust_level": 1
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 8,
            "username": "alloc",
            "name": "Alec Grieser",
            "avatar_template": "/user_avatar/forums.foundationdb.org/alloc/{size}/9_2.png",
            "trust_level": 4
          }
        }
      ]
    },
    {
      "fancy_title": "Implementing sorting by one field and filtering by another",
      "id": 1276,
      "title": "Implementing sorting by one field and filtering by another",
      "slug": "implementing-sorting-by-one-field-and-filtering-by-another",
      "posts_count": 3,
      "reply_count": 1,
      "highest_post_number": 3,
      "image_url": null,
      "created_at": "2019-04-02T12:42:34.217Z",
      "last_posted_at": "2019-04-03T08:23:30.090Z",
      "bumped": true,
      "bumped_at": "2019-04-03T08:23:30.090Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 1,
      "views": 1015,
      "category_id": 7,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": "latest",
          "description": "Original Poster, Most Recent Poster",
          "user": {
            "id": 554,
            "username": "chanon",
            "name": "",
            "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/c/a587f6/{size}.png",
            "trust_level": 0
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 81,
            "username": "ryanworl",
            "name": "Ryan Worl",
            "avatar_template": "/user_avatar/forums.foundationdb.org/ryanworl/{size}/440_2.png",
            "trust_level": 3
          }
        }
      ]
    }
  ],
  "summarizable": false,
  "can_vote": false,
  "vote_count": 0,
  "user_voted": false,
  "discourse_zendesk_plugin_zendesk_id": null,
  "discourse_zendesk_plugin_zendesk_url": "https://your-url.zendesk.com/agent/tickets/",
  "details": {
    "can_edit": false,
    "notification_level": 1,
    "participants": [
      {
        "id": 737,
        "username": "aymalik",
        "name": "Aayushi Malik",
        "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/a/aca169/{size}.png",
        "post_count": 2,
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_color": null,
        "flair_bg_color": null,
        "flair_group_id": null,
        "trust_level": 1
      },
      {
        "id": 8,
        "username": "alloc",
        "name": "Alec Grieser",
        "avatar_template": "/user_avatar/forums.foundationdb.org/alloc/{size}/9_2.png",
        "post_count": 1,
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_color": null,
        "flair_bg_color": null,
        "flair_group_id": null,
        "trust_level": 4
      }
    ],
    "created_by": {
      "id": 737,
      "username": "aymalik",
      "name": "Aayushi Malik",
      "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/a/aca169/{size}.png"
    },
    "last_poster": {
      "id": 737,
      "username": "aymalik",
      "name": "Aayushi Malik",
      "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/a/aca169/{size}.png"
    },
    "links": [
      {
        "url": "https://github.com/FoundationDB/fdb-record-layer/issues/1",
        "title": "Planner does not currently coalesce overlapping filters \u00b7 Issue #1 \u00b7 FoundationDB/fdb-record-layer \u00b7 GitHub",
        "internal": false,
        "attachment": false,
        "reflection": false,
        "clicks": 1,
        "user_id": 8,
        "domain": "github.com",
        "root_domain": "github.com"
      }
    ]
  },
  "bookmarks": []
}