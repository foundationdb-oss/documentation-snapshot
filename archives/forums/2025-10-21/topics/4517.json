{
  "post_stream": {
    "posts": [
      {
        "id": 14164,
        "name": "Jaehui Lee",
        "username": "Jaehui-Lee",
        "avatar_template": "/user_avatar/forums.foundationdb.org/jaehui-lee/{size}/1808_2.png",
        "created_at": "2024-06-18T05:48:52.314Z",
        "cooked": "<p>During performance testing, I installed a cluster and immediately run a high write workload, the cluster hangs in less than 5 seconds.</p>\n<p>I created about 900 partitions with the \u2018redistribute\u2019 command, pre-split them, and run the workload, the cluster will not hang up.<br>\nAnd even i ran a light workload for a few minutes (for warmup) and then run a high load workload, the cluster will not hang.</p>\n<p>Once a hangup occurs, the time it takes to recover varies greatly.<br>\nSometimes it took 2 minutes, sometimes it took 10, 30, or 40 minutes, and sometimes it didn\u2019t work until over an hour later.</p>\n<p>When I checked the status while the cluster is hangup, there are \u2018unknown\u2019 lines.</p>\n<pre><code class=\"lang-auto\">fdb&gt; status\n\nUsing cluster file `/etc/foundationdb/fdb.cluster'.\n\nUnable to read database configuration.\n\nConfiguration:\n  Redundancy mode        - unknown\n  Storage engine         - unknown\n  Coordinators           - unknown\n  Usable Regions         - unknown\n\nCluster:\n  FoundationDB processes - 192\n  Zones                  - 12\n  Machines               - 12\n  Memory availability    - 6.2 GB per process on machine with least available\n  Retransmissions rate   - 1 Hz\n  Server time            - 05/16/24 19:58:03\n\nData:\n  Replication health     - unknown\n  Moving data            - unknown\n  Sum of key-value sizes - unknown\n  Disk space used        - unknown\n\nOperating space:\n  Unable to retrieve operating space status\n\nWorkload:\n  Read rate              - unknown\n  Write rate             - unknown\n  Transactions started   - unknown\n  Transactions committed - unknown\n  Conflict rate          - unknown\n\nBackup and DR:\n  Running backups        - 0\n  Running DRs            - 0 \n</code></pre>\n<p>I looked at the logs with Severity of 30 and 40 among the trace logs during hangups, there are these logs.</p>\n<pre data-code-wrap=\"xml\"><code class=\"lang-xml\">#Severity=30\n&lt;Event Severity=\"30\" Time=\"1718006673.081693\" DateTime=\"2024-06-10T08:04:33Z\" Type=\"RkSSListFetchTimeout\" ID=\"4026439550c60a85\" SuppressedEventCount=\"19\" ThreadID=\"11668067143732054327\" 0.91. 22.43:4501\" LogGroup=\"default\" Roles=\"RK,SS\" /&gt;\n&lt;Event Severity=\"30\" Time=\"1718006673.578616\" DateTime=\"2024-06-10T08:04:33Z\" Type=\"RatekeeperGetSSListLongLatency\" ID=\"4026439550c60a85\" Latency=\"1542.49\" ThreadID=\"11668067143732054327 \" Machine=\"10.91. 22.43:4501\" LogGroup=\"default\" Roles=\"RK,SS\" /&gt;\n\n#Severity=40\n&lt;Event Severity=\"40\" ErrorKind=\"DiskIssue\" Time=\"1718005992.754601\" DateTime=\"2024-06-10T07:53:12Z\" Type=\"StorageServerFailed\" ID=\"4e64c59561ab3bb7\" Error=\"io_timeout\" ErrorDescription=\"A disk IO operation failed to complete in a timely manner\" ErrorCode=\"1521\" Reason=\"Error\" ThreadID=\"10388333767681656538\" Backtrace=\"addr2line -e fdbserver.debug -p -C -f -i 0x4440098 0x443e8cb 0x443ead1 0x27ce337 cee02 0x27cf35e 0x279fa21 0x279fcd3 0xe64b20 0x27b9e94 0x27bac7a 0x13034d0 0x13037b9 0xe64b20 0x27b1665 0x13034d0 0x13037b9 0xe64b20 0x2389bfd 0x43ca6d8 0xdd2086 0x7f467d844555\" Machine=\"10.91.22.41:4510\" LogGroup=\"default\" Roles=\"SS\" /&gt;\n</code></pre>\n<p>I tried changing the knobs below, but it had no effect.</p>\n<pre><code class=\"lang-auto\">knob_storage_hard_limit_bytes\nknob_target_bytes_per_storage_server\nknob_server_list_delay\nknob_storage_server_list_fetch_timeout\n</code></pre>\n<p>I tried profiling with perf, but didn\u2019t get any meaningful results.</p>\n<p>I guess the storage servers can no longer process requests due to the overwhelming write load on one storage server team, but it is strange that the entire cluster hangs up and takes so long to recover.</p>\n<p>I am curious about the fundamental cause of this phenomenon and a solution.</p>\n<p><strong>Test Environment</strong></p>\n<p>FDB Cluster</p>\n<ul>\n<li>FoundationDB 7.1.59</li>\n<li>12 machines\n<ul>\n<li>16 cores CPU, then 192 processes</li>\n<li>4GB Memory, 1TB Disk * 2</li>\n</ul>\n</li>\n</ul>\n<p>Client</p>\n<ul>\n<li>YCSB (FDB 7.1.59)</li>\n<li>Write workload command</li>\n</ul>\n<pre data-code-wrap=\"bash\"><code class=\"lang-bash\">YCSB_FDB_OPTION='-p foundationdb.batchsize=100 -p foundationdb.apiversion=710'\nbin/ycsb.sh load foundationdb -s -p workload=site.ycsb.workloads.CoreWorkload -p recordcount=50000000 $YCSB_FDB_OPTION -threads 64\n</code></pre>",
        "post_number": 1,
        "post_type": 1,
        "posts_count": 2,
        "updated_at": "2024-06-18T10:57:22.223Z",
        "reply_count": 0,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 55,
        "reads": 31,
        "readers_count": 30,
        "score": 311.2,
        "yours": false,
        "topic_id": 4517,
        "topic_slug": "cluster-in-stuck",
        "display_username": "Jaehui Lee",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 4,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "bookmarked": false,
        "actions_summary": [
          {
            "id": 2,
            "count": 2
          }
        ],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 1436,
        "hidden": false,
        "trust_level": 1,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/cluster-in-stuck/4517/1",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null,
        "can_vote": false
      },
      {
        "id": 14268,
        "name": "Jaehui Lee",
        "username": "Jaehui-Lee",
        "avatar_template": "/user_avatar/forums.foundationdb.org/jaehui-lee/{size}/1808_2.png",
        "created_at": "2024-07-18T05:05:41.321Z",
        "cooked": "<p>There was a mistake during the testing process where a <code>KeyValueStoreMemory_OutOfSpace</code> error occurred before the <code>StorageServerFailed</code> error. While testing in the memory storage engine state, it was identified that the cluster stopped due to the in-memory storage queue running out of memory (OOM). After changing the <code>storage_migration_type</code> to <code>aggressive</code> and converting all storage servers to the SSD storage engine, the issue of the cluster not recovering did not reoccur.</p>\n<p>However, the problem of the cluster halting under a write-heavy workload when there is only one shard remains. The identified causes are as follows:</p>\n<ul>\n<li>Initially, there is 1 shard, and there are 3 Storage Servers (SS) holding this shard (1 ServerTeam = 3 SS).</li>\n<li>When the client starts a high load of writes,\n<ul>\n<li>Data starts accumulating rapidly in the TLog.</li>\n<li>The 3 SSs begin fetching data from the TLog.</li>\n<li><em>However, the rate at which data accumulates in the TLog is faster than the rate at which SSs can fetch it.</em></li>\n</ul>\n</li>\n<li>An SS enters the <em>process_behind</em> state if it satisfies any of the following conditions:\n<ul>\n<li>\n<ol>\n<li>The Storage Queue is full and unable to write data to the disk quickly.</li>\n</ol>\n</li>\n<li>\n<ol start=\"2\">\n<li>Upon inspection every BEHIND_CHECK_DELAY seconds, the <em>\u201cread version received from the GRV proxy\u201d</em> is greater than the <em>\u201cmost recent version fetched from the TLog\u201d</em> + <em>\u201cBEHIND_CHECK_VERSION\u201d</em> for more than BEHIND_CHECK_COUNT times.</li>\n</ol>\n<ul>\n<li>BEHIND_CHECK_DELAY = 2 seconds</li>\n<li>BEHIND_CHECK_VERSION = 5 * VERSIONS_PER_SECOND</li>\n<li>BEHIND_CHECK_COUNT = 2 times</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>In the <em>process_behind</em> state,\n<ul>\n<li>The SS does not handle read requests and only processes writes.</li>\n<li>The task that periodically collects the list of SSs executed by the RateKeeper (RK) fails because it needs to read the Server key range stored in the SS.\n<ul>\n<li>If the STORAGE_SERVER_LIST_FETCH_TIMEOUT (default 20s) is exceeded, the TPSLimit is set to 0, preventing the TLog from receiving transactions.</li>\n</ul>\n</li>\n<li>The Data Distributor (DD) attempts to split the shard but fails.</li>\n<li><em>In this state, both read/write requests are blocked, and traffic redistribution is not possible.</em></li>\n</ul>\n</li>\n<li>Eventually, one must wait until the SSs in the initial ServerTeam fully process the backlog of data in the TLog.</li>\n<li>Once the backlog is cleared, normal operation resumes.</li>\n</ul>",
        "post_number": 3,
        "post_type": 1,
        "posts_count": 2,
        "updated_at": "2024-07-18T05:05:41.321Z",
        "reply_count": 0,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 0,
        "reads": 21,
        "readers_count": 20,
        "score": 64.2,
        "yours": false,
        "topic_id": 4517,
        "topic_slug": "cluster-in-stuck",
        "display_username": "Jaehui Lee",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "bookmarked": false,
        "actions_summary": [
          {
            "id": 2,
            "count": 2
          }
        ],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 1436,
        "hidden": false,
        "trust_level": 1,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/cluster-in-stuck/4517/3",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      }
    ],
    "stream": [
      14164,
      14268
    ]
  },
  "timeline_lookup": [
    [
      1,
      491
    ],
    [
      2,
      461
    ]
  ],
  "suggested_topics": [],
  "tags": [],
  "tags_descriptions": {},
  "fancy_title": "Cluster in stuck",
  "id": 4517,
  "title": "Cluster in stuck",
  "posts_count": 2,
  "created_at": "2024-06-18T05:48:52.255Z",
  "views": 207,
  "reply_count": 0,
  "like_count": 4,
  "last_posted_at": "2024-07-18T05:05:41.321Z",
  "visible": true,
  "closed": false,
  "archived": false,
  "has_summary": false,
  "archetype": "regular",
  "slug": "cluster-in-stuck",
  "category_id": 7,
  "word_count": 874,
  "deleted_at": null,
  "user_id": 1436,
  "featured_link": null,
  "pinned_globally": false,
  "pinned_at": null,
  "pinned_until": null,
  "image_url": null,
  "slow_mode_seconds": 0,
  "draft": null,
  "draft_key": "topic_4517",
  "draft_sequence": null,
  "unpinned": null,
  "pinned": false,
  "current_post_number": 1,
  "highest_post_number": 3,
  "deleted_by": null,
  "actions_summary": [
    {
      "id": 4,
      "count": 0,
      "hidden": false,
      "can_act": false
    },
    {
      "id": 8,
      "count": 0,
      "hidden": false,
      "can_act": false
    },
    {
      "id": 10,
      "count": 0,
      "hidden": false,
      "can_act": false
    },
    {
      "id": 7,
      "count": 0,
      "hidden": false,
      "can_act": false
    }
  ],
  "chunk_size": 20,
  "bookmarked": false,
  "topic_timer": null,
  "message_bus_last_id": 0,
  "participant_count": 1,
  "show_read_indicator": false,
  "thumbnails": null,
  "slow_mode_enabled_until": null,
  "tags_disable_ads": false,
  "related_topics": [
    {
      "fancy_title": "Cluster stuck in recovery after crash of one node",
      "id": 3216,
      "title": "Cluster stuck in recovery after crash of one node",
      "slug": "cluster-stuck-in-recovery-after-crash-of-one-node",
      "posts_count": 2,
      "reply_count": 0,
      "highest_post_number": 2,
      "image_url": null,
      "created_at": "2022-03-17T11:59:52.372Z",
      "last_posted_at": "2022-03-18T03:45:59.162Z",
      "bumped": true,
      "bumped_at": "2022-03-18T03:45:59.162Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 1,
      "views": 560,
      "category_id": 7,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": null,
          "description": "Original Poster",
          "user": {
            "id": 1079,
            "username": "xozzslip",
            "name": "",
            "avatar_template": "/user_avatar/forums.foundationdb.org/xozzslip/{size}/1298_2.png",
            "trust_level": 1
          }
        },
        {
          "extras": "latest",
          "description": "Most Recent Poster",
          "user": {
            "id": 454,
            "username": "jzhou",
            "name": "Jingyu Zhou",
            "avatar_template": "/user_avatar/forums.foundationdb.org/jzhou/{size}/445_2.png",
            "admin": true,
            "moderator": true,
            "trust_level": 2
          }
        }
      ]
    },
    {
      "fancy_title": "Full disk on one machine results in 99% performance degradation",
      "id": 850,
      "title": "Full disk on one machine results in 99% performance degradation",
      "slug": "full-disk-on-one-machine-results-in-99-performance-degradation",
      "posts_count": 6,
      "reply_count": 4,
      "highest_post_number": 6,
      "image_url": null,
      "created_at": "2018-11-06T00:18:11.154Z",
      "last_posted_at": "2018-11-08T00:02:29.123Z",
      "bumped": true,
      "bumped_at": "2018-11-08T00:02:29.123Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 0,
      "views": 2223,
      "category_id": 7,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": null,
          "description": "Original Poster",
          "user": {
            "id": 421,
            "username": "rbranson",
            "name": "Rick Branson",
            "avatar_template": "/user_avatar/forums.foundationdb.org/rbranson/{size}/406_2.png",
            "trust_level": 1
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 12,
            "username": "ajbeamon",
            "name": "A.J. Beamon",
            "avatar_template": "/user_avatar/forums.foundationdb.org/ajbeamon/{size}/13_2.png",
            "admin": true,
            "trust_level": 4
          }
        },
        {
          "extras": "latest",
          "description": "Most Recent Poster",
          "user": {
            "id": 13,
            "username": "alexmiller",
            "name": "Alex Miller",
            "avatar_template": "/user_avatar/forums.foundationdb.org/alexmiller/{size}/326_2.png",
            "trust_level": 4
          }
        }
      ]
    },
    {
      "fancy_title": "Segmentation fault error and broken cluster",
      "id": 483,
      "title": "Segmentation fault error and broken cluster",
      "slug": "segmentation-fault-error-and-broken-cluster",
      "posts_count": 17,
      "reply_count": 12,
      "highest_post_number": 17,
      "image_url": null,
      "created_at": "2018-05-31T15:34:28.123Z",
      "last_posted_at": "2018-06-11T17:31:13.656Z",
      "bumped": true,
      "bumped_at": "2018-06-11T17:31:13.656Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 2,
      "views": 4331,
      "category_id": 7,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": "latest",
          "description": "Original Poster, Most Recent Poster",
          "user": {
            "id": 211,
            "username": "brk0v",
            "name": "Viacheslav Biriukov",
            "avatar_template": "/user_avatar/forums.foundationdb.org/brk0v/{size}/173_2.png",
            "trust_level": 1
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 12,
            "username": "ajbeamon",
            "name": "A.J. Beamon",
            "avatar_template": "/user_avatar/forums.foundationdb.org/ajbeamon/{size}/13_2.png",
            "admin": true,
            "trust_level": 4
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 156,
            "username": "spullara",
            "name": "Sam Pullara",
            "avatar_template": "/user_avatar/forums.foundationdb.org/spullara/{size}/125_2.png",
            "trust_level": 2
          }
        }
      ]
    },
    {
      "fancy_title": "How to repair lagging process?",
      "id": 478,
      "title": "How to repair lagging process?",
      "slug": "how-to-repair-lagging-process",
      "posts_count": 10,
      "reply_count": 8,
      "highest_post_number": 10,
      "image_url": null,
      "created_at": "2018-05-29T08:05:25.357Z",
      "last_posted_at": "2018-05-31T03:22:50.621Z",
      "bumped": true,
      "bumped_at": "2018-05-31T03:22:50.621Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 0,
      "views": 2443,
      "category_id": 7,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": null,
          "description": "Original Poster",
          "user": {
            "id": 152,
            "username": "shgxwxl",
            "name": "Shgxwxl",
            "avatar_template": "/user_avatar/forums.foundationdb.org/shgxwxl/{size}/127_2.png",
            "trust_level": 1
          }
        },
        {
          "extras": "latest",
          "description": "Most Recent Poster",
          "user": {
            "id": 230,
            "username": "umpc",
            "name": "Justin Lowery",
            "avatar_template": "/user_avatar/forums.foundationdb.org/umpc/{size}/203_2.png",
            "trust_level": 2
          }
        }
      ]
    },
    {
      "fancy_title": "Storage node failure test",
      "id": 2385,
      "title": "Storage node failure test",
      "slug": "storage-node-failure-test",
      "posts_count": 10,
      "reply_count": 4,
      "highest_post_number": 10,
      "image_url": "https://global.discourse-cdn.com/foundationdb/optimized/1X/4102d40bd87b8652cec4b589fde3adc206780acc_2_1024x435.jpeg",
      "created_at": "2020-10-11T19:45:24.831Z",
      "last_posted_at": "2020-11-05T16:27:46.292Z",
      "bumped": true,
      "bumped_at": "2020-11-05T16:27:46.292Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 0,
      "views": 1081,
      "category_id": 17,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": "latest",
          "description": "Original Poster, Most Recent Poster",
          "user": {
            "id": 769,
            "username": "ajames",
            "name": "Alwin",
            "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/a/9de0a6/{size}.png",
            "trust_level": 2
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 12,
            "username": "ajbeamon",
            "name": "A.J. Beamon",
            "avatar_template": "/user_avatar/forums.foundationdb.org/ajbeamon/{size}/13_2.png",
            "admin": true,
            "trust_level": 4
          }
        }
      ]
    }
  ],
  "summarizable": false,
  "can_vote": false,
  "vote_count": 0,
  "user_voted": false,
  "discourse_zendesk_plugin_zendesk_id": null,
  "discourse_zendesk_plugin_zendesk_url": "https://your-url.zendesk.com/agent/tickets/",
  "details": {
    "can_edit": false,
    "notification_level": 1,
    "participants": [
      {
        "id": 1436,
        "username": "Jaehui-Lee",
        "name": "Jaehui Lee",
        "avatar_template": "/user_avatar/forums.foundationdb.org/jaehui-lee/{size}/1808_2.png",
        "post_count": 2,
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_color": null,
        "flair_bg_color": null,
        "flair_group_id": null,
        "trust_level": 1
      }
    ],
    "created_by": {
      "id": 1436,
      "username": "Jaehui-Lee",
      "name": "Jaehui Lee",
      "avatar_template": "/user_avatar/forums.foundationdb.org/jaehui-lee/{size}/1808_2.png"
    },
    "last_poster": {
      "id": 1436,
      "username": "Jaehui-Lee",
      "name": "Jaehui Lee",
      "avatar_template": "/user_avatar/forums.foundationdb.org/jaehui-lee/{size}/1808_2.png"
    }
  },
  "bookmarks": []
}