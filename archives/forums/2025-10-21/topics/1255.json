{
  "post_stream": {
    "posts": [
      {
        "id": 3727,
        "name": "",
        "username": "jonahwest",
        "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/j/90db22/{size}.png",
        "created_at": "2019-03-25T02:01:43.132Z",
        "cooked": "<p>The Document Layer looks very promising, however, is there a performance overhead to using it?</p>\n<ol>\n<li>\n<p>What are some real-world performance expectations? (operations/sec, latency, CPU usage)</p>\n</li>\n<li>\n<p>How much overhead does the Document Layer produce compared to the standard FoundationDB API?</p>\n</li>\n</ol>\n<p>Any suggestions, advice or experiences would be greatly appreciated. Thanks!</p>",
        "post_number": 1,
        "post_type": 1,
        "posts_count": 2,
        "updated_at": "2019-05-23T18:39:32.749Z",
        "reply_count": 0,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 176,
        "reads": 56,
        "readers_count": 55,
        "score": 891.2,
        "yours": false,
        "topic_id": 1255,
        "topic_slug": "document-layer-performance",
        "display_username": "",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 2,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 542,
        "hidden": false,
        "trust_level": 1,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/document-layer-performance/1255/1",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null,
        "can_vote": false
      },
      {
        "id": 3864,
        "name": "Bhaskar Muppana",
        "username": "mbhaskar",
        "avatar_template": "/user_avatar/forums.foundationdb.org/mbhaskar/{size}/277_2.png",
        "created_at": "2019-04-08T20:36:48.678Z",
        "cooked": "<p>Sorry for the delayed response. I keep procrastinating on this.</p>\n<p>We don\u2019t have any official benchmarking numbers yet. We have done some performance tests for specific use cases, which is hard to reason without digging into the use case. But, I can try to answer the second question. When it comes to layers overhead is the most important aspect. As the FoundationDB performance, in general, better understood and something we can rely upon.</p>\n<p>For the sake of completeness lets just state a couple of known facts about Document Layer</p>\n<ul>\n<li>Document Layer is a stateless layer and keeps all the state in FoundationDB.</li>\n<li>Document Layer is MongoDB compatible, so it receives MongoDB queries and converts them into FoundationDB operations.</li>\n</ul>\n<p>If we know the cost of FoundationDB operations and the mapping of MongoDB requests to FoundationDB operations, that would give us an idea about the cost/overhead of Document Layer.</p>\n<h3>FoundationDB operations</h3>\n<ul>\n<li>\n<code>getReadVersion()</code> - This is usually couple of milliseconds</li>\n<li>\n<code>commit()</code> - Couple of milliseconds, bit more expensive than <code>getReadVersion()</code>\n</li>\n<li>\n<code>get()</code> - sub-millisecond</li>\n<li><code>getRange()</code></li>\n<li>\n<code>set()</code> or <code>clear()</code> - insignificant, as its just in memory. We can just ignore these operations when it comes to performance, although it\u2019s quite easy to abuse these operations and kill the cluster, let\u2019s just assume we are not hitting those cases.</li>\n</ul>\n<p>Every FoundationDB transaction will have to do at least <code>getReadVersion()</code> and <code>commit()</code>. Of course, if the transaction is read-only you wouldn\u2019t do commit. It\u2019s also possible to avoid getting a new read version for every transaction by reusing previously committed or cached read version. We have to compromise on causal consistency for this.</p>\n<h3>MongoDB - FoundationDB mapping</h3>\n<p>There are two aspects of the mapping that affect the performance mainly</p>\n<ul>\n<li>How MongoDB requests are executed with the FoundationDB transactions?\n<ul>\n<li>This decides how often we have to pay the transaction overhead  - <code>getReadVerson()</code> and <code>commit()</code>. This also decides the consistency guarantees Document Layer provides.</li>\n</ul>\n</li>\n<li>How documents are stored on FoundationDB keys?\n<ul>\n<li>This decides how many keys we have to get to respond to MongoDB queries</li>\n</ul>\n</li>\n</ul>\n<p>To keep the discussion focused, let\u2019s stick to CRUD operations only.</p>\n<h4>MongoDB requests to FoundationDB transactions</h4>\n<p>To provide stronger consistency guarantees Document Layer tries to complete a request within a single FDB transaction. But, considering limitations on FDB transactions on the size and duration, it\u2019s not possible to complete the request in a single transaction always. Different requests are handled differently</p>\n<ul>\n<li>Schema update - Like create or delete indexes/collections. Forced to complete in a single transaction to maintain consistency of the schema.</li>\n<li>Insert - Each insert request is forced to complete in a single transaction. This includes updating indexes as well if any exist. Even bulk inserts are forced to complete in a single transaction.</li>\n<li>Update - Depending on the filter it is possible a single update request might need to update too many documents (even entire collection). If an update takes longer than 3 seconds, Document Layer spits into multiple FoundationDB transactions.</li>\n<li>Deletes - same as updates</li>\n</ul>\n<h4>JSON documents to FoundationDB Keys</h4>\n<p>Each JSON field is stored in a single FoundationDB key. If a document has 10 fields, it is stored in 10 FoundationDB keys. Inserting that document would cause 10 sets on FDB, and reading the entire document causes a <code>getRange()</code> which fetches 10 FDB keys. For small enough documents, <code>getRange()</code> wouldn\u2019t be that expensive compared to <code>get()</code>. But, if your document gets quite big (in terms of the number of fields), it could get expensive.</p>\n<h3>What does it mean?</h3>\n<p>If you do a simple insert</p>\n<pre><code class=\"lang-python\">db.coll.insert({'_id': 'Bhaskar', 'section': 'A', 'marks': 90})\n</code></pre>\n<p>That would generate</p>\n<ul>\n<li><code>getReadVersion()</code></li>\n<li>Read schema version</li>\n<li><code>set('Bhaskar:section', 'A')</code></li>\n<li><code>set('Bhaskar:marks', 90)</code></li>\n<li><code>commit()</code></li>\n</ul>\n<p>One surprise here is schema version, Document layer maintains the schema in FoundationDB, and makes sure schema hasn\u2019t changed since it last read on each and every request by reading the schema version. It\u2019s just another key in FDB.</p>\n<p>It would be around 5 to 7ms. These are very approximate numbers, it depends a lot on your FDB cluster setup.</p>\n<p>Reads would do better than this</p>\n<pre><code class=\"lang-python\">db.coll.find({'_id': 'Bhaskar')\n</code></pre>\n<ul>\n<li><code>getReadVersion()</code></li>\n<li>Read schema version</li>\n<li><code>getRange('Bhaskar:')</code></li>\n</ul>\n<h3>Techniques to mitigate latencies</h3>\n<ul>\n<li>Do batch operations - If you do bulk inserts, that would help to mitigate the transaction overhead</li>\n<li>Avoid reading the schema version - Improvements in 6.1 FoundationDB make it possible to avoid reading schema version separately</li>\n<li>Explicit transactions - You can\u2019t batch read-modify-write operations, explicit transactions would make it possible by giving control over transactions to the application.</li>\n</ul>",
        "post_number": 2,
        "post_type": 1,
        "posts_count": 2,
        "updated_at": "2019-04-08T20:36:48.678Z",
        "reply_count": 0,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 9,
        "reads": 46,
        "readers_count": 45,
        "score": 69.2,
        "yours": false,
        "topic_id": 1255,
        "topic_slug": "document-layer-performance",
        "display_username": "Bhaskar Muppana",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "bookmarked": false,
        "actions_summary": [
          {
            "id": 2,
            "count": 1
          }
        ],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 9,
        "hidden": false,
        "trust_level": 4,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/document-layer-performance/1255/2",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      }
    ],
    "stream": [
      3727,
      3864
    ]
  },
  "timeline_lookup": [
    [
      1,
      2403
    ],
    [
      2,
      2388
    ]
  ],
  "suggested_topics": [],
  "tags": [
    "performance"
  ],
  "tags_descriptions": {},
  "fancy_title": "Document Layer Performance",
  "id": 1255,
  "title": "Document Layer Performance",
  "posts_count": 2,
  "created_at": "2019-03-25T02:01:43.056Z",
  "views": 1531,
  "reply_count": 0,
  "like_count": 1,
  "last_posted_at": "2019-04-08T20:36:48.678Z",
  "visible": true,
  "closed": false,
  "archived": false,
  "has_summary": false,
  "archetype": "regular",
  "slug": "document-layer-performance",
  "category_id": 11,
  "word_count": 808,
  "deleted_at": null,
  "user_id": 542,
  "featured_link": null,
  "pinned_globally": false,
  "pinned_at": null,
  "pinned_until": null,
  "image_url": null,
  "slow_mode_seconds": 0,
  "draft": null,
  "draft_key": "topic_1255",
  "draft_sequence": null,
  "unpinned": null,
  "pinned": false,
  "current_post_number": 1,
  "highest_post_number": 2,
  "deleted_by": null,
  "actions_summary": [
    {
      "id": 4,
      "count": 0,
      "hidden": false,
      "can_act": false
    },
    {
      "id": 8,
      "count": 0,
      "hidden": false,
      "can_act": false
    },
    {
      "id": 10,
      "count": 0,
      "hidden": false,
      "can_act": false
    },
    {
      "id": 7,
      "count": 0,
      "hidden": false,
      "can_act": false
    }
  ],
  "chunk_size": 20,
  "bookmarked": false,
  "topic_timer": null,
  "message_bus_last_id": 0,
  "participant_count": 2,
  "show_read_indicator": false,
  "thumbnails": null,
  "slow_mode_enabled_until": null,
  "tags_disable_ads": false,
  "related_topics": [
    {
      "fancy_title": "1 M rows write via Mongo client using document layer",
      "id": 1157,
      "title": "1 M rows write via Mongo client using document layer",
      "slug": "1-m-rows-write-via-mongo-client-using-document-layer",
      "posts_count": 13,
      "reply_count": 6,
      "highest_post_number": 13,
      "image_url": null,
      "created_at": "2019-02-19T21:32:16.215Z",
      "last_posted_at": "2019-06-13T13:08:26.134Z",
      "bumped": true,
      "bumped_at": "2019-06-13T13:08:26.134Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 2,
      "views": 2280,
      "category_id": 14,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": null,
          "description": "Original Poster",
          "user": {
            "id": 521,
            "username": "vaggarwal",
            "name": "VISHAL AGGARWAL",
            "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/v/b3f665/{size}.png",
            "trust_level": 1
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 9,
            "username": "mbhaskar",
            "name": "Bhaskar Muppana",
            "avatar_template": "/user_avatar/forums.foundationdb.org/mbhaskar/{size}/277_2.png",
            "trust_level": 4
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 81,
            "username": "ryanworl",
            "name": "Ryan Worl",
            "avatar_template": "/user_avatar/forums.foundationdb.org/ryanworl/{size}/440_2.png",
            "trust_level": 3
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 13,
            "username": "alexmiller",
            "name": "Alex Miller",
            "avatar_template": "/user_avatar/forums.foundationdb.org/alexmiller/{size}/326_2.png",
            "trust_level": 4
          }
        },
        {
          "extras": "latest",
          "description": "Most Recent Poster",
          "user": {
            "id": 584,
            "username": "aaerofeev",
            "name": "Alexandr Erofeev",
            "avatar_template": "/user_avatar/forums.foundationdb.org/aaerofeev/{size}/582_2.png",
            "trust_level": 1
          }
        }
      ]
    },
    {
      "fancy_title": "Announcing FoundationDB Document Layer",
      "id": 914,
      "title": "Announcing FoundationDB Document Layer",
      "slug": "announcing-foundationdb-document-layer",
      "posts_count": 2,
      "reply_count": 0,
      "highest_post_number": 2,
      "image_url": null,
      "created_at": "2018-11-29T20:15:26.902Z",
      "last_posted_at": "2018-11-29T21:22:01.867Z",
      "bumped": true,
      "bumped_at": "2018-11-29T20:15:27.009Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": true,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 5,
      "views": 902,
      "category_id": 6,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": "latest single",
          "description": "Original Poster, Most Recent Poster",
          "user": {
            "id": 1,
            "username": "davelester",
            "name": "Dave Lester",
            "avatar_template": "/user_avatar/forums.foundationdb.org/davelester/{size}/1927_2.png",
            "trust_level": 4
          }
        }
      ]
    },
    {
      "fancy_title": "Document layer unexpectedly slow with naive test",
      "id": 1981,
      "title": "Document layer unexpectedly slow with naive test",
      "slug": "document-layer-unexpectedly-slow-with-naive-test",
      "posts_count": 3,
      "reply_count": 1,
      "highest_post_number": 3,
      "image_url": null,
      "created_at": "2020-02-26T17:17:34.792Z",
      "last_posted_at": "2020-10-04T03:54:46.084Z",
      "bumped": true,
      "bumped_at": "2020-10-04T03:54:46.084Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [
        "performance"
      ],
      "tags_descriptions": {},
      "like_count": 0,
      "views": 847,
      "category_id": 11,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": null,
          "description": "Original Poster",
          "user": {
            "id": 721,
            "username": "ggilley",
            "name": "Greg Gilley",
            "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/g/7993a0/{size}.png",
            "trust_level": 1
          }
        },
        {
          "extras": "latest",
          "description": "Most Recent Poster",
          "user": {
            "id": 829,
            "username": "chandraonline",
            "name": "Chandra",
            "avatar_template": "/user_avatar/forums.foundationdb.org/chandraonline/{size}/945_2.png",
            "trust_level": 1
          }
        }
      ]
    },
    {
      "fancy_title": "Document layer plans?",
      "id": 180,
      "title": "Document layer plans?",
      "slug": "document-layer-plans",
      "posts_count": 2,
      "reply_count": 0,
      "highest_post_number": 2,
      "image_url": null,
      "created_at": "2018-04-21T14:43:09.747Z",
      "last_posted_at": "2018-04-22T14:19:56.095Z",
      "bumped": true,
      "bumped_at": "2018-04-22T16:39:24.212Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 2,
      "views": 1916,
      "category_id": 9,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": null,
          "description": "Original Poster",
          "user": {
            "id": 30,
            "username": "wwilson",
            "name": "Will Wilson",
            "avatar_template": "/user_avatar/forums.foundationdb.org/wwilson/{size}/88_2.png",
            "trust_level": 2
          }
        },
        {
          "extras": "latest",
          "description": "Most Recent Poster",
          "user": {
            "id": 140,
            "username": "Andrej",
            "name": "",
            "avatar_template": "/user_avatar/forums.foundationdb.org/andrej/{size}/261_2.png",
            "trust_level": 1
          }
        }
      ]
    },
    {
      "fancy_title": "Looking for layer design documentation",
      "id": 946,
      "title": "Looking for layer design documentation",
      "slug": "looking-for-layer-design-documentation",
      "posts_count": 7,
      "reply_count": 2,
      "highest_post_number": 7,
      "image_url": null,
      "created_at": "2018-12-10T11:32:27.613Z",
      "last_posted_at": "2018-12-28T22:14:09.611Z",
      "bumped": true,
      "bumped_at": "2018-12-28T22:14:09.611Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 0,
      "views": 2665,
      "category_id": 11,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": null,
          "description": "Original Poster",
          "user": {
            "id": 287,
            "username": "sfw",
            "name": "Sebastian Weyrauch",
            "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/s/ad7895/{size}.png",
            "trust_level": 1
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 9,
            "username": "mbhaskar",
            "name": "Bhaskar Muppana",
            "avatar_template": "/user_avatar/forums.foundationdb.org/mbhaskar/{size}/277_2.png",
            "trust_level": 4
          }
        },
        {
          "extras": "latest",
          "description": "Most Recent Poster",
          "user": {
            "id": 41,
            "username": "amirouche",
            "name": "Amirouche",
            "avatar_template": "/user_avatar/forums.foundationdb.org/amirouche/{size}/1911_2.png",
            "trust_level": 2
          }
        }
      ]
    }
  ],
  "summarizable": false,
  "can_vote": false,
  "vote_count": 0,
  "user_voted": false,
  "discourse_zendesk_plugin_zendesk_id": null,
  "discourse_zendesk_plugin_zendesk_url": "https://your-url.zendesk.com/agent/tickets/",
  "details": {
    "can_edit": false,
    "notification_level": 1,
    "participants": [
      {
        "id": 9,
        "username": "mbhaskar",
        "name": "Bhaskar Muppana",
        "avatar_template": "/user_avatar/forums.foundationdb.org/mbhaskar/{size}/277_2.png",
        "post_count": 1,
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_color": null,
        "flair_bg_color": null,
        "flair_group_id": null,
        "trust_level": 4
      },
      {
        "id": 542,
        "username": "jonahwest",
        "name": "",
        "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/j/90db22/{size}.png",
        "post_count": 1,
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_color": null,
        "flair_bg_color": null,
        "flair_group_id": null,
        "trust_level": 1
      }
    ],
    "created_by": {
      "id": 542,
      "username": "jonahwest",
      "name": "",
      "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/j/90db22/{size}.png"
    },
    "last_poster": {
      "id": 9,
      "username": "mbhaskar",
      "name": "Bhaskar Muppana",
      "avatar_template": "/user_avatar/forums.foundationdb.org/mbhaskar/{size}/277_2.png"
    }
  },
  "bookmarks": []
}