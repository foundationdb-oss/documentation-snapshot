{
  "post_stream": {
    "posts": [
      {
        "id": 9150,
        "name": "Amanda",
        "username": "amanda",
        "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/a/67e7ee/{size}.png",
        "created_at": "2021-03-12T08:26:07.773Z",
        "cooked": "<p>Hey, I lost my FDB cluster today when I tried to change the public address. I\u2019m running 6.2.25. I have a cluster running on a single EC2 instance, and I\u2019m about to add a second EC2 instance to run some fdbservers from there as well. But the existing setup was just run on the single instance, so the <code>public_address</code> in foundationdb.conf was 127.0.0.1. I changed this to the IP of the instance for two unset-class fdbservers, neither of which were a coordinator. Then things failed:</p>\n<pre><code class=\"lang-auto\">Process performance details:\n  &lt;new-ip&gt;:4510:tls  ( 44% cpu; 30% machine; 0.024 Gbps; 80% disk IO; 1.2 GB / 19.2 GB RAM  )\n    Last logged error: StorageServerFailed: internal_error at Fri Mar 12 03:40:56 2021\n   &lt;new-ip&gt;:4511:tls  ( 71% cpu; 30% machine; 0.024 Gbps; 80% disk IO; 1.4 GB / 19.2 GB RAM  )\n  127.0.0.1:4500:tls     ( 87% cpu; 30% machine; 0.024 Gbps; 51% disk IO; 7.3 GB / 19.1 GB RAM  )\n [...]\n</code></pre>\n<p>The logs for the failed storage server showed:</p>\n<pre><code class=\"lang-auto\">&lt;Event Severity=\"40\"\nTime=\"1615520455.464246\"\nType=\"DeliveredToNotAssigned\"\nID=\"0000000000000000\"\nVersion=\"24615219935000\"\nMutation=\"code: SetValue param1: &lt;some bytes&gt; param2: &lt;some bytes&gt;\"\nBacktrace=\"addr2line -e fdbserver.debug -p -C -f -i [...]\nRoles=\"MP,SS,TL\" /&gt;\n</code></pre>\n<p>Looks like this means the database metadata was corrupted: <a href=\"https://forums.foundationdb.org/t/fdbserver-error-in-a-cluster-with-double-redundancy/2348\" class=\"inline-onebox\">Fdbserver error in a cluster with double redundancy</a> The 000 ID looks odd, is it supposed to be the ID for the fdbserver?</p>\n<p>I changed the public address back to 127.0.0.1, but failed to get that storage server back up (it always went back to that same DeliveredToNotAssigned error. We also just tried restarting everything), and had to wipe the DB since we\u2019re running rf1.</p>\n<p>Note that this change was done on two fdbservers, but only one corrupted. If I shut off the corrupted fdbserver, everything else starts up fine (but data is missing)</p>\n<p>A few questions:</p>\n<ol>\n<li>Can someone shed some light on this error? Also, the bytes in the error look like a regular write from a client - would there have been any way to just throw away this mutation to salvage the rest of the DB? And, why did this corrupt one fdbserver but not the other one?</li>\n<li>Most concerningly\u2013This happened on a non-kubernetes cluster, but we also have a k8s setup where on startup, our FDB wrapper service finds the IP of its pod and sets that as the public address. We\u2019re not using the official fdb k8s operator. Is what we\u2019re doing unsafe - are we at risk of the same corruption there? The config we made change feels very similar to this.</li>\n<li>What is a safe way to do this (change the public address from 127.0.0.1 to the IP of the host)? The corruption happened on our dev cluster where I was testing this, but we still need to do this on one of our production (non-kubernetes) databases.</li>\n</ol>\n<p>Thanks in advance!</p>",
        "post_number": 1,
        "post_type": 1,
        "posts_count": 9,
        "updated_at": "2021-03-12T08:26:07.773Z",
        "reply_count": 0,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 387,
        "reads": 46,
        "readers_count": 45,
        "score": 1934.2,
        "yours": false,
        "topic_id": 2602,
        "topic_slug": "changing-public-address-of-non-coordinator-fdbserver-corrupted-cluster",
        "display_username": "Amanda",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "link_counts": [
          {
            "url": "https://forums.foundationdb.org/t/fdbserver-error-in-a-cluster-with-double-redundancy/2348",
            "internal": true,
            "reflection": false,
            "title": "Fdbserver error in a cluster with double redundancy",
            "clicks": 2
          }
        ],
        "read": true,
        "user_title": null,
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 810,
        "hidden": false,
        "trust_level": 2,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/changing-public-address-of-non-coordinator-fdbserver-corrupted-cluster/2602/1",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null,
        "can_vote": false
      },
      {
        "id": 9165,
        "name": "Amanda",
        "username": "amanda",
        "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/a/67e7ee/{size}.png",
        "created_at": "2021-03-16T02:19:42.833Z",
        "cooked": "<p>I looked into this a bit more, it seems like the error is in the update path that\u2019s hit on storage server startup:  <a href=\"https://github.com/apple/foundationdb/blob/master/fdbserver/storageserver.actor.cpp#L3401\" class=\"inline-onebox\" rel=\"noopener nofollow ugc\">foundationdb/storageserver.actor.cpp at master \u00b7 apple/foundationdb \u00b7 GitHub</a></p>\n<p>Seems like one of the mutations is in a \u201cnot assigned\u201d shard. Initially one all-keys shard is added to each storage server, and it seems like then they are split and assigned: <a href=\"https://github.com/apple/foundationdb/blob/master/fdbserver/storageserver.actor.cpp#L2915\" class=\"inline-onebox\" rel=\"noopener nofollow ugc\">foundationdb/storageserver.actor.cpp at master \u00b7 apple/foundationdb \u00b7 GitHub</a></p>\n<p>I\u2019m still having issues though see how a not-assigned shard would end up on a storage server \u2013 I\u2019m guessing the corruption already existed before the bad mutation.</p>",
        "post_number": 2,
        "post_type": 1,
        "posts_count": 9,
        "updated_at": "2021-03-16T02:19:42.833Z",
        "reply_count": 0,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 7,
        "reads": 34,
        "readers_count": 33,
        "score": 41.8,
        "yours": false,
        "topic_id": 2602,
        "topic_slug": "changing-public-address-of-non-coordinator-fdbserver-corrupted-cluster",
        "display_username": "Amanda",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "link_counts": [
          {
            "url": "https://github.com/apple/foundationdb/blob/master/fdbserver/storageserver.actor.cpp#L3401",
            "internal": false,
            "reflection": false,
            "title": "foundationdb/storageserver.actor.cpp at master \u00b7 apple/foundationdb \u00b7 GitHub",
            "clicks": 1
          },
          {
            "url": "https://github.com/apple/foundationdb/blob/master/fdbserver/storageserver.actor.cpp#L2915",
            "internal": false,
            "reflection": false,
            "title": "foundationdb/storageserver.actor.cpp at master \u00b7 apple/foundationdb \u00b7 GitHub",
            "clicks": 0
          }
        ],
        "read": true,
        "user_title": null,
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 810,
        "hidden": false,
        "trust_level": 2,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/changing-public-address-of-non-coordinator-fdbserver-corrupted-cluster/2602/2",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 9166,
        "name": "",
        "username": "andrew.noyes",
        "avatar_template": "/user_avatar/forums.foundationdb.org/andrew.noyes/{size}/443_2.png",
        "created_at": "2021-03-16T02:27:52.049Z",
        "cooked": "<p>I think <a href=\"https://apple.github.io/foundationdb/building-cluster.html#make-foundationdb-externally-accessible\" class=\"inline-onebox\" rel=\"noopener nofollow ugc\">Building a Cluster \u2014 FoundationDB 6.2</a> is the current recommended way of updating the ip from 127.0.0.1</p>",
        "post_number": 3,
        "post_type": 1,
        "posts_count": 9,
        "updated_at": "2021-03-16T02:27:52.049Z",
        "reply_count": 1,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 0,
        "reads": 32,
        "readers_count": 31,
        "score": 11.4,
        "yours": false,
        "topic_id": 2602,
        "topic_slug": "changing-public-address-of-non-coordinator-fdbserver-corrupted-cluster",
        "display_username": "",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "link_counts": [
          {
            "url": "https://apple.github.io/foundationdb/building-cluster.html#make-foundationdb-externally-accessible",
            "internal": false,
            "reflection": false,
            "title": "Building a Cluster \u2014 FoundationDB 6.2",
            "clicks": 64
          }
        ],
        "read": true,
        "user_title": "",
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 14,
        "hidden": false,
        "trust_level": 2,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/changing-public-address-of-non-coordinator-fdbserver-corrupted-cluster/2602/3",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 9167,
        "name": "Amanda",
        "username": "amanda",
        "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/a/67e7ee/{size}.png",
        "created_at": "2021-03-16T02:56:07.413Z",
        "cooked": "<p>Oh didn\u2019t see that script before. Thanks! A few questions though\u2013</p>\n<ol>\n<li>\n<p>That looks like it\u2019s for a single node - we have a bit of an odd setup of mimicking multiple FDB machines on our single instance. We have a microservice wrapping FDB and each instance of that service runs in a separate docker container, running fdbmonitor with a separate cluster file and multiple fdbserver processes. The docker containers are using host network mode. (So for example, in my dev stack I have 3 instances of the microservice, so 3 docker containers are each running 1 fdbmonitor process and 2 fdbserver processes, and the cluster file for each docker container is a different file with the same contents) I\u2019m guessing I\u2019d have to shut down all the fdbserver processes, run the script on all of the individual cluster files, and start them all back up?</p>\n</li>\n<li>\n<p>It seems like the script only changes the cluster file addresses, when I still have to update the <code>public_address</code> in all the foundationdb.conf files. Do you know if this has to be done before, after, or concurrently with the cluster file change?</p>\n</li>\n</ol>\n<p>I\u2019m ok with making this a downtime process, I\u2019m just concerned from not understanding why this change caused corruption and I want a safe way to do it</p>",
        "post_number": 4,
        "post_type": 1,
        "posts_count": 9,
        "updated_at": "2021-03-16T02:56:07.413Z",
        "reply_count": 1,
        "reply_to_post_number": 3,
        "quote_count": 0,
        "incoming_link_count": 4,
        "reads": 32,
        "readers_count": 31,
        "score": 31.4,
        "yours": false,
        "topic_id": 2602,
        "topic_slug": "changing-public-address-of-non-coordinator-fdbserver-corrupted-cluster",
        "display_username": "Amanda",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "reply_to_user": {
          "id": 14,
          "username": "andrew.noyes",
          "name": "",
          "avatar_template": "/user_avatar/forums.foundationdb.org/andrew.noyes/{size}/443_2.png"
        },
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 810,
        "hidden": false,
        "trust_level": 2,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/changing-public-address-of-non-coordinator-fdbserver-corrupted-cluster/2602/4",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 9176,
        "name": "",
        "username": "andrew.noyes",
        "avatar_template": "/user_avatar/forums.foundationdb.org/andrew.noyes/{size}/443_2.png",
        "created_at": "2021-03-16T17:34:35.876Z",
        "cooked": "<aside class=\"quote no-group\" data-username=\"amanda\" data-post=\"4\" data-topic=\"2602\">\n<div class=\"title\">\n<div class=\"quote-controls\"></div>\n<img loading=\"lazy\" alt=\"\" width=\"24\" height=\"24\" src=\"https://avatars.discourse-cdn.com/v4/letter/a/67e7ee/48.png\" class=\"avatar\"> amanda:</div>\n<blockquote>\n<p>It seems like the script only changes the cluster file addresses, when I still have to update the <code>public_address</code> in all the foundationdb.conf files. Do you know if this has to be done before, after, or concurrently with the cluster file change?</p>\n</blockquote>\n</aside>\n<p>Is it possible for you to use <code>auto:&lt;port&gt;</code> syntax from <a href=\"https://apple.github.io/foundationdb/configuration.html#fdbserver-section\" class=\"inline-onebox\" rel=\"noopener nofollow ugc\">Configuration \u2014 FoundationDB 7.1</a>? I couldn\u2019t find great documentation on what exactly this does but here\u2019s a reference to the source: <a href=\"https://github.com/apple/foundationdb/blob/df90cc89de67ea4748c8cadd18e6fc4ce7fda12e/fdbclient/AutoPublicAddress.cpp#L31\" rel=\"noopener nofollow ugc\">https://github.com/apple/foundationdb/blob/df90cc89de67ea4748c8cadd18e6fc4ce7fda12e/fdbclient/AutoPublicAddress.cpp#L31</a>. I <em>think</em> this is the recommend practice (disclaimer I don\u2019t actually administrate fdb clusters myself very much).</p>\n<aside class=\"quote no-group\" data-username=\"amanda\" data-post=\"4\" data-topic=\"2602\">\n<div class=\"title\">\n<div class=\"quote-controls\"></div>\n<img loading=\"lazy\" alt=\"\" width=\"24\" height=\"24\" src=\"https://avatars.discourse-cdn.com/v4/letter/a/67e7ee/48.png\" class=\"avatar\"> amanda:</div>\n<blockquote>\n<p>I\u2019m ok with making this a downtime process, I\u2019m just concerned from not understanding why this change caused corruption and I want a safe way to do it</p>\n</blockquote>\n</aside>\n<p>I\u2019m also not sure why/how this caused a corruption. I\u2019m going to try to repro locally</p>",
        "post_number": 5,
        "post_type": 1,
        "posts_count": 9,
        "updated_at": "2021-03-16T17:34:35.876Z",
        "reply_count": 1,
        "reply_to_post_number": 4,
        "quote_count": 1,
        "incoming_link_count": 2,
        "reads": 29,
        "readers_count": 28,
        "score": 20.8,
        "yours": false,
        "topic_id": 2602,
        "topic_slug": "changing-public-address-of-non-coordinator-fdbserver-corrupted-cluster",
        "display_username": "",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "link_counts": [
          {
            "url": "https://apple.github.io/foundationdb/configuration.html#fdbserver-section",
            "internal": false,
            "reflection": false,
            "title": "Configuration \u2014 FoundationDB 6.2",
            "clicks": 10
          },
          {
            "url": "https://github.com/apple/foundationdb/blob/df90cc89de67ea4748c8cadd18e6fc4ce7fda12e/fdbclient/AutoPublicAddress.cpp#L31",
            "internal": false,
            "reflection": false,
            "title": "foundationdb/AutoPublicAddress.cpp at df90cc89de67ea4748c8cadd18e6fc4ce7fda12e \u00b7 apple/foundationdb \u00b7 GitHub",
            "clicks": 6
          }
        ],
        "read": true,
        "user_title": "",
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 14,
        "hidden": false,
        "trust_level": 2,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/changing-public-address-of-non-coordinator-fdbserver-corrupted-cluster/2602/5",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 9177,
        "name": "",
        "username": "andrew.noyes",
        "avatar_template": "/user_avatar/forums.foundationdb.org/andrew.noyes/{size}/443_2.png",
        "created_at": "2021-03-16T17:58:37.648Z",
        "cooked": "<p>Unfortunately I wasn\u2019t able to repro. I had a foundationdb.conf with three 6.2.25 fdbservers with <code>public_address = 127.0.0.1:$ID</code>, then changed the two non-coordinator processes to <code>public_address = &lt;ip&gt;:$ID</code>, but the database still worked</p>",
        "post_number": 6,
        "post_type": 1,
        "posts_count": 9,
        "updated_at": "2021-03-16T17:58:37.648Z",
        "reply_count": 1,
        "reply_to_post_number": 5,
        "quote_count": 0,
        "incoming_link_count": 0,
        "reads": 25,
        "readers_count": 24,
        "score": 10.0,
        "yours": false,
        "topic_id": 2602,
        "topic_slug": "changing-public-address-of-non-coordinator-fdbserver-corrupted-cluster",
        "display_username": "",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": "",
        "reply_to_user": {
          "id": 14,
          "username": "andrew.noyes",
          "name": "",
          "avatar_template": "/user_avatar/forums.foundationdb.org/andrew.noyes/{size}/443_2.png"
        },
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 14,
        "hidden": false,
        "trust_level": 2,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/changing-public-address-of-non-coordinator-fdbserver-corrupted-cluster/2602/6",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 9178,
        "name": "Alex Miller",
        "username": "alexmiller",
        "avatar_template": "/user_avatar/forums.foundationdb.org/alexmiller/{size}/326_2.png",
        "created_at": "2021-03-16T21:00:23.709Z",
        "cooked": "<p>I think the two machines part might be key here.</p>\n<p>I\u2019ve been trying to find some sort of story that looks like\u2026</p>\n<ul>\n<li>Assume you had two machines, <code>A</code> and <code>B</code>\n</li>\n<li>A cluster is running on <code>A</code> with 127.0.0.1:4500 and 127.0.0.1:4501</li>\n<li>Two fdbserver processes are started on <code>B</code> as 127.0.0.1:4500 and 127.0.0.1:4501</li>\n<li>The cluster on <code>A</code> is changed to use public IPs</li>\n<li>The two fdbserver processes on <code>B</code> are changed to point to the cluster on <code>A</code>\n</li>\n<li>The public address of 127.0.0.1:4500 from <code>B</code> resolves to the local fdbserver process on <code>A</code> instead of the \u201ccorrect\u201d process on <code>B</code>\n</li>\n</ul>\n<p>Or something like that?  I\u2019m not sure that exact chain of events would work, but I think something that revolves around 127.0.0.1 being ambiguous if you manage to introduce it into a multi-host cluster has to be the key here.</p>",
        "post_number": 7,
        "post_type": 1,
        "posts_count": 9,
        "updated_at": "2021-03-16T21:00:23.709Z",
        "reply_count": 1,
        "reply_to_post_number": 6,
        "quote_count": 0,
        "incoming_link_count": 1,
        "reads": 26,
        "readers_count": 25,
        "score": 15.2,
        "yours": false,
        "topic_id": 2602,
        "topic_slug": "changing-public-address-of-non-coordinator-fdbserver-corrupted-cluster",
        "display_username": "Alex Miller",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "reply_to_user": {
          "id": 14,
          "username": "andrew.noyes",
          "name": "",
          "avatar_template": "/user_avatar/forums.foundationdb.org/andrew.noyes/{size}/443_2.png"
        },
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 13,
        "hidden": false,
        "trust_level": 4,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/changing-public-address-of-non-coordinator-fdbserver-corrupted-cluster/2602/7",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 9179,
        "name": "Amanda",
        "username": "amanda",
        "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/a/67e7ee/{size}.png",
        "created_at": "2021-03-16T21:32:19.374Z",
        "cooked": "<p>Hm, the short answer is we\u2019re running them on the same instance (so same 127.0.0.1) and they all have different ports. What you\u2019re describing sounds like a faulty setup that wouldn\u2019t have worked to start with, right?</p>\n<p>That being said, I don\u2019t understand a few parts of what you mentioned that might be relevant here.</p>\n<blockquote>\n<ul>\n<li>The cluster on <code>A</code> is changed to use public IPs</li>\n</ul>\n</blockquote>\n<p>To clarify, you mean the processes on A switch their <code>public_address</code> in foundationdb.conf from 127.0.0.1 to the IP of the instance right? (There isn\u2019t some other boolean flag in the config stating whether or not this is a local vs public IP?)</p>\n<blockquote>\n<ul>\n<li>The two fdbserver processes on <code>B</code> are changed to point to the cluster on <code>A</code></li>\n</ul>\n</blockquote>\n<p>Is this a configuration change needed on B? I thought A would just start up, hit the coordinator, be identified as the same existing processes due to having the same sqlite filenames, and then cluster controller would tell B what the addresses of the A processes are?</p>\n<p>A more in-depth description of what happened:</p>\n<p>Initial setup:</p>\n<ul>\n<li>service 1 is running fdbmonitor that runs 127.0.0.1:4500 and 127.0.0.1:4501</li>\n<li>service 2 is running fdbmonitor that runs 127.0.0.1:4502 and 127.0.0.1:4503</li>\n<li>[\u2026]</li>\n<li>service 6 is running fdbmonitor that runs 127.0.0.1:4510 and 127.0.0.1:4511</li>\n</ul>\n<p>The services are just our wrapper service. Services 1-6 all run on the same host. All fdbservers are unset class. There\u2019s one coordinator, 4500 on service 1.</p>\n<p>Config change:</p>\n<ul>\n<li>4510 and 4511 (on service 6) change the <code>public_address</code> key in their foundationdb.conf from 127.0.0.1 to the IP of the instance</li>\n<li>4510 and 4511 restart</li>\n</ul>\n<p>Corruption:</p>\n<ul>\n<li>4511 comes up healthy, 4510 does not (with the DeliveredToNotAssigned error). In <code>status details</code>, both of these processes are listed with the IP of the instance, rather than 127.0.0.1 (like all the other fdbservers are listed with)</li>\n<li>There\u2019s another error in 4503, on the resolver role.</li>\n<li>All fdbservers are restarted, no change - same <code>status details</code> output, same errors</li>\n<li>4510 is turned off, all other fdbservers come up healthy (but we\u2019re missing data now)</li>\n</ul>\n<p>Would this timeline have caused an fdbserver to incorrectly resolve the address of another fdbserver?</p>\n<p>Also regarding multiple machines - We do plan on expanding to a second machine, after the public IP config change on the current machine is done.</p>",
        "post_number": 8,
        "post_type": 1,
        "posts_count": 9,
        "updated_at": "2021-03-16T21:49:49.843Z",
        "reply_count": 0,
        "reply_to_post_number": 7,
        "quote_count": 0,
        "incoming_link_count": 2,
        "reads": 25,
        "readers_count": 24,
        "score": 15.0,
        "yours": false,
        "topic_id": 2602,
        "topic_slug": "changing-public-address-of-non-coordinator-fdbserver-corrupted-cluster",
        "display_username": "Amanda",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 2,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "reply_to_user": {
          "id": 13,
          "username": "alexmiller",
          "name": "Alex Miller",
          "avatar_template": "/user_avatar/forums.foundationdb.org/alexmiller/{size}/326_2.png"
        },
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 810,
        "hidden": false,
        "trust_level": 2,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/changing-public-address-of-non-coordinator-fdbserver-corrupted-cluster/2602/8",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 9180,
        "name": "Amanda",
        "username": "amanda",
        "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/a/67e7ee/{size}.png",
        "created_at": "2021-03-16T23:03:07.029Z",
        "cooked": "<p>One other thing that could be helpful - I\u2019m not sure if this is normal or not but after the config change (I didn\u2019t check if this was also the case before the config change) I saw that there were two storage servers running on the failing fdbserver, 4510. One was very small (looking at the sqlite file of the same name as the storage server ID) and it started up fine, the big one is the one that failed. In <code>status json</code> the storage role details/metrics showed up for the new storage role ID, but for the old storage role ID it just showed the error message. I saw <code>ID</code> tags on the trace events from both storage servers. Is it possible that due to the address change, the fdbserver was identified as a totally new one and that\u2019s why it spun up a new storage role?</p>\n<p>And also, regardless of how it got in that state, is there anything actually incorrect about running multiple storage servers on one fdbserver? (Other than resource constraints and not being able to decommission one specific storage role) My understanding is that the shard assignment is tracked with the storage server ID, not by IP?</p>\n<p>Update: Read the <a href=\"https://github.com/apple/foundationdb/blob/master/documentation/sphinx/source/read-write-path.rst\" rel=\"noopener nofollow ugc\">read-write path</a> a bit more (by the way, this doc is awesome! A similar doc on the startup path would also be super great) and I\u2019m curious about the SS to primary TLog mapping. So there <em>should</em> be a primary TLog for each of the two storage roles that showed up on 4510, is it possible the old SS was receiving mutations meant for the new SS (on the same fdbserver)? Is there something in that path that identifies by IP, rather than SS ID? We did however try removing the files for the new SS as a last resort to get the cluster working, and we still had the same error.</p>",
        "post_number": 9,
        "post_type": 1,
        "posts_count": 9,
        "updated_at": "2021-03-16T23:14:47.016Z",
        "reply_count": 0,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 2,
        "reads": 22,
        "readers_count": 21,
        "score": 14.4,
        "yours": false,
        "topic_id": 2602,
        "topic_slug": "changing-public-address-of-non-coordinator-fdbserver-corrupted-cluster",
        "display_username": "Amanda",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 2,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "link_counts": [
          {
            "url": "https://github.com/apple/foundationdb/blob/master/documentation/sphinx/source/read-write-path.rst",
            "internal": false,
            "reflection": false,
            "title": "foundationdb/read-write-path.rst at master \u00b7 apple/foundationdb \u00b7 GitHub",
            "clicks": 4
          }
        ],
        "read": true,
        "user_title": null,
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 810,
        "hidden": false,
        "trust_level": 2,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/changing-public-address-of-non-coordinator-fdbserver-corrupted-cluster/2602/9",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      }
    ],
    "stream": [
      9150,
      9165,
      9166,
      9167,
      9176,
      9177,
      9178,
      9179,
      9180
    ]
  },
  "timeline_lookup": [
    [
      1,
      1685
    ],
    [
      2,
      1681
    ],
    [
      5,
      1680
    ]
  ],
  "suggested_topics": [],
  "tags": [],
  "tags_descriptions": {},
  "fancy_title": "Changing public address of (non-coordinator) fdbserver corrupted cluster",
  "id": 2602,
  "title": "Changing public address of (non-coordinator) fdbserver corrupted cluster",
  "posts_count": 9,
  "created_at": "2021-03-12T08:26:07.697Z",
  "views": 1914,
  "reply_count": 5,
  "like_count": 0,
  "last_posted_at": "2021-03-16T23:03:07.029Z",
  "visible": true,
  "closed": false,
  "archived": false,
  "has_summary": false,
  "archetype": "regular",
  "slug": "changing-public-address-of-non-coordinator-fdbserver-corrupted-cluster",
  "category_id": 7,
  "word_count": 2013,
  "deleted_at": null,
  "user_id": 810,
  "featured_link": null,
  "pinned_globally": false,
  "pinned_at": null,
  "pinned_until": null,
  "image_url": null,
  "slow_mode_seconds": 0,
  "draft": null,
  "draft_key": "topic_2602",
  "draft_sequence": null,
  "unpinned": null,
  "pinned": false,
  "current_post_number": 1,
  "highest_post_number": 9,
  "deleted_by": null,
  "actions_summary": [
    {
      "id": 4,
      "count": 0,
      "hidden": false,
      "can_act": false
    },
    {
      "id": 8,
      "count": 0,
      "hidden": false,
      "can_act": false
    },
    {
      "id": 10,
      "count": 0,
      "hidden": false,
      "can_act": false
    },
    {
      "id": 7,
      "count": 0,
      "hidden": false,
      "can_act": false
    }
  ],
  "chunk_size": 20,
  "bookmarked": false,
  "topic_timer": null,
  "message_bus_last_id": 0,
  "participant_count": 3,
  "show_read_indicator": false,
  "thumbnails": null,
  "slow_mode_enabled_until": null,
  "tags_disable_ads": false,
  "related_topics": [
    {
      "fancy_title": "Deployment with custom fdb.cluster file",
      "id": 592,
      "title": "Deployment with custom fdb.cluster file",
      "slug": "deployment-with-custom-fdb-cluster-file",
      "posts_count": 8,
      "reply_count": 4,
      "highest_post_number": 8,
      "image_url": null,
      "created_at": "2018-07-26T23:00:18.994Z",
      "last_posted_at": "2018-07-27T23:44:31.722Z",
      "bumped": true,
      "bumped_at": "2018-07-27T23:44:31.722Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 1,
      "views": 4329,
      "category_id": 7,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": null,
          "description": "Original Poster",
          "user": {
            "id": 311,
            "username": "ThomasJ",
            "name": "Thomas Johson",
            "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/t/6f9a4e/{size}.png",
            "trust_level": 2
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 12,
            "username": "ajbeamon",
            "name": "A.J. Beamon",
            "avatar_template": "/user_avatar/forums.foundationdb.org/ajbeamon/{size}/13_2.png",
            "admin": true,
            "trust_level": 4
          }
        },
        {
          "extras": "latest",
          "description": "Most Recent Poster",
          "user": {
            "id": 13,
            "username": "alexmiller",
            "name": "Alex Miller",
            "avatar_template": "/user_avatar/forums.foundationdb.org/alexmiller/{size}/326_2.png",
            "trust_level": 4
          }
        }
      ]
    },
    {
      "fancy_title": "What&rsquo;s the best procedure for exposing a public port?",
      "id": 622,
      "title": "What's the best procedure for exposing a public port?",
      "slug": "whats-the-best-procedure-for-exposing-a-public-port",
      "posts_count": 4,
      "reply_count": 1,
      "highest_post_number": 4,
      "image_url": null,
      "created_at": "2018-08-09T00:55:37.895Z",
      "last_posted_at": "2018-08-09T19:32:42.175Z",
      "bumped": true,
      "bumped_at": "2018-08-09T19:32:42.175Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 3,
      "views": 1492,
      "category_id": 7,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": null,
          "description": "Original Poster",
          "user": {
            "id": 44,
            "username": "cespare",
            "name": "Caleb Spare",
            "avatar_template": "/user_avatar/forums.foundationdb.org/cespare/{size}/36_2.png",
            "trust_level": 1
          }
        },
        {
          "extras": "latest",
          "description": "Most Recent Poster",
          "user": {
            "id": 12,
            "username": "ajbeamon",
            "name": "A.J. Beamon",
            "avatar_template": "/user_avatar/forums.foundationdb.org/ajbeamon/{size}/13_2.png",
            "admin": true,
            "trust_level": 4
          }
        }
      ]
    },
    {
      "fancy_title": "Fdbserver error in a cluster with double redundancy",
      "id": 2348,
      "title": "Fdbserver error in a cluster with double redundancy",
      "slug": "fdbserver-error-in-a-cluster-with-double-redundancy",
      "posts_count": 3,
      "reply_count": 1,
      "highest_post_number": 3,
      "image_url": null,
      "created_at": "2020-09-20T18:50:42.932Z",
      "last_posted_at": "2020-09-22T07:33:44.911Z",
      "bumped": true,
      "bumped_at": "2020-09-22T11:25:55.307Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 3,
      "views": 859,
      "category_id": 7,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": "latest",
          "description": "Original Poster, Most Recent Poster",
          "user": {
            "id": 714,
            "username": "tuk",
            "name": "",
            "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/t/b5ac83/{size}.png",
            "trust_level": 2
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 14,
            "username": "andrew.noyes",
            "name": "",
            "avatar_template": "/user_avatar/forums.foundationdb.org/andrew.noyes/{size}/443_2.png",
            "trust_level": 2
          }
        }
      ]
    },
    {
      "fancy_title": "Fdb cluster is unavailable after delete a disk",
      "id": 2232,
      "title": "Fdb cluster is unavailable after delete a disk",
      "slug": "fdb-cluster-is-unavailable-after-delete-a-disk",
      "posts_count": 4,
      "reply_count": 1,
      "highest_post_number": 4,
      "image_url": null,
      "created_at": "2020-07-07T09:35:29.720Z",
      "last_posted_at": "2020-07-09T08:38:11.028Z",
      "bumped": true,
      "bumped_at": "2020-07-09T09:28:06.173Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 0,
      "views": 1154,
      "category_id": 7,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": "latest",
          "description": "Original Poster, Most Recent Poster",
          "user": {
            "id": 585,
            "username": "ssb",
            "name": "Shunbo Shi",
            "avatar_template": "/user_avatar/forums.foundationdb.org/ssb/{size}/656_2.png",
            "trust_level": 1
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 166,
            "username": "gaurav",
            "name": "gaurav",
            "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/g/b487fb/{size}.png",
            "trust_level": 3
          }
        }
      ]
    },
    {
      "fancy_title": "Issues with V6.2 TLS Cluster",
      "id": 1904,
      "title": "Issues with V6.2 TLS Cluster",
      "slug": "issues-with-v6-2-tls-cluster",
      "posts_count": 12,
      "reply_count": 8,
      "highest_post_number": 12,
      "image_url": null,
      "created_at": "2020-01-23T17:31:13.342Z",
      "last_posted_at": "2020-01-28T16:35:52.821Z",
      "bumped": true,
      "bumped_at": "2020-01-28T16:35:52.821Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 0,
      "views": 1620,
      "category_id": 7,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": null,
          "description": "Original Poster",
          "user": {
            "id": 643,
            "username": "lehu",
            "name": "Leo Hu",
            "avatar_template": "/user_avatar/forums.foundationdb.org/lehu/{size}/995_2.png",
            "trust_level": 1
          }
        },
        {
          "extras": "latest",
          "description": "Most Recent Poster",
          "user": {
            "id": 12,
            "username": "ajbeamon",
            "name": "A.J. Beamon",
            "avatar_template": "/user_avatar/forums.foundationdb.org/ajbeamon/{size}/13_2.png",
            "admin": true,
            "trust_level": 4
          }
        }
      ]
    }
  ],
  "summarizable": false,
  "can_vote": false,
  "vote_count": 0,
  "user_voted": false,
  "discourse_zendesk_plugin_zendesk_id": null,
  "discourse_zendesk_plugin_zendesk_url": "https://your-url.zendesk.com/agent/tickets/",
  "details": {
    "can_edit": false,
    "notification_level": 1,
    "participants": [
      {
        "id": 810,
        "username": "amanda",
        "name": "Amanda",
        "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/a/67e7ee/{size}.png",
        "post_count": 5,
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_color": null,
        "flair_bg_color": null,
        "flair_group_id": null,
        "trust_level": 2
      },
      {
        "id": 14,
        "username": "andrew.noyes",
        "name": "",
        "avatar_template": "/user_avatar/forums.foundationdb.org/andrew.noyes/{size}/443_2.png",
        "post_count": 3,
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_color": null,
        "flair_bg_color": null,
        "flair_group_id": null,
        "trust_level": 2
      },
      {
        "id": 13,
        "username": "alexmiller",
        "name": "Alex Miller",
        "avatar_template": "/user_avatar/forums.foundationdb.org/alexmiller/{size}/326_2.png",
        "post_count": 1,
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_color": null,
        "flair_bg_color": null,
        "flair_group_id": null,
        "trust_level": 4
      }
    ],
    "created_by": {
      "id": 810,
      "username": "amanda",
      "name": "Amanda",
      "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/a/67e7ee/{size}.png"
    },
    "last_poster": {
      "id": 810,
      "username": "amanda",
      "name": "Amanda",
      "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/a/67e7ee/{size}.png"
    },
    "links": [
      {
        "url": "https://apple.github.io/foundationdb/building-cluster.html#make-foundationdb-externally-accessible",
        "title": "Building a Cluster \u2014 FoundationDB 6.2",
        "internal": false,
        "attachment": false,
        "reflection": false,
        "clicks": 64,
        "user_id": 14,
        "domain": "apple.github.io",
        "root_domain": "apple.github.io"
      },
      {
        "url": "https://apple.github.io/foundationdb/configuration.html#fdbserver-section",
        "title": "Configuration \u2014 FoundationDB 6.2",
        "internal": false,
        "attachment": false,
        "reflection": false,
        "clicks": 10,
        "user_id": 14,
        "domain": "apple.github.io",
        "root_domain": "apple.github.io"
      },
      {
        "url": "https://github.com/apple/foundationdb/blob/df90cc89de67ea4748c8cadd18e6fc4ce7fda12e/fdbclient/AutoPublicAddress.cpp#L31",
        "title": "foundationdb/AutoPublicAddress.cpp at df90cc89de67ea4748c8cadd18e6fc4ce7fda12e \u00b7 apple/foundationdb \u00b7 GitHub",
        "internal": false,
        "attachment": false,
        "reflection": false,
        "clicks": 6,
        "user_id": 14,
        "domain": "github.com",
        "root_domain": "github.com"
      },
      {
        "url": "https://github.com/apple/foundationdb/blob/master/documentation/sphinx/source/read-write-path.rst",
        "title": "foundationdb/read-write-path.rst at master \u00b7 apple/foundationdb \u00b7 GitHub",
        "internal": false,
        "attachment": false,
        "reflection": false,
        "clicks": 4,
        "user_id": 810,
        "domain": "github.com",
        "root_domain": "github.com"
      },
      {
        "url": "https://forums.foundationdb.org/t/fdbserver-error-in-a-cluster-with-double-redundancy/2348",
        "title": "Fdbserver error in a cluster with double redundancy",
        "internal": true,
        "attachment": false,
        "reflection": false,
        "clicks": 2,
        "user_id": 810,
        "domain": "forums.foundationdb.org",
        "root_domain": "foundationdb.org"
      },
      {
        "url": "https://github.com/apple/foundationdb/blob/master/fdbserver/storageserver.actor.cpp#L3401",
        "title": "foundationdb/storageserver.actor.cpp at master \u00b7 apple/foundationdb \u00b7 GitHub",
        "internal": false,
        "attachment": false,
        "reflection": false,
        "clicks": 1,
        "user_id": 810,
        "domain": "github.com",
        "root_domain": "github.com"
      }
    ]
  },
  "bookmarks": []
}