{
  "post_stream": {
    "posts": [
      {
        "id": 9563,
        "name": "Eugeniu",
        "username": "EugeniuZ",
        "avatar_template": "/user_avatar/forums.foundationdb.org/eugeniuz/{size}/1106_2.png",
        "created_at": "2021-06-13T18:11:24.660Z",
        "cooked": "<p>Hi,</p>\n<p>We are deploying a FoundationDB cluster on AWS. Due to a recent outage we have to recreate our cluster. FDB is used a storage of key-value pairs with a Redis Cluster in front serving as a cache. Whenever the Redis Cluster reaches a memory utilization limit we dump some of the older keys into FDB to free up space. We also retrieve the keys from FDB if requested and key is missing in the cache.</p>\n<p>We had used a kind of default (lazy) setup (process classes were not set explicitly) and it worked well for the normal case.<br>\nHowever now I\u2019m facing issues when trying to bulk load the data from a Redis Cluster (I\u2019ve recreated all the keys in a larger cluster ~ 780M keys). The issue that I discovered is the disk saturation on all servers (tlog and storage classes are combined into a single process)</p>\n<p>Here I\u2019d like to ask for advice on how the setup for initial bulk load of data should differ from a regular setup (where reads/writes are equally likely and at a much lower rate).</p>\n<p>One simple improvement is setting the redundancy setting to \u2018single\u2019 (during bulk load the cluster constantly enters the \u201cHealthy (Repartitioning)\u201d state with triple redundancy setting).</p>\n<p>I\u2019ve read that increasing the tlog processes (alongside disks and cpu cores) could help although didn\u2019t really understood why.</p>\n<p>Any other advice you could suggest for the initial write-intensive setup?</p>\n<p>My goal is to achieve write throughput above 20K/s. The key-value pairs are written in a transaction (4096 pairs per transaction).</p>",
        "post_number": 1,
        "post_type": 1,
        "posts_count": 3,
        "updated_at": "2021-06-13T18:11:24.660Z",
        "reply_count": 0,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 228,
        "reads": 43,
        "readers_count": 42,
        "score": 1153.6,
        "yours": false,
        "topic_id": 2752,
        "topic_slug": "process-classes-initial-vs-production-setup",
        "display_username": "Eugeniu",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "bookmarked": false,
        "actions_summary": [
          {
            "id": 2,
            "count": 1
          }
        ],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 950,
        "hidden": false,
        "trust_level": 1,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/process-classes-initial-vs-production-setup/2752/1",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null,
        "can_vote": false
      },
      {
        "id": 9566,
        "name": "Bhaskar Muppana",
        "username": "mbhaskar",
        "avatar_template": "/user_avatar/forums.foundationdb.org/mbhaskar/{size}/277_2.png",
        "created_at": "2021-06-14T03:30:10.486Z",
        "cooked": "<p>To begin with, FDB is not best known for its bulk loading capabilities. I think, it mainly boils down to two reasons</p>\n<ul>\n<li>Every write has to go through transaction subsystem. No way to write directly to storage servers even when you don\u2019t care about ACID properties</li>\n<li>\n<code>SLQLite</code> storage engine is very sequential in its disk IO. Even if you are running on storage like NVMe or EBS, which gives you high IOPS, it would not do more than 2 to 5 disk I/O in parallel. Community is trying to address this with RocksDB and RedWood storage engines.</li>\n</ul>\n<p>Having said that, there are ways to get the best out of current configuration. Couple of things worked for us in the past. I am sure there are other tricks I am not aware of</p>\n<ul>\n<li>Reduced replication\n<ul>\n<li>As you mentioned single replication would help, but probably not worth the risk. Before you get to change the replication back to desired, if you loose a disk, you have to reload all of your data. I think <strong>double replication</strong> is good compromise.</li>\n</ul>\n</li>\n<li>Transaction size\n<ul>\n<li>Not sure what is your key/value size. FDB maximum transaction size is 10MB. Although having larger transactions are good way to get bandwidth, in my experience having too big would makes things worse. In the past, I managed to get sweet spot between 512KB to 1MB transaction sizes.</li>\n</ul>\n</li>\n<li>Conflict ranges\n<ul>\n<li>If you are doing too many sets in your transaction, by default FDB creates a range for each set. Instead, I suggest setting conflict ranges manually for each transaction to one range (or as few as you can). That reduces serialization work and conflict resolution.</li>\n</ul>\n</li>\n<li>Memory Storage engine\n<ul>\n<li>Depending on your working set size, you could consider memory storage engine. It gives you at least 3x bandwidth compared to <code>SQLLite</code> and yet persists your data. You can later convert the storage engine</li>\n</ul>\n</li>\n<li>Run more servers\n<ul>\n<li>As explained above FDB can not utilize disk IOPS very well. So, TLog and storage server disk throughput is bound by disk latency. I suggest running more servers. For example, instead of using 1 server for 1TB EBS disk, run two storage servers at 512GB each. If you are running on local disk, run multiple servers on same disk.</li>\n<li>NOTE: You have to be careful not scaling the cluster too big, too many storage servers increases work for tlogs. Too many tlogs increase work for proxies. I suggest keep playing with different sizes.</li>\n</ul>\n</li>\n<li>Disable Backup\n<ul>\n<li>Disable FDB backup if you are using it, temporarily during your initial bulk load. As FDB does dual writes to preserve mutation logs, your write bandwidth would double if you disable backup.</li>\n</ul>\n</li>\n</ul>",
        "post_number": 2,
        "post_type": 1,
        "posts_count": 3,
        "updated_at": "2021-06-14T03:36:17.462Z",
        "reply_count": 0,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 26,
        "reads": 42,
        "readers_count": 41,
        "score": 168.4,
        "yours": false,
        "topic_id": 2752,
        "topic_slug": "process-classes-initial-vs-production-setup",
        "display_username": "Bhaskar Muppana",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 2,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "bookmarked": false,
        "actions_summary": [
          {
            "id": 2,
            "count": 2
          }
        ],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 9,
        "hidden": false,
        "trust_level": 4,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/process-classes-initial-vs-production-setup/2752/2",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 9573,
        "name": "Eugeniu",
        "username": "EugeniuZ",
        "avatar_template": "/user_avatar/forums.foundationdb.org/eugeniuz/{size}/1106_2.png",
        "created_at": "2021-06-14T14:45:46.543Z",
        "cooked": "<p>Thanks for the detailed answer <a class=\"mention\" href=\"/u/mbhaskar\">@mbhaskar</a></p>\n<p>Our transaction size is definitely under 2MB as each item is well below 512B range. Not sure what you mean by \u201cconflict ranges\u201d but during the initial load in our case each key is updated exactly once.</p>\n<p>I\u2019ve tried re-running the load test (on 9 fdb servers) with 3 storage + 6 tlog and 3 tlog + 6 storage nodes. Write performance is about 16K keys per second in each case. If however I have a server with storage + tlog using same disk performance degrades (from 16K to 10K and probably lower, didn\u2019t run it for too long). Also replication factor slows down things due to repartitioning while the test is being run.</p>",
        "post_number": 3,
        "post_type": 1,
        "posts_count": 3,
        "updated_at": "2021-06-14T14:45:46.543Z",
        "reply_count": 0,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 0,
        "reads": 39,
        "readers_count": 38,
        "score": 7.8,
        "yours": false,
        "topic_id": 2752,
        "topic_slug": "process-classes-initial-vs-production-setup",
        "display_username": "Eugeniu",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 950,
        "hidden": false,
        "trust_level": 1,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/process-classes-initial-vs-production-setup/2752/3",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      }
    ],
    "stream": [
      9563,
      9566,
      9573
    ]
  },
  "timeline_lookup": [
    [
      1,
      1591
    ],
    [
      3,
      1590
    ]
  ],
  "suggested_topics": [],
  "tags": [
    "performance"
  ],
  "tags_descriptions": {},
  "fancy_title": "Process Classes: Initial vs Production Setup",
  "id": 2752,
  "title": "Process Classes: Initial vs Production Setup",
  "posts_count": 3,
  "created_at": "2021-06-13T18:11:24.573Z",
  "views": 1111,
  "reply_count": 0,
  "like_count": 3,
  "last_posted_at": "2021-06-14T14:45:46.543Z",
  "visible": true,
  "closed": false,
  "archived": false,
  "has_summary": false,
  "archetype": "regular",
  "slug": "process-classes-initial-vs-production-setup",
  "category_id": 17,
  "word_count": 832,
  "deleted_at": null,
  "user_id": 950,
  "featured_link": null,
  "pinned_globally": false,
  "pinned_at": null,
  "pinned_until": null,
  "image_url": null,
  "slow_mode_seconds": 0,
  "draft": null,
  "draft_key": "topic_2752",
  "draft_sequence": null,
  "unpinned": null,
  "pinned": false,
  "current_post_number": 1,
  "highest_post_number": 3,
  "deleted_by": null,
  "actions_summary": [
    {
      "id": 4,
      "count": 0,
      "hidden": false,
      "can_act": false
    },
    {
      "id": 8,
      "count": 0,
      "hidden": false,
      "can_act": false
    },
    {
      "id": 10,
      "count": 0,
      "hidden": false,
      "can_act": false
    },
    {
      "id": 7,
      "count": 0,
      "hidden": false,
      "can_act": false
    }
  ],
  "chunk_size": 20,
  "bookmarked": false,
  "topic_timer": null,
  "message_bus_last_id": 0,
  "participant_count": 2,
  "show_read_indicator": false,
  "thumbnails": null,
  "slow_mode_enabled_until": null,
  "tags_disable_ads": false,
  "related_topics": [
    {
      "fancy_title": "Best practices for bulk load",
      "id": 422,
      "title": "Best practices for bulk load",
      "slug": "best-practices-for-bulk-load",
      "posts_count": 8,
      "reply_count": 6,
      "highest_post_number": 8,
      "image_url": null,
      "created_at": "2018-05-16T17:25:44.677Z",
      "last_posted_at": "2018-05-25T16:09:06.204Z",
      "bumped": true,
      "bumped_at": "2018-05-25T16:09:06.204Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 5,
      "views": 4449,
      "category_id": 7,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": "latest",
          "description": "Original Poster, Most Recent Poster",
          "user": {
            "id": 211,
            "username": "brk0v",
            "name": "Viacheslav Biriukov",
            "avatar_template": "/user_avatar/forums.foundationdb.org/brk0v/{size}/173_2.png",
            "trust_level": 1
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 81,
            "username": "ryanworl",
            "name": "Ryan Worl",
            "avatar_template": "/user_avatar/forums.foundationdb.org/ryanworl/{size}/440_2.png",
            "trust_level": 3
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 230,
            "username": "umpc",
            "name": "Justin Lowery",
            "avatar_template": "/user_avatar/forums.foundationdb.org/umpc/{size}/203_2.png",
            "trust_level": 2
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 53,
            "username": "KrzysFR",
            "name": "Christophe Chevalier",
            "avatar_template": "/user_avatar/forums.foundationdb.org/krzysfr/{size}/43_2.png",
            "trust_level": 2
          }
        }
      ]
    },
    {
      "fancy_title": "Storage queue limiting performance when initially loading data",
      "id": 1135,
      "title": "Storage queue limiting performance when initially loading data",
      "slug": "storage-queue-limiting-performance-when-initially-loading-data",
      "posts_count": 11,
      "reply_count": 6,
      "highest_post_number": 11,
      "image_url": null,
      "created_at": "2019-02-13T10:07:40.715Z",
      "last_posted_at": "2019-10-14T16:11:25.098Z",
      "bumped": true,
      "bumped_at": "2019-10-14T16:11:25.098Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 7,
      "views": 2780,
      "category_id": 7,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": null,
          "description": "Original Poster",
          "user": {
            "id": 509,
            "username": "qlees",
            "name": "",
            "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/q/ba8739/{size}.png",
            "trust_level": 1
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 476,
            "username": "dch",
            "name": "Dave Cottlehuber",
            "avatar_template": "/user_avatar/forums.foundationdb.org/dch/{size}/473_2.png",
            "trust_level": 2
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 663,
            "username": "atul",
            "name": "Atul Gupta",
            "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/a/f14d63/{size}.png",
            "trust_level": 1
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 81,
            "username": "ryanworl",
            "name": "Ryan Worl",
            "avatar_template": "/user_avatar/forums.foundationdb.org/ryanworl/{size}/440_2.png",
            "trust_level": 3
          }
        },
        {
          "extras": "latest",
          "description": "Most Recent Poster",
          "user": {
            "id": 7,
            "username": "SteavedHams",
            "name": "Steve Atherton",
            "avatar_template": "/user_avatar/forums.foundationdb.org/steavedhams/{size}/18_2.png",
            "trust_level": 4
          }
        }
      ]
    },
    {
      "fancy_title": "Bulk insert 2 billion records",
      "id": 1253,
      "title": "Bulk insert 2 billion records",
      "slug": "bulk-insert-2-billion-records",
      "posts_count": 2,
      "reply_count": 0,
      "highest_post_number": 2,
      "image_url": null,
      "created_at": "2019-03-24T10:38:17.344Z",
      "last_posted_at": "2019-03-25T08:43:22.672Z",
      "bumped": true,
      "bumped_at": "2019-03-25T08:43:22.672Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 2,
      "views": 1306,
      "category_id": 7,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": "latest single",
          "description": "Original Poster, Most Recent Poster",
          "user": {
            "id": 419,
            "username": "doublemax",
            "name": "",
            "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/d/8e7dd6/{size}.png",
            "trust_level": 2
          }
        }
      ]
    },
    {
      "fancy_title": "Production optimizations",
      "id": 601,
      "title": "Production optimizations",
      "slug": "production-optimizations",
      "posts_count": 21,
      "reply_count": 14,
      "highest_post_number": 21,
      "image_url": null,
      "created_at": "2018-07-30T21:18:56.894Z",
      "last_posted_at": "2018-08-15T04:47:23.743Z",
      "bumped": true,
      "bumped_at": "2018-08-15T04:47:23.743Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 6,
      "views": 6473,
      "category_id": 7,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": "latest",
          "description": "Original Poster, Most Recent Poster",
          "user": {
            "id": 311,
            "username": "ThomasJ",
            "name": "Thomas Johson",
            "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/t/6f9a4e/{size}.png",
            "trust_level": 2
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 81,
            "username": "ryanworl",
            "name": "Ryan Worl",
            "avatar_template": "/user_avatar/forums.foundationdb.org/ryanworl/{size}/440_2.png",
            "trust_level": 3
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 13,
            "username": "alexmiller",
            "name": "Alex Miller",
            "avatar_template": "/user_avatar/forums.foundationdb.org/alexmiller/{size}/326_2.png",
            "trust_level": 4
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 255,
            "username": "aqua",
            "name": "Matt Lohier",
            "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/a/b9bd4f/{size}.png",
            "trust_level": 1
          }
        }
      ]
    },
    {
      "fancy_title": "Some Clarification on Storage Engine and Disk/IO",
      "id": 1453,
      "title": "Some Clarification on Storage Engine and Disk/IO",
      "slug": "some-clarification-on-storage-engine-and-disk-io",
      "posts_count": 13,
      "reply_count": 8,
      "highest_post_number": 13,
      "image_url": null,
      "created_at": "2019-06-13T18:18:46.358Z",
      "last_posted_at": "2019-07-23T06:20:18.977Z",
      "bumped": true,
      "bumped_at": "2019-07-23T06:20:18.977Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 2,
      "views": 2341,
      "category_id": 7,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": null,
          "description": "Original Poster",
          "user": {
            "id": 594,
            "username": "zhuyi29",
            "name": "Zoe",
            "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/z/edb3f5/{size}.png",
            "trust_level": 1
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 12,
            "username": "ajbeamon",
            "name": "A.J. Beamon",
            "avatar_template": "/user_avatar/forums.foundationdb.org/ajbeamon/{size}/13_2.png",
            "admin": true,
            "trust_level": 4
          }
        },
        {
          "extras": "latest",
          "description": "Most Recent Poster",
          "user": {
            "id": 337,
            "username": "mengxu",
            "name": "Meng Xu",
            "avatar_template": "/user_avatar/forums.foundationdb.org/mengxu/{size}/893_2.png",
            "trust_level": 2
          }
        }
      ]
    }
  ],
  "summarizable": false,
  "can_vote": false,
  "vote_count": 0,
  "user_voted": false,
  "discourse_zendesk_plugin_zendesk_id": null,
  "discourse_zendesk_plugin_zendesk_url": "https://your-url.zendesk.com/agent/tickets/",
  "details": {
    "can_edit": false,
    "notification_level": 1,
    "participants": [
      {
        "id": 950,
        "username": "EugeniuZ",
        "name": "Eugeniu",
        "avatar_template": "/user_avatar/forums.foundationdb.org/eugeniuz/{size}/1106_2.png",
        "post_count": 2,
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_color": null,
        "flair_bg_color": null,
        "flair_group_id": null,
        "trust_level": 1
      },
      {
        "id": 9,
        "username": "mbhaskar",
        "name": "Bhaskar Muppana",
        "avatar_template": "/user_avatar/forums.foundationdb.org/mbhaskar/{size}/277_2.png",
        "post_count": 1,
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_color": null,
        "flair_bg_color": null,
        "flair_group_id": null,
        "trust_level": 4
      }
    ],
    "created_by": {
      "id": 950,
      "username": "EugeniuZ",
      "name": "Eugeniu",
      "avatar_template": "/user_avatar/forums.foundationdb.org/eugeniuz/{size}/1106_2.png"
    },
    "last_poster": {
      "id": 950,
      "username": "EugeniuZ",
      "name": "Eugeniu",
      "avatar_template": "/user_avatar/forums.foundationdb.org/eugeniuz/{size}/1106_2.png"
    }
  },
  "bookmarks": []
}