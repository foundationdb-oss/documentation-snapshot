{
  "post_stream": {
    "posts": [
      {
        "id": 2076,
        "name": "Clement Pang",
        "username": "panghy",
        "avatar_template": "/user_avatar/forums.foundationdb.org/panghy/{size}/19_2.png",
        "created_at": "2018-09-12T08:05:48.776Z",
        "cooked": "<p>This is something we see in 5.2.x where it\u2019s possible for a cluster\u2019s tlogs to overcommit and go into a state where it cannot recover from:</p>\n<p>10.42.2.48:4655        (  4% cpu;  4% machine; 0.037 Gbps;  0% disk IO; 5.2 GB / 14.0 GB RAM  )<br>\nLast logged error: KeyValueStoreMemory_OutOfSpace at Wed Sep 12 07:41:30 2018</p>\n<p>This is a dedicated transaction process and it\u2019s seemingly able to write more than it should and go into a bad state.</p>",
        "post_number": 1,
        "post_type": 1,
        "posts_count": 21,
        "updated_at": "2018-09-12T08:05:48.776Z",
        "reply_count": 0,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 114,
        "reads": 61,
        "readers_count": 60,
        "score": 582.2,
        "yours": false,
        "topic_id": 695,
        "topic_slug": "how-to-prevent-tlogs-from-overcommitting",
        "display_username": "Clement Pang",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "link_counts": [
          {
            "url": "https://forums.foundationdb.org/t/migrating-from-a-large-cluster-to-another/721/3",
            "internal": true,
            "reflection": true,
            "title": "Migrating from a large cluster to another",
            "clicks": 0
          }
        ],
        "read": true,
        "user_title": "",
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 38,
        "hidden": false,
        "trust_level": 2,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/how-to-prevent-tlogs-from-overcommitting/695/1",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null,
        "can_vote": false
      },
      {
        "id": 2085,
        "name": "A.J. Beamon",
        "username": "ajbeamon",
        "avatar_template": "/user_avatar/forums.foundationdb.org/ajbeamon/{size}/13_2.png",
        "created_at": "2018-09-12T22:43:52.591Z",
        "cooked": "<p>Ratekeeper is supposed to be helping with this, and probably did attempt to stop allowing normal priority transactions. If so, that would mean that either immediate priority transactions consumed the rest of the space or enough regular transactions were still allowed to leak through ratekeeper. Assuming you weren\u2019t running immediate priority transactions yourself, this is probably worth filing a GitHub issue for.</p>",
        "post_number": 2,
        "post_type": 1,
        "posts_count": 21,
        "updated_at": "2018-09-12T22:43:52.591Z",
        "reply_count": 0,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 2,
        "reads": 60,
        "readers_count": 59,
        "score": 22.0,
        "yours": false,
        "topic_id": 695,
        "topic_slug": "how-to-prevent-tlogs-from-overcommitting",
        "display_username": "A.J. Beamon",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": true,
        "staff": true,
        "user_id": 12,
        "hidden": false,
        "trust_level": 4,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/how-to-prevent-tlogs-from-overcommitting/695/2",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 2086,
        "name": "Alex Miller",
        "username": "alexmiller",
        "avatar_template": "/user_avatar/forums.foundationdb.org/alexmiller/{size}/326_2.png",
        "created_at": "2018-09-12T23:39:22.303Z",
        "cooked": "<p>By running with the memory storage engine, your TLogs are also using the memory storage engine to spill data out of the disk queue.  The error that you\u2019ve pasted is from this memory storage engine that\u2019s being used to hold spilled data filling up in memory.</p>\n<p>I\u2019ve filed <a href=\"https://github.com/apple/foundationdb/issues/768\" rel=\"nofollow noopener\"> <code>configure memory</code> configures the TLog to spill to memory #768</a> and <a href=\"https://github.com/apple/foundationdb/issues/769\" rel=\"nofollow noopener\">Ratekeeper isn\u2019t throttling when a TLog\u2019s MemoryKeyValueStore is nearly full #769</a> about this.</p>\n<p>To get out of this situation, you\u2019ll need to temporarily feed your TLogs more RAM, via increasing their <code>--storage_memory=</code> flag value, so that your cluster can recover.  Once your cluster has recovered, you can <code>configure log_storage:=2</code> to have the TLogs use the <code>ssd2</code> storage engine.</p>",
        "post_number": 3,
        "post_type": 1,
        "posts_count": 21,
        "updated_at": "2018-09-12T23:39:22.303Z",
        "reply_count": 1,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 1,
        "reads": 58,
        "readers_count": 57,
        "score": 21.6,
        "yours": false,
        "topic_id": 695,
        "topic_slug": "how-to-prevent-tlogs-from-overcommitting",
        "display_username": "Alex Miller",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "link_counts": [
          {
            "url": "https://github.com/apple/foundationdb/issues/769",
            "internal": false,
            "reflection": false,
            "title": "Ratekeeper isn't throttling when a TLog's MemoryKeyValueStore is nearly full \u00b7 Issue #769 \u00b7 apple/foundationdb \u00b7 GitHub",
            "clicks": 10
          },
          {
            "url": "https://github.com/apple/foundationdb/issues/768",
            "internal": false,
            "reflection": false,
            "title": "`configure memory` configures the TLog to spill to memory \u00b7 Issue #768 \u00b7 apple/foundationdb \u00b7 GitHub",
            "clicks": 10
          }
        ],
        "read": true,
        "user_title": null,
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 13,
        "hidden": false,
        "trust_level": 4,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/how-to-prevent-tlogs-from-overcommitting/695/3",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 2091,
        "name": "Clement Pang",
        "username": "panghy",
        "avatar_template": "/user_avatar/forums.foundationdb.org/panghy/{size}/19_2.png",
        "created_at": "2018-09-13T05:10:26.455Z",
        "cooked": "<p>Yeah, that\u2019s SOP for us with 3.x (changing storage_memory). Just thought maybe it could have changed. In the past, it doesn\u2019t have an error message, we just detect that the files are getting too big.</p>\n<p>I did not know there is a configure log_storage option, I assume that\u2019s a 5.x thing. We will probably need to understand the performance implications of running tlogs with ssd instead of memory (as AJ commented on the issue).</p>",
        "post_number": 4,
        "post_type": 1,
        "posts_count": 21,
        "updated_at": "2018-09-13T05:10:26.455Z",
        "reply_count": 0,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 0,
        "reads": 57,
        "readers_count": 56,
        "score": 11.4,
        "yours": false,
        "topic_id": 695,
        "topic_slug": "how-to-prevent-tlogs-from-overcommitting",
        "display_username": "Clement Pang",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": "",
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 38,
        "hidden": false,
        "trust_level": 2,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/how-to-prevent-tlogs-from-overcommitting/695/4",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 2092,
        "name": "Clement Pang",
        "username": "panghy",
        "avatar_template": "/user_avatar/forums.foundationdb.org/panghy/{size}/19_2.png",
        "created_at": "2018-09-13T05:12:12.376Z",
        "cooked": "<p>Oh, and we do not have system immediate transactions against the cluster. This is a pretty common thing in 3.x during recovery when writes are still being attempted against it (at normal priority).</p>",
        "post_number": 5,
        "post_type": 1,
        "posts_count": 21,
        "updated_at": "2018-09-13T05:12:12.376Z",
        "reply_count": 0,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 0,
        "reads": 54,
        "readers_count": 53,
        "score": 10.8,
        "yours": false,
        "topic_id": 695,
        "topic_slug": "how-to-prevent-tlogs-from-overcommitting",
        "display_username": "Clement Pang",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": "",
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 38,
        "hidden": false,
        "trust_level": 2,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/how-to-prevent-tlogs-from-overcommitting/695/5",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 2094,
        "name": "A.J. Beamon",
        "username": "ajbeamon",
        "avatar_template": "/user_avatar/forums.foundationdb.org/ajbeamon/{size}/13_2.png",
        "created_at": "2018-09-13T05:43:21.554Z",
        "cooked": "<p>This problem may not be specific to the memory storage engine, though given the relative sizes of memory and disk it\u2019s probably more likely to be seen in the memory storage engine. If ratekeeper is leaking transactions when the log\u2019s persistent data store is full, then in the ssd engine we\u2019d probably just end up filling the disk all the way. That poses its own difficulties, because unlike the memory storage engine where you might be able to configure the process\u2019s storage memory higher, when the disk is full you may need to either find something to delete from the disk or move the files to a larger disk.</p>",
        "post_number": 6,
        "post_type": 1,
        "posts_count": 21,
        "updated_at": "2018-09-13T05:44:58.654Z",
        "reply_count": 0,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 0,
        "reads": 49,
        "readers_count": 48,
        "score": 9.8,
        "yours": false,
        "topic_id": 695,
        "topic_slug": "how-to-prevent-tlogs-from-overcommitting",
        "display_username": "A.J. Beamon",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": true,
        "staff": true,
        "user_id": 12,
        "hidden": false,
        "trust_level": 4,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/how-to-prevent-tlogs-from-overcommitting/695/6",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 2110,
        "name": "Clement Pang",
        "username": "panghy",
        "avatar_template": "/user_avatar/forums.foundationdb.org/panghy/{size}/19_2.png",
        "created_at": "2018-09-15T05:44:51.149Z",
        "cooked": "<p>I am trying see in the code how the configure log_storage:=2 command works, it doesn\u2019t seem to do what I would expect IO-wise against the drive after applying the change. Since we have dedicated volumes for our tlogs. It\u2019s still doing pure writes against the volume (which is a MemoryKeyValueStore behavior) and the operating space for log servers still show basically what the storage_memory flag value is (unlike on ssd clusters where it shows the amount of disk space left).</p>",
        "post_number": 7,
        "post_type": 1,
        "posts_count": 21,
        "updated_at": "2018-09-15T05:44:51.149Z",
        "reply_count": 0,
        "reply_to_post_number": 3,
        "quote_count": 0,
        "incoming_link_count": 0,
        "reads": 46,
        "readers_count": 45,
        "score": 9.2,
        "yours": false,
        "topic_id": 695,
        "topic_slug": "how-to-prevent-tlogs-from-overcommitting",
        "display_username": "Clement Pang",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": "",
        "reply_to_user": {
          "id": 13,
          "username": "alexmiller",
          "name": "Alex Miller",
          "avatar_template": "/user_avatar/forums.foundationdb.org/alexmiller/{size}/326_2.png"
        },
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 38,
        "hidden": false,
        "trust_level": 2,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/how-to-prevent-tlogs-from-overcommitting/695/7",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 2111,
        "name": "Clement Pang",
        "username": "panghy",
        "avatar_template": "/user_avatar/forums.foundationdb.org/panghy/{size}/19_2.png",
        "created_at": "2018-09-15T06:33:51.254Z",
        "cooked": "<p>In fact, with configure log_storage:=2, it seems like we can get tlogs to run out of space almost immediately (on a brand-new cluster that we configured as memory and then applied the command).</p>",
        "post_number": 8,
        "post_type": 1,
        "posts_count": 21,
        "updated_at": "2018-09-15T06:33:51.254Z",
        "reply_count": 0,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 1,
        "reads": 43,
        "readers_count": 42,
        "score": 13.6,
        "yours": false,
        "topic_id": 695,
        "topic_slug": "how-to-prevent-tlogs-from-overcommitting",
        "display_username": "Clement Pang",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": "",
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 38,
        "hidden": false,
        "trust_level": 2,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/how-to-prevent-tlogs-from-overcommitting/695/8",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 2112,
        "name": "Clement Pang",
        "username": "panghy",
        "avatar_template": "/user_avatar/forums.foundationdb.org/panghy/{size}/19_2.png",
        "created_at": "2018-09-15T06:54:53.034Z",
        "cooked": "<p>Hm, maybe it\u2019s got nothing to do with log_storage:=2. The moment we stood up a large cluster (with logs/proxies/resolvers configured but without log_storage:=2 in another test) and start blasting it with test traffic, the cluster locks up immediately, fdbcli said CC is unresponsive, goes into reinit, unresponsive, reinit, at the same time log storage space drops (from what we configure at 6G to 0G) and then the cluster dies with \u201cInitializing new transaction servers\u2026\u201d which it\u2019ll never be able to do because the tlogs are already overcommitted. It seems like RK should be clamping down since it needs to redistribute the shards with a sudden onslaught of traffic but it isn\u2019t.</p>",
        "post_number": 9,
        "post_type": 1,
        "posts_count": 21,
        "updated_at": "2018-09-15T06:55:44.986Z",
        "reply_count": 0,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 0,
        "reads": 41,
        "readers_count": 40,
        "score": 8.2,
        "yours": false,
        "topic_id": 695,
        "topic_slug": "how-to-prevent-tlogs-from-overcommitting",
        "display_username": "Clement Pang",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": "",
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 38,
        "hidden": false,
        "trust_level": 2,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/how-to-prevent-tlogs-from-overcommitting/695/9",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 2132,
        "name": "Clement Pang",
        "username": "panghy",
        "avatar_template": "/user_avatar/forums.foundationdb.org/panghy/{size}/19_2.png",
        "created_at": "2018-09-19T08:42:37.230Z",
        "cooked": "<p><a class=\"mention\" href=\"/u/ajbeamon\">@ajbeamon</a> is it possible that the fix I made to the memory storage engine on reporting operating space isn\u2019t doing the right thing for RK still?</p>",
        "post_number": 10,
        "post_type": 1,
        "posts_count": 21,
        "updated_at": "2018-09-19T08:42:37.230Z",
        "reply_count": 1,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 1,
        "reads": 40,
        "readers_count": 39,
        "score": 18.0,
        "yours": false,
        "topic_id": 695,
        "topic_slug": "how-to-prevent-tlogs-from-overcommitting",
        "display_username": "Clement Pang",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": "",
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 38,
        "hidden": false,
        "trust_level": 2,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/how-to-prevent-tlogs-from-overcommitting/695/10",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 2133,
        "name": "A.J. Beamon",
        "username": "ajbeamon",
        "avatar_template": "/user_avatar/forums.foundationdb.org/ajbeamon/{size}/13_2.png",
        "created_at": "2018-09-19T15:35:43.836Z",
        "cooked": "<p>You\u2019re referring to <a href=\"https://github.com/apple/foundationdb/pull/41/files\">this one</a>, correct? I don\u2019t spot any obvious problems with it, though if it is somehow failing to report the correct number for available space, it could certainly cause ratekeeper to do the wrong thing. One way we could get a better sense for what\u2019s happening is to look at the RkUpdate trace log events leading up to the point where the cluster locked up. They will indicate whether ratekeeper was trying to restrict transactions and the reason it was doing so. It also reports the worst free space on both storage and log servers, so we can see if there is a problem with the numbers coming back.</p>\n<p>A related interesting thing I just noticed is this line:</p>\n<aside class=\"onebox githubblob\">\n  <header class=\"source\">\n      <a href=\"https://github.com/apple/foundationdb/blob/4d3950903474e2a56f764c36f8159b77740279a2/fdbserver/KeyValueStoreMemory.actor.cpp#L142\" target=\"_blank\">github.com</a>\n  </header>\n  <article class=\"onebox-body\">\n    <h4><a href=\"https://github.com/apple/foundationdb/blob/4d3950903474e2a56f764c36f8159b77740279a2/fdbserver/KeyValueStoreMemory.actor.cpp#L142\" target=\"_blank\">apple/foundationdb/blob/4d3950903474e2a56f764c36f8159b77740279a2/fdbserver/KeyValueStoreMemory.actor.cpp#L142</a></h4>\n<pre class=\"onebox\"><code class=\"lang-cpp\"><ol class=\"start lines\" start=\"132\" style=\"counter-reset: li-counter 131 ;\">\n<li>\t\telse {</li>\n<li>\t\t\tqueue.clear(range, arena);</li>\n<li>\t\t\tif(recovering.isReady() &amp;&amp; !disableSnapshot) {</li>\n<li>\t\t\t\tsemiCommit();</li>\n<li>\t\t\t}</li>\n<li>\t\t}</li>\n<li>\t}</li>\n<li>\n</li>\n<li>\tvirtual Future&lt;Void&gt; commit(bool sequential) {</li>\n<li>\t\tif(getAvailableSize() &lt;= 0) {</li>\n<li class=\"selected\">\t\t\tif(g_network-&gt;isSimulated()) { //FIXME: known bug in simulation we are supressing</li>\n<li>\t\t\t\tint unseed = noUnseed ? 0 : g_random-&gt;randomInt(0, 100001);</li>\n<li>\t\t\t\tTraceEvent(SevWarnAlways, \"KeyValueStoreMemory_OutOfSpace\", id);</li>\n<li>\t\t\t\tTraceEvent(\"ElapsedTime\").detail(\"SimTime\", now()).detail(\"RealTime\", 0)</li>\n<li>\t\t\t\t\t.detail(\"RandomUnseed\", unseed);</li>\n<li>\t\t\t\tflushAndExit(0);</li>\n<li>\t\t\t}</li>\n<li>\t\t\tTraceEvent(SevError, \"KeyValueStoreMemory_OutOfSpace\", id);</li>\n<li>\t\t\treturn Never();</li>\n<li>\t\t}</li>\n<li>\n</li>\n</ol></code></pre>\n\n\n  </article>\n  <div class=\"onebox-metadata\">\n    \n    \n  </div>\n  <div style=\"clear: both\"></div>\n</aside>\n\n<p>It seems that we\u2019re intentionally ignoring cases where we exhaust all memory storage engine space in simulation, so it\u2019s not too surprising that there are ways we could end up here. I\u2019m not sure if there\u2019s a legitimate reason for this (e.g. that some tests are using immediate priority transactions) or if perhaps it was determined too difficult to stop ratekeeper from leaking, but we may want to take a second look at whether we want simulation to be ignoring this scenario.</p>",
        "post_number": 11,
        "post_type": 1,
        "posts_count": 21,
        "updated_at": "2018-09-19T15:35:43.836Z",
        "reply_count": 0,
        "reply_to_post_number": 10,
        "quote_count": 0,
        "incoming_link_count": 0,
        "reads": 42,
        "readers_count": 41,
        "score": 8.4,
        "yours": false,
        "topic_id": 695,
        "topic_slug": "how-to-prevent-tlogs-from-overcommitting",
        "display_username": "A.J. Beamon",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "link_counts": [
          {
            "url": "https://github.com/apple/foundationdb/pull/41/files",
            "internal": false,
            "reflection": false,
            "title": "Available space should take into account both memory and disk by panghy \u00b7 Pull Request #41 \u00b7 apple/foundationdb \u00b7 GitHub",
            "clicks": 1
          },
          {
            "url": "https://github.com/apple/foundationdb/blob/4d3950903474e2a56f764c36f8159b77740279a2/fdbserver/KeyValueStoreMemory.actor.cpp#L142",
            "internal": false,
            "reflection": false,
            "title": "foundationdb/KeyValueStoreMemory.actor.cpp at 4d3950903474e2a56f764c36f8159b77740279a2 \u00b7 apple/foundationdb \u00b7 GitHub",
            "clicks": 0
          }
        ],
        "read": true,
        "user_title": null,
        "reply_to_user": {
          "id": 38,
          "username": "panghy",
          "name": "Clement Pang",
          "avatar_template": "/user_avatar/forums.foundationdb.org/panghy/{size}/19_2.png"
        },
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": true,
        "staff": true,
        "user_id": 12,
        "hidden": false,
        "trust_level": 4,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/how-to-prevent-tlogs-from-overcommitting/695/11",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 2136,
        "name": "Clement Pang",
        "username": "panghy",
        "avatar_template": "/user_avatar/forums.foundationdb.org/panghy/{size}/19_2.png",
        "created_at": "2018-09-19T19:45:30.246Z",
        "cooked": "<p>Alrighty, will check RK logs to see what\u2019s going on.</p>",
        "post_number": 12,
        "post_type": 1,
        "posts_count": 21,
        "updated_at": "2018-09-19T19:45:30.246Z",
        "reply_count": 0,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 0,
        "reads": 36,
        "readers_count": 35,
        "score": 7.2,
        "yours": false,
        "topic_id": 695,
        "topic_slug": "how-to-prevent-tlogs-from-overcommitting",
        "display_username": "Clement Pang",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": "",
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 38,
        "hidden": false,
        "trust_level": 2,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/how-to-prevent-tlogs-from-overcommitting/695/12",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 2140,
        "name": "Clement Pang",
        "username": "panghy",
        "avatar_template": "/user_avatar/forums.foundationdb.org/panghy/{size}/19_2.png",
        "created_at": "2018-09-20T22:19:01.097Z",
        "cooked": "<p><a class=\"mention\" href=\"/u/alexmiller\">@alexmiller</a> any thoughts on using ssd2 engine for tlogs while using memory for storage? Just wanted to give that a try</p>",
        "post_number": 13,
        "post_type": 1,
        "posts_count": 21,
        "updated_at": "2018-09-20T22:19:01.097Z",
        "reply_count": 0,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 0,
        "reads": 34,
        "readers_count": 33,
        "score": 8.8,
        "yours": false,
        "topic_id": 695,
        "topic_slug": "how-to-prevent-tlogs-from-overcommitting",
        "display_username": "Clement Pang",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": "",
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 38,
        "hidden": false,
        "trust_level": 2,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/how-to-prevent-tlogs-from-overcommitting/695/13",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 2241,
        "name": "Clement Pang",
        "username": "panghy",
        "avatar_template": "/user_avatar/forums.foundationdb.org/panghy/{size}/19_2.png",
        "created_at": "2018-10-05T23:29:43.530Z",
        "cooked": "<p>Nothing stood out, we are testing commits from the latest 5.2 branch (also the memory rollback fix that was suggested). Tuning some knobs that we can find as well.</p>\n<p>Setting tlogs to ssd2 did not do what we expected so far.</p>",
        "post_number": 14,
        "post_type": 1,
        "posts_count": 21,
        "updated_at": "2018-10-05T23:29:43.530Z",
        "reply_count": 1,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 0,
        "reads": 28,
        "readers_count": 27,
        "score": 10.6,
        "yours": false,
        "topic_id": 695,
        "topic_slug": "how-to-prevent-tlogs-from-overcommitting",
        "display_username": "Clement Pang",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": "",
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 38,
        "hidden": false,
        "trust_level": 2,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/how-to-prevent-tlogs-from-overcommitting/695/14",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 2244,
        "name": "Alex Miller",
        "username": "alexmiller",
        "avatar_template": "/user_avatar/forums.foundationdb.org/alexmiller/{size}/326_2.png",
        "created_at": "2018-10-06T01:42:29.658Z",
        "cooked": "<p>Is this completely blocking your transition to 5.x?  I marked this to take a look at after trying to close out an ongoing project, but that\u2019s probably going to take another couple weeks.</p>",
        "post_number": 15,
        "post_type": 1,
        "posts_count": 21,
        "updated_at": "2018-10-06T01:42:29.658Z",
        "reply_count": 0,
        "reply_to_post_number": 14,
        "quote_count": 0,
        "incoming_link_count": 0,
        "reads": 28,
        "readers_count": 27,
        "score": 5.6,
        "yours": false,
        "topic_id": 695,
        "topic_slug": "how-to-prevent-tlogs-from-overcommitting",
        "display_username": "Alex Miller",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "reply_to_user": {
          "id": 38,
          "username": "panghy",
          "name": "Clement Pang",
          "avatar_template": "/user_avatar/forums.foundationdb.org/panghy/{size}/19_2.png"
        },
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 13,
        "hidden": false,
        "trust_level": 4,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/how-to-prevent-tlogs-from-overcommitting/695/15",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 2248,
        "name": "Clement Pang",
        "username": "panghy",
        "avatar_template": "/user_avatar/forums.foundationdb.org/panghy/{size}/19_2.png",
        "created_at": "2018-10-06T06:32:34.094Z",
        "cooked": "<p>There are a number of things we are working to resolve:</p>\n<ul>\n<li>TLogs overcommitting is a new thing (leading to KeyValueStoreMemory_OutOfSpace) and it requires upping storage_memory to resolve although this is not unheard of in the past we would simply up the storage_memory and it usually would work (in the past, it would simply get stuck at Initializing New Transaction Servers).</li>\n<li>Rollback issues, basically killing a CC (kill -9) will almost always cause a long period of unavailability. That we tried the idea posted on another thread of picking the highest version to rollback to but that causes clusters to go into \u201cconfiguration_unavailable\u201d state AFAICT. On a hunch, I am testing this: <a href=\"https://github.com/panghy/foundationdb/commit/20cffc03c18a578a98a0d18d7a44ddc6beb40fbe\" rel=\"nofollow noopener\">https://github.com/panghy/foundationdb/commit/20cffc03c18a578a98a0d18d7a44ddc6beb40fbe</a>\n</li>\n<li>Frequent moving of resolution ranges on the master. This seems to have been alleviated by changing STORAGE_METRICS_AVERAGE_INTERVAL to 10.0 from 120.0. My understanding is that it affects the metrics that resolvers are collecting which in turn causes the master to decide whether to rebalance.</li>\n</ul>\n<p>Other than that, we are just about to roll our custom 5.2.5 clients with our custom 3.x client and activate multi-version clients which stands-by the fleet for an upgrade once we know how to run 5.2.x at the same (or above) reliability as before.</p>",
        "post_number": 16,
        "post_type": 1,
        "posts_count": 21,
        "updated_at": "2018-10-06T08:23:15.923Z",
        "reply_count": 0,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 0,
        "reads": 30,
        "readers_count": 29,
        "score": 6.0,
        "yours": false,
        "topic_id": 695,
        "topic_slug": "how-to-prevent-tlogs-from-overcommitting",
        "display_username": "Clement Pang",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 2,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "link_counts": [
          {
            "url": "https://github.com/panghy/foundationdb/commit/20cffc03c18a578a98a0d18d7a44ddc6beb40fbe",
            "internal": false,
            "reflection": false,
            "title": "Change to delay rollback attempts (when there aren't too many failure\u2026 \u00b7 panghy/foundationdb@20cffc0 \u00b7 GitHub",
            "clicks": 2
          }
        ],
        "read": true,
        "user_title": "",
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 38,
        "hidden": false,
        "trust_level": 2,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/how-to-prevent-tlogs-from-overcommitting/695/16",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 2249,
        "name": "Clement Pang",
        "username": "panghy",
        "avatar_template": "/user_avatar/forums.foundationdb.org/panghy/{size}/19_2.png",
        "created_at": "2018-10-06T08:22:46.400Z",
        "cooked": "<p>So I believe I might have found a couple interesting things, I followed up another round of tests with another commit (<a href=\"https://github.com/panghy/foundationdb/commit/05bb4395ea1674926b261aca9b87be874e01cf7d\" rel=\"nofollow noopener\">https://github.com/panghy/foundationdb/commit/05bb4395ea1674926b261aca9b87be874e01cf7d</a>) which essentially waits for up to 30 seconds or if all tlogs are responsive (again, rollback for us is 15 minutes so having up to 30s of unavailability to wait for logs to come back isn\u2019t too bad).</p>\n<p>One interesting thing I noticed is that where coordinators are affects how CC death is handled. Specifically if the coordinators are excluded (exclude IP:port) from the cluster, it doesn\u2019t cause all memory storage processes to rollback at all and the system can recover from a CC kill (sudo kill -9) gracefully instead of exhibiting unavailability for N mins (where N scales with storage_memory of memory nodes). Since I changed two things, I am not sure if that\u2019s also because adding the wait before figuring out knownCommittedVersion for 30s made it better.</p>\n<p>Another thing for memory processes is that the cluster does seem to wait for them to recover from disk rather than going into healing with 5.2.x when memory processes are restarted rapidly. This just leads to tlogs filing up as the storage servers are seemingly not dequeueing from tlogs and will require a long wait until they can catch up. The fix here is seemingly to just kill the dead processes for a bit longer so that they can be properly removed.</p>\n<p>I noticed that there are now dedicated classes for cluster_controller, master and log (the last seems to mean that it\u2019s most likely to take tlogs only instead of also taking on as proxy/resolvers). i wonder if there can be a dedicated class for coordinators.</p>",
        "post_number": 17,
        "post_type": 1,
        "posts_count": 21,
        "updated_at": "2018-10-06T08:22:46.400Z",
        "reply_count": 1,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 0,
        "reads": 33,
        "readers_count": 32,
        "score": 11.6,
        "yours": false,
        "topic_id": 695,
        "topic_slug": "how-to-prevent-tlogs-from-overcommitting",
        "display_username": "Clement Pang",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "link_counts": [
          {
            "url": "https://github.com/panghy/foundationdb/commit/05bb4395ea1674926b261aca9b87be874e01cf7d",
            "internal": false,
            "reflection": false,
            "title": "Go into recovery when there are no unresponsive log servers (that's t\u2026 \u00b7 panghy/foundationdb@05bb439 \u00b7 GitHub",
            "clicks": 0
          }
        ],
        "read": true,
        "user_title": "",
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 38,
        "hidden": false,
        "trust_level": 2,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/how-to-prevent-tlogs-from-overcommitting/695/17",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 2250,
        "name": "Clement Pang",
        "username": "panghy",
        "avatar_template": "/user_avatar/forums.foundationdb.org/panghy/{size}/19_2.png",
        "created_at": "2018-10-06T09:46:59.654Z",
        "cooked": "<p>The logic does seem to help, as you can tell below:</p>\n<pre><code>&lt;Event Severity=\"10\" Time=\"1538815785.209264\" Type=\"TLogLocked\" Machine=\"10.42.2.10:4683\" ID=\"8bfb28dc474f8e23\" TLog=\"0c09b93d6932812d\" end=\"27672122785\" logGroup=\"default\"/&gt;\n&lt;Event Severity=\"10\" Time=\"1538815785.209264\" Type=\"DelayingMasterRecovery\" Machine=\"10.42.2.10:4683\" ID=\"8bfb28dc474f8e23\" StatusCode=\"2\" Status=\"locking_old_transaction_servers\" MissingIDs=\"b2a01e059992bff38bff75465ae563c8, 4059bc9019d0c3b086f720e232db82eb, 16b0804b7f2b76c138c6afd2c1fe8995, 7ca18acd06cb634d5866fa62ca3e36ac\" logGroup=\"default\" TrackLatestType=\"Original\"/&gt;\n&lt;Event Severity=\"10\" Time=\"1538815786.209325\" Type=\"DelayingMasterRecovery\" Machine=\"10.42.2.10:4683\" ID=\"8bfb28dc474f8e23\" StatusCode=\"2\" Status=\"locking_old_transaction_servers\" MissingIDs=\"b2a01e059992bff38bff75465ae563c8, 4059bc9019d0c3b086f720e232db82eb, 16b0804b7f2b76c138c6afd2c1fe8995, 7ca18acd06cb634d5866fa62ca3e36ac\" logGroup=\"default\" TrackLatestType=\"Original\"/&gt;\n&lt;Event Severity=\"10\" Time=\"1538815786.733162\" Type=\"ConnectionFrom\" Machine=\"10.42.2.10:4683\" ID=\"c4419d54e87a14ab\" FromAddress=\"10.42.2.59:59396\" SuppressedEventCount=\"35\" logGroup=\"default\"/&gt;\n&lt;Event Severity=\"10\" Time=\"1538815786.771376\" Type=\"ConnectionEstablished\" Machine=\"10.42.2.10:4683\" ID=\"c4419d54e87a14ab\" Peer=\"10.42.2.59:59396\" ConnectionId=\"1\" SuppressedEventCount=\"35\" logGroup=\"default\"/&gt;\n&lt;Event Severity=\"10\" Time=\"1538815786.771376\" Type=\"IncomingConnection\" Machine=\"10.42.2.10:4683\" ID=\"c4419d54e87a14ab\" FromAddr=\"10.42.2.59:59396\" CanonicalAddr=\"10.42.2.59:4653\" IsPublic=\"1\" logGroup=\"default\"/&gt;\n&lt;Event Severity=\"10\" Time=\"1538815786.771376\" Type=\"ConnectionClosed\" Machine=\"10.42.2.10:4683\" ID=\"0000000000000000\" PeerAddr=\"10.42.2.59:4653\" Error=\"operation_cancelled\" ErrorDescription=\"Asynchronous operation cancelled\" ErrorCode=\"1101\" SuppressedEventCount=\"35\" logGroup=\"default\"/&gt;\n&lt;Event Severity=\"10\" Time=\"1538815786.771376\" Type=\"TLogJoinedMeUnknown\" Machine=\"10.42.2.10:4683\" ID=\"8bfb28dc474f8e23\" TLog=\"ca88d97401ad13cf\" Address=\"10.42.2.59:4653\" logGroup=\"default\"/&gt;\n&lt;Event Severity=\"10\" Time=\"1538815786.771376\" Type=\"TLogJoinedMe\" Machine=\"10.42.2.10:4683\" ID=\"8bfb28dc474f8e23\" TLog=\"7ca18acd06cb634d\" Address=\"10.42.2.59:4653\" logGroup=\"default\"/&gt;\n&lt;Event Severity=\"10\" Time=\"1538815786.772171\" Type=\"TLogLocked\" Machine=\"10.42.2.10:4683\" ID=\"8bfb28dc474f8e23\" TLog=\"7ca18acd06cb634d\" end=\"27672122785\" logGroup=\"default\"/&gt;\n&lt;Event Severity=\"10\" Time=\"1538815787.035086\" Type=\"IncomingConnection\" Machine=\"10.42.2.10:4683\" ID=\"f57166692cca38e1\" FromAddr=\"10.42.2.59:59398\" CanonicalAddr=\"10.42.2.59:4650\" IsPublic=\"1\" logGroup=\"default\"/&gt;\n&lt;Event Severity=\"10\" Time=\"1538815787.036583\" Type=\"TLogJoinedMe\" Machine=\"10.42.2.10:4683\" ID=\"8bfb28dc474f8e23\" TLog=\"b2a01e059992bff3\" Address=\"10.42.2.59:4650\" logGroup=\"default\"/&gt;\n&lt;Event Severity=\"10\" Time=\"1538815787.036583\" Type=\"TLogJoinedMeUnknown\" Machine=\"10.42.2.10:4683\" ID=\"8bfb28dc474f8e23\" TLog=\"a7b2380a1d47c806\" Address=\"10.42.2.59:4650\" logGroup=\"default\"/&gt;\n&lt;Event Severity=\"10\" Time=\"1538815787.037139\" Type=\"TLogLocked\" Machine=\"10.42.2.10:4683\" ID=\"8bfb28dc474f8e23\" TLog=\"b2a01e059992bff3\" end=\"27672122785\" logGroup=\"default\"/&gt;\n&lt;Event Severity=\"10\" Time=\"1538815787.129738\" Type=\"IncomingConnection\" Machine=\"10.42.2.10:4683\" ID=\"67e25797c8b3551f\" FromAddr=\"10.42.2.59:59400\" CanonicalAddr=\"10.42.2.59:4652\" IsPublic=\"1\" logGroup=\"default\"/&gt;\n&lt;Event Severity=\"10\" Time=\"1538815787.132086\" Type=\"TLogJoinedMe\" Machine=\"10.42.2.10:4683\" ID=\"8bfb28dc474f8e23\" TLog=\"16b0804b7f2b76c1\" Address=\"10.42.2.59:4652\" logGroup=\"default\"/&gt;\n&lt;Event Severity=\"10\" Time=\"1538815787.132086\" Type=\"TLogJoinedMeUnknown\" Machine=\"10.42.2.10:4683\" ID=\"8bfb28dc474f8e23\" TLog=\"9e23d610a8de4849\" Address=\"10.42.2.59:4652\" logGroup=\"default\"/&gt;\n&lt;Event Severity=\"10\" Time=\"1538815787.132872\" Type=\"TLogLocked\" Machine=\"10.42.2.10:4683\" ID=\"8bfb28dc474f8e23\" TLog=\"16b0804b7f2b76c1\" end=\"27672122785\" logGroup=\"default\"/&gt;\n&lt;Event Severity=\"10\" Time=\"1538815787.209444\" Type=\"DelayingMasterRecovery\" Machine=\"10.42.2.10:4683\" ID=\"8bfb28dc474f8e23\" StatusCode=\"2\" Status=\"locking_old_transaction_servers\" MissingIDs=\"4059bc9019d0c3b086f720e232db82eb\" logGroup=\"default\" TrackLatestType=\"Original\"/&gt;\n&lt;Event Severity=\"10\" Time=\"1538815787.296189\" Type=\"IncomingConnection\" Machine=\"10.42.2.10:4683\" ID=\"7a609d4744a84de5\" FromAddr=\"10.42.2.59:59402\" CanonicalAddr=\"10.42.2.59:4651\" IsPublic=\"1\" logGroup=\"default\"/&gt;\n&lt;Event Severity=\"10\" Time=\"1538815787.296522\" Type=\"TLogJoinedMe\" Machine=\"10.42.2.10:4683\" ID=\"8bfb28dc474f8e23\" TLog=\"4059bc9019d0c3b0\" Address=\"10.42.2.59:4651\" logGroup=\"default\"/&gt;\n&lt;Event Severity=\"10\" Time=\"1538815787.296522\" Type=\"TLogJoinedMeUnknown\" Machine=\"10.42.2.10:4683\" ID=\"8bfb28dc474f8e23\" TLog=\"fe60a433f5e28635\" Address=\"10.42.2.59:4651\" logGroup=\"default\"/&gt;\n&lt;Event Severity=\"10\" Time=\"1538815787.296953\" Type=\"TLogLocked\" Machine=\"10.42.2.10:4683\" ID=\"8bfb28dc474f8e23\" TLog=\"4059bc9019d0c3b0\" end=\"27672122785\" logGroup=\"default\"/&gt;\n&lt;Event Severity=\"10\" Time=\"1538815788.209522\" Type=\"LogSystemRecovery\" Machine=\"10.42.2.10:4683\" ID=\"8bfb28dc474f8e23\" Cycles=\"40\" TotalServers=\"40\" Present=\"40\" Available=\"40\" Absent=\"0\" ServerState=\"aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\" ReplicationFactor=\"2\" AntiQuorum=\"0\" Policy=\"zoneid^2 x 1\" TooManyFailures=\"0\" LastVersion=\"-1\" RecoveryVersion=\"27671204392\" EndVersion=\"27671204392\" SafeBegin=\"0\" SafeEnd=\"2\" NewSafeBegin=\"0\" LogZones=\"a188c033405bf0c7e3e3f4ab4db7619d,5f207adfb8bce3482a137e74236271f9,08e17799c6882ca97ffd786f10738e2e,5f207adfb8bce3482a137e74236271f9,6034975fa591c43bbd18532021638a03,b98e961a7cd5aca9ccf113d9dc902674,0439c79a19ca33c549459b4190c83245,f1659782186ec6fd118af10c247de0b0,7b3a48e3dde447444009d7c0c54f88d1,b98e961a7cd5aca9ccf113d9dc902674,0439c79a19ca33c549459b4190c83245,0439c79a19ca33c549459b4190c83245,5f207adfb8bce3482a137e74236271f9,0439c79a19ca33c549459b4190c83245,08e17799c6882ca97ffd786f10738e2e,\\...\" LogDataHalls=\"[unset],[unset],[unset],[unset],[unset],[unset],[unset],[unset],[unset],[unset],[unset],[unset],[unset],[unset],[unset],[unset],[unset],[unset],[unset],[unset],[unset],[unset],[unset],[unset],[unset],[unset],[unset],[unset],[unset],[unset],[unset],[unset],[unset],[unset],[unset],[unset],[unset],[unset],[unset],[unset]\" tLogs=\"40\" oldTlogsSize=\"0\" logSystemType=\"2\" At=\"27671204392\" AvailableServers=\"40\" knownCommittedVersion=\"27671202579\" logGroup=\"default\"/&gt;\n</code></pre>\n<p>Specifically, because of the delay, it waited until all logs have joined before attempting recovery which meant it likely had a higher knownCommittedVersion than before (I should have logged that information when the code attempted the delay).</p>\n<p>Obviously, I think for SSD storage engines, this should not be the default (meaning the knob should default to zero) but for memory, since the trade-off is huge (we still had some storage servers rollback in our tests), it\u2019s probably a good idea to wait a couple seconds (up to 10 perhaps in limited experiments I just did) just in case the logs were just restarted or a temporary issue prevented them from responding.</p>",
        "post_number": 18,
        "post_type": 1,
        "posts_count": 21,
        "updated_at": "2018-10-06T09:46:59.654Z",
        "reply_count": 0,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 0,
        "reads": 33,
        "readers_count": 32,
        "score": 6.6,
        "yours": false,
        "topic_id": 695,
        "topic_slug": "how-to-prevent-tlogs-from-overcommitting",
        "display_username": "Clement Pang",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": "",
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 38,
        "hidden": false,
        "trust_level": 2,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/how-to-prevent-tlogs-from-overcommitting/695/18",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 2259,
        "name": "Clement Pang",
        "username": "panghy",
        "avatar_template": "/user_avatar/forums.foundationdb.org/panghy/{size}/19_2.png",
        "created_at": "2018-10-07T08:07:37.586Z",
        "cooked": "<p>Actually, I don\u2019t believe where coordinators are (whether they are actual storage servers) do not affect whether rollback happens (enough tests show that the rollback can still happen). I am wondering (and testing) whether we can choose to not reload the memory KeyValueStore on rollback and instead just reuse the same instance. I have looked at the code a bit and I don\u2019t seem to see why that would break (the MVCC piece doesn\u2019t exist in the IKeyValueStore, whatever that is set(), clear() or committed() is flushed to disk and recovery just reads them and adds a rollback).</p>",
        "post_number": 19,
        "post_type": 1,
        "posts_count": 21,
        "updated_at": "2018-10-07T08:07:37.586Z",
        "reply_count": 0,
        "reply_to_post_number": 17,
        "quote_count": 0,
        "incoming_link_count": 0,
        "reads": 32,
        "readers_count": 31,
        "score": 6.4,
        "yours": false,
        "topic_id": 695,
        "topic_slug": "how-to-prevent-tlogs-from-overcommitting",
        "display_username": "Clement Pang",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": "",
        "reply_to_user": {
          "id": 38,
          "username": "panghy",
          "name": "Clement Pang",
          "avatar_template": "/user_avatar/forums.foundationdb.org/panghy/{size}/19_2.png"
        },
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 38,
        "hidden": false,
        "trust_level": 2,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/how-to-prevent-tlogs-from-overcommitting/695/19",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 2260,
        "name": "Clement Pang",
        "username": "panghy",
        "avatar_template": "/user_avatar/forums.foundationdb.org/panghy/{size}/19_2.png",
        "created_at": "2018-10-07T10:15:04.251Z",
        "cooked": "<p>Alright: <a href=\"https://github.com/apple/foundationdb/pull/821\" rel=\"nofollow noopener\">https://github.com/apple/foundationdb/pull/821</a></p>\n<p>This basically eliminated the dreaded N minutes of recovery when the memory storage servers are asked to roll back. The change is tested and the cluster comes back to life instantly.</p>",
        "post_number": 20,
        "post_type": 1,
        "posts_count": 21,
        "updated_at": "2018-10-07T10:29:53.351Z",
        "reply_count": 0,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 0,
        "reads": 32,
        "readers_count": 31,
        "score": 6.4,
        "yours": false,
        "topic_id": 695,
        "topic_slug": "how-to-prevent-tlogs-from-overcommitting",
        "display_username": "Clement Pang",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 2,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "link_counts": [
          {
            "url": "https://github.com/apple/foundationdb/pull/821",
            "internal": false,
            "reflection": false,
            "title": "Reuse KeyValueStoreMemory on rollback by panghy \u00b7 Pull Request #821 \u00b7 apple/foundationdb \u00b7 GitHub",
            "clicks": 12
          }
        ],
        "read": true,
        "user_title": "",
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 38,
        "hidden": false,
        "trust_level": 2,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/how-to-prevent-tlogs-from-overcommitting/695/20",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      }
    ],
    "stream": [
      2076,
      2085,
      2086,
      2091,
      2092,
      2094,
      2110,
      2111,
      2112,
      2132,
      2133,
      2136,
      2140,
      2241,
      2244,
      2248,
      2249,
      2250,
      2259,
      2260,
      2424
    ]
  },
  "timeline_lookup": [
    [
      1,
      2597
    ],
    [
      2,
      2596
    ],
    [
      7,
      2594
    ],
    [
      10,
      2590
    ],
    [
      11,
      2589
    ],
    [
      13,
      2588
    ],
    [
      14,
      2573
    ],
    [
      19,
      2572
    ],
    [
      21,
      2556
    ]
  ],
  "tags": [],
  "tags_descriptions": {},
  "fancy_title": "How to prevent tlogs from overcommitting",
  "id": 695,
  "title": "How to prevent tlogs from overcommitting",
  "posts_count": 21,
  "created_at": "2018-09-12T08:05:48.702Z",
  "views": 1648,
  "reply_count": 4,
  "like_count": 0,
  "last_posted_at": "2018-10-23T00:50:58.852Z",
  "visible": true,
  "closed": false,
  "archived": false,
  "has_summary": false,
  "archetype": "regular",
  "slug": "how-to-prevent-tlogs-from-overcommitting",
  "category_id": 7,
  "word_count": 2677,
  "deleted_at": null,
  "user_id": 38,
  "featured_link": null,
  "pinned_globally": false,
  "pinned_at": null,
  "pinned_until": null,
  "image_url": null,
  "slow_mode_seconds": 0,
  "draft": null,
  "draft_key": "topic_695",
  "draft_sequence": null,
  "unpinned": null,
  "pinned": false,
  "current_post_number": 1,
  "highest_post_number": 21,
  "deleted_by": null,
  "actions_summary": [
    {
      "id": 4,
      "count": 0,
      "hidden": false,
      "can_act": false
    },
    {
      "id": 8,
      "count": 0,
      "hidden": false,
      "can_act": false
    },
    {
      "id": 10,
      "count": 0,
      "hidden": false,
      "can_act": false
    },
    {
      "id": 7,
      "count": 0,
      "hidden": false,
      "can_act": false
    }
  ],
  "chunk_size": 20,
  "bookmarked": false,
  "topic_timer": null,
  "message_bus_last_id": 0,
  "participant_count": 3,
  "show_read_indicator": false,
  "thumbnails": null,
  "slow_mode_enabled_until": null,
  "tags_disable_ads": false,
  "related_topics": null,
  "summarizable": false,
  "can_vote": false,
  "vote_count": 0,
  "user_voted": false,
  "discourse_zendesk_plugin_zendesk_id": null,
  "discourse_zendesk_plugin_zendesk_url": "https://your-url.zendesk.com/agent/tickets/",
  "details": {
    "can_edit": false,
    "notification_level": 1,
    "participants": [
      {
        "id": 38,
        "username": "panghy",
        "name": "Clement Pang",
        "avatar_template": "/user_avatar/forums.foundationdb.org/panghy/{size}/19_2.png",
        "post_count": 16,
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_color": null,
        "flair_bg_color": null,
        "flair_group_id": null,
        "trust_level": 2
      },
      {
        "id": 12,
        "username": "ajbeamon",
        "name": "A.J. Beamon",
        "avatar_template": "/user_avatar/forums.foundationdb.org/ajbeamon/{size}/13_2.png",
        "post_count": 3,
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_color": null,
        "flair_bg_color": null,
        "flair_group_id": null,
        "admin": true,
        "trust_level": 4
      },
      {
        "id": 13,
        "username": "alexmiller",
        "name": "Alex Miller",
        "avatar_template": "/user_avatar/forums.foundationdb.org/alexmiller/{size}/326_2.png",
        "post_count": 2,
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_color": null,
        "flair_bg_color": null,
        "flair_group_id": null,
        "trust_level": 4
      }
    ],
    "created_by": {
      "id": 38,
      "username": "panghy",
      "name": "Clement Pang",
      "avatar_template": "/user_avatar/forums.foundationdb.org/panghy/{size}/19_2.png"
    },
    "last_poster": {
      "id": 38,
      "username": "panghy",
      "name": "Clement Pang",
      "avatar_template": "/user_avatar/forums.foundationdb.org/panghy/{size}/19_2.png"
    },
    "links": [
      {
        "url": "https://github.com/apple/foundationdb/pull/821",
        "title": "Reuse KeyValueStoreMemory on rollback by panghy \u00b7 Pull Request #821 \u00b7 apple/foundationdb \u00b7 GitHub",
        "internal": false,
        "attachment": false,
        "reflection": false,
        "clicks": 12,
        "user_id": 38,
        "domain": "github.com",
        "root_domain": "github.com"
      },
      {
        "url": "https://github.com/apple/foundationdb/issues/768",
        "title": "`configure memory` configures the TLog to spill to memory \u00b7 Issue #768 \u00b7 apple/foundationdb \u00b7 GitHub",
        "internal": false,
        "attachment": false,
        "reflection": false,
        "clicks": 10,
        "user_id": 13,
        "domain": "github.com",
        "root_domain": "github.com"
      },
      {
        "url": "https://github.com/apple/foundationdb/issues/769",
        "title": "Ratekeeper isn't throttling when a TLog's MemoryKeyValueStore is nearly full \u00b7 Issue #769 \u00b7 apple/foundationdb \u00b7 GitHub",
        "internal": false,
        "attachment": false,
        "reflection": false,
        "clicks": 10,
        "user_id": 13,
        "domain": "github.com",
        "root_domain": "github.com"
      },
      {
        "url": "https://github.com/panghy/foundationdb/commit/20cffc03c18a578a98a0d18d7a44ddc6beb40fbe",
        "title": "Change to delay rollback attempts (when there aren't too many failure\u2026 \u00b7 panghy/foundationdb@20cffc0 \u00b7 GitHub",
        "internal": false,
        "attachment": false,
        "reflection": false,
        "clicks": 2,
        "user_id": 38,
        "domain": "github.com",
        "root_domain": "github.com"
      },
      {
        "url": "https://github.com/apple/foundationdb/pull/41/files",
        "title": "Available space should take into account both memory and disk by panghy \u00b7 Pull Request #41 \u00b7 apple/foundationdb \u00b7 GitHub",
        "internal": false,
        "attachment": false,
        "reflection": false,
        "clicks": 1,
        "user_id": 12,
        "domain": "github.com",
        "root_domain": "github.com"
      }
    ]
  },
  "bookmarks": []
}