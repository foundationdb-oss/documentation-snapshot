{
  "post_stream": {
    "posts": [
      {
        "id": 1456,
        "name": "Christophe Chevalier",
        "username": "KrzysFR",
        "avatar_template": "/user_avatar/forums.foundationdb.org/krzysfr/{size}/43_2.png",
        "created_at": "2018-06-12T18:43:46.971Z",
        "cooked": "<p>I have a process that has two independent modules that can connect to either the same fdb cluster, or two different clusters depending on configuration (one would be for general purpose data, and the other for centralized logging).</p>\n<p>The implementation of each module is completely separate and they don\u2019t share any code (apart from the fdb binding), so they currently create their own Cluster and Database handle, and read the cluster file path from two different configuration sections.</p>\n<p>In the case where both target the same fdb cluster, they will both have the same cluster file path. So if the list of coordinators change on that cluster, both <code>FDBCluster</code> instances may want to update the cluster file \u201cat the same time\u201d.</p>\n<p>Looking at the client code, it seems that <code>monitorLeaderOneGeneration(..)</code> in <code>MonitorLeader.actor.cpp</code> is listening for leader change notifications, and will call <code>ClusterConnectionFile::setConnectionString(..)</code> with the new string. This will create a tmp file with the new cnx string, and swap it with the old .cluster file \u201catomically\u201d. It then does check the content of the file to see if it matches what was written previously.</p>\n<p>I was not able to confirm this or not, but if I create two cluster handles, they will both call <code>monitorLeader(...)</code> so both may respond to the same event and independently try to update the same cluster file.</p>\n<p>Since both cluster handles will share the same network thread, can I safely assume that since the fdb client is single threaded, then both actors won\u2019t try to update the same file at the same time (concurrently) ? At worst, the same file will be overwritten twice with the same content.</p>\n<p>What would happen if the cluster file changes twice in very rapid succession, both the leader monitor actors fire but in some weird order that would end up with the intermediate version of the cluster file on disk?</p>\n<p>Is this a scenario were having multiple of a Cluster handle per process with the same cluster file is a bad thing? Should I try to dedup this at the application level? or maybe even at the binding level? (ie: if second cluster use same path as first one, reuse this handle but create a second database handle, to at least have some isolation between both modules)</p>",
        "post_number": 1,
        "post_type": 1,
        "posts_count": 4,
        "updated_at": "2018-06-12T18:53:13.569Z",
        "reply_count": 0,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 108,
        "reads": 44,
        "readers_count": 43,
        "score": 548.8,
        "yours": false,
        "topic_id": 506,
        "topic_slug": "is-it-safe-to-have-multiple-cluster-handles-in-the-same-process-that-use-the-same-cluster-file",
        "display_username": "Christophe Chevalier",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 2,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 53,
        "hidden": false,
        "trust_level": 2,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/is-it-safe-to-have-multiple-cluster-handles-in-the-same-process-that-use-the-same-cluster-file/506/1",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null,
        "can_vote": false
      },
      {
        "id": 1458,
        "name": "David Scherer",
        "username": "dave",
        "avatar_template": "/user_avatar/forums.foundationdb.org/dave/{size}/89_2.png",
        "created_at": "2018-06-13T13:17:10.979Z",
        "cooked": "<p>Sharing the cluster file is definitely the norm - for example multiple fdbserver processes share the file in a typical server installation.  But a bug here is not inconceivable, because for example the simulator probably can\u2019t simulate fine-grained concurrency in this code (atomic replace is probably \u201catomic\u201d to it).  So remain vigilant, I guess.  I don\u2019t remember the relevant code well enough to answer your specific questions with confidence.</p>",
        "post_number": 2,
        "post_type": 1,
        "posts_count": 4,
        "updated_at": "2018-06-13T13:17:10.979Z",
        "reply_count": 0,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 2,
        "reads": 39,
        "readers_count": 38,
        "score": 17.8,
        "yours": false,
        "topic_id": 506,
        "topic_slug": "is-it-safe-to-have-multiple-cluster-handles-in-the-same-process-that-use-the-same-cluster-file",
        "display_username": "David Scherer",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 22,
        "hidden": false,
        "trust_level": 1,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/is-it-safe-to-have-multiple-cluster-handles-in-the-same-process-that-use-the-same-cluster-file/506/2",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 1463,
        "name": "A.J. Beamon",
        "username": "ajbeamon",
        "avatar_template": "/user_avatar/forums.foundationdb.org/ajbeamon/{size}/13_2.png",
        "created_at": "2018-06-14T15:25:29.326Z",
        "cooked": "<p>I do believe that it is correct that the cluster file is updated on the network thread, and the atomic replace code isn\u2019t concurrent (i.e. it doesn\u2019t yield, so no other work on the network thread could be done in the middle of it). As a result, I wouldn\u2019t expect that you\u2019d have to worry about simultaneous filesystem operations to the cluster file from a single process.</p>\n<p>One possible exception to this may be when using the multi-version client. Each version of the client has its own network thread, and though I don\u2019t think you\u2019ll see updates to the cluster file from each of them normally, it might be possible to have multiple updates simultaneously if a coordinator change is timed well relative to an upgrade.</p>\n<p>I agree with Dave\u2019s thoughts regarding multiple processes using the same cluster file. It should be noted that if the cluster file ends up with the wrong contents, then the process(es) using it will report this fact to the cluster and you will see a message in status indicating so.</p>\n<p>One issue that can come up with multiple processes is in the following scenario where coordinators are changed multiple times:</p>\n<ol>\n<li>Process 1 updates cluster file to A</li>\n<li>Process 1 updates cluster file to B</li>\n<li>Process 2 updates cluster file to A</li>\n<li>Process 2 dies</li>\n</ol>\n<p>If process 1 and process 2 share the same cluster file, you could end up with the wrong contents at the end. As described above, process 1 should report to the cluster that its cluster file is incorrect. If process 2 reconnected, it would update the cluster file so long as some process from coordinator set A was still in the cluster.</p>\n<p>The above scenario could probably happen in a single process case as well, but it would likely involve the death of both clients since they share a process. In that case, it wouldn\u2019t be much different than if you completed step 1 and died immediately afterward.</p>",
        "post_number": 3,
        "post_type": 1,
        "posts_count": 4,
        "updated_at": "2018-06-14T15:28:34.774Z",
        "reply_count": 1,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 4,
        "reads": 33,
        "readers_count": 32,
        "score": 31.6,
        "yours": false,
        "topic_id": 506,
        "topic_slug": "is-it-safe-to-have-multiple-cluster-handles-in-the-same-process-that-use-the-same-cluster-file",
        "display_username": "A.J. Beamon",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": true,
        "staff": true,
        "user_id": 12,
        "hidden": false,
        "trust_level": 4,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/is-it-safe-to-have-multiple-cluster-handles-in-the-same-process-that-use-the-same-cluster-file/506/3",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 1464,
        "name": "Christophe Chevalier",
        "username": "KrzysFR",
        "avatar_template": "/user_avatar/forums.foundationdb.org/krzysfr/{size}/43_2.png",
        "created_at": "2018-06-14T16:16:28.058Z",
        "cooked": "<p>Thanks for the explanation.</p>\n<p>It looks to me that best practice when having multiple process running on the same host, is to have one instance of <code>fdb.cluster</code> for each process, instead of all using the global default path.</p>\n<p>For different app, they could have their own fdb.cluster in their working directory (they could target different clusters anyway). For the same app spawning multiple concurrent process, then either each has its own copy of the file, OR they share the same one and we hope for the best ?</p>",
        "post_number": 4,
        "post_type": 1,
        "posts_count": 4,
        "updated_at": "2018-06-14T16:16:28.058Z",
        "reply_count": 0,
        "reply_to_post_number": 3,
        "quote_count": 0,
        "incoming_link_count": 2,
        "reads": 27,
        "readers_count": 26,
        "score": 15.4,
        "yours": false,
        "topic_id": 506,
        "topic_slug": "is-it-safe-to-have-multiple-cluster-handles-in-the-same-process-that-use-the-same-cluster-file",
        "display_username": "Christophe Chevalier",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "reply_to_user": {
          "id": 12,
          "username": "ajbeamon",
          "name": "A.J. Beamon",
          "avatar_template": "/user_avatar/forums.foundationdb.org/ajbeamon/{size}/13_2.png"
        },
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 53,
        "hidden": false,
        "trust_level": 2,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/is-it-safe-to-have-multiple-cluster-handles-in-the-same-process-that-use-the-same-cluster-file/506/4",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      }
    ],
    "stream": [
      1456,
      1458,
      1463,
      1464
    ]
  },
  "timeline_lookup": [
    [
      1,
      2688
    ],
    [
      2,
      2687
    ],
    [
      3,
      2686
    ]
  ],
  "suggested_topics": [],
  "tags": [],
  "tags_descriptions": {},
  "fancy_title": "Is it safe to have multiple cluster handles in the same process that use the same cluster file?",
  "id": 506,
  "title": "Is it safe to have multiple cluster handles in the same process that use the same cluster file?",
  "posts_count": 4,
  "created_at": "2018-06-12T18:43:46.808Z",
  "views": 1123,
  "reply_count": 1,
  "like_count": 0,
  "last_posted_at": "2018-06-14T16:16:28.058Z",
  "visible": true,
  "closed": false,
  "archived": false,
  "has_summary": false,
  "archetype": "regular",
  "slug": "is-it-safe-to-have-multiple-cluster-handles-in-the-same-process-that-use-the-same-cluster-file",
  "category_id": 7,
  "word_count": 885,
  "deleted_at": null,
  "user_id": 53,
  "featured_link": null,
  "pinned_globally": false,
  "pinned_at": null,
  "pinned_until": null,
  "image_url": null,
  "slow_mode_seconds": 0,
  "draft": null,
  "draft_key": "topic_506",
  "draft_sequence": null,
  "unpinned": null,
  "pinned": false,
  "current_post_number": 1,
  "highest_post_number": 4,
  "deleted_by": null,
  "actions_summary": [
    {
      "id": 4,
      "count": 0,
      "hidden": false,
      "can_act": false
    },
    {
      "id": 8,
      "count": 0,
      "hidden": false,
      "can_act": false
    },
    {
      "id": 10,
      "count": 0,
      "hidden": false,
      "can_act": false
    },
    {
      "id": 7,
      "count": 0,
      "hidden": false,
      "can_act": false
    }
  ],
  "chunk_size": 20,
  "bookmarked": false,
  "topic_timer": null,
  "message_bus_last_id": 0,
  "participant_count": 3,
  "show_read_indicator": false,
  "thumbnails": null,
  "slow_mode_enabled_until": null,
  "tags_disable_ads": false,
  "related_topics": [
    {
      "fancy_title": "Doubts regarding fdb.cluster file",
      "id": 1109,
      "title": "Doubts regarding fdb.cluster file",
      "slug": "doubts-regarding-fdb-cluster-file",
      "posts_count": 4,
      "reply_count": 2,
      "highest_post_number": 4,
      "image_url": null,
      "created_at": "2019-02-02T16:02:47.335Z",
      "last_posted_at": "2019-02-07T17:17:38.271Z",
      "bumped": true,
      "bumped_at": "2019-02-07T17:17:38.271Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 0,
      "views": 2739,
      "category_id": 7,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": null,
          "description": "Original Poster",
          "user": {
            "id": 166,
            "username": "gaurav",
            "name": "gaurav",
            "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/g/b487fb/{size}.png",
            "trust_level": 3
          }
        },
        {
          "extras": "latest",
          "description": "Most Recent Poster",
          "user": {
            "id": 8,
            "username": "alloc",
            "name": "Alec Grieser",
            "avatar_template": "/user_avatar/forums.foundationdb.org/alloc/{size}/9_2.png",
            "trust_level": 4
          }
        }
      ]
    },
    {
      "fancy_title": "Allowing client APIs to use an &ldquo;in-memory&rdquo; fdb.cluster file?",
      "id": 675,
      "title": "Allowing client APIs to use an \"in-memory\" fdb.cluster file?",
      "slug": "allowing-client-apis-to-use-an-in-memory-fdb-cluster-file",
      "posts_count": 3,
      "reply_count": 1,
      "highest_post_number": 3,
      "image_url": null,
      "created_at": "2018-08-31T17:20:31.703Z",
      "last_posted_at": "2018-09-01T21:58:12.317Z",
      "bumped": true,
      "bumped_at": "2018-09-01T21:58:12.317Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 0,
      "views": 1755,
      "category_id": 8,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": "latest",
          "description": "Original Poster, Most Recent Poster",
          "user": {
            "id": 158,
            "username": "aseipp",
            "name": "Austin Seipp",
            "avatar_template": "/user_avatar/forums.foundationdb.org/aseipp/{size}/124_2.png",
            "trust_level": 2
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 8,
            "username": "alloc",
            "name": "Alec Grieser",
            "avatar_template": "/user_avatar/forums.foundationdb.org/alloc/{size}/9_2.png",
            "trust_level": 4
          }
        }
      ]
    },
    {
      "fancy_title": "How to prevent fdbcli from monitoring the connfile?",
      "id": 747,
      "title": "How to prevent fdbcli from monitoring the connfile?",
      "slug": "how-to-prevent-fdbcli-from-monitoring-the-connfile",
      "posts_count": 2,
      "reply_count": 0,
      "highest_post_number": 2,
      "image_url": null,
      "created_at": "2018-10-06T01:55:20.444Z",
      "last_posted_at": "2018-10-08T16:27:34.392Z",
      "bumped": true,
      "bumped_at": "2018-10-08T16:27:34.392Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 0,
      "views": 1386,
      "category_id": 7,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": null,
          "description": "Original Poster",
          "user": {
            "id": 44,
            "username": "cespare",
            "name": "Caleb Spare",
            "avatar_template": "/user_avatar/forums.foundationdb.org/cespare/{size}/36_2.png",
            "trust_level": 1
          }
        },
        {
          "extras": "latest",
          "description": "Most Recent Poster",
          "user": {
            "id": 12,
            "username": "ajbeamon",
            "name": "A.J. Beamon",
            "avatar_template": "/user_avatar/forums.foundationdb.org/ajbeamon/{size}/13_2.png",
            "admin": true,
            "trust_level": 4
          }
        }
      ]
    },
    {
      "fancy_title": "When is the fdb.cluster file updated on the client?",
      "id": 1304,
      "title": "When is the fdb.cluster file updated on the client?",
      "slug": "when-is-the-fdb-cluster-file-updated-on-the-client",
      "posts_count": 3,
      "reply_count": 0,
      "highest_post_number": 3,
      "image_url": null,
      "created_at": "2019-04-13T04:53:05.484Z",
      "last_posted_at": "2019-04-17T00:42:14.299Z",
      "bumped": true,
      "bumped_at": "2019-04-17T00:42:14.299Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 0,
      "views": 957,
      "category_id": 7,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": "latest",
          "description": "Original Poster, Most Recent Poster",
          "user": {
            "id": 542,
            "username": "jonahwest",
            "name": "",
            "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/j/90db22/{size}.png",
            "trust_level": 1
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 15,
            "username": "markus.pilman",
            "name": "Markus Pilman",
            "avatar_template": "/user_avatar/forums.foundationdb.org/markus.pilman/{size}/379_2.png",
            "admin": true,
            "trust_level": 4
          }
        }
      ]
    },
    {
      "fancy_title": "Multiple clusters for the same application, memory backend, and RPC layer",
      "id": 2685,
      "title": "Multiple clusters for the same application, memory backend, and RPC layer",
      "slug": "multiple-clusters-for-the-same-application-memory-backend-and-rpc-layer",
      "posts_count": 2,
      "reply_count": 0,
      "highest_post_number": 2,
      "image_url": null,
      "created_at": "2021-05-01T12:10:48.081Z",
      "last_posted_at": "2021-05-03T05:51:12.996Z",
      "bumped": true,
      "bumped_at": "2021-05-03T05:51:12.996Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 1,
      "views": 384,
      "category_id": 7,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": null,
          "description": "Original Poster",
          "user": {
            "id": 41,
            "username": "amirouche",
            "name": "Amirouche",
            "avatar_template": "/user_avatar/forums.foundationdb.org/amirouche/{size}/1911_2.png",
            "trust_level": 2
          }
        },
        {
          "extras": "latest",
          "description": "Most Recent Poster",
          "user": {
            "id": 12,
            "username": "ajbeamon",
            "name": "A.J. Beamon",
            "avatar_template": "/user_avatar/forums.foundationdb.org/ajbeamon/{size}/13_2.png",
            "admin": true,
            "trust_level": 4
          }
        }
      ]
    }
  ],
  "summarizable": false,
  "can_vote": false,
  "vote_count": 0,
  "user_voted": false,
  "discourse_zendesk_plugin_zendesk_id": null,
  "discourse_zendesk_plugin_zendesk_url": "https://your-url.zendesk.com/agent/tickets/",
  "details": {
    "can_edit": false,
    "notification_level": 1,
    "participants": [
      {
        "id": 53,
        "username": "KrzysFR",
        "name": "Christophe Chevalier",
        "avatar_template": "/user_avatar/forums.foundationdb.org/krzysfr/{size}/43_2.png",
        "post_count": 2,
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_color": null,
        "flair_bg_color": null,
        "flair_group_id": null,
        "trust_level": 2
      },
      {
        "id": 12,
        "username": "ajbeamon",
        "name": "A.J. Beamon",
        "avatar_template": "/user_avatar/forums.foundationdb.org/ajbeamon/{size}/13_2.png",
        "post_count": 1,
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_color": null,
        "flair_bg_color": null,
        "flair_group_id": null,
        "admin": true,
        "trust_level": 4
      },
      {
        "id": 22,
        "username": "dave",
        "name": "David Scherer",
        "avatar_template": "/user_avatar/forums.foundationdb.org/dave/{size}/89_2.png",
        "post_count": 1,
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_color": null,
        "flair_bg_color": null,
        "flair_group_id": null,
        "trust_level": 1
      }
    ],
    "created_by": {
      "id": 53,
      "username": "KrzysFR",
      "name": "Christophe Chevalier",
      "avatar_template": "/user_avatar/forums.foundationdb.org/krzysfr/{size}/43_2.png"
    },
    "last_poster": {
      "id": 53,
      "username": "KrzysFR",
      "name": "Christophe Chevalier",
      "avatar_template": "/user_avatar/forums.foundationdb.org/krzysfr/{size}/43_2.png"
    }
  },
  "bookmarks": []
}