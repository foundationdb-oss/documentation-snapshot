{
  "post_stream": {
    "posts": [
      {
        "id": 9905,
        "name": "Paul Clark",
        "username": "packetship",
        "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/p/50afbb/{size}.png",
        "created_at": "2021-08-23T15:39:50.455Z",
        "cooked": "<p>Hi folks,</p>\n<p>I\u2019ve been doing some performance tests as part of an evaluation for a customer project\u2026  The intended use case would be a large set (say 1000) of highly multi-threaded compute processes (ideally one per machine) connecting to a FoundationDB cluster, with a target throughput of 500k tx/sec.</p>\n<p>Just running some test scripts on some commodity hardware I have lying around, it seems like the single network thread per process is a significant bottleneck.  I have a single physical server running 4 FDB processes, and another test client machine, connected with 1Gbit/sec network.  The clients are C++ using the C API directly.  The server is running in \u2018memory\u2019 model and it gets disk bound if I wind up the value sizes, but the network thread seems to bottleneck well before that:</p>\n<ul>\n<li>1 process with 5000 threads doing a get/set cycle on thread-specific keys: around 1,000 tx/sec</li>\n<li>100 processes with 50 threads (ditto): around 10,000 tx/sec</li>\n</ul>\n<p>This factor of ten difference is consistent across different load patterns.</p>\n<p>For the intended application having to start, manage and distribute load over lots of processes per machine really isn\u2019t an option.</p>\n<p>I see that <a href=\"https://github.com/apple/foundationdb/issues/3336\" class=\"inline-onebox\" rel=\"noopener nofollow ugc\">Run one network thread per database \u00b7 Issue #3336 \u00b7 apple/foundationdb \u00b7 GitHub</a> was resolved with one thread per cluster, but I\u2019m not sure that was what the original reporter was after (the word \u2018database\u2019 was ambiguous I think) - it seemed like they had a similar problem to me.  It was suggested in the comments that one thread per FDBDatabase object would solve this, and it certainly would for me too (I could create a pool of them like I would for any other database connection), but the PR that closed it (<a href=\"https://github.com/apple/foundationdb/pull/4269\" class=\"inline-onebox\" rel=\"noopener nofollow ugc\">Multithreaded client by sears \u00b7 Pull Request #4269 \u00b7 apple/foundationdb \u00b7 GitHub</a>) is one thread per cluster, and not in user control.</p>\n<p>Are multiple threads to the same cluster possible?  Or is there some other mechanism that could be used?</p>\n<p>Many thanks</p>\n<p>Paul</p>",
        "post_number": 1,
        "post_type": 1,
        "posts_count": 3,
        "updated_at": "2021-08-23T15:39:50.455Z",
        "reply_count": 0,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 594,
        "reads": 59,
        "readers_count": 58,
        "score": 2981.8,
        "yours": false,
        "topic_id": 2862,
        "topic_slug": "multiple-network-threads",
        "display_username": "Paul Clark",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "link_counts": [
          {
            "url": "https://github.com/apple/foundationdb/issues/3336",
            "internal": false,
            "reflection": false,
            "title": "Run one network thread per database \u00b7 Issue #3336 \u00b7 apple/foundationdb \u00b7 GitHub",
            "clicks": 35
          },
          {
            "url": "https://github.com/apple/foundationdb/pull/4269",
            "internal": false,
            "reflection": false,
            "title": "Multithreaded client by sears \u00b7 Pull Request #4269 \u00b7 apple/foundationdb \u00b7 GitHub",
            "clicks": 21
          }
        ],
        "read": true,
        "user_title": null,
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 991,
        "hidden": false,
        "trust_level": 1,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/multiple-network-threads/2862/1",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null,
        "can_vote": false
      },
      {
        "id": 9907,
        "name": "A.J. Beamon",
        "username": "ajbeamon",
        "avatar_template": "/user_avatar/forums.foundationdb.org/ajbeamon/{size}/13_2.png",
        "created_at": "2021-08-23T16:28:54.390Z",
        "cooked": "<blockquote>\n<p>It was suggested in the comments that one thread per FDBDatabase object would solve this, and it certainly would for me too (I could create a pool of them like I would for any other database connection)</p>\n</blockquote>\n<p>The multi-threaded client feature can be made to work in the way you describe, though I should caution that I\u2019m not aware of anybody having used it this way extensively. It will also increase the number of independent connections to your cluster, and this number of connections is also limited (I don\u2019t know the current numbers for 6.3, possibly something like 5K client network threads can connect to a cluster).</p>\n<p>In order to use it this way, you will need to set the <code>client_threads_per_version</code> option to the number of separate network threads you want to run, and from there open up a connection to the same cluster multiple times using something like <code>fdb.open</code>. The DB objects are assigned to threads in a round-robin fashion, so each of your objects will have a different thread.</p>\n<p>Some language bindings attempt to cache the DB object when you open it and return it again if you try to open it a second time. If you are using one of these language bindings, then I think you can get around this by copying your cluster file multiple times and using a different file for each connection. Python is an example of a binding that uses this caching, whereas I believe Java does not. If you are using another binding, I can potentially check that for you.</p>",
        "post_number": 2,
        "post_type": 1,
        "posts_count": 3,
        "updated_at": "2021-08-23T16:28:54.390Z",
        "reply_count": 1,
        "reply_to_post_number": null,
        "quote_count": 0,
        "incoming_link_count": 11,
        "reads": 57,
        "readers_count": 56,
        "score": 71.4,
        "yours": false,
        "topic_id": 2862,
        "topic_slug": "multiple-network-threads",
        "display_username": "A.J. Beamon",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": true,
        "staff": true,
        "user_id": 12,
        "hidden": false,
        "trust_level": 4,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/multiple-network-threads/2862/2",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      },
      {
        "id": 9910,
        "name": "Paul Clark",
        "username": "packetship",
        "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/p/50afbb/{size}.png",
        "created_at": "2021-08-23T16:51:41.250Z",
        "cooked": "<p>Oh, that\u2019s great news, thank you.  I had mis-understood that change, then, or perhaps there is another one.</p>\n<p>Understood about server-side limits - but that is true whether we do it with processes or threads.  It probably won\u2019t require extreme numbers of client_threads_per_version, just more than one!</p>\n<p>I\u2019m currently working direct to the C API so I\u2019m in complete control.  The customer will probably want to use an (unofficial) C# binding, though, so I will check whether that caches DB objects or not.</p>\n<p>Many thanks!</p>",
        "post_number": 3,
        "post_type": 1,
        "posts_count": 3,
        "updated_at": "2021-08-23T16:51:58.517Z",
        "reply_count": 0,
        "reply_to_post_number": 2,
        "quote_count": 0,
        "incoming_link_count": 2,
        "reads": 53,
        "readers_count": 52,
        "score": 20.6,
        "yours": false,
        "topic_id": 2862,
        "topic_slug": "multiple-network-threads",
        "display_username": "Paul Clark",
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_bg_color": null,
        "flair_color": null,
        "flair_group_id": null,
        "badges_granted": [],
        "version": 1,
        "can_edit": false,
        "can_delete": false,
        "can_recover": false,
        "can_see_hidden_post": false,
        "can_wiki": false,
        "read": true,
        "user_title": null,
        "reply_to_user": {
          "id": 12,
          "username": "ajbeamon",
          "name": "A.J. Beamon",
          "avatar_template": "/user_avatar/forums.foundationdb.org/ajbeamon/{size}/13_2.png"
        },
        "bookmarked": false,
        "actions_summary": [],
        "moderator": false,
        "admin": false,
        "staff": false,
        "user_id": 991,
        "hidden": false,
        "trust_level": 1,
        "deleted_at": null,
        "user_deleted": false,
        "edit_reason": null,
        "can_view_edit_history": true,
        "wiki": false,
        "post_url": "/t/multiple-network-threads/2862/3",
        "can_accept_answer": false,
        "can_unaccept_answer": false,
        "accepted_answer": false,
        "topic_accepted_answer": null
      }
    ],
    "stream": [
      9905,
      9907,
      9910
    ]
  },
  "timeline_lookup": [
    [
      1,
      1520
    ]
  ],
  "suggested_topics": [],
  "tags": [
    "performance"
  ],
  "tags_descriptions": {},
  "fancy_title": "Multiple network threads",
  "id": 2862,
  "title": "Multiple network threads",
  "posts_count": 3,
  "created_at": "2021-08-23T15:39:50.372Z",
  "views": 1346,
  "reply_count": 1,
  "like_count": 0,
  "last_posted_at": "2021-08-23T16:51:41.250Z",
  "visible": true,
  "closed": false,
  "archived": false,
  "has_summary": false,
  "archetype": "regular",
  "slug": "multiple-network-threads",
  "category_id": 7,
  "word_count": 682,
  "deleted_at": null,
  "user_id": 991,
  "featured_link": null,
  "pinned_globally": false,
  "pinned_at": null,
  "pinned_until": null,
  "image_url": null,
  "slow_mode_seconds": 0,
  "draft": null,
  "draft_key": "topic_2862",
  "draft_sequence": null,
  "unpinned": null,
  "pinned": false,
  "current_post_number": 1,
  "highest_post_number": 3,
  "deleted_by": null,
  "actions_summary": [
    {
      "id": 4,
      "count": 0,
      "hidden": false,
      "can_act": false
    },
    {
      "id": 8,
      "count": 0,
      "hidden": false,
      "can_act": false
    },
    {
      "id": 10,
      "count": 0,
      "hidden": false,
      "can_act": false
    },
    {
      "id": 7,
      "count": 0,
      "hidden": false,
      "can_act": false
    }
  ],
  "chunk_size": 20,
  "bookmarked": false,
  "topic_timer": null,
  "message_bus_last_id": 0,
  "participant_count": 2,
  "show_read_indicator": false,
  "thumbnails": null,
  "slow_mode_enabled_until": null,
  "tags_disable_ads": false,
  "related_topics": [
    {
      "fancy_title": "Multiple clients, one go process",
      "id": 826,
      "title": "Multiple clients, one go process",
      "slug": "multiple-clients-one-go-process",
      "posts_count": 6,
      "reply_count": 1,
      "highest_post_number": 6,
      "image_url": null,
      "created_at": "2018-10-30T22:46:20.543Z",
      "last_posted_at": "2018-10-31T21:07:49.448Z",
      "bumped": true,
      "bumped_at": "2018-10-31T21:07:49.448Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [
        "bindings"
      ],
      "tags_descriptions": {},
      "like_count": 1,
      "views": 1181,
      "category_id": 7,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": null,
          "description": "Original Poster",
          "user": {
            "id": 413,
            "username": "zozos",
            "name": "",
            "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/z/e99b99/{size}.png",
            "trust_level": 0
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 409,
            "username": "TommyLike",
            "name": "Hu Sheng",
            "avatar_template": "/user_avatar/forums.foundationdb.org/tommylike/{size}/395_2.png",
            "trust_level": 1
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 12,
            "username": "ajbeamon",
            "name": "A.J. Beamon",
            "avatar_template": "/user_avatar/forums.foundationdb.org/ajbeamon/{size}/13_2.png",
            "admin": true,
            "trust_level": 4
          }
        },
        {
          "extras": "latest",
          "description": "Most Recent Poster",
          "user": {
            "id": 1,
            "username": "davelester",
            "name": "Dave Lester",
            "avatar_template": "/user_avatar/forums.foundationdb.org/davelester/{size}/1927_2.png",
            "trust_level": 4
          }
        }
      ]
    },
    {
      "fancy_title": "How to improve connections count from client to server in go sdk or in c sdk",
      "id": 223,
      "title": "How to improve connections count from client to server in go sdk or in c sdk",
      "slug": "how-to-improve-connections-count-from-client-to-server-in-go-sdk-or-in-c-sdk",
      "posts_count": 9,
      "reply_count": 7,
      "highest_post_number": 9,
      "image_url": null,
      "created_at": "2018-04-23T15:43:18.969Z",
      "last_posted_at": "2018-04-24T05:23:56.703Z",
      "bumped": true,
      "bumped_at": "2018-04-24T05:23:56.703Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 2,
      "views": 1718,
      "category_id": 7,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": null,
          "description": "Original Poster",
          "user": {
            "id": 152,
            "username": "shgxwxl",
            "name": "Shgxwxl",
            "avatar_template": "/user_avatar/forums.foundationdb.org/shgxwxl/{size}/127_2.png",
            "trust_level": 1
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 22,
            "username": "dave",
            "name": "David Scherer",
            "avatar_template": "/user_avatar/forums.foundationdb.org/dave/{size}/89_2.png",
            "trust_level": 1
          }
        },
        {
          "extras": "latest",
          "description": "Most Recent Poster",
          "user": {
            "id": 13,
            "username": "alexmiller",
            "name": "Alex Miller",
            "avatar_template": "/user_avatar/forums.foundationdb.org/alexmiller/{size}/326_2.png",
            "trust_level": 4
          }
        }
      ]
    },
    {
      "fancy_title": "Go client how to use multi network threads?",
      "id": 3198,
      "title": "Go client how to use multi network threads?",
      "slug": "go-client-how-to-use-multi-network-threads",
      "posts_count": 2,
      "reply_count": 0,
      "highest_post_number": 2,
      "image_url": null,
      "created_at": "2022-03-04T10:59:25.086Z",
      "last_posted_at": "2022-03-04T18:27:58.963Z",
      "bumped": true,
      "bumped_at": "2022-03-04T18:27:58.963Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [
        "bindings",
        "performance"
      ],
      "tags_descriptions": {},
      "like_count": 0,
      "views": 617,
      "category_id": 7,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": null,
          "description": "Original Poster",
          "user": {
            "id": 1042,
            "username": "widjaoidnasdqw",
            "name": "widjaoidnasdqw",
            "avatar_template": "/user_avatar/forums.foundationdb.org/widjaoidnasdqw/{size}/1274_2.png",
            "trust_level": 1
          }
        },
        {
          "extras": "latest",
          "description": "Most Recent Poster",
          "user": {
            "id": 14,
            "username": "andrew.noyes",
            "name": "",
            "avatar_template": "/user_avatar/forums.foundationdb.org/andrew.noyes/{size}/443_2.png",
            "trust_level": 2
          }
        }
      ]
    },
    {
      "fancy_title": "Single client performance",
      "id": 1391,
      "title": "Single client performance",
      "slug": "single-client-performance",
      "posts_count": 3,
      "reply_count": 1,
      "highest_post_number": 3,
      "image_url": null,
      "created_at": "2019-05-24T01:08:12.682Z",
      "last_posted_at": "2019-07-18T19:15:20.415Z",
      "bumped": true,
      "bumped_at": "2019-07-18T21:34:41.053Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [
        "bindings",
        "performance"
      ],
      "tags_descriptions": {},
      "like_count": 1,
      "views": 815,
      "category_id": 7,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": null,
          "description": "Original Poster",
          "user": {
            "id": 393,
            "username": "ex3ndr",
            "name": "Steve Korshakov",
            "avatar_template": "/user_avatar/forums.foundationdb.org/ex3ndr/{size}/389_2.png",
            "trust_level": 2
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 296,
            "username": "theos",
            "name": "Daniil Gitelson",
            "avatar_template": "/user_avatar/forums.foundationdb.org/theos/{size}/282_2.png",
            "trust_level": 1
          }
        },
        {
          "extras": "latest",
          "description": "Most Recent Poster",
          "user": {
            "id": 369,
            "username": "ricky.saltzer",
            "name": "Ricky Saltzer",
            "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/r/f17d59/{size}.png",
            "trust_level": 2
          }
        }
      ]
    },
    {
      "fancy_title": "Question about process class",
      "id": 418,
      "title": "Question about process class",
      "slug": "question-about-process-class",
      "posts_count": 4,
      "reply_count": 1,
      "highest_post_number": 4,
      "image_url": null,
      "created_at": "2018-05-16T01:43:39.821Z",
      "last_posted_at": "2018-05-17T15:51:12.201Z",
      "bumped": true,
      "bumped_at": "2018-05-17T15:51:12.201Z",
      "archetype": "regular",
      "unseen": false,
      "pinned": false,
      "unpinned": null,
      "visible": true,
      "closed": false,
      "archived": false,
      "bookmarked": null,
      "liked": null,
      "tags": [],
      "tags_descriptions": {},
      "like_count": 0,
      "views": 1141,
      "category_id": 8,
      "featured_link": null,
      "has_accepted_answer": false,
      "posters": [
        {
          "extras": null,
          "description": "Original Poster",
          "user": {
            "id": 124,
            "username": "coder0718",
            "name": "Coder0718",
            "avatar_template": "/user_avatar/forums.foundationdb.org/coder0718/{size}/87_2.png",
            "trust_level": 1
          }
        },
        {
          "extras": null,
          "description": "Frequent Poster",
          "user": {
            "id": 179,
            "username": "tcrayford",
            "name": "Tom Crayford",
            "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/t/47e85d/{size}.png",
            "trust_level": 1
          }
        },
        {
          "extras": "latest",
          "description": "Most Recent Poster",
          "user": {
            "id": 12,
            "username": "ajbeamon",
            "name": "A.J. Beamon",
            "avatar_template": "/user_avatar/forums.foundationdb.org/ajbeamon/{size}/13_2.png",
            "admin": true,
            "trust_level": 4
          }
        }
      ]
    }
  ],
  "summarizable": false,
  "can_vote": false,
  "vote_count": 0,
  "user_voted": false,
  "discourse_zendesk_plugin_zendesk_id": null,
  "discourse_zendesk_plugin_zendesk_url": "https://your-url.zendesk.com/agent/tickets/",
  "details": {
    "can_edit": false,
    "notification_level": 1,
    "participants": [
      {
        "id": 991,
        "username": "packetship",
        "name": "Paul Clark",
        "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/p/50afbb/{size}.png",
        "post_count": 2,
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_color": null,
        "flair_bg_color": null,
        "flair_group_id": null,
        "trust_level": 1
      },
      {
        "id": 12,
        "username": "ajbeamon",
        "name": "A.J. Beamon",
        "avatar_template": "/user_avatar/forums.foundationdb.org/ajbeamon/{size}/13_2.png",
        "post_count": 1,
        "primary_group_name": null,
        "flair_name": null,
        "flair_url": null,
        "flair_color": null,
        "flair_bg_color": null,
        "flair_group_id": null,
        "admin": true,
        "trust_level": 4
      }
    ],
    "created_by": {
      "id": 991,
      "username": "packetship",
      "name": "Paul Clark",
      "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/p/50afbb/{size}.png"
    },
    "last_poster": {
      "id": 991,
      "username": "packetship",
      "name": "Paul Clark",
      "avatar_template": "https://avatars.discourse-cdn.com/v4/letter/p/50afbb/{size}.png"
    },
    "links": [
      {
        "url": "https://github.com/apple/foundationdb/issues/3336",
        "title": "Run one network thread per database \u00b7 Issue #3336 \u00b7 apple/foundationdb \u00b7 GitHub",
        "internal": false,
        "attachment": false,
        "reflection": false,
        "clicks": 35,
        "user_id": 991,
        "domain": "github.com",
        "root_domain": "github.com"
      },
      {
        "url": "https://github.com/apple/foundationdb/pull/4269",
        "title": "Multithreaded client by sears \u00b7 Pull Request #4269 \u00b7 apple/foundationdb \u00b7 GitHub",
        "internal": false,
        "attachment": false,
        "reflection": false,
        "clicks": 21,
        "user_id": 991,
        "domain": "github.com",
        "root_domain": "github.com"
      }
    ]
  },
  "bookmarks": []
}